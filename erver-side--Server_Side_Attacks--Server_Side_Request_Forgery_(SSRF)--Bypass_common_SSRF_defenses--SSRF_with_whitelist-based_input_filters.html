<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SSRF with whitelist-based input filters</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>SSRF with whitelist-based input filters</h1><br/>Some applications only allow user input that:<br />• matches<br />• begins with<br />• contains<br />a whitelist of permitted values<br /><br />We can bypass these filter by exploiting inconsistencies in URL parsing.<br />In fact the URL specification contains a number of features that are liable to be overlooked when implementing ad hoc parsing and validation of URLs:<br />• embed credentials in a URL before the hostname, using the @ character<br />	<code>https://</code><code><span style="color:#e01b24;">evil-host</span></code><code>@expectedhost</code><br />•  # character to indicate a URL fragment<br />	<code>https://</code><code><span style="color:#e01b24;">evil-host</span></code><code>#expected-host</code><br />• place required input into a fully-qualified DNS name that you control<br />	<code>https://expected-host.</code><code><span style="color:#e01b24;">evil-host</span></code><br />• URL-encode characters to confuse the URL-parsing code. This is particularly useful if the code that implements the filter handles URL-encoded characters differently than the code that performs the back-end HTTP request.<br />• You can use combinations of these techniques together.<br /><br />Exercise:<br />1. Visit a product, click &quot;Check stock&quot;, intercept the request in Burp Suite, and send it to Burp Repeater.<br />	<a href=""><img src="images/2236-1.png" alt="images/2236-1.png" /></a><br />2. Change the URL in the <code>stockApi</code> parameter to <code>http://127.0.0.1/</code> and observe that the application is parsing the URL, extracting the hostname, and <span style="color:#ff7800;">validating it against a whitelist</span>.<br />	<a href=""><img src="images/2236-2.png" alt="images/2236-2.png" /></a><br />3. Change the URL to <code>http://username@stock.weliketoshop.net/</code> and observe that it is accepted (with an Internal Error), indicating anyway that:<br />   ◇ the URL parser supports embedded credentials<br />   ◇ that the server may have attempted to connect to &quot;username&quot;.<br />	<a href=""><img src="images/2236-3.png" alt="images/2236-3.png" /></a><br />4. Append a <code>#</code> to the username and observe that the URL is now rejected (400 Bad Request)<br />	<a href=""><img src="images/2236-4.png" alt="images/2236-4.png" /></a><br />5. Double-URL encode the <code>#</code> to <code>%2523</code> and observe that is accepted ( with an Internal Server Error), indicating that the server may have attempted to connect to &quot;username&quot;.<br />	<a href=""><img src="images/2236-5.png" alt="images/2236-5.png" /></a><br />6. To access the admin interface and delete the target user, change the URL to:<br />	<code>http://localhost:80%2523@stock.weliketoshop.net</code><br />	<a href=""><img src="images/2236-6.png" alt="images/2236-6.png" /></a><br />	<code><br /></code>7. Delete User, change URL to <code>http://localhost:80%2523@stock.weliketoshop.net/admin/delete?username=carlos</code><br />	<a href=""><img src="images/2236-7.png" alt="images/2236-7.png" /></a><code><br /><br /></code><br /><br /><br /><br /><br /><br /><br />Bibliography:<br />• <a href="https://portswigger.net/web-security/ssrf/lab-ssrf-with-whitelist-filter">https://portswigger.net/web-security/ssrf/lab-ssrf-with-whitelist-filter</a><br />• <a href="https://portswigger.net/research/top-10-web-hacking-techniques-of-2017#1">https://portswigger.net/research/top-10-web-hacking-techniques-of-2017#1</a></div>
</body>
</html>
