<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>7. SUID/SGID Executables</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>7. SUID/SGID Executables</h1><br/>To abuse of these executables we do not need to run them with sudo like in the chapter <a href="Home--Penetration_Test_Methodology--Network_Pentest--Post_Exploitation--Privilege_Escalation--Linux_Privilege_Escalation--5._Sudo.html">Sudo</a><br />The setuid bit appears as an <strong><span style="color:#e01b24;">s</span></strong><br />It may be possible to reverse engineer the program with the SETUID bit set, identify a vulnerability, and exploit this to escalate our privileges. <br /><br /><br />• <strong>S</strong><strong><span style="color:#1e90ff;">U</span></strong><strong>ID</strong> files get executed with the privileges of the file <span style="color:#1e90ff;">owner(user)</span>.<br />• <strong>S</strong><strong><span style="color:#ff8700;">G</span></strong><strong>ID</strong> files get executed with the privileges of the file <span style="color:#ff8700;">group</span>. If the file is owned by root, it gets executed with root privileges, and we may be able to use it to escalate privileges.<br /><br /><strong>Shell Escape Sequences</strong><br />Just as we were able to use <a href="st_Methodology--Network_Pentest--Post_Exploitation--Privilege_Escalation--Linux_Privilege_Escalation--5._Sudo--shell_escape_(awk_example).html">shell escape sequences with programs running via sudo</a>, we can do the same with SUID/SGID files.<br />A list of programs with their shell escape sequences can be found here: <a href="https://gtfobins.github.io/">https://gtfobins.github.io/</a><br /><br /><strong>No LD_PRELOAD &amp; LD_LIBRARY_PATH for executables</strong><br />We cannot use the same LD_PRELOAD and LD_LIBRARY_PATH environment variables tricks used in <a href="gy--Network_Pentest--Post_Exploitation--Privilege_Escalation--Linux_Privilege_Escalation--5._Sudo--Shared_Libraries_environment_variables.html">Sudo Privilege Escalation</a> because they are disabled by default for SUID files executable, due the obvious security risk.<br /><br /><strong>Manually locate files with the SUID or SGID bits set:</strong><br /><br />• SUID or SGID<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#ff9d00;font-weight:700">/</span> -type f -a <span style="color:#333333;font-weight:400">\(</span> -perm -u+s -o -perm -g+s <span style="color:#333333;font-weight:400">\)</span> -exec <span style="color:#ff9d00;font-weight:700">ls</span> -l <span style="color:#ff9d00;font-weight:700">{}</span> <span style="color:#333333;font-weight:400">\;</span> 2&gt; <span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>null     <span style="color:#0088ff;font-weight:400">#&lt;--- BETTER</span></pre></div><br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#ff9d00;font-weight:700">/</span> -perm -u+s -o -perm -g+s -type f 2&gt;<span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>null                                 <span style="color:#0088ff;font-weight:400">#alternative</span></pre></div><br />    <a href=""><img src="images/1305-1.png" alt="images/1305-1.png" /></a><br />    <a href=""><img src="images/1305-2.png" alt="images/1305-2.png" /></a><br /><br />• SUID and SGID<br />	-06000,-6000, -u+s , -u=s are the same thing<br />	<div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#ff9d00;font-weight:700">/</span> -user root -perm -6000 -exec <span style="color:#ff9d00;font-weight:700">ls</span> -ldb <span style="color:#ff9d00;font-weight:700">{}</span> <span style="color:#333333;font-weight:400">\;</span> 2&gt;<span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>null      <span style="color:#0088ff;font-weight:400">#owned by root</span></pre></div><br />	<div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#ff9d00;font-weight:700">/</span> -perm -6000 -exec <span style="color:#ff9d00;font-weight:700">ls</span> -ldb <span style="color:#ff9d00;font-weight:700">{}</span> <span style="color:#333333;font-weight:400">\;</span> 2&gt;<span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>null</pre></div><br /><br />• Only SUID <br />	 -04000,-4000, -u+s , -u=s are the same thing<br />	<div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#ff9d00;font-weight:700">/</span> -user root -perm -4000 -exec <span style="color:#ff9d00;font-weight:700">ls</span> -ldb <span style="color:#ff9d00;font-weight:700">{}</span> <span style="color:#333333;font-weight:400">\;</span> 2&gt;<span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>null      <span style="color:#0088ff;font-weight:400">#suid bit programs owned by root</span></pre></div><br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#ff9d00;font-weight:700">/</span> -type f -a <span style="color:#333333;font-weight:400">\(</span> -perm -u+s <span style="color:#333333;font-weight:400">\)</span> -exec <span style="color:#ff9d00;font-weight:700">ls</span> -l <span style="color:#ff9d00;font-weight:700">{}</span> <span style="color:#333333;font-weight:400">\;</span> 2&gt; <span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>null  <span style="color:#0088ff;font-weight:400">#suid bit owned by any user</span></pre></div><br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#ff9d00;font-weight:700">/</span> -perm -04000 -type f 2&gt;<span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>null                            <span style="color:#0088ff;font-weight:400">#suid bit owned by any user</span></pre></div><br />   ◇ <span style="text-decoration:underline;">search SUID in local partitions:</span><br />    <div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#From CIS</span><br />target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">df</span> --local -P <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">awk</span> <span style="color:#3ad900;font-weight:400">&#39;{if (NR!=1) print $6}&#39;</span> <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">xargs</span> -I <span style="color:#3ad900;font-weight:400">&#39;{}&#39;</span> <span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#3ad900;font-weight:400">&#39;{}&#39;</span> -xdev -type f -perm -4000</pre></div><br />   ◇ <span style="text-decoration:underline;">search SUID in network partitions</span>:<br />    The command above only searches local filesystems, there may still be compromised items on network mounted partitions. <br />    Additionally the --local option to df is not universal to all versions, it can be omitted to search all filesystems on a system including network mounted filesystems or the following command can be run manually for each partition<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ lsblk   <span style="color:#0088ff;font-weight:400">#show partitions</span></pre></div><br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">find</span> &lt;partition&gt; -xdev -type f -perm -4000</pre></div><br /><br />• Only SGID<br />	-02000,-2000, -g+s , -g=s are the same thing<br />	<div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#ff9d00;font-weight:700">/</span> -user root -perm -2000 -exec <span style="color:#ff9d00;font-weight:700">ls</span> -ldb <span style="color:#ff9d00;font-weight:700">{}</span> <span style="color:#333333;font-weight:400">\;</span> 2&gt;<span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>null</pre></div><br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#ff9d00;font-weight:700">/</span> -type f -a <span style="color:#333333;font-weight:400">\(</span> -perm -g+s <span style="color:#333333;font-weight:400">\)</span> -exec <span style="color:#ff9d00;font-weight:700">ls</span> -l <span style="color:#ff9d00;font-weight:700">{}</span> <span style="color:#333333;font-weight:400">\;</span> 2&gt; <span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>null</pre></div><br />   ◇ <span style="text-decoration:underline;">search SUID in local partitions:</span><br />    <div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#From CIS</span><br />target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">df</span> --local -P <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">awk</span> <span style="color:#3ad900;font-weight:400">&#39;{if (NR!=1) print $6}&#39;</span> <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">xargs</span> -I <span style="color:#3ad900;font-weight:400">&#39;{}&#39;</span> <span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#3ad900;font-weight:400">&#39;{}&#39;</span> -xdev -type f -perm -2000</pre></div><br />   ◇ <span style="text-decoration:underline;">search SUID in network partitions</span>:<br />    The command above only searches local filesystems, there may still be compromised items on network mounted partitions. <br />    Additionally the --local option to df is not universal to all versions, it can be omitted to search all filesystems on a system including network mounted filesystems or the following command can be run manually for each partition<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ lsblk   <span style="color:#0088ff;font-weight:400">#show partitions</span></pre></div><br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">find</span> &lt;partition&gt; -xdev -type f -perm -2000</pre></div><br />    To run a service with privileges from a group:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">sudo</span> -u user1 -g users [service]</pre></div><br /><a href=""><img src="images/1305-3.png" alt="images/1305-3.png" /></a><br /><strong>Tools:</strong><br />• <a href="https://github.com/Anon-Exploiter/SUID3NUM">https://github.com/Anon-Exploiter/SUID3NUM</a><br />	differentiate from default binaries and more interesting files with SUID<br />	<a href=""><img src="images/1305-4.png" alt="images/1305-4.png" /></a><br /><br /><br /><br /><strong>Bibliography:</strong><br />• TCM Security: Linux Privilege Escalation for Beginners (<a href="https://academy.tcm-sec.com/p/linux-privilege-escalation">https://academy.tcm-sec.com/p/linux-privilege-escalation</a>)<br />• Tib3rius: Linux Privilege Escalation for OSCP &amp; Beyond! (<a href="https://www.udemy.com/course/linux-privilege-escalation/">https://www.udemy.com/course/linux-privilege-escalation/</a>)<br /></div>
</body>
</html>
