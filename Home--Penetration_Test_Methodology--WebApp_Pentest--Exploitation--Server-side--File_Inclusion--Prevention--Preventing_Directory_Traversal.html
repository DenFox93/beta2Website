<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Preventing Directory Traversal</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Preventing Directory Traversal</h1><br/><br /><strong><h2>Preventing Directory Traversal</h2></strong><br />Directory Traversal could potentially allow attackers to:<br />• Read /etc/passwd<br />• find SSH Keys or know valid user names for a password spray attack<br />• Find other services on the box such as Tomcat and read the tomcat-users.xml file<br />• Discover valid PHP Session Cookies and perform session hijacking<br />• Read current web application configuration and source code<br /><br /><strong><h3>Pull out only the Filename</h3></strong><br />The best way to prevent directory traversal is to use programming language&#39;s (or framework&#39;s) built-in tool to pull only the filename. <br /><strong>PHP</strong> <br />• <code>basename()</code> read the path and only return the filename portion. If only a filename is given, then it will return just the filename. If just the path is given, it will treat whatever is after the final / as the filename.<br />   <span style="text-decoration:underline;">CONS:</span><br />   ◇ if the application needs to enter any directories, it will not be able to do it.<br /><br /><strong><h3>ATTENTION with custom functions</h3></strong><br />With custom functions is possible that are not accounted edge cases<br /><span style="color:#a52a2a;">Example To understand:</span><br />   1) Go in a bash terminal, home directly (<code>cd ~</code>) and run the command <code>cat .?/.*/.?/etc/passwd</code>. <br />      ▪ As we can see Bash allows for for the <code>?</code> and <code>*</code> wildcards to be used as a <code>..</code><br />        <a href=""><img src="images/2389-1.png" alt="images/2389-1.png" /></a><br />   2) Now type <code>php -a</code> to enter the PHP Command Line interpreter and run <code>echo file_get_contents(&#39;.?/.*/.?/etc/passwd&#39;);</code><br />      ▪ As we can see PHP give an ERROR<br />        <a href=""><img src="images/2389-2.png" alt="images/2389-2.png" /></a><br />      ▪ if you replace <code>?</code> and <code>*</code> with <code>.</code>, the command will work as expected<br />        <a href=""><img src="images/2389-3.png" alt="images/2389-3.png" /></a><br />   3) <span style="text-decoration:underline;">Edge cases with our above function</span>: if we have PHP execute bash with the system() function, the attacker would be able to bypass our directory traversal prevention<br />       <code>system(&#39;cat .?/.*/.?/etc/passwd&#39;, $retval);</code><br />       <a href=""><img src="images/2389-4.png" alt="images/2389-4.png" /></a><br />           <br /><strong><h3>Sanitize the user input </h3></strong><br />• To recursively remove any attempts of traversing directories:<br />   ◇ <strong>PHP</strong><br />       If the WebApp function does <code>path.replaceAll(&#39;../&#39;, &#39;&#39;)</code>. The attacker can circumvent it by trying <code>....//</code>, because of that the inner <code>../</code> is removed from the function but leaving <code>../</code><br />    <span style="text-decoration:underline;">Solution</span> is <br />      ▪ completely reject strings that contain forbidden sequences<br />      ▪ recursively apply the normalisation function<br />       <div class="codebox"><pre>while(substr_count($input, &#39;../&#39;, 0)) {<br />    $input = str_replace(&#39;../&#39;, &#39;&#39;, $input);<br />};</pre></div><br />          This code recursively removes ../ sub-strings, so even if the resulting string contains ../ it would still remove it, which would prevent bypasses<br /><br /><strong><h3>Validate that the input starts with an allowed base directory</h3></strong><br />Possible attack: <a href="ploitation--Server-side--File_Inclusion--Local_File_Inclusion(LFI)_File_Disclosure--Directory-Filename_Prefix--Bypass_Only_Approved_Paths.html">Bypass: Only Approved Paths</a><br /><strong>JAVA</strong><br />• <code>getCanonicalPath()</code> + <code>startsWith()</code> validate the canonical path of a file based on user input<br />    <div class="codebox"><pre>File file = new File(BASE_DIRECTORY, userInput);<br />if (file.getCanonicalPath().startsWith(BASE_DIRECTORY)) {<br />    // process file<br />} </pre></div><br />   ◇ <a href="https://www.geeksforgeeks.org/file-getcanonicalpath-method-in-java-with-examples/">getCanonicalPath()</a> →  removes the ‘.’ ‘..’ from the path. sanitize the user input to remove any attempts of traversing directories<br /><br /></div>
</body>
</html>
