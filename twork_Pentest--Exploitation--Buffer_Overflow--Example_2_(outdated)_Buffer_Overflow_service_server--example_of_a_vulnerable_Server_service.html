<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>example of a vulnerable Server service</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>example of a vulnerable Server service</h1><br/><br />• With the Linker import wsoc32<br />   ◇ Dev CPP → Tools → Compiler Options →  check &quot;Add these commands to the linker command line&quot; and includes: &quot;<strong>-lwsock32</strong>&quot; (without quotes)<br />   	<a href=""><img src="images/2019-1.png" alt="images/2019-1.png" /></a><br />• Now you can compile<br />	<a href=""><img src="images/2019-2.png" alt="images/2019-2.png" /></a><br /><br /><br /><div class="codebox"><pre>    <span style="color:#0088ff;font-weight:400">#include &lt;winsock2.h&gt;</span><br />    <span style="color:#0088ff;font-weight:400">#include &lt;windows.h&gt;</span><br />    <span style="color:#0088ff;font-weight:400">#include &lt;fcntl.h&gt;</span><br />    <span style="color:#0088ff;font-weight:400">#include &lt;string.h&gt;</span><br />    <span style="color:#0088ff;font-weight:400">#include &lt;stdlib.h&gt;</span><br />    <span style="color:#0088ff;font-weight:400">#include &lt;errno.h&gt;</span><br />    <span style="color:#0088ff;font-weight:400">#include &lt;stdio.h&gt;</span><br />    <br />    int input_copy(char *myinput){<br />              char buff_ov_variable[<span style="color:#ff0044;font-weight:400">20</span>];<br />              strcpy(buff_ov_variable,myinput);<br />              <span style="color:#ff9d00;font-weight:700">return</span> <span style="color:#ff0044;font-weight:400">0</span>;<br />    }<br />    <br />    <span style="color:#7f0044;font-weight:400">DWORD</span> <span style="color:#7f0044;font-weight:400">WINAPI</span> <span style="color:#7f0044;font-weight:400">SocketHandler</span>(void*);<br />    <br />    int main(int argv, char** argc){<br />    <br />    	//<span style="color:#7f0044;font-weight:400">The</span> port we want the server to listen <br />    	int host_port= <span style="color:#ff0044;font-weight:400">7707</span>;<br />    	int	addr_size = sizeof(<span style="color:#7f0044;font-weight:400">SOCKADDR</span>);<br />    <br />    	//<span style="color:#7f0044;font-weight:400">Initialize</span> socket support - <span style="color:#7f0044;font-weight:400">WINDOWS</span> <span style="color:#7f0044;font-weight:400">ONLY</span>!<br />    	unsigned short wVersionRequested;<br />    	<span style="color:#7f0044;font-weight:400">WSADATA</span> wsaData;<br />    	int err;<br />    	wVersionRequested = <span style="color:#7f0044;font-weight:400">MAKEWORD</span>( <span style="color:#ff0044;font-weight:400">2</span>, <span style="color:#ff0044;font-weight:400">2</span> );<br />     	err = <span style="color:#7f0044;font-weight:400">WSAStartup</span>( wVersionRequested, &amp;wsaData );<br />    	<span style="color:#ff9d00;font-weight:700">if</span> ( err != <span style="color:#ff0044;font-weight:400">0</span> || ( <span style="color:#7f0044;font-weight:400">LOBYTE</span>( wsaData.wVersion ) != <span style="color:#ff0044;font-weight:400">2</span> ||<br />    		    <span style="color:#7f0044;font-weight:400">HIBYTE</span>( wsaData.wVersion ) != <span style="color:#ff0044;font-weight:400">2</span> )) {<br />    	    fprintf(stderr, <span style="color:#3ad900;font-weight:400">&quot;Could not find useable sock dll %d\n&quot;</span>,<span style="color:#7f0044;font-weight:400">WSAGetLastError</span>());<br />    		exit (<span style="color:#7f0044;font-weight:400">EXIT_FAILURE</span>);<br />    	}<br />    <br />    	//<span style="color:#7f0044;font-weight:400">Initialize</span> sockets <span style="color:#ff9d00;font-weight:700">and</span> set any options<br />    	int hsock;<br />    	int * p_int ;<br />    	hsock = socket(<span style="color:#7f0044;font-weight:400">AF_INET</span>, <span style="color:#7f0044;font-weight:400">SOCK_STREAM</span>, <span style="color:#ff0044;font-weight:400">0</span>);<br />    	<span style="color:#ff9d00;font-weight:700">if</span>(hsock == -<span style="color:#ff0044;font-weight:400">1</span>){<br />    		printf(<span style="color:#3ad900;font-weight:400">&quot;Error initializing socket %d\n&quot;</span>,<span style="color:#7f0044;font-weight:400">WSAGetLastError</span>());<br />    		exit (<span style="color:#7f0044;font-weight:400">EXIT_FAILURE</span>);<br />    	}<br />    	<br />    	p_int = (int*)malloc(sizeof(int));<br />    	*p_int = <span style="color:#ff0044;font-weight:400">1</span>;<br />    	<span style="color:#ff9d00;font-weight:700">if</span>( (setsockopt(hsock, <span style="color:#7f0044;font-weight:400">SOL_SOCKET</span>, <span style="color:#7f0044;font-weight:400">SO_REUSEADDR</span>, (char*)p_int, sizeof(int)) == -<span style="color:#ff0044;font-weight:400">1</span> )||<br />    		(setsockopt(hsock, <span style="color:#7f0044;font-weight:400">SOL_SOCKET</span>, <span style="color:#7f0044;font-weight:400">SO_KEEPALIVE</span>, (char*)p_int, sizeof(int)) == -<span style="color:#ff0044;font-weight:400">1</span> ) ){<br />    		printf(<span style="color:#3ad900;font-weight:400">&quot;Error setting options %d\n&quot;</span>, <span style="color:#7f0044;font-weight:400">WSAGetLastError</span>());<br />    		free(p_int);<br />    		exit (<span style="color:#7f0044;font-weight:400">EXIT_FAILURE</span>);<br />    	}<br />    	free(p_int);<br />    <br />    	//<span style="color:#7f0044;font-weight:400">Bind</span> <span style="color:#ff9d00;font-weight:700">and</span> listen<br />    	struct sockaddr_in my_addr;<br />    <br />    	my_addr.sin_family = <span style="color:#7f0044;font-weight:400">AF_INET</span> ;<br />    	my_addr.sin_port = htons(host_port);<br />    	<br />    	memset(&amp;(my_addr.sin_zero), <span style="color:#ff0044;font-weight:400">0</span>, <span style="color:#ff0044;font-weight:400">8</span>);<br />    	my_addr.sin_addr.s_addr = <span style="color:#7f0044;font-weight:400">INADDR_ANY</span> ;<br />    	<br />    	<span style="color:#ff9d00;font-weight:700">if</span>( bind( hsock, (struct sockaddr*)&amp;my_addr, sizeof(my_addr)) == -<span style="color:#ff0044;font-weight:400">1</span> ){<br />    		fprintf(stderr,<span style="color:#3ad900;font-weight:400">&quot;Error binding to socket, make sure nothing else is listening on this port %d\n&quot;</span>,<span style="color:#7f0044;font-weight:400">WSAGetLastError</span>());<br />    		exit (<span style="color:#7f0044;font-weight:400">EXIT_FAILURE</span>);<br />    	}<br />    	<span style="color:#ff9d00;font-weight:700">if</span>(listen( hsock, <span style="color:#ff0044;font-weight:400">10</span>) == -<span style="color:#ff0044;font-weight:400">1</span> ){<br />    		fprintf(stderr, <span style="color:#3ad900;font-weight:400">&quot;Error listening %d\n&quot;</span>,<span style="color:#7f0044;font-weight:400">WSAGetLastError</span>());<br />    		exit (<span style="color:#7f0044;font-weight:400">EXIT_FAILURE</span>);<br />    	}<br />    	<br />    	//<span style="color:#7f0044;font-weight:400">Server</span> operations<br />    <br />    	int* csock;<br />    	sockaddr_in sadr;<br />        <br />    	<br />    	<span style="color:#ff9d00;font-weight:700">while</span>(<span style="color:#ff0044;font-weight:400">true</span>){<br />    		printf(<span style="color:#3ad900;font-weight:400">&quot;waiting for a connection\n&quot;</span>);<br />    		csock = (int*)malloc(sizeof(int));<br />    		<br />    		<span style="color:#ff9d00;font-weight:700">if</span>((*csock = accept( hsock, (<span style="color:#7f0044;font-weight:400">SOCKADDR</span>*)&amp;sadr, &amp;addr_size))!= <span style="color:#7f0044;font-weight:400">INVALID_SOCKET</span> ){<br />    			printf(<span style="color:#3ad900;font-weight:400">&quot;Received connection from %s&quot;</span>,inet_ntoa(sadr.sin_addr));<br />    			<span style="color:#7f0044;font-weight:400">CreateThread</span>(<span style="color:#ff0044;font-weight:400">0</span>,<span style="color:#ff0044;font-weight:400">0</span>,&amp;<span style="color:#7f0044;font-weight:400">SocketHandler</span>, (void*)csock , <span style="color:#ff0044;font-weight:400">0</span>,<span style="color:#ff0044;font-weight:400">0</span>);<br />    		}<br />    		<span style="color:#ff9d00;font-weight:700">else</span>{<br />    			fprintf(stderr, <span style="color:#3ad900;font-weight:400">&quot;Error accepting %d\n&quot;</span>,<span style="color:#7f0044;font-weight:400">WSAGetLastError</span>());<br />    		}<br />    	}<br />    <br />    <br />    }<br />    <br />    <span style="color:#7f0044;font-weight:400">DWORD</span> <span style="color:#7f0044;font-weight:400">WINAPI</span> <span style="color:#7f0044;font-weight:400">SocketHandler</span>(void* lp){<br />        int *csock = (int*)lp;<br />        char banner[<span style="color:#ff0044;font-weight:400">40</span>] = <span style="color:#3ad900;font-weight:400">&quot;Fox Echo Server x.x\n\0&quot;</span>;<br />    	char buffer[<span style="color:#ff0044;font-weight:400">1000000</span>];<br />    	int buffer_len = <span style="color:#ff0044;font-weight:400">1000000</span>;<br />    	int bytecount;<br />		<br />		<br />    	<span style="color:#ff9d00;font-weight:700">if</span>((bytecount = send(*csock, banner, strlen(banner), <span style="color:#ff0044;font-weight:400">0</span>))==<span style="color:#7f0044;font-weight:400">SOCKET_ERROR</span>){<br />    		fprintf(stderr, <span style="color:#3ad900;font-weight:400">&quot;Error sending data %d\n&quot;</span>, <span style="color:#7f0044;font-weight:400">WSAGetLastError</span>());<br />    		free(csock);<br />			exit (<span style="color:#7f0044;font-weight:400">EXIT_FAILURE</span>);<br />    	}<br />		<br />        <br />    	<span style="color:#ff9d00;font-weight:700">if</span>((bytecount = recv(*csock, buffer, buffer_len, <span style="color:#ff0044;font-weight:400">0</span>))==<span style="color:#7f0044;font-weight:400">SOCKET_ERROR</span>){<br />    		fprintf(stderr, <span style="color:#3ad900;font-weight:400">&quot;Error receiving data %d\n&quot;</span>, <span style="color:#7f0044;font-weight:400">WSAGetLastError</span>());<br />    		free(csock);<br />			exit (<span style="color:#7f0044;font-weight:400">EXIT_FAILURE</span>);<br />		}<span style="color:#ff9d00;font-weight:700">else</span>{	<br />            printf(<span style="color:#3ad900;font-weight:400">&quot;Received bytes: %d\nReceived string: \&quot;%s\&quot;\n&quot;</span>, bytecount, buffer);<br />    	<br />    <br />        	input_copy(buffer);	//the vulnerable command<br />    	<br />        	strcat(buffer, <span style="color:#3ad900;font-weight:400">&quot; - ECHO SERVER\n&quot;</span>);<br />		<br />	 <br />	        <span style="color:#ff9d00;font-weight:700">if</span>((bytecount = send(*csock, buffer, strlen(buffer), <span style="color:#ff0044;font-weight:400">0</span>))==<span style="color:#7f0044;font-weight:400">SOCKET_ERROR</span>){<br />    	  	              fprintf(stderr, <span style="color:#3ad900;font-weight:400">&quot;Error sending data %d\n&quot;</span>, <span style="color:#7f0044;font-weight:400">WSAGetLastError</span>());<br />    		              free(csock);<br />		                  exit (<span style="color:#7f0044;font-weight:400">EXIT_FAILURE</span>);<br />    	   }<br />    	   printf(<span style="color:#3ad900;font-weight:400">&quot;Sent bytes %d\n&quot;</span>, bytecount);<br />    	   <br />    	   shutdown(*csock,<span style="color:#ff0044;font-weight:400">2</span>);<br />    	}<br />    	<br />    <br />    <br /> <br />    }<br /></pre></div></div>
</body>
</html>
