<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Crystal/White Box Pentesting</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Crystal/White Box Pentesting</h1><br/><br /><a href=""><img src="images/1570-1.png" alt="images/1570-1.png" /></a><br /><br />Note: Burp Suite and ZAP will see the interaction between index.html and entry.php (because that data will pass through the interception proxy), but they will not see the interaction between entry.php and xml.php (that data is sent server -&gt; server).<br /><br />index.html<br /><div class="codebox"><pre>&lt;html&gt;<br />&lt;body background=&quot;/images/hubble.jpg&quot;&gt;<br />&lt;H1&gt;The Hitchhiker&#39;s Guide to the GalaXXE&lt;/H1&gt;<br />Welcome to the The Hitchhiker&#39;s Guide to the GalaXXE: we were Wikipedia a billion years before Wikipedia!&lt;br&gt;&lt;br&gt;<br />This is our new article creation form: please help expand the universe&#39;s knowledge by creating an article.&lt;br&gt;&lt;br&gt;<br />&lt;form method=&quot;post&quot; action=entry.php&gt;<br /><br />Subject: &lt;br&gt;<br />&lt;input type = &quot;text&quot; name = &quot;subject&quot;&gt;&lt;br&gt;&lt;br&gt;<br />Category: &lt;br&gt;<br />&lt;input type = &quot;text&quot; name = &quot;category&quot;&gt;&lt;br&gt;&lt;br&gt;<br />Text: &lt;br&gt;<br />&lt;input type = &quot;text&quot; name = &quot;text&quot;&gt;&lt;br&gt;&lt;br&gt;<br />    &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;submit&quot;&gt;<br />&lt;/form&gt;<br />&lt;/body&gt;<br />&lt;/html&gt;<br /></pre></div><br /><br />entry.php<br /><div class="codebox"><pre><span style="color:#333333;font-weight:400">&lt;?php</span><br /><span style="color:#333333;font-weight:400">$xmlstr</span> <span style="color:#ff9d00;font-weight:400">=</span> <span style="color:#3ad900;font-weight:400">&lt;&lt;&lt;XML<br />&lt;?xml version=&quot;1.0&quot;?&gt;<br />&lt;entry&gt;<br />    &lt;subject&gt;&lt;/subject&gt;<br />    &lt;category&gt;&lt;/category&gt;<br />    &lt;text&gt;&lt;/text&gt;<br />&lt;/entry&gt;<br />XML;</span><br /><br /><span style="color:#ff9d00;font-weight:700">if(isset(</span><span style="color:#333333;font-weight:400">$_POST[</span><span style="color:#3ad900;font-weight:400">&#39;submit&#39;</span><span style="color:#333333;font-weight:400">]</span><span style="color:#ff9d00;font-weight:400">))</span> {<br />    <span style="color:#333333;font-weight:400">$xml</span> <span style="color:#ff9d00;font-weight:400">=</span> <span style="color:#ff9d00;font-weight:700">new</span> SimpleXMLElement<span style="color:#ff9d00;font-weight:400">(</span><span style="color:#333333;font-weight:400">$xmlstr</span><span style="color:#ff9d00;font-weight:400">);</span><br />    <span style="color:#333333;font-weight:400">$xml</span><span style="color:#ff9d00;font-weight:400">-&gt;</span>subject<span style="color:#ff9d00;font-weight:400">=</span><span style="color:#333333;font-weight:400">$_POST[</span><span style="color:#3ad900;font-weight:400">&quot;subject&quot;</span><span style="color:#333333;font-weight:400">]</span><span style="color:#ff9d00;font-weight:400">;</span><br />    <span style="color:#333333;font-weight:400">$xml</span><span style="color:#ff9d00;font-weight:400">-&gt;</span>category<span style="color:#ff9d00;font-weight:400">=</span><span style="color:#333333;font-weight:400">$_POST[</span><span style="color:#3ad900;font-weight:400">&quot;category&quot;</span><span style="color:#333333;font-weight:400">]</span><span style="color:#ff9d00;font-weight:400">;</span><br />    <span style="color:#333333;font-weight:400">$xml</span><span style="color:#ff9d00;font-weight:400">-&gt;</span>text<span style="color:#ff9d00;font-weight:400">=</span><span style="color:#333333;font-weight:400">$_POST[</span><span style="color:#3ad900;font-weight:400">&quot;text&quot;</span><span style="color:#333333;font-weight:400">]</span><span style="color:#ff9d00;font-weight:400">;</span><br />    <span style="color:#333333;font-weight:400">$xmlstr</span><span style="color:#ff9d00;font-weight:400">=</span><span style="color:#333333;font-weight:400">$xml</span><span style="color:#ff9d00;font-weight:400">-&gt;</span>asXML<span style="color:#ff9d00;font-weight:400">();</span><br />    <span style="color:#333333;font-weight:400">$url</span> <span style="color:#ff9d00;font-weight:400">=</span> <span style="color:#3ad900;font-weight:400">&#39;http://www.example.org/guide/xml.php&#39;</span><span style="color:#ff9d00;font-weight:400">;</span><br />    <span style="color:#333333;font-weight:400">$ch</span> <span style="color:#ff9d00;font-weight:400">=</span> curl_init<span style="color:#ff9d00;font-weight:400">();</span><br />    curl_setopt<span style="color:#ff9d00;font-weight:400">(</span> <span style="color:#333333;font-weight:400">$ch</span><span style="color:#ff9d00;font-weight:400">,</span> CURLOPT_URL<span style="color:#ff9d00;font-weight:400">,</span> <span style="color:#333333;font-weight:400">$url</span> <span style="color:#ff9d00;font-weight:400">);</span><br />    curl_setopt<span style="color:#ff9d00;font-weight:400">(</span> <span style="color:#333333;font-weight:400">$ch</span><span style="color:#ff9d00;font-weight:400">,</span> CURLOPT_POST<span style="color:#ff9d00;font-weight:400">,</span> <span style="color:#ff0044;font-weight:400">true</span> <span style="color:#ff9d00;font-weight:400">);</span><br />    curl_setopt<span style="color:#ff9d00;font-weight:400">(</span> <span style="color:#333333;font-weight:400">$ch</span><span style="color:#ff9d00;font-weight:400">,</span> CURLOPT_HTTPHEADER<span style="color:#ff9d00;font-weight:400">,</span> <span style="color:#7f0044;font-weight:400">array</span><span style="color:#ff9d00;font-weight:400">(</span><span style="color:#3ad900;font-weight:400">&#39;Content-Type: text/xml&#39;</span><span style="color:#ff9d00;font-weight:400">));</span><br />    curl_setopt<span style="color:#ff9d00;font-weight:400">(</span> <span style="color:#333333;font-weight:400">$ch</span><span style="color:#ff9d00;font-weight:400">,</span> CURLOPT_RETURNTRANSFER<span style="color:#ff9d00;font-weight:400">,</span> <span style="color:#ff0044;font-weight:400">true</span> <span style="color:#ff9d00;font-weight:400">);</span><br />    curl_setopt<span style="color:#ff9d00;font-weight:400">(</span> <span style="color:#333333;font-weight:400">$ch</span><span style="color:#ff9d00;font-weight:400">,</span> CURLOPT_POSTFIELDS<span style="color:#ff9d00;font-weight:400">,</span> <span style="color:#333333;font-weight:400">$xmlstr</span> <span style="color:#ff9d00;font-weight:400">);</span><br />    <span style="color:#333333;font-weight:400">$result</span> <span style="color:#ff9d00;font-weight:400">=</span> curl_exec<span style="color:#ff9d00;font-weight:400">(</span><span style="color:#333333;font-weight:400">$ch</span><span style="color:#ff9d00;font-weight:400">);</span><br />    curl_close<span style="color:#ff9d00;font-weight:400">(</span><span style="color:#333333;font-weight:400">$ch</span><span style="color:#ff9d00;font-weight:400">);</span><br />    <span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&#39;&lt;html&gt;&lt;body background=&quot;/images/hubble.jpg&quot;&gt;&lt;H1&gt;Thank you!!&lt;/H1&gt;&#39;</span><span style="color:#ff9d00;font-weight:400">;</span><br />    <span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#333333;font-weight:400">$result</span><span style="color:#ff9d00;font-weight:400">;</span><br />    <span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&#39;&lt;br&gt;&lt;br&gt;&lt;a href=&quot;index.html&quot;&gt;Click here&lt;/a&gt; to make another entry&#39;</span><span style="color:#ff9d00;font-weight:400">;</span><br />    <span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span><span style="color:#ff9d00;font-weight:400">;</span><br />}<br /><br /><span style="color:#333333;font-weight:400">?&gt;</span></pre></div><br /><br />xml.php<br /><div class="codebox"><pre><span style="color:#333333;font-weight:400">&lt;?php</span><br />libxml_disable_entity_loader <span style="color:#ff9d00;font-weight:400">(</span><span style="color:#ff0044;font-weight:400">false</span><span style="color:#ff9d00;font-weight:400">);</span><br /><span style="color:#333333;font-weight:400">$xmlfile</span> <span style="color:#ff9d00;font-weight:400">=</span> file_get_contents<span style="color:#ff9d00;font-weight:400">(</span><span style="color:#3ad900;font-weight:400">&#39;php://input&#39;</span><span style="color:#ff9d00;font-weight:400">);</span><br /><span style="color:#333333;font-weight:400">$dom</span> <span style="color:#ff9d00;font-weight:400">=</span> <span style="color:#ff9d00;font-weight:700">new</span> DOMDocument<span style="color:#ff9d00;font-weight:400">();</span><br /><span style="color:#333333;font-weight:400">$dom</span><span style="color:#ff9d00;font-weight:400">-&gt;</span>loadXML<span style="color:#ff9d00;font-weight:400">(</span><span style="color:#333333;font-weight:400">$xmlfile</span><span style="color:#ff9d00;font-weight:400">,</span> LIBXML_NOENT <span style="color:#ff9d00;font-weight:400">|</span> LIBXML_DTDLOAD<span style="color:#ff9d00;font-weight:400">);</span><br /><span style="color:#333333;font-weight:400">$xml</span> <span style="color:#ff9d00;font-weight:400">=</span> simplexml_import_dom<span style="color:#ff9d00;font-weight:400">(</span><span style="color:#333333;font-weight:400">$dom</span><span style="color:#ff9d00;font-weight:400">);</span><br /><span style="color:#333333;font-weight:400">$subject</span> <span style="color:#ff9d00;font-weight:400">=</span> <span style="color:#333333;font-weight:400">$xml</span><span style="color:#ff9d00;font-weight:400">-&gt;</span>subject<span style="color:#ff9d00;font-weight:400">;</span><br /><span style="color:#333333;font-weight:400">$category</span> <span style="color:#ff9d00;font-weight:400">=</span> <span style="color:#333333;font-weight:400">$xml</span><span style="color:#ff9d00;font-weight:400">-&gt;</span>category<span style="color:#ff9d00;font-weight:400">;</span><br /><span style="color:#333333;font-weight:400">$text</span> <span style="color:#ff9d00;font-weight:400">=</span> <span style="color:#333333;font-weight:400">$xml</span><span style="color:#ff9d00;font-weight:400">-&gt;</span>text<span style="color:#ff9d00;font-weight:400">;</span><br /><br /><span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&quot;Thank you for your Hitchhiker&#39;s Guide to the GalaXXE Submission!!&lt;br&gt;&lt;br&gt;&quot;</span><span style="color:#ff9d00;font-weight:400">;</span><br /><span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&quot;Your entry:&lt;br&gt;&lt;br&gt;&quot;</span><span style="color:#ff9d00;font-weight:400">;</span><br /><span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&quot;Subject: &quot;</span> <span style="color:#ff9d00;font-weight:400">.</span> <span style="color:#333333;font-weight:400">$subject</span> <span style="color:#ff9d00;font-weight:400">.</span> <span style="color:#3ad900;font-weight:400">&quot;&lt;br&gt;&quot;</span><span style="color:#ff9d00;font-weight:400">;</span><br /><span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&quot;Category: &quot;</span> <span style="color:#ff9d00;font-weight:400">.</span> <span style="color:#333333;font-weight:400">$category</span> <span style="color:#ff9d00;font-weight:400">.</span> <span style="color:#3ad900;font-weight:400">&quot;&lt;br&gt;&quot;</span><span style="color:#ff9d00;font-weight:400">;</span><br /><span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&quot;Text: &quot;</span> <span style="color:#ff9d00;font-weight:400">.</span> <span style="color:#333333;font-weight:400">$text</span> <span style="color:#ff9d00;font-weight:400">.</span> <span style="color:#3ad900;font-weight:400">&quot;&lt;br&gt;\n&quot;</span><span style="color:#ff9d00;font-weight:400">;</span><br /><span style="color:#333333;font-weight:400">?&gt;</span><br /></pre></div><br />    <span style="color:#ff0000;">VULNERABLE CODE:</span><br />   ◇ <code>libxml_disable_entity_loader (false);</code> → If set to True &quot;libxml_disable_entity_loader&quot; is used to prevent XML eXternal Entity Injection, the best way is to check the validity of xml by yourself<br />   ◇ <code>$dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD);</code><br />      ▪ <code>LIBXML_NOENT</code> → allow loading XML entities <br />      ▪ <code>LIBXML_DTDLOAD</code> → allow/deny loading external entities <br />    <span style="color:#1e90ff;">PREVENT VULNERABILITY:</span><br />   ◇ <code>factory.setFeature(&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;, true);</code> → disable DTDs (External Entities) completely. Suggested by OWASP (<a href="https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html">here</a>)<br />    <br />    <br />    For a complete prevention vulnerabilities tricks see: <a href="https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html">https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html</a>    <br />    ◇ C/C++: If the Web Application use a version of the library <strong>libxml2</strong> before 2.9, XXE is enabled by default (<a href="https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html#:~:text=Note:">source</a>)<br />    <br />    <br />    <br />    <br /></div>
</body>
</html>
