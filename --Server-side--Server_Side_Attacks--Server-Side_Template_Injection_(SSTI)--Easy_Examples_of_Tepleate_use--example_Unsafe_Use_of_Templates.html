<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>example: Unsafe Use of Templates</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>example: Unsafe Use of Templates</h1><br/><span style="color:#a52a2a;">Example: app.py</span><br /><span style="text-decoration:underline;">Unsafe use of Template</span>: in this example the user have control over the variables.<br />When we visit the website, we will receive an HTML page containing the values of the title and content variables evaluated inside the double brackets on the template page.<br /><br />In this example we have a <span style="text-decoration:underline;">SSTI because user input enters in a template without any validation</span><br /><br />• app.py<br />    <div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#/usr/bin/python3</span><br /><span style="color:#333333;font-weight:400">from</span> <span style="color:#333333;font-weight:400">flask</span> <span style="color:#333333;font-weight:400">import</span> *<br /><br />app = Flask(<span style="color:#333333;font-weight:400">__name__</span>, template_folder=<span style="color:#3ad900;font-weight:400">&quot;./&quot;</span>)<br /><br /><span style="color:#333333;font-weight:400">@app.route</span>(<span style="color:#3ad900;font-weight:400">&quot;/&quot;</span>)<br /><span style="color:#ff9d00;font-weight:700">def</span> <span style="color:#333333;font-weight:400">index</span>():<br />	title = <span style="color:#3ad900;font-weight:400">&quot;Index Page&quot;</span><br />	content = <span style="color:#3ad900;font-weight:400">&quot;Some content&quot;</span><br />	<span style="color:#ff9d00;font-weight:700">return</span> render_template(<span style="color:#3ad900;font-weight:400">&quot;index.html&quot;</span>, title=title, content=content)<br /><br /><span style="color:#333333;font-weight:400">@app.route</span>(<span style="color:#3ad900;font-weight:400">&quot;/hello&quot;</span>, methods=[<span style="color:#3ad900;font-weight:400">&#39;GET&#39;</span>])<br /><span style="color:#ff9d00;font-weight:700">def</span> <span style="color:#333333;font-weight:400">hello</span>():<br />	name = request.args.get(<span style="color:#3ad900;font-weight:400">&quot;name&quot;</span>)<br />	<span style="color:#ff9d00;font-weight:700">if</span> name == <span style="color:#ff0044;font-weight:700">None</span>:<br />		<span style="color:#ff9d00;font-weight:700">return</span> redirect(f<span style="color:#3ad900;font-weight:400">&#39;{url_for(&quot;hello&quot;)}?name=guest&#39;</span>)<br />	htmldoc = f<span style="color:#3ad900;font-weight:400">&quot;&quot;&quot;<br />	&lt;html&gt;<br />	&lt;body&gt;<br />	&lt;h1&gt;Hello&lt;/h1&gt;<br />	&lt;a&gt;Nice to see you {name}&lt;/a&gt;<br />	&lt;/body&gt;<br />	&lt;/html&gt;<br />	&quot;&quot;&quot;</span><br />	<span style="color:#ff9d00;font-weight:700">return</span> render_template_string(htmldoc)<br /><br /><span style="color:#ff9d00;font-weight:700">if</span> <span style="color:#333333;font-weight:400">__name__</span> == <span style="color:#3ad900;font-weight:400">&quot;__main__&quot;</span>:<br />	app.run(host=<span style="color:#3ad900;font-weight:400">&quot;127.0.0.1&quot;</span>, port=<span style="color:#ff0044;font-weight:400">5000</span>)</pre></div><code><br /></code><br /><strong>Exploit</strong><br />In this example, we can inject a template expression directly, and the server will evaluate it. <br />This is a security issue that could lead to remote code execution on the target application<br /><div class="codebox"><pre>curl -gis <span style="color:#3ad900;font-weight:400">&#39;http://127.0.0.1:5000/hello?name={{7*7}}&#39;</span></pre></div><br />    <a href=""><img src="images/2574-1.png" alt="images/2574-1.png" /></a><br />    <a href=""><img src="images/2574-2.png" alt="images/2574-2.png" /></a><br /><br /></div>
</body>
</html>
