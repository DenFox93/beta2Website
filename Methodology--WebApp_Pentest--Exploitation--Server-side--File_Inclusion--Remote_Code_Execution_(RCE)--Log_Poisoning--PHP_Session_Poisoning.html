<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PHP Session Poisoning</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>PHP Session Poisoning</h1><br/><br /><h2>PHP Session Poisoning</h2><br />Usually PHP web applications utilize <span style="color:#ff7800;">PHPSESSID</span> cookies, which can hold specific user-related data on the back-end, so the web application can keep track of user details through their cookies. <br /><br />These details about the session are stored in session files on the back-end, and saved in:<br />   ◇ Linux →  <span style="color:#9141ac;">/var/lib/php/sessions/</span><br />   ◇ Windows →  <span style="color:#9141ac;">C:\Windows\Temp\</span><br />The name of the file that contains our user&#39;s data matches the name of our <span style="color:#ff7800;">PHPSESSID</span> cookie with the <span style="color:#e01b24;">sess_</span>  prefix. <br /><span style="color:#865e3c;">example:</span> if the value of <span style="color:#ff7800;">PHPSESSID</span> cookie is set to <code>tjjnp54mgt13ckf85gplg2khui</code>, then it&#39;s location on disk would be<br />	 <span style="color:#9141ac;">/var/lib/php/sessions/</span><span style="color:#e01b24;">sess_</span><code>tjjnp54mgt13ckf85gplg2khui</code><br /><br />-------------<br />1. Inspect if we have a PHPSESSID cookie set to our session<br />   ◇ In Firefox: Inspect (F12) → Storage → Cookies<br />	<a href=""><img src="images/2373-1.png" alt="images/2373-1.png" /></a><br />2. Since our <span style="color:#ff7800;">PHPSESSID</span> cookie value is set to <span style="color:#ff7800;">tjjnp54mgt13ckf85gplg2khui</span>, it should be stored at <span style="color:#9141ac;">/var/lib/php/sessions/</span><span style="color:#e01b24;">sess_</span><span style="color:#ff7800;">tjjnp54mgt13ckf85gplg2khui</span> <br />	Include this session file through the LFI  and view its contents:<br />	<div class="codebox"><pre>http<span style="color:#ff9d00;font-weight:700">://</span>46.101.61.42<span style="color:#ff9d00;font-weight:700">:</span>30915<span style="color:#ff9d00;font-weight:700">/</span>index.php?language=<span style="color:#ff9d00;font-weight:700">/</span>var<span style="color:#ff9d00;font-weight:700">/</span>lib<span style="color:#ff9d00;font-weight:700">/</span>php<span style="color:#ff9d00;font-weight:700">/</span>sessions<span style="color:#ff9d00;font-weight:700">/</span>sess_tjjnp54mgt13ckf85gplg2khui</pre></div><br />   <a href=""><img src="images/2373-2.png" alt="images/2373-2.png" /></a><br />	The session file contains two values in this example:<br />      ▪ <span style="color:#f6d32d;">selected_language</span> → shows the page “en.php” of the selected language  <br />         -  Under our control, as we can control it through the <span style="color:#33d17a;">?language=</span> parameter<br />      ▪ preference → shows the selected language “English”<br />         - Not under our control because we did not specify it anywhere<br />         <br />------------- <br /><br />3. Check if we can set the value of page to a custom value (example: for <span style="color:#2ec27e;">language</span> parameter) and see if it changes in the session file. <br />	<div class="codebox"><pre>http<span style="color:#ff9d00;font-weight:700">://</span>46.101.61.42<span style="color:#ff9d00;font-weight:700">:</span>30915<span style="color:#ff9d00;font-weight:700">/</span>index.php?language=session_poisoned_by_daniele</pre></div><br />	<a href=""><img src="images/2373-3.png" alt="images/2373-3.png" /></a><br />4. Like point 2 check the values of the session file if it changed<br />	<div class="codebox"><pre>http<span style="color:#ff9d00;font-weight:700">://</span>46.101.61.42<span style="color:#ff9d00;font-weight:700">:</span>30915<span style="color:#ff9d00;font-weight:700">//</span>index.php?language=<span style="color:#ff9d00;font-weight:700">/</span>var<span style="color:#ff9d00;font-weight:700">/</span>lib<span style="color:#ff9d00;font-weight:700">/</span>php<span style="color:#ff9d00;font-weight:700">/</span>sessions<span style="color:#ff9d00;font-weight:700">/</span>sess_k8hmi12d9nlkrchsmda0gnqhoj </pre></div><br />   <a href=""><img src="images/2373-4.png" alt="images/2373-4.png" /></a><br />	the session file contains <span style="color:#2ddff7;">session_poisoned_by_daniele</span> instead of <span style="color:#2ddff7;">es.php</span>, which confirms our ability to control the value of <span style="color:#f6d32d;">selected_language</span> in the session file<br />	<br />-------------<br /><br /> 5. Perform poisoning of the session file by writing PHP code int it (Like point 1 and 3). We can write a basic PHP web shell by changing the <span style="color:#33d17a;">?language=</span> parameter to a URL encoded web shell<br />	<div class="codebox"><pre>http<span style="color:#ff9d00;font-weight:700">://</span>&lt;SERVER_IP&gt;<span style="color:#ff9d00;font-weight:700">:</span>&lt;PORT&gt;<span style="color:#ff9d00;font-weight:700">/</span>index.php?language=%3C%3Fphp%20system%28%24_GET%5B%22cmd%22%5D%29%3B%3F%3E</pre></div><code><br /></code>	<a href=""><img src="images/2373-5.png" alt="images/2373-5.png" /></a><br /><br />6. Like point 2 and 4 we LFI the session file. <br />	Then use <code>&amp;cmd</code> to execute a commands<br />	<a href=""><img src="images/2373-6.png" alt="images/2373-6.png" /></a><br />   <a href=""><img src="images/2373-7.png" alt="images/2373-7.png" /></a><br />	<a href=""><img src="images/2373-8.png" alt="images/2373-8.png" /></a><br />-------------<br /><br />7. use the poisoned web shell to write a permanent web shell to the web directory, or send a reverse shell for easier interaction.</div>
</body>
</html>
