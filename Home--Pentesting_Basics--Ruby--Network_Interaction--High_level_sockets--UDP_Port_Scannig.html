<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>UDP Port Scannig</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>UDP Port Scannig</h1><br/>UDP is often ignored because it is stateless and sometimes identifying if an UDP port is open or closed may take a lot of time.<br />We should run a UDP port scan, only to well-known ports and services<br /><br /><strong>Strategy UDP port scan</strong><br />• send an UDP packet to a port<br />• If we receive an:<br />   ◇ <span style="text-decoration:underline;">ICMP error</span> (destination unreachable or others) then we can conclude that the port is <span style="text-decoration:underline;">closed or firewalled</span>;<br />   ◇ <span style="text-decoration:underline;">UDP response</span> then the port is <span style="text-decoration:underline;">open</span> and the service is available.<br />   ◇ <span style="text-decoration:underline;">NO response</span>:<br />      ▪ <span style="text-decoration:underline;">packet lost</span>, because UDP is stateless<br />      ▪ <span style="text-decoration:underline;">port firewalled</span>, firewall that avoids sending a ICMP packet as a response<br /><br /><span style="text-decoration:underline;">Note</span>s: <br />• max 1 UDP packet for second<br />   Platforms Linux-style avoids sending too many ICMP packets ICMP  in order to avoid network congestion. Linux sends an ICMP packet once per second; therefore our script must take this behavior into account.<br />• script that accepts as parameter a list of ports instead of a range<br /><br /><div class="codebox"><pre><span style="color:#7f0044;font-weight:400">require</span> <span style="color:#3ad900;font-weight:400">&#39;socket&#39;</span><br /><span style="color:#7f0044;font-weight:400">require</span> <span style="color:#3ad900;font-weight:400">&#39;timeout&#39;</span><br /><br /><span style="color:#ff9d00;font-weight:700">def</span> main(host,ports)<br />	open = []<br />	filtered = []	<br />	closed = []<br />	<span style="color:#0088ff;font-weight:400">#ports is an array of ports</span><br />	<span style="color:#0088ff;font-weight:400"># for each port we have to send some UDP packets</span><br />	<span style="color:#0088ff;font-weight:400"># and catch any response</span><br />	ports.each <span style="color:#ff9d00;font-weight:700">do</span> |port|<br />		<span style="color:#0088ff;font-weight:400"># we create a proper UDP socket</span><br />		u = <span style="color:#7f0044;font-weight:400">UDPSocket</span>.new<br />		u.connect(host,port)	<br />		<span style="color:#0088ff;font-weight:400"># and we send from 1 up to 5 packets</span><br />		(1..5).each <span style="color:#ff9d00;font-weight:700">do</span> |i|<br />			<span style="color:#ff9d00;font-weight:700">begin</span>	<br />				<span style="color:#0088ff;font-weight:400">#First, we send a packet and wait for the first response. </span><br />				<span style="color:#0088ff;font-weight:400"># If no response is received, the timeout is triggered</span><br />				<span style="color:#0088ff;font-weight:400"># (note that the timeout is incremental).</span><br />				<span style="color:#0088ff;font-weight:400"># If the timeout is triggered for all 5 packets</span><br />				<span style="color:#0088ff;font-weight:400">#then we consider the port filtered</span><br />				<span style="color:#7f0044;font-weight:400">Timeout</span>::timeout(i*<span style="color:#ff0044;font-weight:400">0.5</span>){<br />					u.write(<span style="color:#3ad900;font-weight:400">&quot;\0&quot;</span>)<br />					u.recv(<span style="color:#ff0044;font-weight:400">10</span>) <br />					open.push port<br />				}<br />			<span style="color:#ff9d00;font-weight:700">rescue</span> <span style="color:#7f0044;font-weight:400">Errno::ECONNREFUSED</span><br />				<span style="color:#0088ff;font-weight:400"># port is considered closed if we receive an ICMP </span><br />				<span style="color:#0088ff;font-weight:400"># destination unreachable</span><br />				closed.push port <br />				<span style="color:#ff9d00;font-weight:700">break</span><br />			<span style="color:#ff9d00;font-weight:700">rescue</span> <span style="color:#7f0044;font-weight:400">Timeout::Error</span><br />				<span style="color:#0088ff;font-weight:400"># port is considered filtered if the timeout is </span><br />				<span style="color:#0088ff;font-weight:400"># triggered for all the (5) packets</span><br />				filtered.push(port) <span style="color:#ff9d00;font-weight:700">if</span> i==<span style="color:#ff0044;font-weight:400">5</span><br />			<span style="color:#ff9d00;font-weight:700">else</span><br />				<span style="color:#0088ff;font-weight:400"># in this case no exception is raised and the </span><br />				<span style="color:#0088ff;font-weight:400"># body timeout does not raise a timeout exeception</span><br />				<span style="color:#ff9d00;font-weight:700">break</span><br />			<span style="color:#ff9d00;font-weight:700">end</span><br />		<span style="color:#ff9d00;font-weight:700">end</span><br />	<span style="color:#ff9d00;font-weight:700">end</span><br />	puts <span style="color:#3ad900;font-weight:400">&quot;OPEN&quot;</span> <span style="color:#ff9d00;font-weight:700">if</span> !open.empty?<br />	puts open <span style="color:#ff9d00;font-weight:700">if</span> !open.empty?<br />	puts <span style="color:#3ad900;font-weight:400">&quot;FILTERED|OPEN&quot;</span> <span style="color:#ff9d00;font-weight:700">if</span> !filtered.empty?<br />	puts filtered <span style="color:#ff9d00;font-weight:700">if</span> !filtered.empty?<br />	puts <span style="color:#3ad900;font-weight:400">&quot;CLOSED&quot;</span> <span style="color:#ff9d00;font-weight:700">if</span> !closed.empty?<br />	puts closed <span style="color:#ff9d00;font-weight:700">if</span> !closed.empty?<br /><span style="color:#ff9d00;font-weight:700">end</span><br /><br /><br /><span style="color:#ff9d00;font-weight:700">begin</span> <br />	host = <span style="color:#7f0044;font-weight:400">ARGV</span>[<span style="color:#ff0044;font-weight:400">0</span>]<br />    <span style="color:#0088ff;font-weight:400"># We accept an array of ports to test split by -</span><br />	<span style="color:#0088ff;font-weight:400"># EXAMPLE: for 53-161-167 argument we have </span><br />	<span style="color:#0088ff;font-weight:400"># ports = [53,161,167]</span><br />	ports = <span style="color:#7f0044;font-weight:400">ARGV</span>[<span style="color:#ff0044;font-weight:400">1</span>].split(<span style="color:#3ad900;font-weight:400">&quot;-&quot;</span>).map{|x| x.to_i}<br />	main(host,ports)	<br /><br /><span style="color:#ff9d00;font-weight:700">end</span></pre></div><br />    <a href=""><img src="images/1956-1.png" alt="images/1956-1.png" /></a></div>
</body>
</html>
