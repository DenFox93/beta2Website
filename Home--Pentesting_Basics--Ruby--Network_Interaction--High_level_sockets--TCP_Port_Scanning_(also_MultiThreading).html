<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>TCP Port Scanning (also MultiThreading)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>TCP Port Scanning (also MultiThreading)</h1><br/>• With TCPSocket, we try to connect to an host port.<br />• If the connection is successful (TCP three way handshake), then the port is clearly open.<br />• If the connection is refused, then the port is closed or firewalled (the host or the firewall respond with RST+ACK).<br />• Otherwise, if we do not receive a response, there is probably a firewall that filters the port with no response at all.<br /><br /><br /><br /><div class="codebox"><pre><span style="color:#7f0044;font-weight:400">require</span> <span style="color:#3ad900;font-weight:400">&#39;socket&#39;</span><br /><br /><span style="color:#ff9d00;font-weight:700">def</span> main(host,start_port,end_port)<br />	open = []<br />	filtered = []	<br />	<span style="color:#0088ff;font-weight:400">#For each port between start_port and end_port</span><br />	<span style="color:#0088ff;font-weight:400"># we try the connection and we identify </span><br />	<span style="color:#0088ff;font-weight:400"># if it is filtered or open.</span><br />	start_port.upto(end_port) <span style="color:#ff9d00;font-weight:700">do</span> |port|<br />		<span style="color:#ff9d00;font-weight:700">begin</span><br />			<span style="color:#7f0044;font-weight:400">TCPSocket</span>.open(host,port)<br />			<span style="color:#0088ff;font-weight:400">#If no exception occurs, </span><br />			<span style="color:#0088ff;font-weight:400"># then the port is open and we push it into the open array.</span><br />			open.push port<br />		<span style="color:#ff9d00;font-weight:700">rescue</span> <span style="color:#7f0044;font-weight:400">Errno::ETIMEDOUT</span><br />		    <span style="color:#0088ff;font-weight:400"># If a timeout error is raised, the port is certainly filtered </span><br />		    <span style="color:#0088ff;font-weight:400"># and we push it into the filtered array.</span><br />			filtered.push port<br />		<span style="color:#ff9d00;font-weight:700">rescue</span> <span style="color:#7f0044;font-weight:400">Errno::ECONNREFUSED</span> <br />		    <span style="color:#0088ff;font-weight:400">#also rescue the connection refusal error </span><br />		    <span style="color:#0088ff;font-weight:400"># to avoid the script termination. But nothing is done</span><br />		<span style="color:#ff9d00;font-weight:700">end</span><br />	<span style="color:#ff9d00;font-weight:700">end</span><br />	puts <span style="color:#3ad900;font-weight:400">&quot;OPEN&quot;</span> <span style="color:#ff9d00;font-weight:700">if</span> !open.empty?<br />	puts open <span style="color:#ff9d00;font-weight:700">if</span> !open.empty?<br />	puts <span style="color:#3ad900;font-weight:400">&quot;FILTERED&quot;</span> <span style="color:#ff9d00;font-weight:700">if</span> !filtered.empty?<br />	puts filtered <span style="color:#ff9d00;font-weight:700">if</span> !filtered.empty?<br /><span style="color:#ff9d00;font-weight:700">end</span><br /><br /><br /><span style="color:#ff9d00;font-weight:700">begin</span> <br />	host = <span style="color:#7f0044;font-weight:400">ARGV</span>[<span style="color:#ff0044;font-weight:400">0</span>]<br /><br />	<span style="color:#0088ff;font-weight:400"># EXAMPLE: from 10-200 argument we have </span><br />	<span style="color:#0088ff;font-weight:400"># start_port = 10 and end_port = 200</span><br />	start_port,end_port = <span style="color:#7f0044;font-weight:400">ARGV</span>[<span style="color:#ff0044;font-weight:400">1</span>].split(<span style="color:#3ad900;font-weight:400">&quot;-&quot;</span>).map{|x| x.to_i}<br />	main(host,start_port,end_port)	<br /><br /><span style="color:#ff9d00;font-weight:700">end</span></pre></div><br />    <a href=""><img src="images/1955-1.png" alt="images/1955-1.png" /></a><br />    <br /><br /><strong>TCP Port Scanner MultiThreading</strong><br /><div class="codebox"><pre><span style="color:#7f0044;font-weight:400">require</span> <span style="color:#3ad900;font-weight:400">&#39;socket&#39;</span><br /><span style="color:#7f0044;font-weight:400">require</span> <span style="color:#3ad900;font-weight:400">&#39;timeout&#39;</span><br /><br /><span style="color:#ff9d00;font-weight:700">def</span> main(host,start_port,end_port)<br />	open = []<br />	filtered = []<br />	<span style="color:#0088ff;font-weight:400"># thread array	</span><br />	thread = []<br />	start_port.upto(end_port) <span style="color:#ff9d00;font-weight:700">do</span> |port|<br />		<span style="color:#0088ff;font-weight:400"># for each port we create a thread appending</span><br />		<span style="color:#0088ff;font-weight:400"># the thread identifier to thread array</span><br />		thread &lt;&lt; <span style="color:#7f0044;font-weight:400">Thread</span>.new <span style="color:#ff9d00;font-weight:700">do</span><br />		<span style="color:#ff9d00;font-weight:700">begin</span><br />			<span style="color:#ff9d00;font-weight:700">begin</span><br />			<span style="color:#0088ff;font-weight:400"># the connection has 30 seconds to be estabilished</span><br />			<span style="color:#7f0044;font-weight:400">Timeout</span>::timeout(<span style="color:#ff0044;font-weight:400">30</span>){<br />				<span style="color:#7f0044;font-weight:400">TCPSocket</span>.open(host,port)<br />				open.push port<br />			}<br />			<span style="color:#0088ff;font-weight:400"># if there is no response in 30 seconds</span><br />			<span style="color:#0088ff;font-weight:400"># we consider the port filtered</span><br />			<span style="color:#ff9d00;font-weight:700">rescue</span> <span style="color:#7f0044;font-weight:400">Timeout::Error</span><br />				filtered.push port<br />			<span style="color:#ff9d00;font-weight:700">end</span><br />		<span style="color:#ff9d00;font-weight:700">rescue</span> <span style="color:#7f0044;font-weight:400">Errno::ECONNREFUSED</span> <br />		<span style="color:#ff9d00;font-weight:700">end</span><br />		<span style="color:#ff9d00;font-weight:700">end</span><br />	<br />	<span style="color:#ff9d00;font-weight:700">end</span><br />	<span style="color:#0088ff;font-weight:400"># wait the termination of each thread</span><br />	thread.each { |th| th.join }<br />	puts <span style="color:#3ad900;font-weight:400">&quot;OPEN&quot;</span> <span style="color:#ff9d00;font-weight:700">if</span> !open.empty?<br />	puts open <span style="color:#ff9d00;font-weight:700">if</span> !open.empty?<br />	puts <span style="color:#3ad900;font-weight:400">&quot;CLOSED|FILTERED&quot;</span> <span style="color:#ff9d00;font-weight:700">if</span> !filtered.empty?<br />	puts filtered <span style="color:#ff9d00;font-weight:700">if</span> !filtered.empty?<br /><span style="color:#ff9d00;font-weight:700">end</span><br /><br /><br /><span style="color:#ff9d00;font-weight:700">begin</span> <br />	host = <span style="color:#7f0044;font-weight:400">ARGV</span>[<span style="color:#ff0044;font-weight:400">0</span>]<br /><br />	<span style="color:#0088ff;font-weight:400"># EXAMPLE: from 10-200 argument we have </span><br />	<span style="color:#0088ff;font-weight:400"># start_port = 10 and end_port = 200</span><br />	start_port,end_port = <span style="color:#7f0044;font-weight:400">ARGV</span>[<span style="color:#ff0044;font-weight:400">1</span>].split(<span style="color:#3ad900;font-weight:400">&quot;-&quot;</span>).map{|x| x.to_i}<br />	main(host,start_port,end_port)	<br /><br /><span style="color:#ff9d00;font-weight:700">end</span><br /></pre></div></div>
</body>
</html>
