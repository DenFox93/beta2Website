<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Privileges</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Privileges</h1><br/><br />• To Read Files we need:<br />   ◇ FILE privilege enabled for the DB user<br />• To Write Files <br />   ◇ <span style="color:#ffa500;">FILE</span> privilege enabled for the DB user<br />   ◇ MySQL global <span style="color:#a020f0;">secure_file_priv</span> variable not enabled<br />   ◇ Write access to the location we want to write to on the back-end server<br /><br /><br /><br /><br /><strong><span style="color:#ffa500;">FILE</span></strong><strong> Privilege</strong><br />FILE privilege allow to  load a file&#39;s content into a table and then dump data from that table and read files<br />Most of the features that we will try to exploit rely on the <a href="https://dev.mysql.com/doc/refman/5.1/en/privileges-provided.html#priv_file">FILE</a> privilege that &quot;gives you permission to read and write files on the server host&quot;:<br />   ◇ <span style="text-decoration:underline;">Can be granted</span> to any MySQL user, depending on the web application needs<br />   ◇ <span style="text-decoration:underline;">Always granted</span> to the MySQL root user, both on *nix systems and MS Windows<br />      ▪ if an application connects to its database as root, exploiting a SQL injection will lead not only to data compromise, but also to full server takeover.<br /><div class="codebox"><pre>SELECT grantee, privilege_type FROM information_schema.user_privileges</pre></div><br /><span style="color:#a52a2a;">examples of how to use these queries during exploitation:</span><br />    <div class="codebox"><pre>input&#39; UNION SELECT 1, grantee, privilege_type, 4 FROM information_schema.user_privileges-- -</pre></div><br />    <a href=""><img src="images/2515-1.png" alt="images/2515-1.png" /></a><br />    We have <strong><span style="color:#ffa500;">FILE</span></strong> privilege!<br />    <br /><br /><strong><h4>secure_file_priv</h4></strong><strong> Variable</strong> (<a href="https://mariadb.com/kb/en/server-system-variables/#secure_file_priv">https://mariadb.com/kb/en/server-system-variables/#secure_file_priv</a>)<br />The <span style="color:#a020f0;">secure_file_priv</span> variable is used to determine where to read/write files from.<br />   ◇ An <span style="color:#ff0000;">empty</span> value →  read/write files from the entire file system<br />      ▪ MariaDB has this variable set to empty by default, which lets us read/write to any file if the user has the <span style="color:#ffa500;">FILE</span> privilege<br />   ◇ directory set → we can only read from the folder specified by the variable. <br />      ▪ MySQL (old configurations) uses /var/lib/mysql-files as the default folder. This means that reading files through a MySQL injection isn&#39;t possible with default settings<br />   ◇ NULL → cannot read/write from any directory<br />      ▪ MySQL (modern configurations) default to NULL, meaning that we cannot read/write files anywhere within the system<br />How retrieve <span style="color:#a020f0;">secure_file_priv</span> value<br />• From mysql command line<br />    <div class="codebox"><pre>SHOW VARIABLES LIKE &#39;secure_file_priv&#39;;</pre></div><br />• Using UNION Injection<br />    We need to get this vale through a SELECT statement.<br />    Since Global Variables are stored in INFORMATION_SCHEMA database → <a href="https://dev.mysql.com/doc/refman/5.7/en/information-schema-variables-table.html">global_variables</a> table → variable_name,variable_value<br />    <div class="codebox"><pre>SELECT variable_name, variable_value FROM information_schema.global_variables where variable_name=&quot;secure_file_priv&quot;</pre></div><br />    <span style="color:#a52a2a;">examples of how to use these queries during exploitation:</span><br />    <div class="codebox"><pre>cn&#39; UNION SELECT 1, variable_name, variable_value, 4 FROM information_schema.global_variables where variable_name=&quot;secure_file_priv&quot;-- -</pre></div><br />    If we retrieve an <span style="color:#ff0000;">empty</span> result means that we can read/write files to any location<br />    <a href=""><img src="images/2515-2.png" alt="images/2515-2.png" /></a><br />    </div>
</body>
</html>
