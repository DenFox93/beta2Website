<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Detect Reflected XSS into with Nokogiri</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Detect Reflected XSS into with Nokogiri</h1><br/><br /><strong>Detect Reflected XSS with Nokogiri</strong><br />Nokogiri treats text of the response as a TextNode that must be contained in some ElementNode.<br />In our scenario:<br />• the ElementNode must be a script node &lt;script&gt;....&lt;/script&gt;<br />• TextNode must contains the string ‘alert(12345)’.<br /><br />We can add and test other XSS vectors other the one specified in XSS_VECTORS , the same thing is true for Testing_Values<br /><br /><br /><br /><div class="codebox"><pre><span style="color:#7f0044;font-weight:400">require</span> <span style="color:#3ad900;font-weight:400">&#39;nokogiri&#39;</span><br /><span style="color:#7f0044;font-weight:400">require</span> <span style="color:#3ad900;font-weight:400">&#39;open-uri&#39;</span><br /><span style="color:#7f0044;font-weight:400">require</span> <span style="color:#3ad900;font-weight:400">&#39;cgi&#39;</span><br /><span style="color:#0088ff;font-weight:400">#for https</span><br /><span style="color:#7f0044;font-weight:400">require</span> <span style="color:#3ad900;font-weight:400">&#39;openssl&#39;</span><br /><br /><span style="color:#0088ff;font-weight:400">#How use it</span><br /><span style="color:#0088ff;font-weight:400"># ruby detect_xss.rb [target_url] [target_parameter]</span><br /><br /><span style="color:#0088ff;font-weight:400">#Target constant contains the URL of the target resource, including the query string</span><br /><span style="color:#7f0044;font-weight:400">Target</span> = <span style="color:#7f0044;font-weight:400">URI</span>(<span style="color:#7f0044;font-weight:400">ARGV</span>[<span style="color:#ff0044;font-weight:400">0</span>])<br /><span style="color:#7f0044;font-weight:400">Parameter</span> = <span style="color:#7f0044;font-weight:400">ARGV</span>[<span style="color:#ff0044;font-weight:400">1</span>]<br /><br /><span style="color:#7f0044;font-weight:400">XSS_VECTORS</span> = [<span style="color:#3ad900;font-weight:400">&quot;&lt;script&gt;alert(123456)&lt;/script&gt;&quot;</span>]<br /><span style="color:#7f0044;font-weight:400">Testing_Values</span> = [<span style="color:#3ad900;font-weight:400">&quot;alert(123456)&quot;</span>]<br /><br /><span style="color:#0088ff;font-weight:400"># Using the CGI class, we can parse the query string to obtain an hash of the GET parameters (‘name’=&gt;’value’).</span><br /><span style="color:#7f0044;font-weight:400">Query</span> = <span style="color:#7f0044;font-weight:400">CGI</span>.parse(<span style="color:#7f0044;font-weight:400">Target</span>.query)<br /><br /><span style="color:#0088ff;font-weight:400">#The zip instruction combined with the each method, iterates over the XSS_VECTORS and the Testing_Values.</span><br /><span style="color:#0088ff;font-weight:400">#  In each iteration, the elements at the same position of the two array are selected: vect and test.</span><br /><span style="color:#0088ff;font-weight:400">#  We do this because we may want to test different injection payloads and for each of them, </span><br /><span style="color:#0088ff;font-weight:400">#    we may have a specific value to test.</span><br /><span style="color:#0088ff;font-weight:400">#    In this sceario we only a pair to test inside the arrys XSS_VECTORS &amp; Testing_Values</span><br /><span style="color:#7f0044;font-weight:400">XSS_VECTORS</span>.zip(<span style="color:#7f0044;font-weight:400">Testing_Values</span>).each <span style="color:#ff9d00;font-weight:700">do</span> |vect,test|<br /><br />	<span style="color:#7f0044;font-weight:400">Query</span>[<span style="color:#7f0044;font-weight:400">Parameter</span>] = vect<br />	<span style="color:#7f0044;font-weight:400">Target</span>.query = <span style="color:#7f0044;font-weight:400">URI</span>.encode_www_form(<span style="color:#7f0044;font-weight:400">Query</span>)<br />	<span style="color:#0088ff;font-weight:400">#doc encapsulates the response and we can use Nokogiri to navigate it</span><br />	doc = <span style="color:#7f0044;font-weight:400">Nokogiri::HTML</span>(<span style="color:#7f0044;font-weight:400">URI</span>.open(<span style="color:#7f0044;font-weight:400">Target</span>))<br />	<span style="color:#0088ff;font-weight:400">#--&gt; With XPath, we can search(...) through all of the text nodes in order to find the one that contains the string ‘alert(12345)’.</span><br />	<span style="color:#0088ff;font-weight:400">#--&gt; //text() is used to select all of the text nodes of the entire html document (without element nodes).</span><br />	<span style="color:#0088ff;font-weight:400">#--&gt; [] brackets are used to test if the extracted nodes satisfies a particular condition.</span><br />	<span style="color:#0088ff;font-weight:400">#--&gt; contains(arg1,arg2) is a XPath function that checks if a particular string (first argument) </span><br />	<span style="color:#0088ff;font-weight:400">#    contains another string (second argument). </span><br />	<span style="color:#0088ff;font-weight:400">#    Therefore, in the example for each text node (specified with the point . ), </span><br />	<span style="color:#0088ff;font-weight:400">#    it tests if it contains the second argument (our ‘alert(12345)’ string ).</span><br />	doc.search(<span style="color:#3ad900;font-weight:400">&quot;//text()[contains(.,&#39;#{test}&#39;)]&quot;</span>).each <span style="color:#ff9d00;font-weight:700">do</span>	|el|<br />		<span style="color:#ff9d00;font-weight:700">if</span> el.parent.name == <span style="color:#3ad900;font-weight:400">&#39;script&#39;</span><span style="color:#ff9d00;font-weight:700">then</span><br />			puts <span style="color:#3ad900;font-weight:400">&quot;----- Probable XSS found -------&quot;</span><br />			puts <span style="color:#3ad900;font-weight:400">&quot;Injection Vector: #{vect}&quot;</span>,<span style="color:#3ad900;font-weight:400">&quot;\n&quot;</span><br />			puts <span style="color:#3ad900;font-weight:400">&quot;FOUND IN THE FOLLOWING CODE&quot;</span><br />			puts el.parent.parent.to_html	<br />			puts <span style="color:#3ad900;font-weight:400">&quot;--------------------------------&quot;</span>,<span style="color:#3ad900;font-weight:400">&quot;\n&quot;</span><br />		<span style="color:#ff9d00;font-weight:700">end</span><br />	<span style="color:#ff9d00;font-weight:700">end</span> <br /><br /><span style="color:#ff9d00;font-weight:700">end</span></pre></div><br />	<a href=""><img src="images/2001-1.png" alt="images/2001-1.png" /></a><br />	<br /><br /></div>
</body>
</html>
