<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Forge UDP packet</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Forge UDP packet</h1><br/><strong><h3>UDPPacket class</h3></strong> (<a href="https://github.com/todb/packetfu/blob/master/lib/packetfu/protos/udp.rb">https://github.com/todb/packetfu/blob/master/lib/packetfu/protos/udp.rb</a>)<br /><br /><div class="codebox"><pre><span style="color:#7f0044;font-weight:400">require</span> <span style="color:#3ad900;font-weight:400">&quot;packetfu&quot;</span><br /><span style="color:#7f0044;font-weight:400">include</span> <span style="color:#7f0044;font-weight:400">PacketFu</span></pre></div><br /><a href=""><img src="images/1964-1.png" alt="images/1964-1.png" /></a><br /><br /><div class="codebox"><pre>u= <span style="color:#7f0044;font-weight:400">UDPPacket</span>.new</pre></div><br />	<a href=""><img src="images/1964-2.png" alt="images/1964-2.png" /></a><br /><br />Check the documentation to know how to set these values:<br />• ETHHeader: <a href="https://www.rubydoc.info/github/todb/packetfu/PacketFu/EthHeader">https://www.rubydoc.info/github/todb/packetfu/PacketFu/EthHeader</a><br />• IPHeader: <a href="https://www.rubydoc.info/github/todb/packetfu/PacketFu/IPHeader">https://www.rubydoc.info/github/todb/packetfu/PacketFu/IPHeader</a><br />• UDPHeader: <a href="https://www.rubydoc.info/github/todb/packetfu/PacketFu/UDPHeader">https://www.rubydoc.info/github/todb/packetfu/PacketFu/UDPHeader</a><br /><br /><strong>How send an UDP packet</strong><br />To send an UDP packet you need to set the following fields:<br />   ◇ eth_saddr → source MAC address<br />      ▪ Check Utils.whoami?[:eth_saddr]<br />      	<a href=""><img src="images/1964-3.png" alt="images/1964-3.png" /></a><br />   ◇ eth_daddr → destination MAC address <br />      ▪ destination outside our local network → MAC address of the default gateway<br />         - Check Utils.whoami?[:eth_daddr]<br />            <a href=""><img src="images/1964-4.png" alt="images/1964-4.png" /></a><br />      ▪ destination inside of the local network → MAC address of the destination<br />         - Utils.arp(&quot;[IP_Address_destination]&quot;)<br />   ◇ ip_daddr → destination address<br />   ◇ ip_saddr → source address<br />   ◇ udp_src → source UDP port<br />   ◇ udp_dst → destination UDP port<br />   <br /><div class="codebox"><pre>u= <span style="color:#7f0044;font-weight:400">UDPPacket</span>.new<br />u.eth_saddr=<span style="color:#3ad900;font-weight:400">&quot;00:0c:29:90:45:a8&quot;</span>  <span style="color:#0088ff;font-weight:400">#source MAC address</span><br />u.eth_daddr=<span style="color:#3ad900;font-weight:400">&quot;00:50:56:f3:2d:fd&quot;</span>  <span style="color:#0088ff;font-weight:400">#destination MAC address</span><br />u.ip_saddr=<span style="color:#3ad900;font-weight:400">&quot;192.168.3.136&quot;</span>       <span style="color:#0088ff;font-weight:400">#ip source address</span><br />u.ip_daddr= <span style="color:#3ad900;font-weight:400">&quot;132.163.96.3&quot;</span>       <span style="color:#0088ff;font-weight:400">#ip destination address</span><br />u.udp_src=<span style="color:#ff0044;font-weight:400">5000</span>                   <span style="color:#0088ff;font-weight:400">#source UDP port</span><br />u.udp_dst=<span style="color:#ff0044;font-weight:400">37</span>                     <span style="color:#0088ff;font-weight:400">#destination UDP port</span><br />u.recalc                         <span style="color:#0088ff;font-weight:400">#use first always recalc, in order to calculate the</span><br />                                 <span style="color:#0088ff;font-weight:400"># checksum of the modified packet</span><br />u.to_w                           <span style="color:#0088ff;font-weight:400">#To send the packet</span><br /></pre></div><br /><a href=""><img src="images/1964-5.png" alt="images/1964-5.png" /></a><br /><strong>Why our machine sent back a ICMP packet?</strong><br />We sent the packet directly to the network without going through the kernel TCP/IP stack.  <br />Because we are using raw sockets, in our kernel, <span style="text-decoration:underline;">we do not have a real socket (bound to UDP source port) that is waiting for an UDP time response</span><br /><span style="text-decoration:underline;">Solution:</span> to avoid the ICMP kernel response, we need to create an UDP socket which binds itself to our source port.<br /><br /><div class="codebox"><pre>s=<span style="color:#7f0044;font-weight:400">UDPSocket</span>.new<br />s.bind(<span style="color:#3ad900;font-weight:400">&quot;192.168.3.136&quot;</span>,<span style="color:#3ad900;font-weight:400">&quot;5000&quot;</span>)<br />u.to_w<br /></pre></div><br />	<a href=""><img src="images/1964-6.png" alt="images/1964-6.png" /></a><br />	<a href=""><img src="images/1964-7.png" alt="images/1964-7.png" /></a><br /><br /><br /><strong>Fast Way: The parameters below can be set automatically (no spoofing)</strong><br /><span style="color:#ff0000;">WARNING if the destination is in the local network:</span> this method will set the <span style="text-decoration:underline;">destination MAC address(eth_daddr/eth_dst)</span> at the default gateway, but if the target is inside the local network, we need to set directly the MAC address of the target and not of the default gateway.<br />• eth_saddr → source MAC address<br />• eth_daddr → destination MAC address<br />• ip_saddr → ip source address<br />with this command:<br /><div class="codebox"><pre>u=<span style="color:#7f0044;font-weight:400">UDPPacket</span>.new(<span style="color:#ff0044;font-weight:400">:config</span> =&gt; <span style="color:#7f0044;font-weight:400">Utils</span>.whoami?)</pre></div><br /><a href=""><img src="images/1964-8.png" alt="images/1964-8.png" /></a></div>
</body>
</html>
