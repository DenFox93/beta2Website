<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Configure Server</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Configure Server</h1><br/><strong><h3>Configure the Server (Raspberry Pi)</h3></strong><br /><br />To check if the Telesploit Relay works and is online we have to ping the subdomain that we have associated with the Ip address of the AWS instance(see <a href="https://www.godaddy.com/help/create-a-subdomain-4080">here</a>) <div class="codebox"><pre>daniele@TelesploitServer<span style="color:#ff9d00;font-weight:700">:/</span>$ <span style="color:#ff9d00;font-weight:700">ping</span> &lt;relaySubdomain&gt;</pre></div><br /><br />1. There is been a change in the new Kali Linux 2020. Now we have to create the root user<br />   ◇ In the old version we run as root at boot<br />   ◇ In the new version 2020 we need to create an unprivileged user because root is lock. <br />      ▪ So we can upgrade the local local user to a super user that will do not ask for password when we use privilege commands<br />        <div class="codebox"><pre>daniele@TelesploitServer<span style="color:#ff9d00;font-weight:700">:/</span>$ <span style="color:#ff9d00;font-weight:700">sudo</span> <span style="color:#ff9d00;font-weight:700">passwd</span> root   <span style="color:#0088ff;font-weight:400">#set a password for the root user, the root user is now activated</span></pre></div><br /><br />2. Fully update of Kali Linux<br />    <div class="codebox"><pre>root@TelesploitServer<span style="color:#ff9d00;font-weight:700">:/</span>$ apt-get update -y<br />root@TelesploitServer<span style="color:#ff9d00;font-weight:700">:/</span>$ apt-get upgrade -y</pre></div><br /><br />3. Install Telesploit server<br />   <div class="codebox"><pre>daniele@TelesploitServer<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">sudo</span> -i          <span style="color:#0088ff;font-weight:400">#we have to run relay_setup.sh as root</span><br />root@TelesploitServer<span style="color:#ff9d00;font-weight:700">:</span>~# <span style="color:#ff9d00;font-weight:700">cd</span> <span style="color:#ff9d00;font-weight:700">/</span>root <br />root@TelesploitServer<span style="color:#ff9d00;font-weight:700">:</span>~# git clone https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>telesploit<span style="color:#ff9d00;font-weight:700">/</span>telesploit-server.git</pre></div><br />5. Update the relay_fqdn, tester_pub_key, usb_drive, and network_interface_name variables in telesploit-server/server.cfg<br />    <div class="codebox"><pre>root@TelesploitServer<span style="color:#ff9d00;font-weight:700">:</span>~# <span style="color:#ff9d00;font-weight:700">ls</span><br />root@TelesploitServer<span style="color:#ff9d00;font-weight:700">:</span>~# <span style="color:#ff9d00;font-weight:700">cd</span> telesploit-server<br />root@TelesploitServer<span style="color:#ff9d00;font-weight:700">:</span>~# <span style="color:#ff9d00;font-weight:700">ls</span><br />root@TelesploitServer<span style="color:#ff9d00;font-weight:700">:</span>~# nano server.cfg</pre></div><br />   1) Change <code>relay_fqdn=&#39;relay.example.com&#39;</code> To <code>relay_fqdn=&#39;&lt;relaySubdomain&gt;&#39;</code>  →  &lt;relaySubdomain&gt; is the subdomain that we associate to the ip address of the instance of AWS (<a href="https://www.godaddy.com/help/create-a-subdomain-4080">here</a> to see how we have done)<br />   2) Change <code>tester_pub_key=&#39;ssh-rsa AAAA mykey@example&#39;</code> To <code>tester_pub_key=&#39;&lt;penTesterPublicKey&gt;&#39;</code> → &lt;penTesterPublicKey&gt; is the public key of the penetration tester. We have to use OpenSSH authorized_keys file format(RSA key pair) for it because will be added to /.ssh/authorized_keys that support this format for multiple keys.<br />    In this way we can access to the Server via ssh also with the private key pair of &lt;penTesterPublicKey&gt;   <br />    <span style="color:#a5452a;">example:</span><br />    OpenSSH authorized_keys file format: ssh-rsa AAAA[...lots of characters...] <span style="color:#00ff00;">JohnDoe</span><br />    <a href=""><img src="images/1001-1.png" alt="images/1001-1.png" /></a><br />    <span style="color:#a5452a;">example 2:</span><br />    To generate a RSA Key pair<br />        <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">ssh-keygen</span> -t rsa</pre></div><br />        <a href="file://G:/Other computers/Yoga 520/CherryTree/screenshots2/Telesploit/RSA-key.png"><img src="images/1001-2.png" alt="images/1001-2.png" /></a><br />   3) Change <code>usb_drive=&#39;/dev/sdb1&#39;</code> To <code>usb_drive=&#39;&lt;mount-position&gt;&#39;</code> → usb drive where the logs and configs are saved, In the next point we will set up it<br />   4) Change <code>network_interface_name=&#39;eth0&#39;</code> To <code>network_interface_name=&#39;&lt;interface&gt;&#39;</code> → usually is correct<br />   5) Change <code>gpg_key=&#39;PlzChangeMe-NoSingleQuotes!&#39;</code> To <code>gpg_key=&#39;&lt;your-choice&gt;&#39;</code> → it is recommended to change this, the network and connection configs will be encrypted with this gpg_key and copied to the USB drive. To decrypt we will use the same gpg_key<br />       <br /><br />7. Insert a USB flash drive (SanDisk Ultra Fit or other small form factor USBs recommended as this must stay connected to the system)<br />8. Format for example with gparted the USB drive to FAT32 and label it as TELESPLOIT (default)<br />9. Mount the USB flash drive, the position of the USB is by default:  /media/root/TELESPLOIT<br />   ◇ by GUI: Simply right click on the TELESPLOIT drive icon on the desktop and select mount<br />   ◇ by command line: <br />      <div class="codebox"><pre>root@TelesploitServer<span style="color:#ff9d00;font-weight:700">:</span>~# wipefs -a -f <span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>sdb<br />root@TelesploitServer<span style="color:#ff9d00;font-weight:700">:</span>~# parted -s -a optimal <span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>sdb mklabel msdos mkpart primary fat32 0% 100%<br />root@TelesploitServer<span style="color:#ff9d00;font-weight:700">:</span>~# mkfs.vfat -n TELESPLOIT <span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>sdb1<br />root@TelesploitServer<span style="color:#ff9d00;font-weight:700">:</span>~# <span style="color:#ff9d00;font-weight:700">mkdir</span> -p <span style="color:#ff9d00;font-weight:700">/</span>media<span style="color:#ff9d00;font-weight:700">/</span>root<span style="color:#ff9d00;font-weight:700">/</span>TELESPLOIT<br />root@TelesploitServer<span style="color:#ff9d00;font-weight:700">:</span>~# <span style="color:#ff9d00;font-weight:700">mount</span> <span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>sdb1 <span style="color:#ff9d00;font-weight:700">/</span>media<span style="color:#ff9d00;font-weight:700">/</span>root<span style="color:#ff9d00;font-weight:700">/</span>TELESPLOIT</pre></div><br /><br />10. Run server script<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">/</span>root<span style="color:#ff9d00;font-weight:700">/</span>telesploit-server<span style="color:#ff9d00;font-weight:700">/</span>server_setup.sh</pre></div><br />    The script will ask the following questions:<br />   1) If any of these requirements have not been met then press Ctrl+C to exit, otherwise hit any key to continue...<br />   2) If the relay does not resolve then exit now and check the network connection and DNS entry for the relay. Press any key to continue or Ctrl+C to exit...<br />   3) Configure the Telesploit server for DHCP or STATIC? [D/S] → answer: DHCP in this case is ok<br />   4) What type of connection should the Telesploit server use?<br />      1- [D]irect TLS - No proxy is required. Certificate checking is enabled. SSH host-based verification is enabled.<br />      2- [U]nsafe TLS - No proxy is required. Certificate checking is disabled. SSH host-based verification is enabled.<br />      3- [P]lain - Simple proxy. No password required. Certificate checking is disabled. SSH host-based verification is enabled.<br />      4- [B]asic - Proxy uses BASIC authentication. Certificate checking is disabled. SSH host-based verification is enabled.<br />      5- [N]TLM - Proxy uses NTLM authentication. Certificate checking is disabled. SSH host-based verification is enabled.<br />     Choose the Telesploit server connection type [D/U/P/B/N]: → answer: Here we have to decide how to connect the server to the relay. <br />      ▪ <span style="text-decoration:underline;">The recommended configuration is Direct TLS </span>, with that we not have a proxy from which we have to get out, but we have both security check(Certificate check and SSH verification).<br />      ▪ If they are breaking connection and and we get SSL errors we can do the <span style="text-decoration:underline;">Unsafe TLS</span>, the Certificate check is disabled but there is still SSH verification so we do not have to worry about about a man in the middle attack<br />      ▪ <span style="text-decoration:underline;">Basic</span> and <span style="text-decoration:underline;">NTLM</span> if we need a proxy to get out from the network<br />     6- identical files indicate a secure connection. non-matching files may indicate an active man-in-the-middle attack, review the files /root/.ssh/trusted and /root/.ssh/tested before continuing<br />        *CODE server_setup.sh: These are the operations that the server_setup.sh has done:<br />             <a href=""><img src="images/1001-3.png" alt="images/1001-3.png" /></a><br />             *<span style="color:#ff0000;">ATTENTION:</span> in the test done, during the configuration, in this script server_setup.sh the files did not match while during <a href="ork_Pentest--Attacker_Testing_Infrastructure--Penetration_Testing_via_SSH(or_VPN)--Telesploit--3._Telesploit_Client--3.1_Configure_Client.html">Configure Client in setup_client.sh (point 2.4) yes</a>... Is this could be caused by the fact that to retrieve the fingerprint from the webpage is been used curl instead of wget?<br />         *CODE relay_setup.sh: This is been the creation of the SSH trusted fingerprint on the relay, using the script relay_setup.sh<br />            <a href=""><img src="images/1001-4.png" alt="images/1001-4.png" /></a><br />         if /root/.ssh/trusted and /root/.ssh/tested do not match, could be a problem of the configuration or a MITM attack. <br />         This is also the reason of why we have associated the Ip address of the AWS instance with the a subdomain of our domain, so we can do this check!<br />         From <a href="https://docs.oracle.com/cd/E88353_01/html/E37839/ssh-keyscan-1.html">Oracle documentation</a>:<br />                <a href=""><img src="images/1001-5.png" alt="images/1001-5.png" /></a><br /><br /><br /><br /><br />        </div>
</body>
</html>
