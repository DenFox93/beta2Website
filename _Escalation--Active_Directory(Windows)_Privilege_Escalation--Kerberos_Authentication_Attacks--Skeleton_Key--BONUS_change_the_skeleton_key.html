<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>BONUS: change the skeleton key</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>BONUS: change the skeleton key</h1><br/>The <span style="text-decoration:underline;">Skeleton key</span>(Master Key) by default is “mimikatz” that converted to NT hash is “60BA4FCADC466C7A033C178194C03DF6”. This password will work for any account in the domain. <br />The skeleton key is defined two times first in the function “kuhl_misc_skeleton_rc4_init” and then in “kuhl_misc_skeleton_rc4_init_decryp”:<br />• New versions of mimikatz(from <a href="https://github.com/gentilkiwi/mimikatz/commit/c1c1608ca8712a58035319e848bb666676970383#diff-cf4373b6c7195386ac1973681e5561bd96e1bb9e099cfd3febd1111e986bd17c">29/02/2016</a>) →  in the source code file <a href="https://github.com/gentilkiwi/mimikatz/blob/master/mimikatz/modules/kuhl_m_misc.c#L607">kuhl_m_misc.c</a>(lines:607,634) Master Key as the parameter:<br />    DWORD kiwiKey[] = {0xca4fba60, 0x7a6c46dc, 0x81173c03, 0xf63dc094};”<br />• Old versions of mimikatz → in the source code file <a href="https://github.com/gentilkiwi/mimikatz/blob/2d9e15bb8320df727d36564bc16df50ea9e557e4/mimikatz/modules/kuhl_m_misc.c#L672">kuhl_m_misc.c</a>(lines:672,700)  Master Key as the parameter:<br />    BYTE kiwiKey[] = {0x60, 0xba, 0x4f, 0xca, 0xdc, 0x46, 0x6c, 0x7a, 0x03, 0x3c, 0x17, 0x81, 0x94, 0xc0, 0x3d, 0xf6};<br /><br />If we went change the default skeleton key “mimikatz” in the New versions of mimikatz, we can do that by following these steps:<br /><br /><div class="codebox"><pre>from sys import argv<br /><br />password<span style="color:#ff9d00;font-weight:700">=</span>argv[<span style="color:#333333;font-weight:400">1</span>]<br />print(<span style="color:#3ad900;font-weight:400">&quot;The password inserted is --&gt; &quot;</span> <span style="color:#ff9d00;font-weight:700">+</span> str(password))<br />import hashlib,binascii<br />hash <span style="color:#ff9d00;font-weight:700">=</span> hashlib.new(<span style="color:#333333;font-weight:400">&#39;md4&#39;</span>, password.encode(<span style="color:#333333;font-weight:400">&#39;utf-16le&#39;</span>)).digest()<br />nt<span style="color:#ff9d00;font-weight:700">=</span> binascii.hexlify(hash)<br />print(<span style="color:#3ad900;font-weight:400">&quot;The NTLM calculated is --&gt; &quot;</span> <span style="color:#ff9d00;font-weight:700">+</span> str(nt))<br /><br />kiwikey<span style="color:#ff9d00;font-weight:700">=</span>[]<br />splits<span style="color:#ff9d00;font-weight:700">=</span>[nt[i<span style="color:#ff9d00;font-weight:700">:</span>i<span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">8</span>] <span style="color:#ff9d00;font-weight:700">for</span> i <span style="color:#ff9d00;font-weight:700">in</span> range(<span style="color:#333333;font-weight:400">0</span>, len(nt), <span style="color:#333333;font-weight:400">8</span>)]<br /><span style="color:#ff9d00;font-weight:700">for</span> j <span style="color:#ff9d00;font-weight:700">in</span> splits<span style="color:#ff9d00;font-weight:700">:</span> <br />	reverse<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#3ad900;font-weight:400">&quot;&quot;</span>.join(reversed([j[i<span style="color:#ff9d00;font-weight:700">:</span>i<span style="color:#ff9d00;font-weight:700">+</span><span style="color:#333333;font-weight:400">2</span>] <span style="color:#ff9d00;font-weight:700">for</span> i <span style="color:#ff9d00;font-weight:700">in</span> range(<span style="color:#333333;font-weight:400">0</span>, len(j), <span style="color:#333333;font-weight:400">2</span>)]));<br />	kiwikey.append(<span style="color:#3ad900;font-weight:400">&quot;0x&quot;</span><span style="color:#ff9d00;font-weight:700">+</span>reverse)<br /><br />kiwikey2<span style="color:#ff9d00;font-weight:700">=</span>str(kiwikey)<br />kiwikey<span style="color:#ff9d00;font-weight:700">=</span>kiwikey2.replace(<span style="color:#3ad900;font-weight:400">&quot;&#39;&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;&quot;</span>)<br />kiwikey2<span style="color:#ff9d00;font-weight:700">=</span>kiwikey.replace(<span style="color:#3ad900;font-weight:400">&quot;[&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;{&quot;</span>)<br />kiwikey<span style="color:#ff9d00;font-weight:700">=</span> kiwikey2.replace(<span style="color:#3ad900;font-weight:400">&quot;]&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;}&quot;</span>)<br />print(<span style="color:#3ad900;font-weight:400">&quot;The kiwikey calculated is --&gt; &quot;</span> <span style="color:#ff9d00;font-weight:700">+</span> str(kiwikey))</pre></div><br /><br />We can run it also by directly use wget:<br />    <div class="codebox"><pre>wget <span style="color:#ff9d00;font-weight:700">-</span>qO <span style="color:#ff9d00;font-weight:700">-</span> https<span style="color:#ff9d00;font-weight:700">://</span>raw.githubusercontent.com<span style="color:#ff9d00;font-weight:700">/</span>DenFox93<span style="color:#ff9d00;font-weight:700">/</span>passwordToSkeletonKey<span style="color:#ff9d00;font-weight:700">/</span>main<span style="color:#ff9d00;font-weight:700">/</span>converter.py | python <span style="color:#ff9d00;font-weight:700">-</span> &lt;PASSWORD&gt;</pre></div><br />    wget<br />      ▪ -O &lt;file&gt;, --output-document=&lt;file&gt; → the document of the url will be saved with the filename specified.  If - is used as file, documents will be printed to standard output<br />      ▪ -q, --quiet → Turn off Wget&#39;s output<br />    python<br />      ▪ - → read from standard input and not from file<br />          <a href=""><img src="images/1219-1.png" alt="images/1219-1.png" /></a><br />          <a href=""><img src="images/1219-2.png" alt="images/1219-2.png" /></a></div>
</body>
</html>
