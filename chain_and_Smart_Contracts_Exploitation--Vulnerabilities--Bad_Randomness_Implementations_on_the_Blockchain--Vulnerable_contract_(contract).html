<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Vulnerable contract (contract)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Vulnerable contract (contract)</h1><br/><br /><br /><div class="codebox"><pre>pragma solidity ^0.6.6;<br /><br />contract vulnerableBlockHashGame {<br />    <br />    uint balance = <span style="color:#ff0044;font-weight:400">2</span> ether;<br />    mapping (address =&gt; uint) blockNumber;     <span style="color:#0088ff;font-weight:400">//&lt;---</span><br />    <span style="color:#7f0044;font-weight:400">bool</span> public win; <br />    <br />    constructor() public payable{<br />        require(msg.value &gt;= <span style="color:#ff0044;font-weight:400">10</span> ether);<br />    }<br />    <br />    function get_block_number() internal  {   <br />        blockNumber[msg.sender] = uint(block.number);   <span style="color:#0088ff;font-weight:400">//&lt;---</span><br />    }<br />    <br />    function playGame() public payable {<br />        require (msg.value &gt;= <span style="color:#ff0044;font-weight:400">1</span> ether);<br />        get_block_number();<br />    }<br />     <br />     <br />    function checkWinner() public payable { <br />        <span style="color:#ff9d00;font-weight:700">if</span> (uint(blockhash(blockNumber[msg.sender])) % <span style="color:#ff0044;font-weight:400">2</span> == <span style="color:#ff0044;font-weight:400">0</span>) {    <span style="color:#0088ff;font-weight:400">//&lt;---</span><br />            win = <span style="color:#ff0044;font-weight:400">true</span>; <br />            msg.sender.transfer(balance);<br />        }<br />        <span style="color:#ff9d00;font-weight:700">else</span>{<br />            win = <span style="color:#ff0044;font-weight:400">false</span>;<br />        }<br />    }<br />    <br />    function wasteTime() public{<br />        uint test = uint(block.number);<br /><br />     }<br /><br />}</pre></div><br />    <a href=""><img src="images/1437-1.png" alt="images/1437-1.png" /></a><br />1. <strong><span style="color:#ff0000;">playgame()</span></strong><br />    <a href=""><img src="images/1437-2.png" alt="images/1437-2.png" /></a><br />2. <strong><span style="color:#ff0000;">checkWinner()</span></strong> and <strong><span style="color:#1e90ff;">win</span></strong><br />    To check if we have won<br />    <a href=""><img src="images/1437-3.png" alt="images/1437-3.png" /></a><br />    <a href=""><img src="images/1437-4.png" alt="images/1437-4.png" /></a><br /><br />3. Wait for 256 blocks(transactions) to pass after the execution of <strong><span style="color:#ff0000;">playgame()</span></strong>. We can simulate it with the function <strong><span style="color:#ff8700;">wasteTime()</span></strong><br />    Use the function wasteTime() for <span style="text-decoration:underline;">257+3=260 or more time(259th block.number still in memory) to take the value of the blockNumber to zero</span> before checking if he has won the game. By doing this the attacker would guarantee a win. <br />    <a href=""><img src="images/1437-5.png" alt="images/1437-5.png" /></a><br />    <a href=""><img src="images/1437-6.png" alt="images/1437-6.png" /></a><br />4. We can repeat the <strong><span style="color:#ff0000;">playgame()</span></strong> function until we have withdraw all the funds from the contract<br />    <a href=""><img src="images/1437-7.png" alt="images/1437-7.png" /></a><br />    <a href=""><img src="images/1437-8.png" alt="images/1437-8.png" /></a><br />    This error message <span style="text-decoration:underline;">in this case</span> mean that in the contract there are no more funds</div>
</body>
</html>
