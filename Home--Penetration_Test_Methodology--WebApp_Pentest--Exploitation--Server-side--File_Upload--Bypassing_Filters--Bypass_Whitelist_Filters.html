<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Bypass Whitelist Filters</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Bypass Whitelist Filters</h1><br/><br /><br />A whitelist is generally more secure than a blacklist<br /><br /><strong>When use Blacklist or Whitelist</strong><br />• Blacklist may be helpful in cases where the upload functionality needs to allow a wide variety of file types (e.g., File Manager)<br />• Whitelist is usually only used with upload functionalities where only a few file types are allowed. <br />Both may also be used in tandem<br /><br /><br /><br /><br /><br />• <strong><h3>Bypass with Double Extension</h3></strong> (shell.jpg.php)<br />	This Bypass work if the code only tests whether the file name contains an image extension --&gt; a straightforward method of passing the regex test is through Double Extensions. For example, if the .jpg extension was allowed, we can add it in our uploaded file name and still end our filename with .php (e.g. shell.jpg.php), in which case we should be able to pass the whitelist test, while still uploading a PHP script that can execute PHP code.<br /><br />	Check example of source codes in the subchapter: <a href="Test_Methodology--WebApp_Pentest--Exploitation--Server-side--File_Upload--Bypassing_Filters--Bypass_Whitelist_Filters--source_code_review.html">Source Code review</a><br /><br />	<strong>Fuzzing</strong><br />	Add <span style="text-decoration:underline;">after</span> an <span style="color:#ff7800;">extension allowed</span> the <span style="color:#9141ac;">extensions that we want to fuzz</span><br />	For example to test.<span style="color:#ff7800;">jpg</span>.<span style="color:#9141ac;">EXT</span> we will change <code><span style="color:#813d9c;">EXT</span></code> with a wordlist like this:<br />	   ◇ <a href="https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/web-extensions.txt">https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/web-extensions.txt</a><br /><br /><br />• <strong><h3>Bypass with Reverse Double Extension</h3></strong> (shell.php.jpg)<br />	This bypass exploit a web server misconfiguration. <br />	Even if the file upload functionality uses a strict regex pattern that only matches the final extension in the file name, <br />	The organization may use the insecure configurations for the web server that allow the execution of files when they contain a pattern(like strings php,phar,..)<br />	<br />	<strong>Fuzzing</strong><br />	Add <span style="text-decoration:underline;">before</span> an <span style="color:#ff7800;">extension allowed</span> the <span style="color:#9141ac;">extensions that we want to fuzz</span><br />	For example to test.<span style="color:#9141ac;">EXT</span>.<span style="color:#ff7800;">jpg</span> we will change <code><span style="color:#813d9c;">EXT</span></code> with a wordlist like this:<br />	   ◇ <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Extension%20PHP/extensions.lst">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Extension%20PHP/extensions.lst</a><br /><br /><br /><h3>• </h3><strong><h3>Bypass with Character Injection</h3></strong> (%20, %0a, %00, %0d0a, /, .\, ., … inside the name)<br />	It is possible inject several characters <span style="text-decoration:underline;">before or after</span> <span style="text-decoration:underline;">the final extension</span> to cause the web application to misinterpret the filename and execute the uploaded file as a PHP script.<br />	<div class="codebox"><pre>%20<br />%0a<br />%00<br />%0d0a<br />/<br />.\<br />.<br />…<br />:</pre></div><br />   ◇ %00 →  works with PHP servers with version 5.X or earlier, %00 causes the PHP web server to end the file name after the (%00)<br />      ▪ <span style="color:#865e3c;">example:</span> <span style="color:#2ec27e;">TEST.php</span><span style="color:#e01b24;">%00</span>.jpg will be stored as <span style="color:#2ec27e;">TEST.php</span>, while still passing the whitelist.  <br />   ◇ : → works with Windows server, injecting a colon (:)  causes the PHP web server to end the file name after the (:)<br />      ▪ <span style="color:#865e3c;">example:</span> <span style="color:#2ec27e;">TEST.aspx</span><span style="color:#e01b24;">:</span>.jpg will be stored as <span style="color:#2ec27e;">TEST.aspx</span> while still passing the whitelist. <br /><br />	<span style="text-decoration:underline;">Bash script to create test payloads</span><br />	<div class="codebox"><pre>for char in &#39;%20&#39; &#39;%0a&#39; &#39;%00&#39; &#39;%0d0a&#39; &#39;/&#39; &#39;.\\&#39; &#39;.&#39; &#39;…&#39; &#39;:&#39;; do<br />    for ext in &#39;.php&#39; &#39;.phps&#39; &#39;.pcap&#39; &#39;.php&#39; &#39;.php2&#39; &#39;.php3&#39; &#39;.php4&#39; &#39;.php5&#39; &#39;.php6&#39; &#39;.php7&#39; &#39;.phps&#39; &#39;.pht&#39; &#39;.phtml&#39;; do<br />        echo &quot;TEST$char$ext.jpg&quot; &gt;&gt; wordlist.txt<br />        echo &quot;TEST$ext$char.jpg&quot; &gt;&gt; wordlist.txt<br />        echo &quot;TEST.jpg$char$ext&quot; &gt;&gt; wordlist.txt<br />        echo &quot;TEST.jpg$ext$char&quot; &gt;&gt; wordlist.txt<br />    done<br />done</pre></div><br />	Edit it accordngly with the technologies running on the Web Application, for more extension see the chapter <a href="Home--Penetration_Test_Methodology--WebApp_Pentest--Exploitation--Server-side--File_Upload--Bypassing_Filters--Bypass_Blacklist_Filters.html">Bypass Blaclist Filters</a> <br />	<br />	<br />	<br /><br /><br /><table class="table"><tr><th>Whitelist Bypass</th><th> </th></tr><tr><td>shell.jpg.php</td><td>Double Extension</td></tr><tr><td>shell.php.jpg</td><td>Reverse Double Extension</td></tr><tr><td>%20, %0a, %00, %0d0a, /, .\, ., …</td><td>Character Injection - Before/After Extension</td></tr></table><br /></div>
</body>
</html>
