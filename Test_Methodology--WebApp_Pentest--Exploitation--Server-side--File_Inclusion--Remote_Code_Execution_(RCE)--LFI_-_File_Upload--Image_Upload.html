<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Image Upload</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Image Upload</h1><br/><br /><strong><h2>Image upload</h2></strong><br />For the attack in this section, we do <span style="text-decoration:underline;">NOT require the file upload form</span>(functions that file to blacklist/whitelist adeguately) to be vulnerable, but <span style="text-decoration:underline;">merely allow us to upload files</span>. We do not need for example that the file contain in the name “.php” to be executed because once uploaded is the vulnerable function that allow to execute files:<br /><br />1. Craft a malicious image containing a PHP web shell code that still looks and works as an image. <br />   just in case the upload form checks for both the extension and content type:<br />   1) use an <span style="text-decoration:underline;">allowed image extension</span> in the file name (e.g. shell.gif),<br />   2) include the <span style="text-decoration:underline;">image magic bytes</span> at the beginning of the file content (e.g. GIF8). <br />   	For more Magic Bytes check the chapter <a href="Home--Penetration_Test_Methodology--WebApp_Pentest--Exploitation--Server-side--File_Upload--Bypassing_Filters--Bypass_Type_Filters.html">File Upload → Bypassing Filters → Bypass Type</a> Filters <br />   <span style="color:#865e3c;">example:</span><br />  <div class="codebox"><pre>$ <span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#3ad900;font-weight:400">&#39;GIF8&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;&#39;</span> &gt; shell.gif</pre></div><code><br /></code><br />2. Upload the malicious file <br />3. Include the file through the LFI vulnerability.<br />   ◇ To include the uploaded file, we need to know the path to our uploaded file.<br />   ◇ especially with images, we would get access to our uploaded file and can get its path from its URL. In our case, if we inspect the source code after uploading the image, we can get its URL<br />   <span style="color:#865e3c;">example: HTML code</span><br />	By viewing the source code we will see only the last extension<br />		<a href=""><img src="images/2364-1.png" alt="images/2364-1.png" /></a><br />	By Inspecting the image uploaded (here sometimes we can find the imedded file)<br />		<a href=""><img src="images/2364-2.png" alt="images/2364-2.png" /></a><br /> ◇ If we do not know where the file is uploaded, then we can fuzz for an uploads directory, and then fuzz for our uploaded file, though this may not always work as some web applications properly hide the uploaded files<br />		<br />4. include the uploaded file in the LFI vulnerable function, and the PHP code should get executed<br />	<span style="color:#865e3c;">example:</span><br />	vulnerable LFI function called from the language parameter<br />	<div class="codebox"><pre>http<span style="color:#ff9d00;font-weight:700">://</span>&lt;SERVER_IP&gt;<span style="color:#ff9d00;font-weight:700">:</span>&lt;PORT&gt;<span style="color:#ff9d00;font-weight:700">/</span>index.php?language=.<span style="color:#ff9d00;font-weight:700">/</span>profile_images<span style="color:#ff9d00;font-weight:700">/</span>shell.gif<span style="color:#ff9d00;font-weight:700">&amp;</span>cmd=<span style="color:#ff9d00;font-weight:700">id</span></pre></div><br />	<div class="codebox"><pre>http<span style="color:#ff9d00;font-weight:700">://</span>&lt;SERVER_IP&gt;<span style="color:#ff9d00;font-weight:700">:</span>&lt;PORT&gt;<span style="color:#ff9d00;font-weight:700">/</span>index.php?language=profile_images<span style="color:#ff9d00;font-weight:700">/</span>shell.gif<span style="color:#ff9d00;font-weight:700">&amp;</span>cmd=<span style="color:#ff9d00;font-weight:700">id</span></pre></div><br /> 	Note: In case the soorce code prefix a directory before our input, then we simply need to <code>../</code> out of that directory and then use our URL path, as we we have seen in <a href="hodology--WebApp_Pentest--Exploitation--Server-side--File_Inclusion--Local_File_Inclusion(LFI)_File_Disclosure--Directory-Filename_Prefix.html">Local File Inclusion(LFI): File Disclosure → Directory/Filename Prefix</a><br />   </div>
</body>
</html>
