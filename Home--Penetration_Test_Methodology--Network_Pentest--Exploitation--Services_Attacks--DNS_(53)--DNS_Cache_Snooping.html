<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>DNS Cache Snooping</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>DNS Cache Snooping</h1><br/>DNS cache snooping is when someone queries a DNS server in order to find out (snoop) if the DNS server has a specific DNS record cached, and thereby <span style="text-decoration:underline;">deduce if the DNS server&#39;s owner (or its users) have recently visited a specific site</span>. <br /><br />There are tow ways to do do a DNS Cache Snooping:<br />• <code>nonrecursive</code> mode, queries are sent to the server with the RD (recursion desired) flag set to 0. The server should respond positively to these only if it has the domain cached.<br />• <code>timed</code> mode, the mean and standard deviation response times for a cached domain are calculated by sampling the resolution of a name (www.google.com) several times. Then, each domain is resolved and the time taken compared to the mean. If it is less than one standard deviation over the mean, it is considered cached. The <code>timed</code> mode inserts entries in the cache and can only be used reliably once<br /><br /><strong><code>Nonrecursive mode</code></strong><br />The nslookup command can be configured to create queries that do not request recursion using the <strong>set norecurse</strong> syntax, which sets the RD bit to zero.<br />This mean that the DNS server server NOT forward that request to other DNS servers<br />Using this technique, we can harvest a bunch of information from DNS servers to see which domain names users have recently accessed, possibly revealing some interesting and maybe even embarrassing information.<br />It is an interesting technique when the clients have a badly configured DNS server.<br />   ◇ <strong>Windows command line</strong><br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">for</span> <span style="color:#ff9d00;font-weight:700">/</span>F <span style="color:#ff9d00;font-weight:700">%</span>i <span style="color:#ff9d00;font-weight:700">in</span> (domains.txt) <span style="color:#ff9d00;font-weight:700">do</span> @<span style="color:#ff9d00;font-weight:700">echo</span> <span style="color:#ff9d00;font-weight:700">%</span>i &amp; nslookup <span style="color:#ff9d00;font-weight:700">-</span>norecurse <span style="color:#ff9d00;font-weight:700">%</span>i [nameserver] | find <span style="color:#3ad900;font-weight:400">&quot;answer&quot;</span> &amp; <span style="color:#ff9d00;font-weight:700">echo</span>.  <span style="color:#0088ff;font-weight:400">#check multiple domains</span></pre></div><br />    This command is built from a FOR /F loop, which iterates over the contents of the file domains.txt. In that file, just put all of the names you want to check in the target DNS server&#39;s cache, with one name per line. At each iteration through the loop, we turn off command echo (@), display the current name we are checking (echo %i) and then we run nslookup with the -norecurse option.<br />   ◇ <strong>Linux shell</strong><br />    <div class="codebox"><pre>dig @[nameserver] [domain] <span style="color:#ff9d00;font-weight:700">+</span>norecurse                                                                 <span style="color:#0088ff;font-weight:400">#check only a domain</span></pre></div><br />        <a href=""><img src="images/645-1.png" alt="images/645-1.png" /></a><br />        <a href=""><img src="images/645-2.png" alt="images/645-2.png" /></a><br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">for</span> i <span style="color:#ff9d00;font-weight:700">in</span> <span style="color:#ff9d00;font-weight:700">`cat</span> domains.txt<span style="color:#ff9d00;font-weight:700">`</span>; <span style="color:#ff9d00;font-weight:700">do</span> host <span style="color:#ff9d00;font-weight:700">-r</span> <span style="color:#0088ff;font-weight:400">$i</span> [nameserver]; done                                          <span style="color:#0088ff;font-weight:400">#check multiple domains</span></pre></div> <br />    &quot;-r&quot; is how you turn off recursion with the host command. The &quot;host&quot; command is silent if it doesn&#39;t retrieve any information, so we don&#39;t need to do any extra parsing to separate out the negative responses like in the windows cmd.<br />    In general, &quot;host&quot; is much more useful for scripting kinds of applications than the &quot;dig&quot; command is<br />   ◇ <strong>nmap</strong><br />    <div class="codebox"><pre>nmap -sU -p 53 --script dns-cache-snoop.nse [nameserver]                                              <span style="color:#0088ff;font-weight:400">#check multiple domains</span></pre></div><br />    --script-args &#39;dns-cache-snoop.domains={host1,host2,host3}&#39;  → use a different list of domains to resolve instead of the default list of domains to check that are the top 50 most popular sites, each one being listed twice, once with &quot;www.&quot; and once without<br />    <span style="color:#a5452a;">example:</span><br />    <span style="color:#666666;"> </span>against Google DNS at 8.8.8.8 <br />        <a href=""><img src="images/645-3.png" alt="images/645-3.png" /></a><br />   ◇ <strong>recon-ng</strong><br />      We have to use the module cache_snoop of recon-ng. To do that see <a href="est--Recoinnaissance_(OSINT_Open_Source_Information_Gathering)--Infrastructure_Information_Gathering--Tool_recon-ng--Modules--cache_snoop.html">this chapter</a> <br />      <br /><br /><strong><code>Timed mode</code></strong><br />It can be less accurate then nonrecursive mode and take more time<br />   ◇ <strong>nmap</strong><br />    <div class="codebox"><pre>nmap -sU -p 53 --script dns-cache-snoop.nse --script-args <span style="color:#3ad900;font-weight:400">&#39;dns-cache-snoop.mode=timed,dns-cache-snoop.domains={www.google.com,facebook.com,www.youtube.com}&#39;</span> [nameserver]<br />nmap -sU -p 53 --script dns-cache-snoop.nse --script-args <span style="color:#3ad900;font-weight:400">&#39;dns-cache-snoop.mode=timed&#39;</span> [nameserver]</pre></div><br />        --script-args &#39;dns-cache-snoop.mode=timed&#39; → timed mode instead of the default nonrecursive mode<br />        --script-args &#39;dns-cache-snoop.domains={host1,host2,host3}&#39;  → use a different list of domains to resolve instead of the default list of domains to check that are the top 50 most popular sites, each one being listed twice, once with &quot;www.&quot; and once without<br /><br /><br /><strong><h3>Dump cache from a DNS server</h3></strong><br />If we are on a system where the name server process is running, we can dump its cache to a local file:<br /><div class="codebox"><pre>rndc dumpdb <span style="color:#ff9d00;font-weight:700">-</span>cache</pre></div><br />The cache is dumped to a file called &quot;named_dump.db&quot; in the current working directory of the name server process.<br />But where is the current working directory of the name server process? Well you could check the value of the &quot;directory&quot; option in named.conf, or just use the command lsof<br /><div class="codebox"><pre>lsof <span style="color:#ff9d00;font-weight:700">-</span>a <span style="color:#ff9d00;font-weight:700">-</span>c named <span style="color:#ff9d00;font-weight:700">-</span>d cwd</pre></div><br />    The command line options here mean show the current working directory (&quot;-d cwd&quot;) of the named process (&quot;-c named&quot;). <br />    The &quot;-a&quot; means to &quot;and&quot; these two conditions together rather than &quot;or&quot; them, which would be the normal default for lsof.<br /><br />Bibliography:<br />• “Hands on Hacking: Become an Expert at Next Gen Penetration Testing and Purple Teaming” Matthew Hickey, Jennifer Arcuri<br />• <a href="http://blog.commandlinekungfu.com/2009/03/episode-17-dns-cache-snooping-in-single.html">http://blog.commandlinekungfu.com/2009/03/episode-17-dns-cache-snooping-in-single.html</a><br />• <a href="https://support.simpledns.plus/kb/a125/what-is-dns-cache-snooping-and-how-do-i-prevent-it.aspx">https://support.simpledns.plus/kb/a125/what-is-dns-cache-snooping-and-how-do-i-prevent-it.aspx</a><br />• <a href="https://nmap.org/nsedoc/scripts/dns-cache-snoop.html">https://nmap.org/nsedoc/scripts/dns-cache-snoop.html</a></div>
</body>
</html>
