<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>source code review</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>source code review</h1><br/><br /><br /><strong><h3>Code allow </h3></strong><strong><h3>upload of files</h3></strong><strong><h3> only if the file END with an Image Extension</h3></strong><br /><br /><strong>php</strong><br /><div class="codebox"><pre>$fileName = basename($_FILES[&quot;uploadFile&quot;][&quot;name&quot;]);<br /><br />if (!preg_match(&#39;^.*\.(jpg|jpeg|png|gif)&#39;, $fileName)) {<br />    echo &quot;Only images are allowed&quot;;<br />    die();<br />}</pre></div><br />	The script uses a Regular Expression (regex) to test whether the filename contains any whitelisted image extensions.<br />	<span style="color:#e01b24;">PROBLEM:</span> The issue lies within the regex, as it only checks whether the file name contains the extension and not if it actually ends with it. <br />	<span style="color:#2ec27e;">SOLUTION:</span> Consider only the final file extension. Use (^.*\.) to match everything up to the last (.), and then uses ($) at the end to only match extensions that end the file name. So, the above attack would not work.<br />	<div class="codebox"><pre>if (!preg_match(&#39;/^.*\.(jpg|jpeg|png|gif)$/&#39;, $fileName)) { ...SNIP... }</pre></div><br />	 <br /><br /><br /><strong><h3>Code allow </h3></strong><strong><h3>execution of files</h3></strong><strong><h3> (already uploaded) only if they match a certain pattern</h3></strong><br /><br /><strong>xml</strong><br /><div class="codebox"><pre>&lt;FilesMatch &quot;.+\.ph(ar|p|tml)&quot;&gt;<br />    SetHandler application/x-httpd-php<br />&lt;/FilesMatch&gt;</pre></div><br />	This configuration of the web server determines which files to allow PHP code execution. To do that it specify a whitelist with a regex pattern that matches .phar, .php, and .phtml. <br />	<span style="color:#e01b24;">PROBLEM:</span> this regex pattern have the same mistake we saw above because forget to end it with ($). Any file that contains the above extensions will be allowed PHP code execution, even if it does not end with the PHP extension. <br />		<span style="color:#865e3c;">example:</span> the file name (shell.php.jpg) should pass the earlier whitelist test as it ends with (.jpg), and it would be able to execute PHP code due to the above misconfiguration, as it contains (.php) in its name<h3>.</h3><br /><br />Bibliography:<br /><a href="https://academy.hackthebox.com/">https://academy.hackthebox.com/</a></div>
</body>
</html>
