<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>smbclient (connect to smb shell)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>smbclient (connect to smb shell)</h1><br/><br /><strong><h3>1. Enumerate the shares</h3></strong><br />Once we know, with nmblookup tool, that a machine has the File Server service running (<span style="color:#ff8700;">&lt;20&gt;</span>), we can enumerate the shares <br /><div class="codebox"><pre>smbclient -N -L &lt;address&gt;</pre></div><br />    <strong>-L</strong> → services that are available on a target<strong><br />    //&lt;address&gt;</strong> →  target IP address<br />    <strong>-N</strong> →  suppress password prompt<br />    <span style="color:#ff0000;">ERROR:</span><br />    If on Linux we receive the <span style="text-decoration:underline;">error</span> &quot;Protocol negotiation failed: NT_STATUS_IO_TIMEOUT&quot;<br />    edit <strong>/etc/samba/smb.conf</strong> and under global settings add the following lines:<br />    <div class="codebox"><pre>client min protocol = CORE  <span style="color:#0088ff;font-weight:400">#SMB1 version used by Windows 2000, XP, Server 2003</span><br />client max protocol = SMB3  <span style="color:#0088ff;font-weight:400">#SMB3 used by Windows 10</span></pre></div><br /><br /><a href=""><img src="images/413-1.png" alt="images/413-1.png" /></a><br /><strong>smbclient</strong> also displays <span style="color:#ff0000;">administrative shares</span> that are hidden when using Windows standard tools(NET VIEW). The hidden shares have a $ sign at the end<br /><br /><strong><h3>2. Connect and Check for Null Session vulnerability</h3></strong><br />    Similar to &quot;net use&quot; and “net view” of Windows<br />    Check to login to all the Shares found!<br />   ◇ Option1:<br />    <div class="codebox"><pre>smbclient <span style="color:#ff9d00;font-weight:700">//</span>&lt;address&gt;<span style="color:#ff9d00;font-weight:700">/</span>ipc$ <span style="color:#ff9d00;font-weight:700">-</span>N     <span style="color:#0088ff;font-weight:400">#Linux target</span><br />smbclient <span style="color:#ff9d00;font-weight:700">\\\\</span>&lt;address&gt;<span style="color:#ff9d00;font-weight:700">\\</span>ipc$ <span style="color:#ff9d00;font-weight:700">-</span>N  <span style="color:#0088ff;font-weight:400">#Windows target</span></pre></div><br />    <a href=""><img src="images/413-2.png" alt="images/413-2.png" /></a><br />    The host is vulnerable in this case because we are able to login without credentials.<br />    <br />   ◇ Option 3: Login normally if we have the credentials<br />    <div class="codebox"><pre>smbclient -U &#39;&lt;username&gt;&#39;%&#39;&lt;password&gt;&#39; \\\\10.10.10.182\\Data</pre></div><br /><br /><br /><strong><h3>3. Post Connection</h3></strong><br />   ◇ <strong>Mount a directory on the attacker machine</strong><br />       <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">mkdir</span> &lt;local-directory&gt;<br />root@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">mount</span> -t cifs <span style="color:#333333;font-weight:400">\\\\</span>192.168.13.26<span style="color:#333333;font-weight:400">\\</span>[remote-directory] [local-directory]<br />root@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">ls</span> -l &lt;local-directory&gt;</pre></div><br />       This require the “cifs-utils” package in this case. “cifs-utils” can be installed by issuing an “apt install cifs-utils” command from your shell (assuming you’re on a Debian-based distribution)<br />        <span style="text-decoration:underline;">If it require username and password we can</span><br />       <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">mkdir</span> &lt;local-directory&gt;<br />root@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">mount</span> -t cifs <span style="color:#333333;font-weight:400">\\\\</span>192.168.13.26<span style="color:#333333;font-weight:400">\\</span>[remote-directory] [local-directory] -o rw,vers=1.0,user=[username],password=[password]<br />root@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">ls</span> -l &lt;local-directory&gt;</pre></div><br />   <br />   <br />   ◇ <strong>Alternative: Copy only a file on the loacal machine</strong>   &lt;---<br />    <div class="codebox"><pre>get &lt;file&gt;  <span style="color:#ff9d00;font-weight:700">/</span>home<span style="color:#ff9d00;font-weight:700">/</span>kali<span style="color:#ff9d00;font-weight:700">/</span>Desktop<span style="color:#ff9d00;font-weight:700">/</span>&lt;file&gt;</pre></div><br />    <a href=""><img src="images/413-3.png" alt="images/413-3.png" /></a><br />   <br />   <br />   ◇ <strong>Alternative: Recursive copy of the files and folders</strong><br />    Download all the files listed in the actual folder, preserving the structure of the directories inside<br />    <div class="codebox"><pre>smb&gt; cd &lt;folder&gt;<br />smb&gt; ls<br />smb&gt; recurse ON<br />smb&gt; prompt OFF<br />smb&gt; mget *</pre></div><br />    We can use a tool like tree to see the structures of the folders<br />    <div class="codebox"><pre>root@kali:/# tree</pre></div><br />        <a href=""><img src="images/413-4.png" alt="images/413-4.png" /></a><br />        <br />           </div>
</body>
</html>
