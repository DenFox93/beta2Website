<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>9. NFS root squashing(ports 111,2049)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>9. NFS root squashing(ports 111,2049)</h1><br/><br />• NFS (Network File System) is a popular distributed file system.<br />• NFS shares are configured in the /etc/exports file.<br />• Allows users to access shared files or directories over the network hosted on Unix/Linux systems<br />• By default, created files inherit the remote user’s id and group id (as owner and group respectively), even if they don’t exist on the NFS server<br />• NFS uses TCP/UDP port 2049<br />• Any accessible mounts can be listed remotely by issuing the command <code>showmount -e</code>, which lists the NFS server&#39;s export list (or the access control list for filesystems) that NFS clients).<br /><br /><table class="table"><tr><th>Option</th><th>Description</th></tr><tr><td>root_squash</td><td>If the root user is used to access NFS shares, it will be changed to the nfsnobody user, which is an unprivileged account. Any files created and uploaded by the root user will be owned by the nfsnobody user, which prevents an attacker from uploading binaries with the SUID bit set.</td></tr><tr><td>no_root_squash</td><td>Remote users connecting to the share as the local root user will be able to create files on the NFS server as the root user. This would allow for the creation of malicious scripts/programs with the SUID bit set.</td></tr></table><br /><br /><strong><h3>Check for NFS root squashing vulnerability</h3></strong><br />   ◇  Check from the target: Check the contents of /etc/exports for shares with the <strong>no_root_squash</strong> option:<br />        <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">cat</span> <span style="color:#ff9d00;font-weight:700">/</span>etc<span style="color:#ff9d00;font-weight:700">/</span>exports</pre></div><br />   ◇ Show the NFS server’s export list:<br />        <div class="codebox"><pre>attacker@kali<span style="color:#ff9d00;font-weight:700">:/</span># showmount --exports &lt;target&gt;</pre></div><br />        <a href=""><img src="images/1315-1.png" alt="images/1315-1.png" /></a><br />   ◇ Nmap scripts:<br />       Once we have found a NFS ports open, we can use some nmap NSE scripts to know more<br />      ▪ <span style="color:#ff8700;">nfs-ls.nse → Access rights + Available Exports files (Directory Listing)</span> <br />      ▪ <span style="color:#00ff00;">nfs-showmount.nse → Available Export folder</span><br />      ▪ <span style="color:#ff00e0;">nfs-statfs.nse </span><br />        <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">ls</span> <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>share<span style="color:#ff9d00;font-weight:700">/</span>nmap<span style="color:#ff9d00;font-weight:700">/</span>scripts<span style="color:#ff9d00;font-weight:700">/</span> <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">grep</span> nfs</pre></div><br />            <a href=""><img src="images/1315-2.png" alt="images/1315-2.png" /></a><br />        <div class="codebox"><pre>root@kali<span style="color:#ff9d00;font-weight:700">:/</span># nmap --script nfs-ls,nfs-showmount,nfs-statfs &lt;IP Address&gt;</pre></div><br />             <a href=""><img src="images/1315-3.png" alt="images/1315-3.png" /></a><br /><br />   ◇ Mount an NFS share:<br />        <div class="codebox"><pre>attacker@kali<span style="color:#ff9d00;font-weight:700">:/</span># <span style="color:#ff9d00;font-weight:700">mount</span> -t nfs -o rw,vers=2,nolock 192.168.1.25<span style="color:#ff9d00;font-weight:700">:</span>[remoteDirectory] [localDirectory]     <span style="color:#0088ff;font-weight:400">#now attacker and target are sharing the folder</span></pre></div><br />        mount options:<br />         - -o, --options &lt;list&gt; → comma-separated list of mount options<br />            → -w, --rw, --read-write → mount the filesystem read-write (default)<br />            → vers=&lt;number&gt; → select the nfs version, we should specify to use version 2 because if it doesn&#39;t have any authentication or authorization.<br />            → nolock → disables file locking. This setting is occasionally required when connecting to older NFS servers.<br />         - -t, --types &lt;list&gt; → limit the set of filesystem types<br />        <a href=""><img src="images/1315-4.png" alt="images/1315-4.png" /></a><br /><br /><strong><h3>Vulnerability</h3></strong><br />• <span style="text-decoration:underline;">Any Ip address can mount folder</span><br />    If the exported directory, like in our case is followed by a “*” value, means that is allowed mounting them from any IP address or host.<br />• <span style="text-decoration:underline;">Only Whitelisted Ip Address can mount folder</span><br />    Ideally an administrator should explicitly define (whitelist) IP addresses or hosts that should be allowed to connect to the NFS server<br />    Even in the case where our access is restricted due to an NFS whitelist configuration like the above, the output still gives us valuable information regarding which IP addresses or hosts can mount the available exports.<br />    In this scenario<br />   ◇ we have to check if we can spoof our IP address to match a whitelisted IP address or take control of a host which is allowed to connect.<br /><br /><strong><h3>Root Squashing</h3></strong><br />Root Squashing is how NFS prevents an obvious privilege escalation.<br />If the remote user is (or claims to be) root (uid=0), NFS will instead “squash” the user and treat them as if they are the “nobody” user, in the “nogroup” group. <span style="text-decoration:underline;">While this behavior is default, it can be disabled!</span><br /><strong>Disable Root Squashing</strong><br />no_root_squash is an NFS configuration option which turns root squashing off.<br />When included in a writable share configuration, a remote user who identifies as “root” can create files on the NFS share as the local root user.<br /><br /></div>
</body>
</html>
