<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>script: TCP SYN scan</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>script: TCP SYN scan</h1><br/><br /><strong>TCP SYN flood</strong>: Famous DOS attack based on TCP SYN packets. An attacker sends a flood of TCP SYN packets, forcing the target host to allocate a lot of resources reserved to the incoming connections until a crash happens.<br /><strong>TCP SYN scan</strong>: port scanner that avoids finalizing the tcp 3-way handshake. Like when we use <a href="Test_Methodology--Network_Pentest--Scanning_and_Enumeration--Port_Scanning_(on_hosts_alive)--nmap_[-s]--SCAN_TECHNIQUES---sS_TCP_SYN_Scan.html">nmap -sS</a> instead of <a href="_Methodology--Network_Pentest--Scanning_and_Enumeration--Port_Scanning_(on_hosts_alive)--nmap_[-s]--SCAN_TECHNIQUES---sT_TCP_Connect_Scan.html">nmap -sT</a><br /><br />Single Port scan:<br />	<a href=""><img src="images/1968-1.png" alt="images/1968-1.png" /></a><br />	   <a href="file://G:/Other computers/Yoga 520/CherryTree/screenshots2/PTP-elearnsecurity/2. Network Security/2. Scanning/-sS_port_open.png"><img src="images/1968-2.png" alt="images/1968-2.png" /></a><a href=""><img src="images/1968-3.png" alt="images/1968-3.png" /></a><br /><br /><br />Ruby Script<br /><div class="codebox"><pre><span style="color:#0088ff;font-weight:400"># TCP SYN PORT SCANNER</span><br /><br /><span style="color:#0088ff;font-weight:400">#USAGE:</span><br /><span style="color:#0088ff;font-weight:400"># ruby tcp_syn_scan.rb [host] [start_port]-[end_port]</span><br /><br /><span style="color:#7f0044;font-weight:400">require</span> <span style="color:#3ad900;font-weight:400">&#39;packetfu&#39;</span><br /><span style="color:#7f0044;font-weight:400">include</span> <span style="color:#7f0044;font-weight:400">PacketFu</span><br /><br /><br /><span style="color:#ff9d00;font-weight:700">def</span> main(host,start_port,end_port)<br />	open = []; closed = []<br />	<span style="color:#0088ff;font-weight:400">#start packet sniffer</span><br />	start_capture(host,open,closed,start_port,end_port)<br />	<span style="color:#0088ff;font-weight:400">#send the TCP SYN packet for each port we want to test</span><br />	send_tcp_syn(host,start_port,end_port)<br />	<span style="color:#0088ff;font-weight:400">#The ports that are filtered are the ones that are not opened or closed</span><br />	filtered=(start_port..end_port).to_a - (open+closed)<br />	puts <span style="color:#3ad900;font-weight:400">&quot;OPEN&quot;</span>,open <span style="color:#ff9d00;font-weight:700">if</span> !open.empty?<br />	puts <span style="color:#3ad900;font-weight:400">&quot;FILTERED&quot;</span>,filtered <span style="color:#ff9d00;font-weight:700">if</span> !filtered.empty?<br /><span style="color:#ff9d00;font-weight:700">end</span><br /><br /><br /><br /><br /><span style="color:#ff9d00;font-weight:700">def</span> send_tcp_syn(host,start_port,end_port)<br />	<span style="color:#0088ff;font-weight:400">#create a TCPPacket </span><br />	t = <span style="color:#7f0044;font-weight:400">TCPPacket</span>.new(<span style="color:#ff0044;font-weight:400">:config</span> =&gt; <span style="color:#7f0044;font-weight:400">Utils</span>.whoami?)<br />	<span style="color:#0088ff;font-weight:400">#set the correct mac address</span><br />	<span style="color:#0088ff;font-weight:400"># --&gt; UNCHANGED: default gateway, because the host is outside the network</span><br />	<span style="color:#0088ff;font-weight:400"># --&gt; CHANGE: host mac address coming from ARP request if the host belongs to the network</span><br />	t.eth_daddr = <span style="color:#7f0044;font-weight:400">Utils</span>.arp(host) <span style="color:#ff9d00;font-weight:700">if</span> <span style="color:#7f0044;font-weight:400">Utils</span>.arp(host)<br />	t.ip_daddr = host<br />	t.tcp_flags.syn = <span style="color:#ff0044;font-weight:400">1</span><br />	<span style="color:#0088ff;font-weight:400">#for each port</span><br />	start_port.upto(end_port) <span style="color:#ff9d00;font-weight:700">do</span> |port|<br />		t.tcp_dport = port<br />		t.recalc<br />		<span style="color:#0088ff;font-weight:400">#send a TCP SYN packet, two times to avoid packets loss</span><br />		<span style="color:#0088ff;font-weight:400"># sleep method avoid creating a flood of SYN packets against the target host</span><br />		<span style="color:#0088ff;font-weight:400"># otherwise the target host may become suspicious</span><br />		2.times.each { t.to_w;sleep(<span style="color:#ff0044;font-weight:400">0.02</span>)}<br />	<span style="color:#ff9d00;font-weight:700">end</span><br />	sleep(<span style="color:#ff0044;font-weight:400">1</span>)<br /><span style="color:#ff9d00;font-weight:700">end</span><br /><br /><br /><br /><span style="color:#ff9d00;font-weight:700">def</span> start_capture(host,open,closed,start_port,end_port)<br />	<span style="color:#0088ff;font-weight:400">#a new thread is required; </span><br />	<span style="color:#0088ff;font-weight:400"># because we sniff TCP SYN+ACK and RST+ACK at the same time we send TCP SYN.</span><br />	<span style="color:#0088ff;font-weight:400"># otherwise some responses could be dropped by the PacketFu captured stream, because overloaded by a lot of packets</span><br />	<span style="color:#7f0044;font-weight:400">Thread</span>.new{<br />		cap = <span style="color:#7f0044;font-weight:400">Capture</span>.new<br />		cap.capture(<span style="color:#ff0044;font-weight:400">:filter</span> =&gt; (<span style="color:#3ad900;font-weight:400">&quot;tcp and src host &quot;</span>+host) )<br />		cap.stream.each <span style="color:#ff9d00;font-weight:700">do</span> |raw_packet|<br />				tcp_packet = <span style="color:#7f0044;font-weight:400">Packet</span>.parse(raw_packet)<br />				port = tcp_packet.tcp_sport.to_i<br />				<span style="color:#ff9d00;font-weight:700">next</span> <span style="color:#ff9d00;font-weight:700">if</span> !port.between?(start_port,end_port)<br />				flags = tcp_packet.tcp_flags<br />				open.push(port) <span style="color:#ff9d00;font-weight:700">if</span> (flags.syn==<span style="color:#ff0044;font-weight:400">1</span> &amp;&amp; flags.ack==<span style="color:#ff0044;font-weight:400">1</span> &amp;&amp; !open.<span style="color:#7f0044;font-weight:400">include</span>?(port)) <br />				closed.push(port) <span style="color:#ff9d00;font-weight:700">if</span> (flags.rst==<span style="color:#ff0044;font-weight:400">1</span> &amp;&amp; flags.ack==<span style="color:#ff0044;font-weight:400">1</span> &amp;&amp; !open.<span style="color:#7f0044;font-weight:400">include</span>?(port))<br />		<span style="color:#ff9d00;font-weight:700">end</span><br />	}<br /><span style="color:#ff9d00;font-weight:700">end</span><br /><br /><br /><span style="color:#ff9d00;font-weight:700">begin</span> <br />	host = <span style="color:#7f0044;font-weight:400">ARGV</span>[<span style="color:#ff0044;font-weight:400">0</span>]<br /><br />	<span style="color:#0088ff;font-weight:400"># EXAMPLE: from 10-200 argument we have </span><br />	<span style="color:#0088ff;font-weight:400"># start_port = 10 and end_port = 200</span><br />	start_port,end_port = <span style="color:#7f0044;font-weight:400">ARGV</span>[<span style="color:#ff0044;font-weight:400">1</span>].split(<span style="color:#3ad900;font-weight:400">&quot;-&quot;</span>).map{|x| x.to_i}<br />	main(host,start_port,end_port)	<br /><br /><span style="color:#ff9d00;font-weight:700">end</span><br /></pre></div><br /><br />	<a href=""><img src="images/1968-4.png" alt="images/1968-4.png" /></a><br />   ◇ <span style="text-decoration:underline;">port open</span>:<br />	<a href=""><img src="images/1968-5.png" alt="images/1968-5.png" /></a><br />   ◇ <span style="text-decoration:underline;">port closed</span>:<br />	as we can see from wireshark the packet is transmitted 2 times, but this only because is been specified in the script <br />	<a href=""><img src="images/1968-6.png" alt="images/1968-6.png" /></a><br /><br /></div>
</body>
</html>
